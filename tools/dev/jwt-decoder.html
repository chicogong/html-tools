<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT è§£ç å™¨ - åœ¨çº¿å·¥å…·</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ”</text></svg>">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root { --primary-color: #8b5cf6; --header-color: #ef4444; --payload-color: #3b82f6; --signature-color: #10b981; }
        [data-theme="dark"] { --primary-color: #a78bfa; }
        body { padding: 1rem; min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem; }
        header h1 { margin: 0; font-size: 1.75rem; display: flex; align-items: center; gap: 0.5rem; }
        .header-actions { display: flex; gap: 0.5rem; align-items: center; }
        .theme-toggle { cursor: pointer; background: var(--primary-color); border: none; padding: 0.5rem 1rem; border-radius: 8px; color: white; font-size: 1rem; }
        .back-link { color: var(--primary-color); text-decoration: none; padding: 0.5rem 1rem; border-radius: 8px; border: 1px solid var(--primary-color); font-size: 0.9rem; }
        .input-section { margin-bottom: 1.5rem; }
        .input-section label { font-weight: 600; margin-bottom: 0.5rem; display: block; }
        .input-section textarea { font-family: 'SF Mono', Monaco, monospace; font-size: 0.9rem; min-height: 120px; }
        .actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; flex-wrap: wrap; }
        .example-btn { font-size: 0.8rem; padding: 0.3rem 0.6rem; background: var(--code-background-color); border: 1px solid var(--muted-border-color); border-radius: 4px; cursor: pointer; }
        .example-btn:hover { background: var(--primary-color); color: white; }
        .jwt-visual { margin: 1.5rem 0; padding: 1rem; background: var(--card-background-color); border-radius: 12px; }
        .jwt-visual h3 { margin-top: 0; margin-bottom: 1rem; font-size: 1rem; }
        .jwt-parts { font-family: 'SF Mono', Monaco, monospace; font-size: 0.85rem; word-break: break-all; line-height: 1.8; }
        .jwt-parts .header { color: var(--header-color); }
        .jwt-parts .payload { color: var(--payload-color); }
        .jwt-parts .signature { color: var(--signature-color); }
        .jwt-parts .dot { color: var(--muted-color); font-weight: bold; }
        .decode-result { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; }
        .section-card { background: var(--card-background-color); border-radius: 12px; overflow: hidden; border: 2px solid transparent; }
        .section-card.header { border-color: var(--header-color); }
        .section-card.payload { border-color: var(--payload-color); }
        .section-card.signature { border-color: var(--signature-color); }
        .section-header { padding: 0.75rem 1rem; display: flex; justify-content: space-between; align-items: center; }
        .section-card.header .section-header { background: var(--header-color); color: white; }
        .section-card.payload .section-header { background: var(--payload-color); color: white; }
        .section-card.signature .section-header { background: var(--signature-color); color: white; }
        .section-title { font-weight: 600; font-size: 0.9rem; }
        .section-copy { background: rgba(255,255,255,0.2); border: none; padding: 0.25rem 0.5rem; border-radius: 4px; color: white; cursor: pointer; font-size: 0.75rem; }
        .section-body { padding: 1rem; }
        .section-body pre { margin: 0; font-size: 0.85rem; overflow-x: auto; white-space: pre-wrap; word-break: break-all; }
        .claims-table { width: 100%; font-size: 0.85rem; border-collapse: collapse; }
        .claims-table th, .claims-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid var(--muted-border-color); }
        .claims-table th { font-weight: 600; color: var(--muted-color); width: 35%; }
        .claims-table td { font-family: 'SF Mono', Monaco, monospace; }
        .claims-table .claim-name { color: var(--primary-color); }
        .claims-table .claim-desc { font-size: 0.75rem; color: var(--muted-color); font-family: inherit; }
        .time-claim { display: flex; flex-direction: column; gap: 0.25rem; }
        .time-claim .timestamp { color: var(--muted-color); font-size: 0.8rem; }
        .time-claim .human { color: var(--primary-color); }
        .time-claim.expired .human { color: #ef4444; }
        .time-claim.valid .human { color: #10b981; }
        .status-badge { display: inline-flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
        .status-badge.valid { background: #10b98120; color: #10b981; }
        .status-badge.expired { background: #ef444420; color: #ef4444; }
        .status-badge.warning { background: #f59e0b20; color: #f59e0b; }
        .verify-section { margin-top: 1.5rem; background: var(--card-background-color); padding: 1.5rem; border-radius: 12px; }
        .verify-section h3 { margin-top: 0; }
        .verify-section input { font-family: 'SF Mono', Monaco, monospace; }
        .verify-result { margin-top: 1rem; padding: 1rem; border-radius: 8px; display: none; }
        .verify-result.valid { background: #10b98120; border: 1px solid #10b981; }
        .verify-result.invalid { background: #ef444420; border: 1px solid #ef4444; }
        .error-msg { color: #ef4444; background: #ef444420; padding: 1rem; border-radius: 8px; margin-top: 1rem; }
        .toast { position: fixed; bottom: 20px; right: 20px; padding: 1rem 1.5rem; background: #10b981; color: white; border-radius: 8px; font-weight: 500; z-index: 1000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .info-box { background: var(--code-background-color); padding: 1rem; border-radius: 8px; margin-top: 1rem; font-size: 0.85rem; }
        .info-box h4 { margin: 0 0 0.5rem 0; font-size: 0.9rem; }
        .info-box ul { margin: 0; padding-left: 1.5rem; }
        .info-box li { margin: 0.25rem 0; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ” JWT è§£ç å™¨</h1>
            <div class="header-actions">
                <a href="/" class="back-link">â† è¿”å›é¦–é¡µ</a>
                <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“</button>
            </div>
        </header>

        <div class="input-section">
            <label for="jwtInput">è¾“å…¥ JWT Token</label>
            <textarea id="jwtInput" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c" oninput="decodeJWT()"></textarea>
            <div class="actions">
                <button onclick="decodeJWT()">è§£ç </button>
                <button onclick="clearAll()" class="secondary">æ¸…ç©º</button>
                <button onclick="pasteFromClipboard()" class="secondary outline">ç²˜è´´</button>
                <span style="margin-left: auto;"></span>
                <button class="example-btn" onclick="loadExample(0)">ç¤ºä¾‹: HS256</button>
                <button class="example-btn" onclick="loadExample(1)">ç¤ºä¾‹: RS256</button>
                <button class="example-btn" onclick="loadExample(2)">ç¤ºä¾‹: å·²è¿‡æœŸ</button>
            </div>
        </div>

        <div id="result" style="display: none;">
            <div class="jwt-visual">
                <h3>Token ç»“æ„</h3>
                <div class="jwt-parts" id="jwtParts"></div>
            </div>

            <div id="statusBadges" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>

            <div class="decode-result">
                <div class="section-card header">
                    <div class="section-header">
                        <span class="section-title">Header (å¤´éƒ¨)</span>
                        <button class="section-copy" onclick="copySection('header')">å¤åˆ¶</button>
                    </div>
                    <div class="section-body">
                        <pre id="headerJson"></pre>
                    </div>
                </div>

                <div class="section-card payload">
                    <div class="section-header">
                        <span class="section-title">Payload (è½½è·)</span>
                        <button class="section-copy" onclick="copySection('payload')">å¤åˆ¶</button>
                    </div>
                    <div class="section-body">
                        <pre id="payloadJson"></pre>
                        <div id="claimsTable"></div>
                    </div>
                </div>

                <div class="section-card signature">
                    <div class="section-header">
                        <span class="section-title">Signature (ç­¾å)</span>
                        <button class="section-copy" onclick="copySection('signature')">å¤åˆ¶</button>
                    </div>
                    <div class="section-body">
                        <pre id="signatureValue"></pre>
                        <div class="info-box">
                            <h4>ç­¾åéªŒè¯è¯´æ˜</h4>
                            <p>ç­¾åç”¨äºéªŒè¯ Token çš„å®Œæ•´æ€§ã€‚éœ€è¦ä½¿ç”¨ç›¸åŒçš„ç®—æ³•å’Œå¯†é’¥è¿›è¡ŒéªŒè¯ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="verify-section">
                <h3>ç­¾åéªŒè¯ (ä»…æ”¯æŒ HS256/HS384/HS512)</h3>
                <label for="secretKey">å¯†é’¥ (Secret Key)</label>
                <input type="text" id="secretKey" placeholder="è¾“å…¥å¯†é’¥è¿›è¡ŒéªŒè¯" oninput="verifySignature()">
                <div class="verify-result" id="verifyResult"></div>
            </div>
        </div>

        <div id="errorMsg" class="error-msg" style="display: none;"></div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        const exampleTokens = [
            // HS256 example
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyLCJleHAiOjE5MTYyMzkwMjIsInJvbGUiOiJhZG1pbiJ9.x5Y7R9YvJjGrOXKq8tSFqLZwM5fOJhJ5A7YL8FwP4GY',
            // RS256 example  
            'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsImtpZCI6InJzYTEifQ.eyJpc3MiOiJodHRwczovL2V4YW1wbGUuY29tIiwiYXVkIjoibXktYXBwIiwic3ViIjoidXNlcjEyMyIsImlhdCI6MTcwMzAwMDAwMCwiZXhwIjoxOTAzMDAwMDAwfQ.mock_rs256_signature_here',
            // Expired token
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiJ1c2VyMTIzIiwibmFtZSI6IkV4cGlyZWQgVXNlciIsImlhdCI6MTUwMDAwMDAwMCwiZXhwIjoxNTAwMDAwMDAxfQ.expired_token_signature'
        ];

        const registeredClaims = {
            'iss': 'Issuer (ç­¾å‘è€…)',
            'sub': 'Subject (ä¸»é¢˜/ç”¨æˆ·)',
            'aud': 'Audience (å—ä¼—)',
            'exp': 'Expiration Time (è¿‡æœŸæ—¶é—´)',
            'nbf': 'Not Before (ç”Ÿæ•ˆæ—¶é—´)',
            'iat': 'Issued At (ç­¾å‘æ—¶é—´)',
            'jti': 'JWT ID (å”¯ä¸€æ ‡è¯†)'
        };

        let decodedData = { header: null, payload: null, signature: null };

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        (function() {
            const savedTheme = localStorage.getItem('theme') || 
                (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function loadExample(index) {
            document.getElementById('jwtInput').value = exampleTokens[index];
            decodeJWT();
        }

        async function pasteFromClipboard() {
            try {
                const text = await navigator.clipboard.readText();
                document.getElementById('jwtInput').value = text;
                decodeJWT();
            } catch (e) {
                showToast('æ— æ³•è®¿é—®å‰ªè´´æ¿', 'error');
            }
        }

        function clearAll() {
            document.getElementById('jwtInput').value = '';
            document.getElementById('result').style.display = 'none';
            document.getElementById('errorMsg').style.display = 'none';
            document.getElementById('secretKey').value = '';
            decodedData = { header: null, payload: null, signature: null };
        }

        function base64UrlDecode(str) {
            // Add padding
            let base64 = str.replace(/-/g, '+').replace(/_/g, '/');
            const padding = base64.length % 4;
            if (padding) {
                base64 += '='.repeat(4 - padding);
            }
            
            try {
                return decodeURIComponent(atob(base64).split('').map(c => {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
            } catch (e) {
                return atob(base64);
            }
        }

        function decodeJWT() {
            const jwt = document.getElementById('jwtInput').value.trim();
            if (!jwt) {
                document.getElementById('result').style.display = 'none';
                document.getElementById('errorMsg').style.display = 'none';
                return;
            }

            const parts = jwt.split('.');
            if (parts.length !== 3) {
                showError('æ— æ•ˆçš„ JWT æ ¼å¼ï¼šåº”åŒ…å«ä¸‰ä¸ªéƒ¨åˆ†ï¼ˆheader.payload.signatureï¼‰');
                return;
            }

            try {
                const header = JSON.parse(base64UrlDecode(parts[0]));
                const payload = JSON.parse(base64UrlDecode(parts[1]));
                const signature = parts[2];

                decodedData = { header, payload, signature };

                // Display JWT parts with colors
                document.getElementById('jwtParts').innerHTML = 
                    `<span class="header">${parts[0]}</span><span class="dot">.</span>` +
                    `<span class="payload">${parts[1]}</span><span class="dot">.</span>` +
                    `<span class="signature">${parts[2]}</span>`;

                // Display header
                document.getElementById('headerJson').textContent = JSON.stringify(header, null, 2);

                // Display payload
                document.getElementById('payloadJson').textContent = JSON.stringify(payload, null, 2);

                // Display signature
                document.getElementById('signatureValue').textContent = signature;

                // Generate status badges
                generateStatusBadges(payload);

                // Generate claims table
                generateClaimsTable(payload);

                document.getElementById('result').style.display = 'block';
                document.getElementById('errorMsg').style.display = 'none';

                // Verify if secret is already entered
                verifySignature();
            } catch (e) {
                showError('è§£ç å¤±è´¥ï¼š' + e.message);
            }
        }

        function generateStatusBadges(payload) {
            const badges = [];
            const now = Math.floor(Date.now() / 1000);

            if (payload.exp) {
                if (payload.exp < now) {
                    badges.push('<span class="status-badge expired">âš ï¸ å·²è¿‡æœŸ</span>');
                } else {
                    badges.push('<span class="status-badge valid">âœ“ æœªè¿‡æœŸ</span>');
                }
            }

            if (payload.nbf && payload.nbf > now) {
                badges.push('<span class="status-badge warning">â³ å°šæœªç”Ÿæ•ˆ</span>');
            }

            if (decodedData.header?.alg) {
                badges.push(`<span class="status-badge">${decodedData.header.alg}</span>`);
            }

            document.getElementById('statusBadges').innerHTML = badges.join('');
        }

        function generateClaimsTable(payload) {
            const now = Math.floor(Date.now() / 1000);
            let html = '<table class="claims-table"><thead><tr><th>å£°æ˜ (Claim)</th><th>å€¼</th></tr></thead><tbody>';

            for (const [key, value] of Object.entries(payload)) {
                const isRegistered = registeredClaims[key];
                let displayValue = value;
                let extraClass = '';

                // Handle time claims
                if (['exp', 'nbf', 'iat'].includes(key) && typeof value === 'number') {
                    const date = new Date(value * 1000);
                    const isExpired = key === 'exp' && value < now;
                    const isNotYet = key === 'nbf' && value > now;
                    extraClass = isExpired ? 'expired' : (isNotYet ? 'warning' : 'valid');
                    
                    displayValue = `
                        <div class="time-claim ${extraClass}">
                            <span class="timestamp">${value}</span>
                            <span class="human">${date.toLocaleString('zh-CN')}</span>
                            ${isExpired ? '<span style="color: #ef4444; font-size: 0.75rem;">å·²è¿‡æœŸ</span>' : ''}
                            ${isNotYet ? '<span style="color: #f59e0b; font-size: 0.75rem;">å°šæœªç”Ÿæ•ˆ</span>' : ''}
                        </div>
                    `;
                } else if (typeof value === 'object') {
                    displayValue = `<pre style="margin:0">${JSON.stringify(value, null, 2)}</pre>`;
                }

                html += `
                    <tr>
                        <td>
                            <span class="claim-name">${key}</span>
                            ${isRegistered ? `<div class="claim-desc">${isRegistered}</div>` : ''}
                        </td>
                        <td>${displayValue}</td>
                    </tr>
                `;
            }

            html += '</tbody></table>';
            document.getElementById('claimsTable').innerHTML = html;
        }

        async function verifySignature() {
            const secret = document.getElementById('secretKey').value;
            const resultEl = document.getElementById('verifyResult');
            
            if (!secret || !decodedData.header) {
                resultEl.style.display = 'none';
                return;
            }

            const alg = decodedData.header.alg;
            if (!['HS256', 'HS384', 'HS512'].includes(alg)) {
                resultEl.className = 'verify-result';
                resultEl.style.display = 'block';
                resultEl.innerHTML = `<p>âš ï¸ ä»…æ”¯æŒ HMAC ç®—æ³• (HS256/HS384/HS512) çš„éªŒè¯ã€‚å½“å‰ç®—æ³•: ${alg}</p>`;
                return;
            }

            try {
                const jwt = document.getElementById('jwtInput').value.trim();
                const parts = jwt.split('.');
                const data = parts[0] + '.' + parts[1];

                const algMap = {
                    'HS256': { name: 'HMAC', hash: 'SHA-256' },
                    'HS384': { name: 'HMAC', hash: 'SHA-384' },
                    'HS512': { name: 'HMAC', hash: 'SHA-512' }
                };

                const encoder = new TextEncoder();
                const keyData = encoder.encode(secret);
                const key = await crypto.subtle.importKey(
                    'raw', keyData, algMap[alg], false, ['sign']
                );

                const signature = await crypto.subtle.sign(
                    algMap[alg], key, encoder.encode(data)
                );

                const computedSig = btoa(String.fromCharCode(...new Uint8Array(signature)))
                    .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');

                const isValid = computedSig === parts[2];

                resultEl.className = `verify-result ${isValid ? 'valid' : 'invalid'}`;
                resultEl.style.display = 'block';
                resultEl.innerHTML = isValid 
                    ? '<p>âœ… ç­¾åéªŒè¯æˆåŠŸï¼Token å®Œæ•´æ€§éªŒè¯é€šè¿‡ã€‚</p>'
                    : '<p>âŒ ç­¾åéªŒè¯å¤±è´¥ï¼Token å¯èƒ½è¢«ç¯¡æ”¹æˆ–å¯†é’¥ä¸æ­£ç¡®ã€‚</p>';
            } catch (e) {
                resultEl.className = 'verify-result invalid';
                resultEl.style.display = 'block';
                resultEl.innerHTML = `<p>âŒ éªŒè¯å‡ºé”™: ${e.message}</p>`;
            }
        }

        function copySection(section) {
            let content = '';
            if (section === 'header') {
                content = JSON.stringify(decodedData.header, null, 2);
            } else if (section === 'payload') {
                content = JSON.stringify(decodedData.payload, null, 2);
            } else if (section === 'signature') {
                content = decodedData.signature;
            }
            
            navigator.clipboard.writeText(content);
            showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        }

        function showError(msg) {
            document.getElementById('result').style.display = 'none';
            document.getElementById('errorMsg').textContent = msg;
            document.getElementById('errorMsg').style.display = 'block';
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.style.background = type === 'error' ? '#ef4444' : '#10b981';
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Init
        loadExample(0);
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂØåÊñáÊú¨ËΩ¨Á∫ØÊñáÊú¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --editor-bg-light: #fff;
            --editor-bg-dark: #1e1e2e;
        }
        [data-theme="light"] {
            --editor-bg: var(--editor-bg-light);
        }
        [data-theme="dark"] {
            --editor-bg: var(--editor-bg-dark);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .theme-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 0.5rem;
        }
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }
        .editor-box {
            display: flex;
            flex-direction: column;
        }
        .editor-box label {
            margin-bottom: 0.5rem;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .char-count {
            font-weight: normal;
            font-size: 0.85rem;
            color: var(--pico-muted-color);
        }
        .rich-editor {
            min-height: 300px;
            padding: 1rem;
            border: 1px solid var(--pico-muted-border-color);
            border-radius: 8px;
            background: var(--editor-bg);
            overflow-y: auto;
            resize: vertical;
        }
        .rich-editor:focus {
            outline: 2px solid var(--pico-primary);
            outline-offset: 2px;
        }
        textarea {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            min-height: 300px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .options-section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: var(--pico-card-background-color);
            border-radius: 8px;
        }
        .options-section h3 {
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .option-group label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        #message {
            min-height: 2rem;
        }
        .error {
            color: var(--pico-del-color);
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 0, 0, 0.1);
        }
        .success-msg {
            color: var(--pico-ins-color);
        }
        .drop-zone {
            border: 2px dashed var(--pico-muted-border-color);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }
        .drop-zone.dragover {
            border-color: var(--pico-primary);
            background: rgba(var(--pico-primary-rgb), 0.1);
        }
        .drop-zone p {
            margin: 0;
            color: var(--pico-muted-color);
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        .stat-item {
            padding: 1rem;
            background: var(--pico-card-background-color);
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--pico-primary);
        }
        .stat-label {
            font-size: 0.85rem;
            color: var(--pico-muted-color);
        }
        .preview-section {
            margin-top: 2rem;
        }
        .preview-box {
            background: var(--editor-bg);
            border: 1px solid var(--pico-muted-border-color);
            border-radius: 8px;
            padding: 1rem;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>ÂØåÊñáÊú¨ËΩ¨Á∫ØÊñáÊú¨</h1>
            <button class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">üåì</button>
        </header>

        <div class="drop-zone" id="dropZone">
            <p>ÊãñÊîæÊñá‰ª∂Âà∞ËøôÈáåÔºàÊîØÊåÅ HTML„ÄÅWordÊñáÊ°£ÁâáÊÆµÔºâÊàñ‰ªéÂÖ∂‰ªñÂ∫îÁî®Á≤òË¥¥ÂØåÊñáÊú¨</p>
        </div>

        <section class="options-section">
            <h3>ËΩ¨Êç¢ÈÄâÈ°π</h3>
            <div class="option-group">
                <label><input type="checkbox" id="optPreserveLineBreaks" checked> ‰øùÁïôÊç¢Ë°å</label>
                <label><input type="checkbox" id="optPreserveLists" checked> ËΩ¨Êç¢ÂàóË°®‰∏∫ÊñáÊú¨</label>
                <label><input type="checkbox" id="optPreserveLinks"> ‰øùÁïôÈìæÊé•URL</label>
                <label><input type="checkbox" id="optRemoveExtraSpaces" checked> ÁßªÈô§Â§ö‰ΩôÁ©∫Ê†º</label>
                <label><input type="checkbox" id="optTrimLines" checked> ‰øÆÂâ™Ë°åÈ¶ñÂ∞æÁ©∫Ê†º</label>
                <label><input type="checkbox" id="optRemoveEmptyLines"> ÁßªÈô§Á©∫Ë°å</label>
                <label><input type="checkbox" id="optPreserveTables"> ËΩ¨Êç¢Ë°®Ê†º‰∏∫ÊñáÊú¨</label>
            </div>
        </section>

        <div class="editor-container">
            <div class="editor-box">
                <label for="richInput">
                    ÂØåÊñáÊú¨ËæìÂÖ•
                    <span class="char-count" id="inputCount">0 Â≠óÁ¨¶</span>
                </label>
                <div class="rich-editor" id="richInput" contenteditable="true" placeholder="Âú®Ê≠§Á≤òË¥¥ÂØåÊñáÊú¨ÂÜÖÂÆπÔºåÊàñÁõ¥Êé•ËæìÂÖ•HTML"></div>
            </div>
            <div class="editor-box">
                <label for="plainOutput">
                    Á∫ØÊñáÊú¨ËæìÂá∫
                    <span class="char-count" id="outputCount">0 Â≠óÁ¨¶</span>
                </label>
                <textarea id="plainOutput" readonly placeholder="ËΩ¨Êç¢ÂêéÁöÑÁ∫ØÊñáÊú¨Â∞ÜÊòæÁ§∫Âú®ËøôÈáå"></textarea>
            </div>
        </div>

        <div class="btn-group">
            <button onclick="convert()">ËΩ¨Êç¢</button>
            <button class="secondary" onclick="clearAll()">Ê∏ÖÁ©∫</button>
            <button class="secondary" onclick="copyResult()">Â§çÂà∂ÁªìÊûú</button>
            <button class="secondary" onclick="pasteFromClipboard()">‰ªéÂâ™Ë¥¥ÊùøÁ≤òË¥¥</button>
            <button class="secondary" onclick="loadHtml()">ËæìÂÖ•HTML‰ª£Á†Å</button>
        </div>

        <div id="message"></div>

        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="statChars">0</div>
                <div class="stat-label">Â≠óÁ¨¶Êï∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statCharsNoSpace">0</div>
                <div class="stat-label">Â≠óÁ¨¶Êï∞Ôºà‰∏çÂê´Á©∫Ê†ºÔºâ</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statWords">0</div>
                <div class="stat-label">ÂçïËØç/ËØçÁªÑÊï∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statLines">0</div>
                <div class="stat-label">Ë°åÊï∞</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statParagraphs">0</div>
                <div class="stat-label">ÊÆµËêΩÊï∞</div>
            </div>
        </div>

        <details class="preview-section">
            <summary>HTMLÊ∫êÁ†ÅÈ¢ÑËßà</summary>
            <div class="preview-box" id="htmlPreview"></div>
        </details>
    </main>

    <script>
        // Theme toggle
        function toggleTheme() {
            var html = document.documentElement;
            var currentTheme = html.getAttribute('data-theme');
            var newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        (function() {
            var savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function showMessage(msg, isError) {
            var messageDiv = document.getElementById('message');
            var p = document.createElement('p');
            p.className = isError ? 'error' : 'success-msg';
            p.textContent = msg;
            messageDiv.textContent = '';
            messageDiv.appendChild(p);
            setTimeout(function() { messageDiv.textContent = ''; }, 3000);
        }

        function clearAll() {
            document.getElementById('richInput').innerHTML = '';
            document.getElementById('plainOutput').value = '';
            document.getElementById('htmlPreview').textContent = '';
            updateCounts();
            updateStats('');
        }

        function copyResult() {
            var output = document.getElementById('plainOutput');
            if (!output.value) {
                showMessage('Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ', true);
                return;
            }
            navigator.clipboard.writeText(output.value).then(function() {
                showMessage('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', false);
            }).catch(function() {
                showMessage('Â§çÂà∂Â§±Ë¥•', true);
            });
        }

        function pasteFromClipboard() {
            navigator.clipboard.read().then(function(clipboardItems) {
                for (var i = 0; i < clipboardItems.length; i++) {
                    var item = clipboardItems[i];
                    
                    // Try HTML first
                    if (item.types.indexOf('text/html') >= 0) {
                        item.getType('text/html').then(function(blob) {
                            blob.text().then(function(html) {
                                document.getElementById('richInput').innerHTML = html;
                                convert();
                            });
                        });
                        return;
                    }
                    
                    // Fall back to plain text
                    if (item.types.indexOf('text/plain') >= 0) {
                        item.getType('text/plain').then(function(blob) {
                            blob.text().then(function(text) {
                                document.getElementById('richInput').textContent = text;
                                convert();
                            });
                        });
                        return;
                    }
                }
            }).catch(function() {
                // Fallback for browsers that don't support clipboard.read()
                navigator.clipboard.readText().then(function(text) {
                    document.getElementById('richInput').textContent = text;
                    convert();
                }).catch(function(err) {
                    showMessage('Êó†Ê≥ïËÆøÈóÆÂâ™Ë¥¥Êùø: ' + err.message, true);
                });
            });
        }

        function loadHtml() {
            var html = prompt('ËØ∑ËæìÂÖ•HTML‰ª£Á†Å:');
            if (html) {
                document.getElementById('richInput').innerHTML = html;
                convert();
            }
        }

        function updateCounts() {
            var richInput = document.getElementById('richInput');
            var plainOutput = document.getElementById('plainOutput');
            
            document.getElementById('inputCount').textContent = richInput.textContent.length + ' Â≠óÁ¨¶';
            document.getElementById('outputCount').textContent = plainOutput.value.length + ' Â≠óÁ¨¶';
        }

        function updateStats(text) {
            // Character count
            document.getElementById('statChars').textContent = text.length;
            
            // Characters without spaces
            var noSpaces = text.replace(/\s/g, '');
            document.getElementById('statCharsNoSpace').textContent = noSpaces.length;
            
            // Word count (for Chinese, count characters; for English, count words)
            var chineseChars = text.match(/[\u4e00-\u9fa5]/g) || [];
            var englishWords = text.match(/[a-zA-Z]+/g) || [];
            document.getElementById('statWords').textContent = chineseChars.length + englishWords.length;
            
            // Line count
            var lines = text.split('\n');
            document.getElementById('statLines').textContent = lines.length;
            
            // Paragraph count (non-empty lines separated by empty lines)
            var paragraphs = text.split(/\n\s*\n/).filter(function(p) { return p.trim().length > 0; });
            document.getElementById('statParagraphs').textContent = Math.max(paragraphs.length, text.trim() ? 1 : 0);
        }

        // HTML to plain text converter
        function htmlToPlainText(html) {
            var options = {
                preserveLineBreaks: document.getElementById('optPreserveLineBreaks').checked,
                preserveLists: document.getElementById('optPreserveLists').checked,
                preserveLinks: document.getElementById('optPreserveLinks').checked,
                removeExtraSpaces: document.getElementById('optRemoveExtraSpaces').checked,
                trimLines: document.getElementById('optTrimLines').checked,
                removeEmptyLines: document.getElementById('optRemoveEmptyLines').checked,
                preserveTables: document.getElementById('optPreserveTables').checked
            };
            
            // Create a temporary element to parse HTML
            var temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Process the content
            var result = processNode(temp, options);
            
            // Post-processing
            if (options.removeExtraSpaces) {
                result = result.replace(/[ \t]+/g, ' ');
            }
            
            if (options.trimLines) {
                result = result.split('\n').map(function(line) {
                    return line.trim();
                }).join('\n');
            }
            
            if (options.removeEmptyLines) {
                result = result.replace(/\n\s*\n/g, '\n');
            } else {
                // Collapse multiple blank lines to maximum 2
                result = result.replace(/\n{3,}/g, '\n\n');
            }
            
            return result.trim();
        }

        function processNode(node, options) {
            var result = '';
            
            for (var i = 0; i < node.childNodes.length; i++) {
                var child = node.childNodes[i];
                
                if (child.nodeType === Node.TEXT_NODE) {
                    result += child.textContent;
                } else if (child.nodeType === Node.ELEMENT_NODE) {
                    var tagName = child.tagName.toLowerCase();
                    
                    // Skip hidden elements
                    if (child.style && (child.style.display === 'none' || child.style.visibility === 'hidden')) {
                        continue;
                    }
                    
                    // Skip script and style
                    if (tagName === 'script' || tagName === 'style' || tagName === 'noscript') {
                        continue;
                    }
                    
                    // Handle different elements
                    switch (tagName) {
                        case 'br':
                            if (options.preserveLineBreaks) {
                                result += '\n';
                            }
                            break;
                            
                        case 'p':
                        case 'div':
                        case 'section':
                        case 'article':
                        case 'header':
                        case 'footer':
                        case 'main':
                        case 'aside':
                            var content = processNode(child, options);
                            if (content.trim()) {
                                if (result && !result.endsWith('\n')) {
                                    result += '\n';
                                }
                                result += content;
                                if (options.preserveLineBreaks) {
                                    result += '\n';
                                }
                            }
                            break;
                            
                        case 'h1':
                        case 'h2':
                        case 'h3':
                        case 'h4':
                        case 'h5':
                        case 'h6':
                            var headingContent = processNode(child, options);
                            if (headingContent.trim()) {
                                if (result && !result.endsWith('\n')) {
                                    result += '\n';
                                }
                                result += headingContent.toUpperCase();
                                if (options.preserveLineBreaks) {
                                    result += '\n\n';
                                }
                            }
                            break;
                            
                        case 'ul':
                        case 'ol':
                            if (options.preserveLists) {
                                if (result && !result.endsWith('\n')) {
                                    result += '\n';
                                }
                                result += processList(child, options, tagName === 'ol', 0);
                            } else {
                                result += processNode(child, options);
                            }
                            break;
                            
                        case 'li':
                            result += processNode(child, options);
                            break;
                            
                        case 'a':
                            var linkText = processNode(child, options);
                            if (options.preserveLinks) {
                                var href = child.getAttribute('href');
                                if (href && href !== linkText && !href.startsWith('#') && !href.startsWith('javascript:')) {
                                    result += linkText + ' (' + href + ')';
                                } else {
                                    result += linkText;
                                }
                            } else {
                                result += linkText;
                            }
                            break;
                            
                        case 'img':
                            var alt = child.getAttribute('alt');
                            if (alt) {
                                result += '[ÂõæÁâá: ' + alt + ']';
                            }
                            break;
                            
                        case 'table':
                            if (options.preserveTables) {
                                if (result && !result.endsWith('\n')) {
                                    result += '\n';
                                }
                                result += processTable(child, options);
                            } else {
                                result += processNode(child, options);
                            }
                            break;
                            
                        case 'tr':
                        case 'td':
                        case 'th':
                        case 'thead':
                        case 'tbody':
                        case 'tfoot':
                            result += processNode(child, options);
                            break;
                            
                        case 'blockquote':
                            var quoteContent = processNode(child, options);
                            if (quoteContent.trim()) {
                                var quoteLines = quoteContent.split('\n').map(function(line) {
                                    return '> ' + line;
                                }).join('\n');
                                if (result && !result.endsWith('\n')) {
                                    result += '\n';
                                }
                                result += quoteLines + '\n';
                            }
                            break;
                            
                        case 'pre':
                        case 'code':
                            result += child.textContent;
                            if (tagName === 'pre' && options.preserveLineBreaks) {
                                result += '\n';
                            }
                            break;
                            
                        case 'hr':
                            if (result && !result.endsWith('\n')) {
                                result += '\n';
                            }
                            result += '---\n';
                            break;
                            
                        default:
                            result += processNode(child, options);
                    }
                }
            }
            
            return result;
        }

        function processList(listNode, options, isOrdered, depth) {
            var result = '';
            var counter = 1;
            var indent = '';
            for (var d = 0; d < depth; d++) {
                indent += '  ';
            }
            
            for (var i = 0; i < listNode.children.length; i++) {
                var child = listNode.children[i];
                if (child.tagName.toLowerCase() === 'li') {
                    var prefix = isOrdered ? (counter + '. ') : '- ';
                    var content = '';
                    
                    for (var j = 0; j < child.childNodes.length; j++) {
                        var liChild = child.childNodes[j];
                        if (liChild.nodeType === Node.TEXT_NODE) {
                            content += liChild.textContent.trim();
                        } else if (liChild.nodeType === Node.ELEMENT_NODE) {
                            var liTagName = liChild.tagName.toLowerCase();
                            if (liTagName === 'ul' || liTagName === 'ol') {
                                // Nested list
                                if (content.trim()) {
                                    result += indent + prefix + content.trim() + '\n';
                                    content = '';
                                }
                                result += processList(liChild, options, liTagName === 'ol', depth + 1);
                            } else {
                                content += processNode(liChild, options);
                            }
                        }
                    }
                    
                    if (content.trim()) {
                        result += indent + prefix + content.trim() + '\n';
                    }
                    counter++;
                }
            }
            
            return result;
        }

        function processTable(tableNode, options) {
            var rows = [];
            var maxCols = 0;
            
            // Extract all rows
            var trElements = tableNode.querySelectorAll('tr');
            for (var i = 0; i < trElements.length; i++) {
                var tr = trElements[i];
                var row = [];
                var cells = tr.querySelectorAll('td, th');
                for (var j = 0; j < cells.length; j++) {
                    row.push(processNode(cells[j], options).trim());
                }
                if (row.length > 0) {
                    rows.push(row);
                    maxCols = Math.max(maxCols, row.length);
                }
            }
            
            if (rows.length === 0) return '';
            
            // Calculate column widths
            var colWidths = [];
            for (var c = 0; c < maxCols; c++) {
                var maxWidth = 0;
                for (var r = 0; r < rows.length; r++) {
                    if (rows[r][c]) {
                        maxWidth = Math.max(maxWidth, rows[r][c].length);
                    }
                }
                colWidths.push(Math.max(maxWidth, 3));
            }
            
            // Build table string
            var result = '';
            
            for (var r = 0; r < rows.length; r++) {
                var line = '| ';
                for (var c = 0; c < maxCols; c++) {
                    var cell = rows[r][c] || '';
                    var padding = colWidths[c] - cell.length;
                    line += cell;
                    for (var p = 0; p < padding; p++) {
                        line += ' ';
                    }
                    line += ' | ';
                }
                result += line.trim() + '\n';
                
                // Add separator after header row
                if (r === 0) {
                    var separator = '| ';
                    for (var c = 0; c < maxCols; c++) {
                        for (var w = 0; w < colWidths[c]; w++) {
                            separator += '-';
                        }
                        separator += ' | ';
                    }
                    result += separator.trim() + '\n';
                }
            }
            
            return result;
        }

        function convert() {
            var richInput = document.getElementById('richInput');
            var plainOutput = document.getElementById('plainOutput');
            var htmlPreview = document.getElementById('htmlPreview');
            
            var html = richInput.innerHTML;
            
            if (!html.trim()) {
                showMessage('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ', true);
                return;
            }
            
            try {
                var plainText = htmlToPlainText(html);
                plainOutput.value = plainText;
                htmlPreview.textContent = html;
                
                updateCounts();
                updateStats(plainText);
                
                showMessage('ËΩ¨Êç¢ÊàêÂäü', false);
            } catch (e) {
                showMessage('ËΩ¨Êç¢ÈîôËØØ: ' + e.message, true);
            }
        }

        // Drag and drop handling
        var dropZone = document.getElementById('dropZone');
        var richInput = document.getElementById('richInput');

        dropZone.addEventListener('dragover', function(e) {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', function(e) {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            
            var files = e.dataTransfer.files;
            var items = e.dataTransfer.items;
            
            // Check for HTML content
            if (items) {
                for (var i = 0; i < items.length; i++) {
                    if (items[i].type === 'text/html') {
                        items[i].getAsString(function(html) {
                            richInput.innerHTML = html;
                            convert();
                        });
                        return;
                    }
                }
            }
            
            // Handle file drop
            if (files.length > 0) {
                var file = files[0];
                var reader = new FileReader();
                
                reader.onload = function(event) {
                    var content = event.target.result;
                    
                    if (file.type === 'text/html' || file.name.endsWith('.html') || file.name.endsWith('.htm')) {
                        richInput.innerHTML = content;
                    } else {
                        richInput.textContent = content;
                    }
                    
                    convert();
                };
                
                reader.readAsText(file);
            }
        });

        // Auto-convert on input (debounced)
        var timeout;
        richInput.addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                if (richInput.innerHTML.trim()) {
                    convert();
                } else {
                    updateCounts();
                }
            }, 500);
        });

        // Handle paste events
        richInput.addEventListener('paste', function(e) {
            // Let the paste happen, then convert
            setTimeout(function() {
                convert();
            }, 100);
        });

        // Option change handlers
        var optionCheckboxes = document.querySelectorAll('.option-group input[type="checkbox"]');
        optionCheckboxes.forEach(function(checkbox) {
            checkbox.addEventListener('change', function() {
                if (richInput.innerHTML.trim()) {
                    convert();
                }
            });
        });

        // Initial count update
        updateCounts();
        updateStats('');
    </script>
</body>
</html>

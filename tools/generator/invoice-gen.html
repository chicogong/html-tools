<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‘ç¥¨/æ”¶æ®ç”Ÿæˆå™¨ - WebUtils</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --primary-color: #1095c1;
            --danger-color: #c10016;
        }
        
        body {
            padding: 1rem;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .header h1 {
            margin: 0;
        }
        
        .theme-toggle {
            cursor: pointer;
            font-size: 1.5rem;
            background: none;
            border: none;
            padding: 0.5rem;
        }
        
        .container-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .container-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--pico-card-background-color);
            border-radius: var(--pico-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .card h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--pico-muted-border-color);
            padding-bottom: 0.5rem;
        }
        
        .item-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .item-row input {
            margin-bottom: 0;
        }
        
        .btn-remove {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-remove:hover {
            opacity: 0.8;
        }
        
        .btn-add {
            width: 100%;
            margin-top: 0.5rem;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--pico-muted-border-color);
        }
        
        .summary-row.total {
            font-weight: bold;
            font-size: 1.2rem;
            border-bottom: none;
            border-top: 2px solid var(--pico-muted-border-color);
            margin-top: 0.5rem;
            padding-top: 1rem;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .action-buttons button {
            flex: 1;
            min-width: 120px;
        }
        
        /* é¢„è§ˆæ ·å¼ */
        .preview-container {
            background: white;
            color: #333;
            padding: 2rem;
            border-radius: var(--pico-border-radius);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .invoice-header h2 {
            margin: 0;
            color: #333;
        }
        
        .invoice-header .invoice-no {
            color: #666;
            font-size: 0.9rem;
        }
        
        .invoice-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .info-block h4 {
            margin: 0 0 0.5rem;
            color: #333;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .info-block p {
            margin: 0.25rem 0;
            color: #555;
            font-size: 0.9rem;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        
        .invoice-table th {
            background: #f5f5f5;
            color: #333;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            border-bottom: 2px solid #ddd;
        }
        
        .invoice-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            color: #333;
        }
        
        .invoice-table .text-right {
            text-align: right;
        }
        
        .invoice-summary {
            display: flex;
            justify-content: flex-end;
        }
        
        .summary-table {
            width: 250px;
        }
        
        .summary-table .row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            color: #555;
        }
        
        .summary-table .row.total {
            font-weight: bold;
            font-size: 1.2rem;
            color: #333;
            border-top: 2px solid #333;
            margin-top: 0.5rem;
            padding-top: 1rem;
        }
        
        .invoice-footer {
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            text-align: center;
            color: #888;
            font-size: 0.85rem;
        }
        
        .stamp-area {
            margin-top: 2rem;
            display: flex;
            justify-content: flex-end;
        }
        
        .stamp-box {
            width: 150px;
            height: 150px;
            border: 2px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 0.8rem;
        }
        
        /* æ‰“å°æ ·å¼ */
        @media print {
            body {
                padding: 0;
                background: white;
            }
            
            .no-print {
                display: none !important;
            }
            
            .preview-container {
                box-shadow: none;
                padding: 0;
            }
            
            .invoice-table th {
                background: #f5f5f5 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .item-row {
                grid-template-columns: 1fr 1fr;
            }
            
            .item-row .item-name {
                grid-column: span 2;
            }
        }
        
        .item-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 0.5rem;
            font-weight: bold;
            font-size: 0.85rem;
            color: var(--pico-muted-color);
            margin-bottom: 0.5rem;
            padding: 0 0.25rem;
        }
        
        @media (max-width: 600px) {
            .item-header {
                display: none;
            }
        }
    </style>
</head>
<body>
    <main class="container">
        <a href="../../index.html" style="display:inline-block;margin-bottom:1rem;color:var(--pico-primary);text-decoration:none;">â† è¿”å›é¦–é¡µ</a>
        <div class="header no-print">
            <h1>ğŸ“„ å‘ç¥¨/æ”¶æ®ç”Ÿæˆå™¨</h1>
            <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
        </div>
        
        <div class="container-grid no-print">
            <!-- å·¦ä¾§ï¼šè¡¨å•è¾“å…¥ -->
            <div>
                <!-- å‘ç¥¨ç±»å‹ -->
                <div class="card">
                    <h3>ğŸ“‹ å‘ç¥¨ä¿¡æ¯</h3>
                    <div class="form-row">
                        <label>
                            å‘ç¥¨ç±»å‹
                            <select id="invoiceType" onchange="updatePreview()">
                                <option value="invoice">å‘ç¥¨</option>
                                <option value="receipt">æ”¶æ®</option>
                                <option value="quote">æŠ¥ä»·å•</option>
                            </select>
                        </label>
                        <label>
                            å‘ç¥¨ç¼–å·
                            <input type="text" id="invoiceNo" placeholder="INV-001" onchange="updatePreview()">
                        </label>
                    </div>
                    <div class="form-row">
                        <label>
                            å¼€ç¥¨æ—¥æœŸ
                            <input type="date" id="invoiceDate" onchange="updatePreview()">
                        </label>
                        <label>
                            åˆ°æœŸæ—¥æœŸ
                            <input type="date" id="dueDate" onchange="updatePreview()">
                        </label>
                    </div>
                </div>
                
                <!-- å–æ–¹ä¿¡æ¯ -->
                <div class="card">
                    <h3>ğŸ¢ å–æ–¹ä¿¡æ¯</h3>
                    <label>
                        å…¬å¸åç§°
                        <input type="text" id="sellerName" placeholder="æ‚¨çš„å…¬å¸åç§°" onchange="updatePreview()">
                    </label>
                    <label>
                        åœ°å€
                        <input type="text" id="sellerAddress" placeholder="å…¬å¸åœ°å€" onchange="updatePreview()">
                    </label>
                    <div class="form-row">
                        <label>
                            ç”µè¯
                            <input type="text" id="sellerPhone" placeholder="è”ç³»ç”µè¯" onchange="updatePreview()">
                        </label>
                        <label>
                            ç¨å·
                            <input type="text" id="sellerTaxId" placeholder="çº³ç¨äººè¯†åˆ«å·" onchange="updatePreview()">
                        </label>
                    </div>
                </div>
                
                <!-- ä¹°æ–¹ä¿¡æ¯ -->
                <div class="card">
                    <h3>ğŸ‘¤ ä¹°æ–¹ä¿¡æ¯</h3>
                    <label>
                        å®¢æˆ·åç§°
                        <input type="text" id="buyerName" placeholder="å®¢æˆ·/å…¬å¸åç§°" onchange="updatePreview()">
                    </label>
                    <label>
                        åœ°å€
                        <input type="text" id="buyerAddress" placeholder="å®¢æˆ·åœ°å€" onchange="updatePreview()">
                    </label>
                    <div class="form-row">
                        <label>
                            ç”µè¯
                            <input type="text" id="buyerPhone" placeholder="è”ç³»ç”µè¯" onchange="updatePreview()">
                        </label>
                        <label>
                            ç¨å·
                            <input type="text" id="buyerTaxId" placeholder="çº³ç¨äººè¯†åˆ«å·" onchange="updatePreview()">
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- å³ä¾§ï¼šå•†å“å’Œæ±‡æ€» -->
            <div>
                <!-- å•†å“åˆ—è¡¨ -->
                <div class="card">
                    <h3>ğŸ“¦ å•†å“/æœåŠ¡æ˜ç»†</h3>
                    <div class="item-header">
                        <span>åç§°</span>
                        <span>æ•°é‡</span>
                        <span>å•ä»·</span>
                        <span>å°è®¡</span>
                        <span></span>
                    </div>
                    <div id="itemList"></div>
                    <button class="btn-add secondary" onclick="addItem()">+ æ·»åŠ å•†å“</button>
                </div>
                
                <!-- ç¨ç‡å’Œæ±‡æ€» -->
                <div class="card">
                    <h3>ğŸ’° é‡‘é¢æ±‡æ€»</h3>
                    <div class="form-row">
                        <label>
                            ç¨ç‡ (%)
                            <input type="number" id="taxRate" value="13" min="0" max="100" step="0.1" onchange="updatePreview()">
                        </label>
                        <label>
                            æŠ˜æ‰£ (%)
                            <input type="number" id="discount" value="0" min="0" max="100" step="0.1" onchange="updatePreview()">
                        </label>
                    </div>
                    <div id="summarySection">
                        <div class="summary-row">
                            <span>å°è®¡</span>
                            <span id="subtotal">Â¥0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>æŠ˜æ‰£</span>
                            <span id="discountAmount">-Â¥0.00</span>
                        </div>
                        <div class="summary-row">
                            <span>ç¨é¢</span>
                            <span id="taxAmount">Â¥0.00</span>
                        </div>
                        <div class="summary-row total">
                            <span>æ€»è®¡</span>
                            <span id="totalAmount">Â¥0.00</span>
                        </div>
                    </div>
                </div>
                
                <!-- å¤‡æ³¨ -->
                <div class="card">
                    <h3>ğŸ“ å¤‡æ³¨</h3>
                    <textarea id="notes" rows="3" placeholder="ä»˜æ¬¾æ–¹å¼ã€é“¶è¡Œè´¦å·ç­‰ä¿¡æ¯..." onchange="updatePreview()"></textarea>
                </div>
                
                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-buttons">
                    <button onclick="printInvoice()">ğŸ–¨ï¸ æ‰“å°</button>
                    <button onclick="exportPDF()" class="secondary">ğŸ“¥ å¯¼å‡ºPDF</button>
                    <button onclick="saveData()" class="contrast">ğŸ’¾ ä¿å­˜æ•°æ®</button>
                    <button onclick="loadData()" class="outline">ğŸ“‚ åŠ è½½æ•°æ®</button>
                </div>
            </div>
        </div>
        
        <!-- å‘ç¥¨é¢„è§ˆ -->
        <div class="card no-print" style="margin-top: 1rem;">
            <h3>ğŸ‘ï¸ é¢„è§ˆ</h3>
        </div>
        
        <div class="preview-container" id="invoicePreview">
            <!-- é¢„è§ˆå†…å®¹å°†é€šè¿‡JSç”Ÿæˆ -->
        </div>
    </main>
    
    <!-- html2pdfåº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <script>
        // å•†å“åˆ—è¡¨æ•°æ®
        let items = [];
        let itemIdCounter = 0;
        
        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            // è®¾ç½®é»˜è®¤æ—¥æœŸ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('invoiceDate').value = today;
            
            // è®¾ç½®åˆ°æœŸæ—¥æœŸä¸º30å¤©å
            const dueDate = new Date();
            dueDate.setDate(dueDate.getDate() + 30);
            document.getElementById('dueDate').value = dueDate.toISOString().split('T')[0];
            
            // ç”Ÿæˆå‘ç¥¨ç¼–å·
            document.getElementById('invoiceNo').value = 'INV-' + Date.now().toString().slice(-6);
            
            // æ·»åŠ åˆå§‹å•†å“è¡Œ
            addItem();
            
            // åŠ è½½ä¿å­˜çš„ä¸»é¢˜
            const savedTheme = localStorage.getItem('invoice-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            
            updatePreview();
        });
        
        // ä¸»é¢˜åˆ‡æ¢
        window.toggleTheme = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('invoice-theme', newTheme);
        };
        
        // è½¬ä¹‰HTMLç‰¹æ®Šå­—ç¬¦é˜²æ­¢XSS
        window.escapeHtml = function(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        // æ·»åŠ å•†å“è¡Œ
        function addItem() {
            const id = itemIdCounter++;
            items.push({ id, name: '', quantity: 1, price: 0 });
            renderItems();
        }
        
        // åˆ é™¤å•†å“è¡Œ
        function removeItem(id) {
            items = items.filter(item => item.id !== id);
            if (items.length === 0) {
                addItem();
            } else {
                renderItems();
                updatePreview();
            }
        }
        
        // æ›´æ–°å•†å“æ•°æ®
        function updateItem(id, field, value) {
            const item = items.find(i => i.id === id);
            if (item) {
                if (field === 'quantity' || field === 'price') {
                    item[field] = parseFloat(value) || 0;
                } else {
                    item[field] = value;
                }
            }
            updateSubtotals();
            updatePreview();
        }
        
        // æ¸²æŸ“å•†å“åˆ—è¡¨
        function renderItems() {
            const container = document.getElementById('itemList');
            container.textContent = '';
            
            items.forEach(item => {
                const row = document.createElement('div');
                row.className = 'item-row';
                
                const nameInput = document.createElement('input');
                nameInput.type = 'text';
                nameInput.className = 'item-name';
                nameInput.placeholder = 'å•†å“åç§°';
                nameInput.value = item.name;
                nameInput.addEventListener('change', () => updateItem(item.id, 'name', nameInput.value));
                
                const qtyInput = document.createElement('input');
                qtyInput.type = 'number';
                qtyInput.placeholder = 'æ•°é‡';
                qtyInput.min = '0';
                qtyInput.step = '1';
                qtyInput.value = item.quantity;
                qtyInput.addEventListener('change', () => updateItem(item.id, 'quantity', qtyInput.value));
                
                const priceInput = document.createElement('input');
                priceInput.type = 'number';
                priceInput.placeholder = 'å•ä»·';
                priceInput.min = '0';
                priceInput.step = '0.01';
                priceInput.value = item.price;
                priceInput.addEventListener('change', () => updateItem(item.id, 'price', priceInput.value));
                
                const subtotalInput = document.createElement('input');
                subtotalInput.type = 'text';
                subtotalInput.readOnly = true;
                subtotalInput.value = 'Â¥' + (item.quantity * item.price).toFixed(2);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'btn-remove';
                removeBtn.title = 'åˆ é™¤';
                removeBtn.textContent = 'âœ•';
                removeBtn.addEventListener('click', () => removeItem(item.id));
                
                row.appendChild(nameInput);
                row.appendChild(qtyInput);
                row.appendChild(priceInput);
                row.appendChild(subtotalInput);
                row.appendChild(removeBtn);
                
                container.appendChild(row);
            });
        }
        
        // æ›´æ–°å°è®¡æ˜¾ç¤º
        function updateSubtotals() {
            const subtotal = items.reduce((sum, item) => sum + item.quantity * item.price, 0);
            const discountRate = parseFloat(document.getElementById('discount').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            const discountAmount = subtotal * discountRate / 100;
            const afterDiscount = subtotal - discountAmount;
            const taxAmount = afterDiscount * taxRate / 100;
            const total = afterDiscount + taxAmount;
            
            document.getElementById('subtotal').textContent = 'Â¥' + subtotal.toFixed(2);
            document.getElementById('discountAmount').textContent = '-Â¥' + discountAmount.toFixed(2);
            document.getElementById('taxAmount').textContent = 'Â¥' + taxAmount.toFixed(2);
            document.getElementById('totalAmount').textContent = 'Â¥' + total.toFixed(2);
        }
        
        // æ›´æ–°é¢„è§ˆ
        window.updatePreview = function() {
            updateSubtotals();
            
            const invoiceType = document.getElementById('invoiceType').value;
            const typeNames = { invoice: 'å‘ç¥¨', receipt: 'æ”¶æ®', quote: 'æŠ¥ä»·å•' };
            const typeName = typeNames[invoiceType];
            
            const invoiceNo = document.getElementById('invoiceNo').value || '-';
            const invoiceDate = document.getElementById('invoiceDate').value || '-';
            const dueDate = document.getElementById('dueDate').value || '-';
            
            const sellerName = document.getElementById('sellerName').value || 'æœªå¡«å†™';
            const sellerAddress = document.getElementById('sellerAddress').value || '';
            const sellerPhone = document.getElementById('sellerPhone').value || '';
            const sellerTaxId = document.getElementById('sellerTaxId').value || '';
            
            const buyerName = document.getElementById('buyerName').value || 'æœªå¡«å†™';
            const buyerAddress = document.getElementById('buyerAddress').value || '';
            const buyerPhone = document.getElementById('buyerPhone').value || '';
            const buyerTaxId = document.getElementById('buyerTaxId').value || '';
            
            const notes = document.getElementById('notes').value || '';
            
            const subtotal = items.reduce((sum, item) => sum + item.quantity * item.price, 0);
            const discountRate = parseFloat(document.getElementById('discount').value) || 0;
            const taxRate = parseFloat(document.getElementById('taxRate').value) || 0;
            
            const discountAmount = subtotal * discountRate / 100;
            const afterDiscount = subtotal - discountAmount;
            const taxAmount = afterDiscount * taxRate / 100;
            const total = afterDiscount + taxAmount;
            
            // ä½¿ç”¨DOM APIå®‰å…¨æ„å»ºé¢„è§ˆ
            const preview = document.getElementById('invoicePreview');
            preview.textContent = '';
            
            // å‘ç¥¨å¤´éƒ¨
            const header = document.createElement('div');
            header.className = 'invoice-header';
            const h2 = document.createElement('h2');
            h2.textContent = typeName;
            const pNo = document.createElement('p');
            pNo.className = 'invoice-no';
            pNo.textContent = 'ç¼–å·: ' + invoiceNo;
            header.appendChild(h2);
            header.appendChild(pNo);
            preview.appendChild(header);
            
            // å–æ–¹ä¹°æ–¹ä¿¡æ¯
            const infoSection = document.createElement('div');
            infoSection.className = 'invoice-info';
            
            const sellerBlock = document.createElement('div');
            sellerBlock.className = 'info-block';
            const sellerTitle = document.createElement('h4');
            sellerTitle.textContent = 'å–æ–¹';
            sellerBlock.appendChild(sellerTitle);
            const sellerNameP = document.createElement('p');
            const sellerNameStrong = document.createElement('strong');
            sellerNameStrong.textContent = sellerName;
            sellerNameP.appendChild(sellerNameStrong);
            sellerBlock.appendChild(sellerNameP);
            if (sellerAddress) {
                const p = document.createElement('p');
                p.textContent = sellerAddress;
                sellerBlock.appendChild(p);
            }
            if (sellerPhone) {
                const p = document.createElement('p');
                p.textContent = 'ç”µè¯: ' + sellerPhone;
                sellerBlock.appendChild(p);
            }
            if (sellerTaxId) {
                const p = document.createElement('p');
                p.textContent = 'ç¨å·: ' + sellerTaxId;
                sellerBlock.appendChild(p);
            }
            
            const buyerBlock = document.createElement('div');
            buyerBlock.className = 'info-block';
            const buyerTitle = document.createElement('h4');
            buyerTitle.textContent = 'ä¹°æ–¹';
            buyerBlock.appendChild(buyerTitle);
            const buyerNameP = document.createElement('p');
            const buyerNameStrong = document.createElement('strong');
            buyerNameStrong.textContent = buyerName;
            buyerNameP.appendChild(buyerNameStrong);
            buyerBlock.appendChild(buyerNameP);
            if (buyerAddress) {
                const p = document.createElement('p');
                p.textContent = buyerAddress;
                buyerBlock.appendChild(p);
            }
            if (buyerPhone) {
                const p = document.createElement('p');
                p.textContent = 'ç”µè¯: ' + buyerPhone;
                buyerBlock.appendChild(p);
            }
            if (buyerTaxId) {
                const p = document.createElement('p');
                p.textContent = 'ç¨å·: ' + buyerTaxId;
                buyerBlock.appendChild(p);
            }
            
            infoSection.appendChild(sellerBlock);
            infoSection.appendChild(buyerBlock);
            preview.appendChild(infoSection);
            
            // æ—¥æœŸä¿¡æ¯
            const dateSection = document.createElement('div');
            dateSection.className = 'invoice-info';
            const dateBlock1 = document.createElement('div');
            dateBlock1.className = 'info-block';
            const dateP1 = document.createElement('p');
            const dateStrong1 = document.createElement('strong');
            dateStrong1.textContent = 'å¼€ç¥¨æ—¥æœŸ: ';
            dateP1.appendChild(dateStrong1);
            dateP1.appendChild(document.createTextNode(invoiceDate));
            dateBlock1.appendChild(dateP1);
            
            const dateBlock2 = document.createElement('div');
            dateBlock2.className = 'info-block';
            const dateP2 = document.createElement('p');
            const dateStrong2 = document.createElement('strong');
            dateStrong2.textContent = 'åˆ°æœŸæ—¥æœŸ: ';
            dateP2.appendChild(dateStrong2);
            dateP2.appendChild(document.createTextNode(dueDate));
            dateBlock2.appendChild(dateP2);
            
            dateSection.appendChild(dateBlock1);
            dateSection.appendChild(dateBlock2);
            preview.appendChild(dateSection);
            
            // å•†å“è¡¨æ ¼
            const table = document.createElement('table');
            table.className = 'invoice-table';
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['å•†å“/æœåŠ¡', 'æ•°é‡', 'å•ä»·', 'é‡‘é¢'].forEach((text, i) => {
                const th = document.createElement('th');
                th.textContent = text;
                if (i > 0) th.className = 'text-right';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            const tbody = document.createElement('tbody');
            const validItems = items.filter(item => item.name);
            if (validItems.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 4;
                td.style.textAlign = 'center';
                td.style.color = '#999';
                td.textContent = 'æš‚æ— å•†å“';
                tr.appendChild(td);
                tbody.appendChild(tr);
            } else {
                validItems.forEach(item => {
                    const tr = document.createElement('tr');
                    const td1 = document.createElement('td');
                    td1.textContent = item.name;
                    const td2 = document.createElement('td');
                    td2.className = 'text-right';
                    td2.textContent = item.quantity;
                    const td3 = document.createElement('td');
                    td3.className = 'text-right';
                    td3.textContent = 'Â¥' + item.price.toFixed(2);
                    const td4 = document.createElement('td');
                    td4.className = 'text-right';
                    td4.textContent = 'Â¥' + (item.quantity * item.price).toFixed(2);
                    tr.appendChild(td1);
                    tr.appendChild(td2);
                    tr.appendChild(td3);
                    tr.appendChild(td4);
                    tbody.appendChild(tr);
                });
            }
            table.appendChild(tbody);
            preview.appendChild(table);
            
            // æ±‡æ€»
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'invoice-summary';
            const summaryTable = document.createElement('div');
            summaryTable.className = 'summary-table';
            
            const row1 = document.createElement('div');
            row1.className = 'row';
            const span1a = document.createElement('span');
            span1a.textContent = 'å°è®¡';
            const span1b = document.createElement('span');
            span1b.textContent = 'Â¥' + subtotal.toFixed(2);
            row1.appendChild(span1a);
            row1.appendChild(span1b);
            summaryTable.appendChild(row1);
            
            if (discountRate > 0) {
                const row2 = document.createElement('div');
                row2.className = 'row';
                const span2a = document.createElement('span');
                span2a.textContent = 'æŠ˜æ‰£ (' + discountRate + '%)';
                const span2b = document.createElement('span');
                span2b.textContent = '-Â¥' + discountAmount.toFixed(2);
                row2.appendChild(span2a);
                row2.appendChild(span2b);
                summaryTable.appendChild(row2);
            }
            
            const row3 = document.createElement('div');
            row3.className = 'row';
            const span3a = document.createElement('span');
            span3a.textContent = 'ç¨é¢ (' + taxRate + '%)';
            const span3b = document.createElement('span');
            span3b.textContent = 'Â¥' + taxAmount.toFixed(2);
            row3.appendChild(span3a);
            row3.appendChild(span3b);
            summaryTable.appendChild(row3);
            
            const row4 = document.createElement('div');
            row4.className = 'row total';
            const span4a = document.createElement('span');
            span4a.textContent = 'æ€»è®¡';
            const span4b = document.createElement('span');
            span4b.textContent = 'Â¥' + total.toFixed(2);
            row4.appendChild(span4a);
            row4.appendChild(span4b);
            summaryTable.appendChild(row4);
            
            summaryDiv.appendChild(summaryTable);
            preview.appendChild(summaryDiv);
            
            // å¤‡æ³¨
            if (notes) {
                const footer = document.createElement('div');
                footer.className = 'invoice-footer';
                const notesP = document.createElement('p');
                const notesStrong = document.createElement('strong');
                notesStrong.textContent = 'å¤‡æ³¨: ';
                notesP.appendChild(notesStrong);
                notesP.appendChild(document.createTextNode(notes));
                footer.appendChild(notesP);
                preview.appendChild(footer);
            }
            
            // ç›–ç« åŒº
            const stampArea = document.createElement('div');
            stampArea.className = 'stamp-area';
            const stampBox = document.createElement('div');
            stampBox.className = 'stamp-box';
            stampBox.textContent = 'ç›–ç« å¤„';
            stampArea.appendChild(stampBox);
            preview.appendChild(stampArea);
        };
        
        // æ‰“å°å‘ç¥¨
        window.printInvoice = function() {
            window.print();
        };
        
        // å¯¼å‡ºPDF
        window.exportPDF = function() {
            const element = document.getElementById('invoicePreview');
            const invoiceNo = document.getElementById('invoiceNo').value || 'invoice';
            
            const opt = {
                margin: 10,
                filename: invoiceNo + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            html2pdf().set(opt).from(element).save();
        };
        
        // ä¿å­˜æ•°æ®åˆ°æœ¬åœ°
        window.saveData = function() {
            const data = {
                invoiceType: document.getElementById('invoiceType').value,
                invoiceNo: document.getElementById('invoiceNo').value,
                invoiceDate: document.getElementById('invoiceDate').value,
                dueDate: document.getElementById('dueDate').value,
                sellerName: document.getElementById('sellerName').value,
                sellerAddress: document.getElementById('sellerAddress').value,
                sellerPhone: document.getElementById('sellerPhone').value,
                sellerTaxId: document.getElementById('sellerTaxId').value,
                buyerName: document.getElementById('buyerName').value,
                buyerAddress: document.getElementById('buyerAddress').value,
                buyerPhone: document.getElementById('buyerPhone').value,
                buyerTaxId: document.getElementById('buyerTaxId').value,
                taxRate: document.getElementById('taxRate').value,
                discount: document.getElementById('discount').value,
                notes: document.getElementById('notes').value,
                items: items
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'invoice-' + (data.invoiceNo || 'data') + '.json';
            a.click();
            URL.revokeObjectURL(url);
        };
        
        // ä»æ–‡ä»¶åŠ è½½æ•°æ®
        window.loadData = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            
                            document.getElementById('invoiceType').value = data.invoiceType || 'invoice';
                            document.getElementById('invoiceNo').value = data.invoiceNo || '';
                            document.getElementById('invoiceDate').value = data.invoiceDate || '';
                            document.getElementById('dueDate').value = data.dueDate || '';
                            document.getElementById('sellerName').value = data.sellerName || '';
                            document.getElementById('sellerAddress').value = data.sellerAddress || '';
                            document.getElementById('sellerPhone').value = data.sellerPhone || '';
                            document.getElementById('sellerTaxId').value = data.sellerTaxId || '';
                            document.getElementById('buyerName').value = data.buyerName || '';
                            document.getElementById('buyerAddress').value = data.buyerAddress || '';
                            document.getElementById('buyerPhone').value = data.buyerPhone || '';
                            document.getElementById('buyerTaxId').value = data.buyerTaxId || '';
                            document.getElementById('taxRate').value = data.taxRate || 13;
                            document.getElementById('discount').value = data.discount || 0;
                            document.getElementById('notes').value = data.notes || '';
                            
                            if (data.items && data.items.length > 0) {
                                items = data.items;
                                itemIdCounter = Math.max(...items.map(i => i.id)) + 1;
                            }
                            
                            renderItems();
                            updatePreview();
                            
                            alert('æ•°æ®åŠ è½½æˆåŠŸï¼');
                        } catch (err) {
                            alert('æ–‡ä»¶æ ¼å¼é”™è¯¯ï¼Œè¯·é€‰æ‹©æœ‰æ•ˆçš„JSONæ–‡ä»¶');
                        }
                    };
                    reader.readAsText(file);
                }
            };
            input.click();
        };
    </script>
</body>
</html>

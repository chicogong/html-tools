<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è¯¾å ‚å¼¹å¹• - WebUtils</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="è¯¾å ‚å¼¹å¹• - WebUtils" />
    <meta name="keywords" content="classroom-danmaku,life,tools,webutils" />
    <meta name="author" content="WebUtils" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://tools.realtime-ai.chat/tools/life/classroom-danmaku.html" />

    <!-- Open Graph -->
    <meta property="og:title" content="è¯¾å ‚å¼¹å¹• - WebUtils" />
    <meta property="og:description" content="è¯¾å ‚å¼¹å¹• - WebUtils" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://tools.realtime-ai.chat/tools/life/classroom-danmaku.html"
    />
    <meta property="og:site_name" content="WebUtils" />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:image" content="https://tools.realtime-ai.chat/social-preview.png" />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="640" />
    <meta property="og:image:type" content="image/png" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="è¯¾å ‚å¼¹å¹• - WebUtils" />
    <meta name="twitter:description" content="è¯¾å ‚å¼¹å¹• - WebUtils" />
    <meta name="twitter:image" content="https://tools.realtime-ai.chat/social-preview.png" />

    <meta name="description" content="æ‰«ç å‘å¼¹å¹•ï¼Œæ”¯æŒè·¨è®¾å¤‡å®æ—¶åŒæ­¥ï¼Œé€‚åˆè¯¾å ‚æ•™å­¦äº’åŠ¨" />
    <meta name="keywords" content="è¯¾å ‚å¼¹å¹•,å¼¹å¹•æŠ•å±,æ•™å­¦äº’åŠ¨,æ‰«ç å¼¹å¹•" />
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/mqtt@5.10.3/dist/mqtt.min.js"></script>
    <style>
      :root {
        --bg-deep: #0a0a0f;
        --bg-surface: #12121a;
        --bg-card: #1a1a24;
        --bg-input: #0e0e14;
        --text-primary: #e8e8ed;
        --text-secondary: #8888a0;
        --text-muted: #55556a;
        --border-subtle: #2a2a3a;
        --border-strong: #3a3a4a;
        --accent-cyan: #00f5d4;
        --accent-green: #10b981;
        --accent-red: #f43f5e;
        --accent-yellow: #fbbf24;
        --accent-purple: #a855f7;
        --glow-cyan: rgb(0, 245, 212, 0.15);
        --glow-green: rgb(16, 185, 129, 0.15);
        --glow-red: rgb(244, 63, 94, 0.15);
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
      }

      [data-theme="light"] {
        --bg-deep: #fafafa;
        --bg-surface: #fff;
        --bg-card: #fff;
        --bg-input: #f5f5f5;
        --bg-hover: #f5f5f5;
        --text-primary: #1a1a1a;
        --text-secondary: #666;
        --text-muted: #999;
        --border-subtle: #e5e5e5;
        --border-strong: #d5d5d5;
      }

      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--border-subtle);
        background: var(--bg-card);
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 100;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .theme-toggle:hover {
        transform: scale(1.1);
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      :root {
        --bg-primary: #0a0a0f;
        --bg-secondary: #12121a;
        --bg-card: #1a1a24;
        --text-primary: #e4e4e7;
        --text-secondary: #a1a1aa;
        --accent: #00f5d4;
        --accent-glow: rgba(0, 245, 212, 0.3);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-primary);
        color: var(--text-primary);
        min-height: 100vh;
        overflow: hidden;
      }

      /* å¼¹å¹•ç”»å¸ƒ */
      #danmaku-stage {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      .danmaku-item {
        position: absolute;
        white-space: nowrap;
        font-size: 32px;
        font-weight: 600;
        text-shadow:
          2px 2px 4px rgba(0, 0, 0, 0.8),
          0 0 10px rgba(0, 0, 0, 0.5);
        animation: danmaku-move linear forwards;
        will-change: transform;
      }

      @keyframes danmaku-move {
        from {
          transform: translateX(0);
        }
        to {
          transform: translateX(calc(-100% - 100vw));
        }
      }

      /* ========== ç•™è¨€å¢™æ¨¡å¼ ========== */
      #message-wall {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        padding: 80px 20px 180px;
        overflow: hidden;
        display: none;
        z-index: 10;
      }

      body.wall-mode #message-wall {
        display: block;
      }

      body.wall-mode #danmaku-stage {
        display: none;
      }

      body.wall-mode .screen-hint {
        display: none;
      }

      .wall-container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .wall-bubble {
        position: absolute;
        padding: 12px 20px;
        border-radius: 20px;
        font-size: 18px;
        font-weight: 500;
        max-width: 280px;
        overflow-wrap: break-word;
        white-space: normal;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        animation: bubble-appear 0.5s ease-out forwards;
        transition: transform 0.3s ease;
      }

      .wall-bubble:hover {
        transform: scale(1.05);
        z-index: 100;
      }

      .wall-bubble::before {
        content: "";
        position: absolute;
        bottom: -8px;
        left: 20px;
        width: 0;
        height: 0;
        border-left: 10px solid transparent;
        border-right: 10px solid transparent;
        border-top: 10px solid currentcolor;
        opacity: 0.8;
      }

      @keyframes bubble-appear {
        0% {
          opacity: 0;
          transform: scale(0.5) translateY(20px);
        }
        100% {
          opacity: 1;
          transform: scale(1) translateY(0);
        }
      }

      @keyframes bubble-float {
        0%,
        100% {
          transform: translateY(0);
        }
        50% {
          transform: translateY(-10px);
        }
      }

      .wall-bubble.floating {
        animation:
          bubble-appear 0.5s ease-out forwards,
          bubble-float 4s ease-in-out infinite 0.5s;
      }

      /* æ°”æ³¡é¢œè‰²ä¸»é¢˜ */
      .wall-bubble.theme-cyan {
        background: linear-gradient(135deg, #00f5d4 0%, #00b4d8 100%);
        color: #000;
      }
      .wall-bubble.theme-cyan::before {
        border-top-color: #00b4d8;
      }

      .wall-bubble.theme-pink {
        background: linear-gradient(135deg, #ff6b9d 0%, #c44569 100%);
        color: #fff;
      }
      .wall-bubble.theme-pink::before {
        border-top-color: #c44569;
      }

      .wall-bubble.theme-yellow {
        background: linear-gradient(135deg, #ffd93d 0%, #ff9500 100%);
        color: #000;
      }
      .wall-bubble.theme-yellow::before {
        border-top-color: #ff9500;
      }

      .wall-bubble.theme-purple {
        background: linear-gradient(135deg, #a855f7 0%, #7c3aed 100%);
        color: #fff;
      }
      .wall-bubble.theme-purple::before {
        border-top-color: #7c3aed;
      }

      .wall-bubble.theme-blue {
        background: linear-gradient(135deg, #38bdf8 0%, #0284c7 100%);
        color: #fff;
      }
      .wall-bubble.theme-blue::before {
        border-top-color: #0284c7;
      }

      .wall-bubble.theme-green {
        background: linear-gradient(135deg, #4ade80 0%, #16a34a 100%);
        color: #000;
      }
      .wall-bubble.theme-green::before {
        border-top-color: #16a34a;
      }

      /* ç•™è¨€å¢™ç©ºçŠ¶æ€ */
      .wall-empty {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-secondary);
      }

      .wall-empty-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .wall-empty-text {
        font-size: 24px;
        margin-bottom: 10px;
      }

      .wall-empty-hint {
        font-size: 16px;
        opacity: 0.7;
      }

      /* æ§åˆ¶é¢æ¿ */
      .control-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(to top, var(--bg-secondary) 0%, transparent 100%);
        padding: 60px 20px 20px;
        z-index: 100;
        transition: transform 0.3s ease;
      }

      .control-panel.hidden {
        transform: translateY(100%);
      }

      .panel-inner {
        max-width: 600px;
        margin: 0 auto;
      }

      .input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      #danmaku-input {
        flex: 1;
        padding: 14px 18px;
        font-size: 16px;
        background: var(--bg-card);
        border: 2px solid transparent;
        border-radius: 12px;
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s;
      }

      #danmaku-input:focus {
        border-color: var(--accent);
      }

      #danmaku-input::placeholder {
        color: var(--text-secondary);
      }

      .btn {
        padding: 14px 24px;
        font-size: 16px;
        font-weight: 600;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .btn-primary {
        background: var(--accent);
        color: var(--bg-primary);
      }

      .btn-primary:hover {
        box-shadow: 0 0 20px var(--accent-glow);
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: var(--bg-card);
        color: var(--text-primary);
      }

      .btn-secondary:hover {
        background: #252530;
      }

      .options-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }

      .color-picker {
        display: flex;
        gap: 6px;
      }

      .color-btn {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
      }

      .color-btn:hover {
        transform: scale(1.1);
      }

      .color-btn.active {
        border-color: var(--text-primary);
        box-shadow: 0 0 10px currentcolor;
      }

      .size-select {
        padding: 8px 12px;
        background: var(--bg-card);
        border: none;
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
      }

      /* é¡¶éƒ¨å·¥å…·æ  */
      .top-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(to bottom, var(--bg-secondary) 0%, transparent 100%);
        z-index: 100;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 18px;
        font-weight: 700;
      }

      .logo-icon {
        font-size: 24px;
      }

      .top-actions {
        display: flex;
        gap: 10px;
      }

      .btn-icon {
        width: 44px;
        height: 44px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
      }

      /* æ¨¡å¼åˆ‡æ¢ */
      .mode-tabs {
        display: flex;
        background: var(--bg-card);
        border-radius: 10px;
        padding: 4px;
      }

      .mode-tab {
        padding: 8px 16px;
        font-size: 14px;
        font-weight: 500;
        background: transparent;
        border: none;
        border-radius: 8px;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .mode-tab.active {
        background: var(--accent);
        color: var(--bg-primary);
      }

      /* äºŒç»´ç å¼¹çª— */
      .qr-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s;
      }

      .qr-modal.show {
        opacity: 1;
        visibility: visible;
      }

      .qr-content {
        background: var(--bg-card);
        border-radius: 20px;
        padding: 30px;
        text-align: center;
        max-width: 360px;
        width: 90%;
      }

      .qr-content h3 {
        margin-bottom: 10px;
        font-size: 20px;
      }

      .qr-content p {
        color: var(--text-secondary);
        font-size: 14px;
        margin-bottom: 20px;
      }

      #qrcode {
        background: white;
        padding: 15px;
        border-radius: 12px;
        display: inline-block;
        margin-bottom: 20px;
      }

      #qrcode canvas {
        display: block;
      }

      .room-info {
        background: var(--bg-secondary);
        padding: 10px 15px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 14px;
        margin-bottom: 15px;
        word-break: break-all;
      }

      .room-info .label {
        color: var(--text-secondary);
        font-size: 12px;
        display: block;
        margin-bottom: 5px;
      }

      .connection-status {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 13px;
        color: var(--text-secondary);
        margin-top: 15px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #ef4444;
      }

      .status-dot.connected {
        background: #22c55e;
      }

      /* æŠ•å±æ¨¡å¼æç¤º */
      .screen-mode-hint {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        color: var(--text-secondary);
        pointer-events: none;
        opacity: 0.5;
        transition: opacity 0.3s;
      }

      .screen-mode-hint.has-danmaku {
        opacity: 0;
      }

      .screen-mode-hint .icon {
        font-size: 64px;
        margin-bottom: 20px;
      }

      .screen-mode-hint h2 {
        font-size: 24px;
        margin-bottom: 10px;
        color: var(--text-primary);
      }

      .screen-mode-hint p {
        font-size: 16px;
      }

      /* ç»Ÿè®¡ä¿¡æ¯ */
      .stats {
        position: fixed;
        top: 70px;
        right: 20px;
        background: var(--bg-card);
        padding: 10px 16px;
        border-radius: 10px;
        font-size: 14px;
        color: var(--text-secondary);
        z-index: 50;
      }

      .stats span {
        color: var(--accent);
        font-weight: 600;
      }

      /* å¿«æ·é”®æç¤º */
      .shortcuts-hint {
        position: fixed;
        bottom: 120px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--bg-card);
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 12px;
        color: var(--text-secondary);
        opacity: 0.7;
        z-index: 50;
      }

      .shortcuts-hint kbd {
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
        margin: 0 2px;
      }

      /* å…¨å±æŠ•å±æ¨¡å¼ */
      body.screen-mode .control-panel,
      body.screen-mode .top-bar,
      body.screen-mode .stats,
      body.screen-mode .shortcuts-hint {
        opacity: 0;
        pointer-events: none;
      }

      body.screen-mode:hover .top-bar {
        opacity: 1;
        pointer-events: auto;
      }

      /* è¿”å›é“¾æ¥ */
      .back-link {
        position: fixed;
        top: 15px;
        left: 20px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: 14px;
        z-index: 200;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: color 0.2s;
      }

      .back-link:hover {
        color: var(--accent);
      }

      body.screen-mode .back-link {
        opacity: 0;
      }

      body.screen-mode:hover .back-link {
        opacity: 1;
      }

      /* æ‰‹æœºç«¯å‘é€æ¨¡å¼ */
      body.sender-mode {
        background: var(--bg-secondary);
      }

      body.sender-mode .top-bar,
      body.sender-mode .stats,
      body.sender-mode .shortcuts-hint,
      body.sender-mode .screen-mode-hint,
      body.sender-mode .back-link {
        display: none;
      }

      body.sender-mode .control-panel {
        position: fixed;
        top: 0;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background: var(--bg-secondary);
      }

      body.sender-mode .panel-inner {
        max-width: 100%;
      }

      .sender-header {
        display: none;
        text-align: center;
        margin-bottom: 30px;
      }

      body.sender-mode .sender-header {
        display: block;
      }

      .sender-header h2 {
        font-size: 24px;
        margin-bottom: 8px;
      }

      .sender-header p {
        color: var(--text-secondary);
        font-size: 14px;
      }

      /* å“åº”å¼ */
      @media (max-width: 600px) {
        .danmaku-item {
          font-size: 24px;
        }

        .top-bar {
          flex-direction: column;
          gap: 10px;
          padding: 10px;
        }

        .shortcuts-hint {
          display: none;
        }

        .qr-content {
          padding: 20px;
        }
      }

      .breadcrumb {
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
      }
      .breadcrumb a {
        color: #667eea;
        text-decoration: none;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }
      .breadcrumb span {
        color: #999;
        margin: 0 5px;
      }
      .visually-hidden {
        position: absolute;

        width: 1px;

        height: 1px;

        margin: -1px;

        padding: 0;

        overflow: hidden;

        clip: rect(0, 0, 0, 0);

        white-space: nowrap;

        border: 0;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="åˆ‡æ¢ä¸»é¢˜">
      <span id="theme-icon">ğŸŒ™</span>
    </button>

    <nav class="breadcrumb">
      <a href="../../index.html">é¦–é¡µ</a>
      <span>â€º</span>
      è¯¾å ‚å¼¹å¹•
    </nav>
    <!-- å¼¹å¹•èˆå° -->
    <div id="danmaku-stage"></div>

    <!-- ç•™è¨€å¢™ -->
    <div id="message-wall">
      <div class="wall-container" id="wallContainer">
        <div class="wall-empty" id="wallEmpty">
          <div class="wall-empty-icon">ğŸ’­</div>
          <div class="wall-empty-text">ç­‰å¾…ç•™è¨€...</div>
          <div class="wall-empty-hint">å‘é€çš„æ¶ˆæ¯å°†ä»¥æ°”æ³¡å½¢å¼æ°¸ä¹…å±•ç¤ºåœ¨è¿™é‡Œ</div>
        </div>
      </div>
    </div>

    <!-- æŠ•å±æ¨¡å¼æç¤º -->
    <div class="screen-mode-hint" id="screenHint">
      <div class="icon">ğŸ“º</div>
      <h2>ç­‰å¾…å¼¹å¹•...</h2>
      <p>ç‚¹å‡»å³ä¸Šè§’äºŒç»´ç æŒ‰é’®ï¼Œæ‰«ç å‘é€å¼¹å¹•</p>
    </div>

    <!-- ç»Ÿè®¡ä¿¡æ¯ -->
    <div class="stats">
      å¼¹å¹•:
      <span id="danmakuCount">0</span>
      | åœ¨çº¿:
      <span id="onlineCount">1</span>
    </div>

    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="top-bar">
      <div class="logo">
        <span class="logo-icon">ğŸ’¬</span>
        <span>è¯¾å ‚å¼¹å¹•</span>
      </div>

      <div class="mode-tabs">
        <button class="mode-tab active" data-mode="normal">å¼¹å¹•æ¨¡å¼</button>
        <button class="mode-tab" data-mode="wall">ç•™è¨€å¢™</button>
        <button class="mode-tab" data-mode="screen">æŠ•å±æ¨¡å¼</button>
      </div>

      <div class="top-actions">
        <button class="btn btn-secondary btn-icon" id="qrBtn" title="æ‰«ç å‘å¼¹å¹•">ğŸ“±</button>
        <button class="btn btn-secondary btn-icon" id="clearBtn" title="æ¸…ç©ºå¼¹å¹•">ğŸ—‘ï¸</button>
        <button class="btn btn-secondary btn-icon" id="fullscreenBtn" title="å…¨å±">â›¶</button>
      </div>
    </div>

    <!-- å¿«æ·é”®æç¤º -->
    <div class="shortcuts-hint">
      <kbd>Enter</kbd>
      å‘é€ |
      <kbd>F</kbd>
      å…¨å± |
      <kbd>Q</kbd>
      äºŒç»´ç 
    </div>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="control-panel" id="controlPanel">
      <div class="panel-inner">
        <div class="sender-header">
          <h2>ğŸ“± å‘é€å¼¹å¹•</h2>
          <p id="senderRoomInfo">æˆ¿é—´å·: ---</p>
        </div>

        <div class="input-row">
          <input
            type="text"
            id="danmaku-input"
            placeholder="è¾“å…¥å¼¹å¹•å†…å®¹..."
            maxlength="50"
            autocomplete="off"
          />
          <button class="btn btn-primary" id="sendBtn">å‘é€</button>
        </div>

        <div class="options-row">
          <div class="color-picker" id="colorPicker">
            <button class="color-btn active" style="background: #fff" data-color="#ffffff"></button>
            <button class="color-btn" style="background: #00f5d4" data-color="#00f5d4"></button>
            <button class="color-btn" style="background: #fee440" data-color="#fee440"></button>
            <button class="color-btn" style="background: #f72585" data-color="#f72585"></button>
            <button class="color-btn" style="background: #4cc9f0" data-color="#4cc9f0"></button>
            <button class="color-btn" style="background: #7209b7" data-color="#7209b7"></button>
          </div>

          <select class="size-select" id="sizeSelect">
            <option value="24">å°å·</option>
            <option value="32" selected>ä¸­å·</option>
            <option value="48">å¤§å·</option>
          </select>
        </div>
      </div>
    </div>

    <!-- äºŒç»´ç å¼¹çª— -->
    <div class="qr-modal" id="qrModal">
      <div class="qr-content">
        <h3>ğŸ“± æ‰«ç å‘å¼¹å¹•</h3>
        <p>ç”¨æ‰‹æœºæ‰«æäºŒç»´ç ï¼Œå³å¯å‘é€å¼¹å¹•åˆ°å¤§å±</p>
        <div id="qrcode"></div>
        <div class="room-info">
          <span class="label">æˆ¿é—´å·</span>
          <span id="roomId">---</span>
        </div>
        <button class="btn btn-secondary" id="closeQrBtn" style="width: 100%">å…³é—­</button>
        <div class="connection-status">
          <span class="status-dot" id="statusDot"></span>
          <span id="statusText">è¿æ¥ä¸­...</span>
        </div>
      </div>
    </div>

    <script>
      (function () {
        "use strict";

        // ========== é…ç½® ==========
        // ä½¿ç”¨ Supabase å…¬å…±é¡¹ç›®çš„ Realtimeï¼ˆåŒ¿åè®¿é—®ï¼‰
        // è¿™æ˜¯ä¸€ä¸ªå…¬å¼€çš„æ¼”ç¤ºç”¨ Supabase é¡¹ç›®
        var SUPABASE_URL = "https://xyzcompany.supabase.co";
        var SUPABASE_ANON_KEY = "public-anon-key";

        // ========== çŠ¶æ€ ==========
        var state = {
          color: "#ffffff",
          size: 32,
          speed: 8,
          count: 0,
          mode: "normal",
          tracks: [],
          trackCount: 0,
          roomId: null,
          isSender: false,
          connected: false,
          onlineCount: 1
        };

        // ========== DOM å…ƒç´  ==========
        var stage = document.getElementById("danmaku-stage");
        var input = document.getElementById("danmaku-input");
        var sendBtn = document.getElementById("sendBtn");
        var clearBtn = document.getElementById("clearBtn");
        var fullscreenBtn = document.getElementById("fullscreenBtn");
        var qrBtn = document.getElementById("qrBtn");
        var colorPicker = document.getElementById("colorPicker");
        var sizeSelect = document.getElementById("sizeSelect");
        var controlPanel = document.getElementById("controlPanel");
        var countDisplay = document.getElementById("danmakuCount");
        var onlineDisplay = document.getElementById("onlineCount");
        var screenHint = document.getElementById("screenHint");
        var modeTabs = document.querySelectorAll(".mode-tab");
        var qrModal = document.getElementById("qrModal");
        var closeQrBtn = document.getElementById("closeQrBtn");
        var roomIdDisplay = document.getElementById("roomId");
        var statusDot = document.getElementById("statusDot");
        var statusText = document.getElementById("statusText");
        var senderRoomInfo = document.getElementById("senderRoomInfo");
        var wallContainer = document.getElementById("wallContainer");
        var wallEmpty = document.getElementById("wallEmpty");

        // ç•™è¨€å¢™æ¶ˆæ¯å­˜å‚¨
        var wallMessages = [];

        // ========== æˆ¿é—´ ID ç”Ÿæˆ ==========
        function generateRoomId() {
          return Math.random().toString(36).substring(2, 8).toUpperCase();
        }

        function getRoomFromUrl() {
          var params = new URLSearchParams(window.location.search);
          return params.get("room");
        }

        function setRoomInUrl(roomId) {
          var url = new URL(window.location.href);
          url.searchParams.set("room", roomId);
          window.history.replaceState({}, "", url);
        }

        // ========== BroadcastChannelï¼ˆåŒè®¾å¤‡åŒæ­¥ï¼‰==========
        var localChannel = null;
        try {
          localChannel = new BroadcastChannel("classroom-danmaku-" + state.roomId);
        } catch (err) {}

        function initLocalChannel() {
          if (localChannel) {
            localChannel.close();
          }
          try {
            localChannel = new BroadcastChannel("classroom-danmaku-" + state.roomId);
            localChannel.onmessage = function (e) {
              if (e.data && e.data.type === "danmaku") {
                renderDanmaku(e.data);
              }
            };
          } catch (err) {}
        }

        // ========== MQTT è·¨è®¾å¤‡é€šä¿¡ ==========
        // ä½¿ç”¨å…è´¹çš„ HiveMQ å…¬å…± MQTT Broker
        // https://www.hivemq.com/mqtt/public-mqtt-broker/
        // MQTT topic å¤©ç„¶æ”¯æŒæˆ¿é—´éš”ç¦»
        var MQTT_BROKER = "wss://broker.hivemq.com:8884/mqtt";
        var mqttClient = null;
        var mqttReconnectTimer = null;

        function connectMQTT() {
          if (mqttClient && mqttClient.connected) return;

          try {
            var clientId = "danmaku_" + Math.random().toString(36).substring(2, 10);
            var topic = "classroom-danmaku/" + state.roomId;

            mqttClient = mqtt.connect(MQTT_BROKER, {
              clientId: clientId,
              clean: true,
              connectTimeout: 10000,
              reconnectPeriod: 3000
            });

            mqttClient.on("connect", function () {
              state.connected = true;
              updateConnectionStatus();
              console.log("MQTT connected, room:", state.roomId);

              // è®¢é˜…æˆ¿é—´ topic
              mqttClient.subscribe(topic, function (err) {
                if (!err) {
                  console.log("Subscribed to:", topic);
                  // å‘é€ä¸Šçº¿é€šçŸ¥
                  mqttClient.publish(
                    topic,
                    JSON.stringify({
                      type: "join",
                      roomId: state.roomId,
                      timestamp: Date.now()
                    })
                  );
                }
              });
            });

            mqttClient.on("message", function (receivedTopic, message) {
              try {
                var data = JSON.parse(message.toString());

                if (data.type === "danmaku") {
                  renderDanmaku(data);
                  // åŒæ­¥åˆ°æœ¬åœ°å…¶ä»–æ ‡ç­¾é¡µ
                  if (localChannel) {
                    localChannel.postMessage(data);
                  }
                } else if (data.type === "join" || data.type === "leave") {
                  // ç®€å•çš„åœ¨çº¿äººæ•°ä¼°ç®—
                  state.onlineCount = Math.max(
                    1,
                    state.onlineCount + (data.type === "join" ? 1 : -1)
                  );
                  onlineDisplay.textContent = state.onlineCount;
                }
              } catch (err) {
                console.error("Message parse error:", err);
              }
            });

            mqttClient.on("close", function () {
              state.connected = false;
              updateConnectionStatus();
            });

            mqttClient.on("error", function (err) {
              console.error("MQTT error:", err);
              state.connected = false;
              updateConnectionStatus();
            });

            mqttClient.on("offline", function () {
              state.connected = false;
              updateConnectionStatus();
            });
          } catch (err) {
            console.error("MQTT connection error:", err);
            state.connected = false;
            updateConnectionStatus();
          }
        }

        function updateConnectionStatus() {
          if (state.connected) {
            statusDot.classList.add("connected");
            statusText.textContent = "å·²è¿æ¥ - æˆ¿é—´ " + state.roomId;
          } else {
            statusDot.classList.remove("connected");
            statusText.textContent = "è¿æ¥ä¸­...";
          }
        }

        // ========== è®¡ç®—è½¨é“ ==========
        function calculateTracks() {
          var trackHeight = 50;
          state.trackCount = Math.floor((window.innerHeight * 0.7) / trackHeight);
          state.tracks = new Array(state.trackCount).fill(0);
        }

        function getAvailableTrack() {
          var now = Date.now();
          var minTime = Infinity;
          var bestTrack = 0;

          for (var i = 0; i < state.trackCount; i++) {
            if (state.tracks[i] <= now) {
              return i;
            }
            if (state.tracks[i] < minTime) {
              minTime = state.tracks[i];
              bestTrack = i;
            }
          }
          return bestTrack;
        }

        // ========== é¢œè‰²åˆ°ä¸»é¢˜æ˜ å°„ ==========
        function getWallTheme(color) {
          var themes = {
            "#ffffff": "cyan",
            "#00f5d4": "cyan",
            "#ffd93d": "yellow",
            "#ff6b9d": "pink",
            "#38bdf8": "blue",
            "#a855f7": "purple"
          };
          return (
            themes[color] ||
            ["cyan", "pink", "yellow", "purple", "blue", "green"][Math.floor(Math.random() * 6)]
          );
        }

        // ========== æ¸²æŸ“ç•™è¨€å¢™æ°”æ³¡ ==========
        function renderWallBubble(data) {
          var text = data.text || "";
          var color = data.color || "#ffffff";

          if (!text.trim()) return;

          // éšè—ç©ºçŠ¶æ€æç¤º
          if (wallEmpty) {
            wallEmpty.style.display = "none";
          }

          var bubble = document.createElement("div");
          bubble.className = "wall-bubble floating theme-" + getWallTheme(color);
          bubble.textContent = text;

          // éšæœºä½ç½®ï¼Œé¿å…é‡å 
          var containerRect = wallContainer.getBoundingClientRect();
          var maxX = containerRect.width - 300;
          var maxY = containerRect.height - 100;

          // å°è¯•æ‰¾ä¸€ä¸ªä¸é‡å çš„ä½ç½®
          var attempts = 0;
          var x, y;
          do {
            x = Math.random() * maxX;
            y = Math.random() * maxY;
            attempts++;
          } while (attempts < 10 && isOverlapping(x, y, 280, 60));

          bubble.style.left = x + "px";
          bubble.style.top = y + "px";

          // éšæœºå»¶è¿Ÿæµ®åŠ¨åŠ¨ç”»
          bubble.style.animationDelay = "0s, " + Math.random() * 2 + "s";

          wallContainer.appendChild(bubble);

          // å­˜å‚¨æ¶ˆæ¯
          wallMessages.push({
            text: text,
            color: color,
            x: x,
            y: y,
            element: bubble
          });

          // é™åˆ¶æœ€å¤§æ¶ˆæ¯æ•°
          if (wallMessages.length > 50) {
            var oldest = wallMessages.shift();
            if (oldest.element && oldest.element.parentNode) {
              oldest.element.style.opacity = "0";
              oldest.element.style.transform = "scale(0.5)";
              setTimeout(function () {
                if (oldest.element.parentNode) {
                  oldest.element.remove();
                }
              }, 500);
            }
          }

          state.count++;
          countDisplay.textContent = state.count;
        }

        // æ£€æŸ¥ä½ç½®æ˜¯å¦é‡å 
        function isOverlapping(x, y, width, height) {
          for (var i = 0; i < wallMessages.length; i++) {
            var msg = wallMessages[i];
            if (Math.abs(msg.x - x) < width && Math.abs(msg.y - y) < height) {
              return true;
            }
          }
          return false;
        }

        // ========== æ¸²æŸ“å¼¹å¹• ==========
        function renderDanmaku(data) {
          var text = data.text || "";
          var color = data.color || "#ffffff";
          var size = data.size || 32;
          var speed = data.speed || 8;

          if (!text.trim()) return;

          // å‘é€æ¨¡å¼ä¸æ¸²æŸ“
          if (state.isSender) return;

          // ç•™è¨€å¢™æ¨¡å¼ä½¿ç”¨æ°”æ³¡æ¸²æŸ“
          if (state.mode === "wall") {
            renderWallBubble(data);
            return;
          }

          // å¼¹å¹•æ¨¡å¼
          var el = document.createElement("div");
          el.className = "danmaku-item";
          el.textContent = text;
          el.style.color = color;
          el.style.fontSize = size + "px";

          var track = getAvailableTrack();
          var topPos = 50 + track * 50;
          el.style.top = topPos + "px";
          el.style.right = "-100%";

          var duration = speed + text.length * 0.1;
          el.style.animationDuration = duration + "s";

          state.tracks[track] = Date.now() + duration * 0.4 * 1000;

          stage.appendChild(el);

          state.count++;
          countDisplay.textContent = state.count;

          screenHint.classList.add("has-danmaku");

          el.addEventListener("animationend", function () {
            el.remove();
          });
        }

        // ========== æ¸…ç©ºå¼¹å¹• ==========
        function clearAllDanmaku() {
          // æ¸…ç©ºå¼¹å¹•
          while (stage.firstChild) {
            stage.removeChild(stage.firstChild);
          }

          // æ¸…ç©ºç•™è¨€å¢™
          wallMessages = [];
          var bubbles = wallContainer.querySelectorAll(".wall-bubble");
          bubbles.forEach(function (b) {
            b.remove();
          });
          if (wallEmpty) {
            wallEmpty.style.display = "block";
          }

          state.count = 0;
          countDisplay.textContent = "0";
          screenHint.classList.remove("has-danmaku");
        }

        // ========== å‘é€å¼¹å¹• ==========
        function sendDanmaku() {
          var text = input.value.trim();
          if (!text) return;

          var data = {
            type: "danmaku",
            roomId: state.roomId,
            text: text,
            color: state.color,
            size: state.size,
            speed: state.speed,
            timestamp: Date.now()
          };

          // æœ¬åœ°æ¸²æŸ“ï¼ˆéå‘é€æ¨¡å¼ï¼‰
          if (!state.isSender) {
            renderDanmaku(data);
          }

          // é€šè¿‡ MQTT å‘é€
          if (mqttClient && mqttClient.connected) {
            var topic = "classroom-danmaku/" + state.roomId;
            mqttClient.publish(topic, JSON.stringify(data));
          }

          // æœ¬åœ°å¹¿æ’­
          if (localChannel) {
            localChannel.postMessage(data);
          }

          input.value = "";
          input.focus();

          // å‘é€æˆåŠŸåé¦ˆ
          if (state.isSender) {
            sendBtn.textContent = "å·²å‘é€ âœ“";
            setTimeout(function () {
              sendBtn.textContent = "å‘é€";
            }, 1000);
          }
        }

        // ========== ç”ŸæˆäºŒç»´ç  ==========
        var qrInstance = null;

        function showQrCode() {
          var qrContainer = document.getElementById("qrcode");
          qrContainer.innerHTML = "";

          var senderUrl =
            window.location.origin +
            window.location.pathname +
            "?room=" +
            state.roomId +
            "&mode=sender";

          // ä½¿ç”¨ qrcodejs åº“
          qrInstance = new QRCode(qrContainer, {
            text: senderUrl,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.M
          });

          roomIdDisplay.textContent = state.roomId;
          qrModal.classList.add("show");
        }

        function hideQrCode() {
          qrModal.classList.remove("show");
        }

        // ========== äº‹ä»¶ç»‘å®š ==========
        sendBtn.addEventListener("click", sendDanmaku);

        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            sendDanmaku();
          }
        });

        colorPicker.addEventListener("click", function (e) {
          var btn = e.target.closest(".color-btn");
          if (!btn) return;

          colorPicker.querySelectorAll(".color-btn").forEach(function (b) {
            b.classList.remove("active");
          });
          btn.classList.add("active");
          state.color = btn.dataset.color;
        });

        sizeSelect.addEventListener("change", function () {
          state.size = parseInt(this.value, 10);
        });

        clearBtn.addEventListener("click", clearAllDanmaku);

        qrBtn.addEventListener("click", showQrCode);
        closeQrBtn.addEventListener("click", hideQrCode);

        qrModal.addEventListener("click", function (e) {
          if (e.target === qrModal) {
            hideQrCode();
          }
        });

        fullscreenBtn.addEventListener("click", function () {
          if (!document.fullscreenElement) {
            document.documentElement.requestFullscreen().catch(function () {});
          } else {
            document.exitFullscreen();
          }
        });

        modeTabs.forEach(function (tab) {
          tab.addEventListener("click", function () {
            modeTabs.forEach(function (t) {
              t.classList.remove("active");
            });
            this.classList.add("active");
            state.mode = this.dataset.mode;

            // æ¸…é™¤æ‰€æœ‰æ¨¡å¼ç±»
            document.body.classList.remove("screen-mode", "wall-mode");

            if (state.mode === "screen") {
              document.body.classList.add("screen-mode");
              controlPanel.classList.add("hidden");
            } else if (state.mode === "wall") {
              document.body.classList.add("wall-mode");
              controlPanel.classList.remove("hidden");
            } else {
              controlPanel.classList.remove("hidden");
            }
          });
        });

        document.addEventListener("keydown", function (e) {
          if (state.isSender) return;

          if (e.key === "f" || e.key === "F") {
            if (document.activeElement !== input) {
              e.preventDefault();
              fullscreenBtn.click();
            }
          }

          if (e.key === "q" || e.key === "Q") {
            if (document.activeElement !== input) {
              e.preventDefault();
              if (qrModal.classList.contains("show")) {
                hideQrCode();
              } else {
                showQrCode();
              }
            }
          }

          if (e.key === "Escape") {
            if (qrModal.classList.contains("show")) {
              hideQrCode();
            } else if (state.mode === "screen") {
              modeTabs[0].click();
            }
          }
        });

        window.addEventListener("resize", calculateTracks);

        // ========== åˆå§‹åŒ– ==========
        function init() {
          // æ£€æŸ¥ URL å‚æ•°
          var urlRoom = getRoomFromUrl();
          var urlParams = new URLSearchParams(window.location.search);
          var isSenderMode = urlParams.get("mode") === "sender";

          if (urlRoom) {
            state.roomId = urlRoom;
          } else {
            state.roomId = generateRoomId();
            setRoomInUrl(state.roomId);
          }

          state.isSender = isSenderMode;

          // åˆå§‹åŒ–æœ¬åœ°é¢‘é“
          initLocalChannel();

          // è¿æ¥ MQTT
          connectMQTT();

          // è®¡ç®—å¼¹å¹•è½¨é“
          calculateTracks();

          if (state.isSender) {
            // å‘é€æ¨¡å¼
            document.body.classList.add("sender-mode");
            senderRoomInfo.textContent = "æˆ¿é—´å·: " + state.roomId;
          } else {
            // æ˜¾ç¤ºæ¨¡å¼
            input.focus();

            // æ¬¢è¿å¼¹å¹•
            setTimeout(function () {
              renderDanmaku({
                text: "æ¬¢è¿ä½¿ç”¨è¯¾å ‚å¼¹å¹•ï¼ç‚¹å‡»ğŸ“±æ‰«ç å‘å¼¹å¹•",
                color: "#00f5d4",
                size: 32,
                speed: 10
              });
            }, 1000);
          }
        }

        init();
      })();

      // Theme toggle
      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        html.setAttribute("data-theme", newTheme);
        document.getElementById("theme-icon").textContent = newTheme === "light" ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", newTheme);
      }

      // Load saved theme
      const savedTheme = localStorage.getItem("theme") || "dark";
      if (savedTheme === "light") {
        document.documentElement.setAttribute("data-theme", "light");
        document.getElementById("theme-icon").textContent = "â˜€ï¸";
      }
    </script>
  </body>
</html>

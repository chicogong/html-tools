<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SVG æ¸²æŸ“å™¨ - WebUtils</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="å°† SVG ä»£ç æ¸²æŸ“ä¸º PNG/JPEG å›¾ç‰‡" />
    <meta name="keywords" content="svg æ¸²æŸ“ png jpeg è½¬æ¢" />
    <meta name="author" content="WebUtils" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://tools.realtime-ai.chat/tools/media/svg-render.html" />

    <!-- Open Graph -->
    <meta property="og:title" content="SVG æ¸²æŸ“å™¨ - WebUtils" />
    <meta property="og:description" content="å°† SVG ä»£ç æ¸²æŸ“ä¸º PNG/JPEG å›¾ç‰‡" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://tools.realtime-ai.chat/tools/media/svg-render.html" />
    <meta property="og:site_name" content="WebUtils" />
    <meta property="og:locale" content="zh_CN" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="SVG æ¸²æŸ“å™¨ - WebUtils" />
    <meta name="twitter:description" content="å°† SVG ä»£ç æ¸²æŸ“ä¸º PNG/JPEG å›¾ç‰‡" />
    <!-- OG Image -->
    <meta property="og:image" content="https://tools.realtime-ai.chat/social-preview.png" />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="640" />
    <meta property="og:image:type" content="image/png" />
    <meta name="twitter:image" content="https://tools.realtime-ai.chat/social-preview.png" />

    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      [data-theme="light"] {
        --bg-deep: #fafafa;
        --bg-surface: #fff;
        --bg-card: #fff;
        --bg-hover: #f5f5f5;
        --text-primary: #1a1a1a;
        --text-secondary: #666;
        --text-muted: #999;
        --border-subtle: #e5e5e5;
      }

      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid rgb(255, 255, 255, 0.2);
        background: rgb(255, 255, 255, 0.1);
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 100;
        transition: all 0.2s;
      }

      .theme-toggle:hover {
        transform: scale(1.1);
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        min-height: 100vh;
        color: #e8e8e8;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, #9b59b6, #3498db);
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .subtitle {
        color: #888;
        font-size: 0.95rem;
      }

      .main-content {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (width <= 900px) {
        .main-content {
          grid-template-columns: 1fr;
        }
      }

      .panel {
        background: rgb(255, 255, 255, 0.05);
        border-radius: 12px;
        padding: 20px;
        border: 1px solid rgb(255, 255, 255, 0.1);
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .panel-title {
        font-size: 1rem;
        color: #9b59b6;
      }

      textarea {
        width: 100%;
        height: 300px;
        background: rgb(0, 0, 0, 0.3);
        border: 1px solid rgb(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 15px;
        font-family: Monaco, Consolas, monospace;
        font-size: 13px;
        color: #e8e8e8;
        resize: vertical;
        line-height: 1.5;
      }

      textarea:focus {
        outline: none;
        border-color: #9b59b6;
      }

      .preview-container {
        background: #fff;
        border-radius: 8px;
        min-height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        position: relative;
      }

      .preview-container.checkerboard {
        background-image:
          linear-gradient(45deg, #ccc 25%, transparent 25%),
          linear-gradient(-45deg, #ccc 25%, transparent 25%),
          linear-gradient(45deg, transparent 75%, #ccc 75%),
          linear-gradient(-45deg, transparent 75%, #ccc 75%);
        background-size: 20px 20px;
        background-position:
          0 0,
          0 10px,
          10px -10px,
          -10px 0;
      }

      #preview {
        max-width: 100%;
        max-height: 300px;
      }

      .controls {
        margin-top: 20px;
      }

      .control-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .control-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .control-group label {
        font-size: 0.85rem;
        color: #888;
      }

      input[type="number"],
      select {
        background: rgb(0, 0, 0, 0.3);
        border: 1px solid rgb(255, 255, 255, 0.1);
        border-radius: 6px;
        padding: 8px 12px;
        color: #e8e8e8;
        font-size: 0.9rem;
        width: 120px;
      }

      input[type="number"]:focus,
      select:focus {
        outline: none;
        border-color: #9b59b6;
      }

      input[type="color"] {
        width: 50px;
        height: 36px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .btn-row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #9b59b6, #8e44ad);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgb(155, 89, 182, 0.4);
      }

      .btn-secondary {
        background: rgb(255, 255, 255, 0.1);
        color: #e8e8e8;
        border: 1px solid rgb(255, 255, 255, 0.2);
      }

      .btn-secondary:hover {
        background: rgb(255, 255, 255, 0.15);
      }

      .btn-success {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        color: white;
      }

      .btn-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 20px rgb(46, 204, 113, 0.4);
      }

      .examples {
        margin-top: 20px;
      }

      .example-chips {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .chip {
        padding: 6px 12px;
        background: rgb(155, 89, 182, 0.2);
        border: 1px solid rgb(155, 89, 182, 0.3);
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .chip:hover {
        background: rgb(155, 89, 182, 0.3);
      }

      .error {
        color: #e74c3c;
        padding: 10px;
        text-align: center;
        font-size: 0.9rem;
      }

      .info {
        margin-top: 15px;
        padding: 10px;
        background: rgb(52, 152, 219, 0.1);
        border-radius: 8px;
        font-size: 0.85rem;
        color: #888;
      }

      .info span {
        color: #3498db;
      }

      footer {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid rgb(255, 255, 255, 0.1);
        color: #666;
        font-size: 0.85rem;
      }

      footer a {
        color: #9b59b6;
        text-decoration: none;
      }

      footer a:hover {
        text-decoration: underline;
      }

      /* Canvas for export - hidden */
      #exportCanvas {
        display: none;
      }

      .breadcrumb {
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
      }
      .breadcrumb a {
        color: #667eea;
        text-decoration: none;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }
      .breadcrumb span {
        color: #999;
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <nav class="breadcrumb">
      <a href="../../index.html">é¦–é¡µ</a>
      <span>â€º</span>
      SVG æ¸²æŸ“å™¨
    </nav>
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ™</button>
    <div class="container">
      <header>
        <h1>SVG æ¸²æŸ“å™¨</h1>
        <p class="subtitle">å°† SVG ä»£ç æ¸²æŸ“ä¸º PNG/JPEG å›¾ç‰‡ï¼Œæ”¯æŒè‡ªå®šä¹‰å°ºå¯¸å’ŒèƒŒæ™¯</p>
      </header>

      <div class="main-content">
        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">SVG ä»£ç </span>
            <button class="btn btn-secondary" onclick="clearInput()">æ¸…ç©º</button>
          </div>
          <textarea
            id="svgInput"
            placeholder='åœ¨æ­¤ç²˜è´´ SVG ä»£ç ...&#10;&#10;ä¾‹å¦‚:&#10;<svg width="100" height="100">&#10;  <circle cx="50" cy="50" r="40" fill="#9b59b6"/>&#10;</svg>'
          ></textarea>

          <div class="examples">
            <div class="panel-title" style="margin-bottom: 10px">ç¤ºä¾‹</div>
            <div class="example-chips">
              <span class="chip" onclick="loadExample('circle')">åœ†å½¢</span>
              <span class="chip" onclick="loadExample('gradient')">æ¸å˜</span>
              <span class="chip" onclick="loadExample('star')">äº”è§’æ˜Ÿ</span>
              <span class="chip" onclick="loadExample('text')">æ–‡å­—</span>
              <span class="chip" onclick="loadExample('pattern')">å›¾æ¡ˆ</span>
            </div>
          </div>
        </div>

        <div class="panel">
          <div class="panel-header">
            <span class="panel-title">é¢„è§ˆ</span>
          </div>
          <div class="preview-container" id="previewContainer">
            <div id="preview"></div>
          </div>

          <div class="controls">
            <div class="control-row">
              <div class="control-group">
                <label>å¯¼å‡ºå®½åº¦ (px)</label>
                <input type="number" id="exportWidth" value="512" min="1" max="4096" />
              </div>
              <div class="control-group">
                <label>å¯¼å‡ºé«˜åº¦ (px)</label>
                <input type="number" id="exportHeight" value="512" min="1" max="4096" />
              </div>
              <div class="control-group">
                <label>æ ¼å¼</label>
                <select id="exportFormat">
                  <option value="png">PNG</option>
                  <option value="jpeg">JPEG</option>
                  <option value="webp">WebP</option>
                </select>
              </div>
            </div>
            <div class="control-row">
              <div class="control-group">
                <label>èƒŒæ™¯é¢œè‰²</label>
                <input type="color" id="bgColor" value="#ffffff" />
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="transparentBg" checked />
                <label for="transparentBg">é€æ˜èƒŒæ™¯ (ä»… PNG/WebP)</label>
              </div>
              <div class="checkbox-group">
                <input type="checkbox" id="showCheckerboard" checked />
                <label for="showCheckerboard">æ˜¾ç¤ºæ£‹ç›˜æ ¼</label>
              </div>
            </div>
            <div class="control-row">
              <div class="control-group">
                <label>JPEG è´¨é‡</label>
                <input type="number" id="jpegQuality" value="90" min="1" max="100" />
              </div>
            </div>
            <div class="btn-row">
              <button class="btn btn-primary" onclick="renderSVG()">æ¸²æŸ“é¢„è§ˆ</button>
              <button class="btn btn-success" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
              <button class="btn btn-secondary" onclick="copyToClipboard()">å¤åˆ¶åˆ°å‰ªè´´æ¿</button>
            </div>
          </div>

          <div class="info" id="svgInfo" style="display: none">
            åŸå§‹å°ºå¯¸:
            <span id="originalSize">-</span>
            | å¯¼å‡ºå°ºå¯¸:
            <span id="exportSize">-</span>
          </div>
        </div>
      </div>

      <footer>
        <a href="../../index.html">è¿”å›å·¥å…·åˆ—è¡¨</a>
        Â·
        <a
          href="https://github.com/chicogong/html-tools/blob/master/tools/svg-render.html"
          target="_blank"
        >
          æŸ¥çœ‹æºä»£ç 
        </a>
      </footer>
    </div>

    <canvas id="exportCanvas"></canvas>

    <script>
      const svgInput = document.getElementById("svgInput");
      const preview = document.getElementById("preview");
      const previewContainer = document.getElementById("previewContainer");
      const exportWidth = document.getElementById("exportWidth");
      const exportHeight = document.getElementById("exportHeight");
      const exportFormat = document.getElementById("exportFormat");
      const bgColor = document.getElementById("bgColor");
      const transparentBg = document.getElementById("transparentBg");
      const showCheckerboard = document.getElementById("showCheckerboard");
      const jpegQuality = document.getElementById("jpegQuality");
      const svgInfo = document.getElementById("svgInfo");
      const originalSize = document.getElementById("originalSize");
      const exportSize = document.getElementById("exportSize");
      const canvas = document.getElementById("exportCanvas");
      const ctx = canvas.getContext("2d");

      const examples = {
        circle: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <circle cx="100" cy="100" r="80" fill="#9b59b6"/>
  <circle cx="100" cy="100" r="50" fill="#3498db"/>
  <circle cx="100" cy="100" r="20" fill="#e74c3c"/>
</svg>`,
        gradient: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#9b59b6"/>
      <stop offset="100%" style="stop-color:#3498db"/>
    </linearGradient>
  </defs>
  <rect width="200" height="200" fill="url(#grad)" rx="20"/>
</svg>`,
        star: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <polygon 
    points="100,10 40,198 190,78 10,78 160,198" 
    fill="#f1c40f"
    stroke="#e67e22"
    stroke-width="3"/>
</svg>`,
        text: `<svg width="300" height="100" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="textGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#9b59b6"/>
      <stop offset="100%" style="stop-color:#e74c3c"/>
    </linearGradient>
  </defs>
  <text x="150" y="60" 
    font-family="Arial, sans-serif" 
    font-size="40" 
    font-weight="bold"
    fill="url(#textGrad)" 
    text-anchor="middle">
    SVG Text
  </text>
</svg>`,
        pattern: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <pattern id="dots" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
      <circle cx="10" cy="10" r="4" fill="#9b59b6"/>
    </pattern>
  </defs>
  <rect width="200" height="200" fill="url(#dots)"/>
  <rect x="50" y="50" width="100" height="100" fill="#3498db" opacity="0.8" rx="10"/>
</svg>`
      };

      // åŠ è½½ç¤ºä¾‹
      window.loadExample = function (name) {
        if (examples[name]) {
          svgInput.value = examples[name];
          renderSVG();
          saveState();
        }
      };

      // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
      function showError(message) {
        preview.textContent = "";
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;
        preview.appendChild(errorDiv);
        svgInfo.style.display = "none";
      }

      // æ¸²æŸ“ SVG (ä½¿ç”¨ DOMPurify è¿›è¡Œå®‰å…¨å¤„ç†)
      function renderSVG() {
        const svg = svgInput.value.trim();
        if (!svg) {
          showError("è¯·è¾“å…¥ SVG ä»£ç ");
          return;
        }

        try {
          // ä½¿ç”¨ DOMPurify æ¸…ç† SVGï¼Œåªå…è®¸ SVG ç›¸å…³æ ‡ç­¾å’Œå±æ€§
          const cleanSvg = DOMPurify.sanitize(svg, {
            USE_PROFILES: { svg: true, svgFilters: true },
            ADD_TAGS: ["use"],
            ADD_ATTR: ["xlink:href", "xmlns:xlink"]
          });

          // éªŒè¯æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ SVG
          const parser = new DOMParser();
          const doc = parser.parseFromString(cleanSvg, "image/svg+xml");
          const errorNode = doc.querySelector("parsererror");

          if (errorNode) {
            showError("SVG è§£æé”™è¯¯: " + errorNode.textContent.substring(0, 100));
            return;
          }

          const svgElement = doc.querySelector("svg");
          if (!svgElement) {
            showError("æœªæ‰¾åˆ°æœ‰æ•ˆçš„ SVG å…ƒç´ ");
            return;
          }

          // è·å–åŸå§‹å°ºå¯¸
          let width = svgElement.getAttribute("width");
          let height = svgElement.getAttribute("height");
          const viewBox = svgElement.getAttribute("viewBox");

          if (viewBox && (!width || !height)) {
            const parts = viewBox.split(/\s+|,/);
            if (parts.length === 4) {
              width = width || parts[2];
              height = height || parts[3];
            }
          }

          width = parseFloat(width) || 100;
          height = parseFloat(height) || 100;

          // æ›´æ–°å¯¼å‡ºå°ºå¯¸å»ºè®®
          if (exportWidth.value == 512 && exportHeight.value == 512) {
            const scale = Math.min(512 / width, 512 / height);
            exportWidth.value = Math.round(width * scale);
            exportHeight.value = Math.round(height * scale);
          }

          // æ˜¾ç¤ºä¿¡æ¯
          originalSize.textContent = width + " x " + height;
          exportSize.textContent = exportWidth.value + " x " + exportHeight.value;
          svgInfo.style.display = "block";

          // é¢„è§ˆ - ä½¿ç”¨æ¸…ç†åçš„ SVG
          preview.textContent = "";
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = cleanSvg;
          const previewSvg = tempDiv.firstElementChild;
          if (previewSvg) {
            previewSvg.style.maxWidth = "100%";
            previewSvg.style.maxHeight = "300px";
            preview.appendChild(previewSvg);
          }
        } catch (e) {
          showError("æ¸²æŸ“é”™è¯¯: " + e.message);
        }
      }

      // ç”Ÿæˆå›¾ç‰‡æ•°æ®
      async function generateImageData() {
        const svg = svgInput.value.trim();
        if (!svg) {
          throw new Error("è¯·è¾“å…¥ SVG ä»£ç ");
        }

        const width = parseInt(exportWidth.value) || 512;
        const height = parseInt(exportHeight.value) || 512;
        const format = exportFormat.value;
        const isTransparent = transparentBg.checked && format !== "jpeg";
        const quality = parseInt(jpegQuality.value) / 100;

        // å‡†å¤‡ SVG - ä½¿ç”¨ DOMPurify æ¸…ç†
        let svgData = DOMPurify.sanitize(svg, {
          USE_PROFILES: { svg: true, svgFilters: true },
          ADD_TAGS: ["use"],
          ADD_ATTR: ["xlink:href", "xmlns:xlink"]
        });

        // ç¡®ä¿ SVG æœ‰ xmlns
        if (!svgData.includes("xmlns")) {
          svgData = svgData.replace("<svg", '<svg xmlns="http://www.w3.org/2000/svg"');
        }

        // è®¾ç½® canvas å°ºå¯¸
        canvas.width = width;
        canvas.height = height;

        // æ¸…ç©ºå¹¶è®¾ç½®èƒŒæ™¯
        if (!isTransparent) {
          ctx.fillStyle = bgColor.value;
          ctx.fillRect(0, 0, width, height);
        } else {
          ctx.clearRect(0, 0, width, height);
        }

        // åˆ›å»ºå›¾ç‰‡
        return new Promise((resolve, reject) => {
          const img = new Image();
          const blob = new Blob([svgData], { type: "image/svg+xml;charset=utf-8" });
          const url = URL.createObjectURL(blob);

          img.onload = function () {
            // è®¡ç®—ç¼©æ”¾ä»¥ä¿æŒæ¯”ä¾‹
            const scale = Math.min(width / img.width, height / img.height);
            const scaledWidth = img.width * scale;
            const scaledHeight = img.height * scale;
            const x = (width - scaledWidth) / 2;
            const y = (height - scaledHeight) / 2;

            ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
            URL.revokeObjectURL(url);

            const mimeType =
              format === "jpeg" ? "image/jpeg" : format === "webp" ? "image/webp" : "image/png";
            const dataUrl = canvas.toDataURL(mimeType, quality);
            resolve(dataUrl);
          };

          img.onerror = function () {
            URL.revokeObjectURL(url);
            reject(new Error("SVG åŠ è½½å¤±è´¥"));
          };

          img.src = url;
        });
      }

      // ä¸‹è½½å›¾ç‰‡
      window.downloadImage = async function () {
        try {
          const dataUrl = await generateImageData();
          const format = exportFormat.value;
          const link = document.createElement("a");
          link.download = "svg-export." + format;
          link.href = dataUrl;
          link.click();
        } catch (e) {
          alert("å¯¼å‡ºå¤±è´¥: " + e.message);
        }
      };

      // å¤åˆ¶åˆ°å‰ªè´´æ¿
      window.copyToClipboard = async function () {
        try {
          const dataUrl = await generateImageData();

          // å°† dataUrl è½¬æ¢ä¸º blob
          const response = await fetch(dataUrl);
          const blob = await response.blob();

          await navigator.clipboard.write([new ClipboardItem({ [blob.type]: blob })]);

          alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        } catch (e) {
          alert("å¤åˆ¶å¤±è´¥: " + e.message);
        }
      };

      // æ¸…ç©ºè¾“å…¥
      window.clearInput = function () {
        svgInput.value = "";
        preview.textContent = "";
        svgInfo.style.display = "none";
        saveState();
      };

      // åˆ‡æ¢æ£‹ç›˜æ ¼èƒŒæ™¯
      showCheckerboard.addEventListener("change", function () {
        previewContainer.classList.toggle("checkerboard", showCheckerboard.checked);
      });

      // æ ¼å¼æ”¹å˜æ—¶æ›´æ–°é€æ˜èƒŒæ™¯é€‰é¡¹
      exportFormat.addEventListener("change", function () {
        const format = exportFormat.value;
        if (format === "jpeg") {
          transparentBg.checked = false;
          transparentBg.disabled = true;
        } else {
          transparentBg.disabled = false;
        }
      });

      // URL çŠ¶æ€æŒä¹…åŒ–
      function saveState() {
        const state = {
          svg: svgInput.value,
          width: exportWidth.value,
          height: exportHeight.value,
          format: exportFormat.value,
          bg: bgColor.value,
          transparent: transparentBg.checked,
          quality: jpegQuality.value
        };
        try {
          const hash = btoa(encodeURIComponent(JSON.stringify(state)));
          history.replaceState(null, "", "#" + hash);
        } catch (e) {
          console.error("ä¿å­˜çŠ¶æ€å¤±è´¥:", e);
        }
      }

      function loadState() {
        const hash = window.location.hash.slice(1);
        if (hash) {
          try {
            const state = JSON.parse(decodeURIComponent(atob(hash)));
            if (state.svg) svgInput.value = state.svg;
            if (state.width) exportWidth.value = state.width;
            if (state.height) exportHeight.value = state.height;
            if (state.format) exportFormat.value = state.format;
            if (state.bg) bgColor.value = state.bg;
            if (state.transparent !== undefined) transparentBg.checked = state.transparent;
            if (state.quality) jpegQuality.value = state.quality;
            renderSVG();
          } catch (e) {
            console.error("åŠ è½½çŠ¶æ€å¤±è´¥:", e);
          }
        }
      }

      // è¾“å…¥æ—¶è‡ªåŠ¨æ¸²æŸ“å’Œä¿å­˜
      var renderTimeout;
      svgInput.addEventListener("input", function () {
        clearTimeout(renderTimeout);
        renderTimeout = setTimeout(function () {
          renderSVG();
          saveState();
        }, 300);
      });

      // è®¾ç½®æ”¹å˜æ—¶ä¿å­˜çŠ¶æ€
      [exportWidth, exportHeight, exportFormat, bgColor, transparentBg, jpegQuality].forEach(
        function (el) {
          el.addEventListener("change", function () {
            exportSize.textContent = exportWidth.value + " x " + exportHeight.value;
            saveState();
          });
        }
      );

      // åˆå§‹åŒ–
      loadState();
      previewContainer.classList.add("checkerboard");

      window.toggleTheme = function () {
        const html = document.documentElement;
        const btn = document.querySelector(".theme-toggle");
        const next = html.getAttribute("data-theme") === "light" ? "dark" : "light";
        html.setAttribute("data-theme", next);
        btn.textContent = next === "light" ? "â˜€ï¸" : "ğŸŒ™";
        localStorage.setItem("theme", next);
      };

      (function () {
        const saved = localStorage.getItem("theme");
        if (saved) {
          document.documentElement.setAttribute("data-theme", saved);
          const btn = document.querySelector(".theme-toggle");
          if (btn) btn.textContent = saved === "light" ? "â˜€ï¸" : "ğŸŒ™";
        }
      })();
    </script>
  </body>
</html>

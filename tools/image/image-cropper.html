<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡è£å‰ªå·¥å…· - HTML Tools</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { --bg-primary: #0a0a0f; --bg-secondary: #12121a; --bg-tertiary: #1a1a25; --text-primary: #fff; --text-secondary: #88a; --accent: #6366f1; --border: #2a2a3a; --success: #22c55e; }
        [data-theme="light"] { --bg-primary: #f8fafc; --bg-secondary: #fff; --bg-tertiary: #f1f5f9; --text-primary: #1e293b; --text-secondary: #64748b; --border: #e2e8f0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .header { background: linear-gradient(135deg, #8b5cf6, #a855f7); padding: 2rem; text-align: center; }
        .header h1 { font-size: 1.8rem; margin-bottom: 0.5rem; }
        .nav { display: flex; justify-content: space-between; max-width: 1200px; margin: 0 auto 1rem; }
        .back-link { color: rgba(255,255,255,0.9); text-decoration: none; }
        .theme-toggle { background: rgba(255,255,255,0.2); border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; color: white; cursor: pointer; }
        .container { max-width: 1000px; margin: 0 auto; padding: 2rem; }
        .card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 1rem; padding: 1.5rem; margin-bottom: 1.5rem; }
        .drop-zone { border: 2px dashed var(--border); border-radius: 0.75rem; padding: 3rem; text-align: center; cursor: pointer; transition: all 0.2s; }
        .drop-zone:hover { border-color: var(--accent); }
        .drop-zone input { display: none; }
        .crop-container { position: relative; margin: 1.5rem 0; background: var(--bg-tertiary); border-radius: 0.5rem; overflow: hidden; }
        .crop-canvas { display: block; max-width: 100%; margin: 0 auto; cursor: crosshair; }
        .crop-box { position: absolute; border: 2px solid var(--accent); background: rgba(99, 102, 241, 0.1); pointer-events: none; }
        .aspect-buttons { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .aspect-btn { padding: 0.5rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: 0.5rem; color: var(--text-primary); cursor: pointer; font-size: 0.85rem; transition: all 0.2s; }
        .aspect-btn:hover, .aspect-btn.active { background: var(--accent); border-color: var(--accent); color: white; }
        .preview-section { margin-top: 1.5rem; }
        .preview-section h3 { font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem; }
        .preview-canvas { background: var(--bg-tertiary); border-radius: 0.5rem; max-width: 100%; }
        .btn-group { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .btn { flex: 1; padding: 0.75rem 1rem; border: none; border-radius: 0.5rem; cursor: pointer; font-size: 1rem; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .hidden { display: none; }
        .size-info { font-size: 0.85rem; color: var(--text-secondary); margin-top: 0.5rem; text-align: center; }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav">
            <a href="../../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ ä¸»é¢˜</button>
        </div>
        <h1>âœ‚ï¸ å›¾ç‰‡è£å‰ªå·¥å…·</h1>
        <p>è‡ªç”±è£å‰ªæˆ–æŒ‰æ¯”ä¾‹è£å‰ªå›¾ç‰‡</p>
    </div>
    <div class="container">
        <div class="card">
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*" onchange="handleFile(this.files[0])">
                <div style="font-size: 3rem;">ğŸ–¼ï¸</div>
                <p style="color: var(--text-secondary);">ç‚¹å‡»é€‰æ‹©å›¾ç‰‡æˆ–æ‹–æ”¾å›¾ç‰‡</p>
            </div>
        </div>
        
        <div class="card hidden" id="cropSection">
            <div class="aspect-buttons">
                <button class="aspect-btn active" onclick="setAspect(null)">è‡ªç”±</button>
                <button class="aspect-btn" onclick="setAspect(1)">1:1</button>
                <button class="aspect-btn" onclick="setAspect(4/3)">4:3</button>
                <button class="aspect-btn" onclick="setAspect(16/9)">16:9</button>
                <button class="aspect-btn" onclick="setAspect(3/2)">3:2</button>
                <button class="aspect-btn" onclick="setAspect(2/3)">2:3</button>
                <button class="aspect-btn" onclick="setAspect(9/16)">9:16</button>
            </div>
            
            <div class="crop-container" id="cropContainer">
                <canvas id="cropCanvas" class="crop-canvas"></canvas>
            </div>
            <div class="size-info" id="cropInfo">æ‹–åŠ¨é¼ æ ‡é€‰æ‹©è£å‰ªåŒºåŸŸ</div>
            
            <div class="preview-section">
                <h3>è£å‰ªé¢„è§ˆ</h3>
                <canvas id="previewCanvas" class="preview-canvas"></canvas>
            </div>
            
            <div class="btn-group">
                <button class="btn btn-primary" onclick="resetCrop()">ğŸ”„ é‡ç½®</button>
                <button class="btn btn-success" onclick="download()">ğŸ’¾ ä¸‹è½½</button>
            </div>
        </div>
    </div>
    <script>
        let img = null;
        let cropCanvas, cropCtx, previewCanvas, previewCtx;
        let isSelecting = false;
        let startX, startY, cropX, cropY, cropW, cropH;
        let aspectRatio = null;
        let scale = 1;
        
        const dropZone = document.getElementById('dropZone');
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = 'var(--accent)'; });
        dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = '');
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '';
            handleFile(e.dataTransfer.files[0]);
        });
        
        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            
            img = new Image();
            img.onload = () => {
                document.getElementById('cropSection').classList.remove('hidden');
                initCrop();
            };
            img.src = URL.createObjectURL(file);
        }
        
        function initCrop() {
            cropCanvas = document.getElementById('cropCanvas');
            cropCtx = cropCanvas.getContext('2d');
            previewCanvas = document.getElementById('previewCanvas');
            previewCtx = previewCanvas.getContext('2d');
            
            const container = document.getElementById('cropContainer');
            const maxWidth = container.clientWidth - 20;
            scale = Math.min(1, maxWidth / img.width);
            
            cropCanvas.width = img.width * scale;
            cropCanvas.height = img.height * scale;
            
            drawImage();
            
            // Full image as initial selection
            cropX = 0;
            cropY = 0;
            cropW = cropCanvas.width;
            cropH = cropCanvas.height;
            drawSelection();
            updatePreview();
            
            cropCanvas.onmousedown = startSelection;
            cropCanvas.onmousemove = updateSelection;
            cropCanvas.onmouseup = endSelection;
            cropCanvas.onmouseleave = endSelection;
            
            // Touch events
            cropCanvas.ontouchstart = (e) => { e.preventDefault(); startSelection(e.touches[0]); };
            cropCanvas.ontouchmove = (e) => { e.preventDefault(); updateSelection(e.touches[0]); };
            cropCanvas.ontouchend = endSelection;
        }
        
        function drawImage() {
            cropCtx.clearRect(0, 0, cropCanvas.width, cropCanvas.height);
            cropCtx.drawImage(img, 0, 0, cropCanvas.width, cropCanvas.height);
        }
        
        function drawSelection() {
            drawImage();
            
            // Darken outside selection
            cropCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
            cropCtx.fillRect(0, 0, cropCanvas.width, cropY);
            cropCtx.fillRect(0, cropY + cropH, cropCanvas.width, cropCanvas.height - cropY - cropH);
            cropCtx.fillRect(0, cropY, cropX, cropH);
            cropCtx.fillRect(cropX + cropW, cropY, cropCanvas.width - cropX - cropW, cropH);
            
            // Selection border
            cropCtx.strokeStyle = '#6366f1';
            cropCtx.lineWidth = 2;
            cropCtx.strokeRect(cropX, cropY, cropW, cropH);
            
            // Grid lines
            cropCtx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
            cropCtx.lineWidth = 1;
            for (let i = 1; i < 3; i++) {
                cropCtx.beginPath();
                cropCtx.moveTo(cropX + cropW * i / 3, cropY);
                cropCtx.lineTo(cropX + cropW * i / 3, cropY + cropH);
                cropCtx.moveTo(cropX, cropY + cropH * i / 3);
                cropCtx.lineTo(cropX + cropW, cropY + cropH * i / 3);
                cropCtx.stroke();
            }
        }
        
        function startSelection(e) {
            const rect = cropCanvas.getBoundingClientRect();
            startX = (e.clientX || e.pageX) - rect.left;
            startY = (e.clientY || e.pageY) - rect.top;
            isSelecting = true;
        }
        
        function updateSelection(e) {
            if (!isSelecting) return;
            
            const rect = cropCanvas.getBoundingClientRect();
            let endX = (e.clientX || e.pageX) - rect.left;
            let endY = (e.clientY || e.pageY) - rect.top;
            
            cropX = Math.min(startX, endX);
            cropY = Math.min(startY, endY);
            cropW = Math.abs(endX - startX);
            cropH = Math.abs(endY - startY);
            
            if (aspectRatio) {
                if (cropW / cropH > aspectRatio) {
                    cropW = cropH * aspectRatio;
                } else {
                    cropH = cropW / aspectRatio;
                }
            }
            
            // Keep within bounds
            cropX = Math.max(0, Math.min(cropX, cropCanvas.width - cropW));
            cropY = Math.max(0, Math.min(cropY, cropCanvas.height - cropH));
            
            drawSelection();
            updateCropInfo();
        }
        
        function endSelection() {
            isSelecting = false;
            updatePreview();
        }
        
        function updateCropInfo() {
            const realW = Math.round(cropW / scale);
            const realH = Math.round(cropH / scale);
            document.getElementById('cropInfo').textContent = `è£å‰ªå°ºå¯¸: ${realW} Ã— ${realH} åƒç´ `;
        }
        
        function updatePreview() {
            if (cropW < 5 || cropH < 5) return;
            
            const realX = cropX / scale;
            const realY = cropY / scale;
            const realW = cropW / scale;
            const realH = cropH / scale;
            
            const maxPreviewW = 300;
            const previewScale = Math.min(1, maxPreviewW / realW);
            
            previewCanvas.width = realW * previewScale;
            previewCanvas.height = realH * previewScale;
            
            previewCtx.drawImage(img, realX, realY, realW, realH, 0, 0, previewCanvas.width, previewCanvas.height);
            updateCropInfo();
        }
        
        function setAspect(ratio) {
            aspectRatio = ratio;
            document.querySelectorAll('.aspect-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function resetCrop() {
            cropX = 0;
            cropY = 0;
            cropW = cropCanvas.width;
            cropH = cropCanvas.height;
            drawSelection();
            updatePreview();
        }
        
        function download() {
            const realX = cropX / scale;
            const realY = cropY / scale;
            const realW = cropW / scale;
            const realH = cropH / scale;
            
            const canvas = document.createElement('canvas');
            canvas.width = realW;
            canvas.height = realH;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, realX, realY, realW, realH, 0, 0, realW, realH);
            
            const link = document.createElement('a');
            link.download = 'cropped_image.png';
            link.href = canvas.toDataURL('image/png');
            link.click();
        }
        
        function toggleTheme() {
            const t = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
        }

        document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');
    </script>
</body>
</html>

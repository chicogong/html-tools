<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ç«™ä¼šè®¡æ—¶å™¨ - WebUtils</title>
    <style>
      :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --text-color: #e0e0e0;
        --primary-color: #0f3460;
        --accent-color: #00d9ff;
        --border-color: #0f3460;
        --input-bg: #1a1a2e;
        --success-color: #4ade80;
        --warning-color: #fbbf24;
        --danger-color: #f87171;
      }

      [data-theme="light"] {
        --bg-color: #f0f4f8;
        --card-bg: #fff;
        --text-color: #1a1a2e;
        --primary-color: #e0e7ff;
        --accent-color: #0891b2;
        --border-color: #c7d2fe;
        --input-bg: #f8fafc;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-size: 16px;
        line-height: 1.6;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--accent-color), #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-toggle {
        position: absolute;
        right: 0;
        top: 0;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
      }

      .back-link {
        position: absolute;
        left: 0;
        top: 0;
        color: var(--accent-color);
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
      }

      .panel-title {
        font-size: 1rem;
        margin-bottom: 15px;
        color: var(--accent-color);
      }

      .timer-display {
        text-align: center;
        padding: 40px 20px;
      }

      .current-speaker {
        font-size: 1.5rem;
        margin-bottom: 20px;
        color: var(--accent-color);
      }

      .timer-circle {
        position: relative;
        width: 250px;
        height: 250px;
        margin: 0 auto 30px;
      }

      .timer-circle svg {
        transform: rotate(-90deg);
      }

      .timer-circle-bg {
        fill: none;
        stroke: var(--border-color);
        stroke-width: 10;
      }

      .timer-circle-progress {
        fill: none;
        stroke: var(--success-color);
        stroke-width: 10;
        stroke-linecap: round;
        transition:
          stroke-dashoffset 1s linear,
          stroke 0.3s ease;
      }

      .timer-circle-progress.warning {
        stroke: var(--warning-color);
      }

      .timer-circle-progress.danger {
        stroke: var(--danger-color);
      }

      .timer-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
      }

      .timer-time {
        font-size: 4rem;
        font-weight: 300;
        font-family: monospace;
      }

      .timer-status {
        font-size: 14px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .controls {
        display: flex;
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .control-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        font-size: 24px;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .control-btn.primary {
        background: var(--accent-color);
        color: #000;
        width: 80px;
        height: 80px;
        font-size: 28px;
      }

      .control-btn.primary:hover {
        transform: scale(1.05);
      }

      .control-btn.secondary {
        background: var(--primary-color);
        color: var(--text-color);
      }

      .control-btn.secondary:hover {
        background: var(--border-color);
      }

      .settings-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
        align-items: center;
      }

      .settings-row label {
        font-size: 14px;
        min-width: 100px;
      }

      .settings-row input {
        flex: 1;
        padding: 10px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
      }

      .settings-row input:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .member-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .member-item {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 12px;
        background: var(--input-bg);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .member-item:hover {
        background: var(--primary-color);
      }

      .member-item.active {
        border-left: 3px solid var(--accent-color);
        background: var(--primary-color);
      }

      .member-item.done {
        opacity: 0.5;
      }

      .member-item.done .member-name {
        text-decoration: line-through;
      }

      .member-number {
        width: 28px;
        height: 28px;
        border-radius: 50%;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
      }

      .member-item.active .member-number {
        background: var(--accent-color);
        color: #000;
      }

      .member-item.done .member-number {
        background: var(--success-color);
        color: #000;
      }

      .member-name {
        flex: 1;
      }

      .member-time {
        font-size: 12px;
        opacity: 0.7;
        font-family: monospace;
      }

      .member-input {
        flex: 1;
        padding: 8px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        font-size: 14px;
      }

      .member-input:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--accent-color);
        color: #000;
      }

      .btn-secondary {
        background: var(--primary-color);
        color: var(--text-color);
      }

      .btn-danger {
        background: transparent;
        color: var(--danger-color);
        padding: 8px 12px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
        margin-top: 20px;
      }

      .stat-card {
        background: var(--input-bg);
        padding: 15px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent-color);
      }

      .stat-label {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .progress-bar {
        height: 8px;
        background: var(--input-bg);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 15px;
      }

      .progress-fill {
        height: 100%;
        background: var(--accent-color);
        transition: width 0.3s ease;
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
        }
        50% {
          transform: scale(1.02);
        }
      }

      .timer-display.running .timer-circle {
        animation: pulse 2s ease-in-out infinite;
      }

      .shuffle-btn {
        font-size: 16px !important;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a href="../../index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
        <h1>ç«™ä¼šè®¡æ—¶å™¨</h1>
        <p>æ¯æ—¥ç«™ä¼šæ—¶é—´ç®¡ç†</p>
        <button class="theme-toggle" onclick="toggleTheme()" aria-label="ğŸŒ“ åˆ‡æ¢ä¸»é¢˜">
          ğŸŒ“ åˆ‡æ¢ä¸»é¢˜
        </button>
      </div>

      <div class="panel">
        <div class="timer-display" id="timerDisplay">
          <div class="current-speaker" id="currentSpeaker">å‡†å¤‡å¼€å§‹</div>
          <div class="timer-circle">
            <svg width="250" height="250">
              <circle class="timer-circle-bg" cx="125" cy="125" r="110"></circle>
              <circle
                class="timer-circle-progress"
                id="progressCircle"
                cx="125"
                cy="125"
                r="110"
                stroke-dasharray="691"
                stroke-dashoffset="0"
              ></circle>
            </svg>
            <div class="timer-text">
              <div class="timer-time" id="timerTime">02:00</div>
              <div class="timer-status" id="timerStatus">ç‚¹å‡»å¼€å§‹</div>
            </div>
          </div>
          <div class="controls">
            <button
              class="control-btn secondary"
              onclick="prevPerson()"
              title="ä¸Šä¸€ä½"
              aria-label="â®"
            >
              â®
            </button>
            <button class="control-btn primary" id="playBtn" onclick="toggleTimer()" aria-label="â–¶">
              â–¶
            </button>
            <button
              class="control-btn secondary"
              onclick="nextPerson()"
              title="ä¸‹ä¸€ä½"
              aria-label="â­"
            >
              â­
            </button>
            <button
              class="control-btn secondary"
              onclick="resetTimer()"
              title="é‡ç½®"
              aria-label="ğŸ”„"
            >
              ğŸ”„
            </button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">âš™ï¸ è®¾ç½®</div>
        <div class="settings-row">
          <label for="input-----">æ¯äººæ—¶é•¿</label>
          <input
            
            type="number"
            id="timePerPerson"
            value="120"
            min="30"
            max="600"
            aria-label="æ•°å­—è¾“å…¥æ¡†"
            placeholder="è¯·è¾“å…¥æ•°å­—è¾“å…¥æ¡†"
          />
          ç§’
        </div>
        <div class="settings-row">
          <label for="input-----">é¢„è­¦æ—¶é—´</label>
          <input
            
            type="number"
            id="warningTime"
            value="30"
            min="5"
            max="120"
            aria-label="æ•°å­—è¾“å…¥æ¡†"
            placeholder="è¯·è¾“å…¥æ•°å­—è¾“å…¥æ¡†"
          />
          ç§’ (å‰©ä½™æ—¶å˜é»„)
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ‘¥ å‚ä¼šäººå‘˜</div>
        <div class="member-list" id="memberList"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="addMember()" aria-label="+ æ·»åŠ æˆå‘˜">
            + æ·»åŠ æˆå‘˜
          </button>
          <button class="btn btn-secondary shuffle-btn" onclick="shuffleMembers()">
            ğŸ”€ éšæœºæ’åº
          </button>
          <button class="btn btn-secondary" onclick="resetAll()" aria-label="ğŸ—‘ï¸ é‡ç½®å…¨éƒ¨">
            ğŸ—‘ï¸ é‡ç½®å…¨éƒ¨
          </button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“Š ç»Ÿè®¡</div>
        <div class="progress-bar">
          <div class="progress-fill" id="overallProgress" style="width: 0%"></div>
        </div>
        <p style="text-align: center; margin-top: 10px; font-size: 13px">
          è¿›åº¦:
          <span id="progressText">0 / 0</span>
        </p>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalMembers">0</div>
            <div class="stat-label">æ€»äººæ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="completedCount">0</div>
            <div class="stat-label">å·²å®Œæˆ</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalTime">0:00</div>
            <div class="stat-label">æ€»è€—æ—¶</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgTime">0:00</div>
            <div class="stat-label">å¹³å‡æ—¶é•¿</div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const LS_KEY = "standup-timer-data";

      let members = [];
      let currentIndex = -1;
      let timeLeft = 120;
      let totalTimePerPerson = 120;
      let isRunning = false;
      let timerInterval = null;
      let totalElapsed = 0;

      function init() {
        const savedTheme = localStorage.getItem("theme") || "dark";
        if (savedTheme === "light") {
          document.body.setAttribute("data-theme", "light");
        }

        loadFromStorage();

        if (members.length === 0) {
          members = [
            { id: 1, name: "æˆå‘˜ 1", done: false, time: 0 },
            { id: 2, name: "æˆå‘˜ 2", done: false, time: 0 },
            { id: 3, name: "æˆå‘˜ 3", done: false, time: 0 }
          ];
        }

        document.getElementById("timePerPerson").addEventListener("change", (e) => {
          totalTimePerPerson = parseInt(e.target.value) || 120;
          if (!isRunning && currentIndex === -1) {
            timeLeft = totalTimePerPerson;
            updateDisplay();
          }
          saveToStorage();
        });

        document.getElementById("warningTime").addEventListener("change", saveToStorage);

        renderMembers();
        updateDisplay();
        updateStats();
      }

      function generateId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
      }

      function addMember(name = "") {
        members.push({
          id: generateId(),
          name: name || "æˆå‘˜ " + (members.length + 1),
          done: false,
          time: 0
        });
        renderMembers();
        updateStats();
        saveToStorage();
      }

      function removeMember(id) {
        const index = members.findIndex((m) => m.id === id);
        if (index === currentIndex) {
          pauseTimer();
          currentIndex = -1;
        } else if (index < currentIndex) {
          currentIndex--;
        }
        members = members.filter((m) => m.id !== id);
        renderMembers();
        updateStats();
        saveToStorage();
      }

      function renderMembers() {
        const container = document.getElementById("memberList");
        container.textContent = "";

        members.forEach((member, index) => {
          const div = document.createElement("div");
          div.className = "member-item";
          if (index === currentIndex) div.classList.add("active");
          if (member.done) div.classList.add("done");

          const number = document.createElement("div");
          number.className = "member-number";
          number.textContent = member.done ? "âœ“" : index + 1;

          const nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.className = "member-input";
          nameInput.value = member.name;
          nameInput.addEventListener("input", (e) => {
            member.name = e.target.value;
            if (index === currentIndex) {
              document.getElementById("currentSpeaker").textContent =
                member.name || "æˆå‘˜ " + (index + 1);
            }
            saveToStorage();
          });
          nameInput.addEventListener("click", (e) => e.stopPropagation());

          const time = document.createElement("div");
          time.className = "member-time";
          time.textContent = formatTime(member.time);

          const deleteBtn = document.createElement("button");
          deleteBtn.className = "btn btn-danger";
          deleteBtn.textContent = "Ã—";
          deleteBtn.addEventListener("click", (e) => {
            e.stopPropagation();
            removeMember(member.id);
          });

          div.appendChild(number);
          div.appendChild(nameInput);
          div.appendChild(time);
          div.appendChild(deleteBtn);

          div.addEventListener("click", () => {
            if (!member.done) {
              selectMember(index);
            }
          });

          container.appendChild(div);
        });
      }

      function selectMember(index) {
        if (isRunning) {
          pauseTimer();
        }
        currentIndex = index;
        timeLeft = totalTimePerPerson;
        renderMembers();
        updateDisplay();
        document.getElementById("currentSpeaker").textContent =
          members[index]?.name || "æˆå‘˜ " + (index + 1);
        document.getElementById("timerStatus").textContent = "å‡†å¤‡å°±ç»ª";
      }

      function toggleTimer() {
        if (isRunning) {
          pauseTimer();
        } else {
          startTimer();
        }
      }

      function startTimer() {
        if (currentIndex === -1) {
          // Find first undone member
          const firstUndone = members.findIndex((m) => !m.done);
          if (firstUndone === -1) {
            showToast("æ‰€æœ‰æˆå‘˜å·²å®Œæˆ");
            return;
          }
          selectMember(firstUndone);
        }

        isRunning = true;
        document.getElementById("playBtn").textContent = "â¸";
        document.getElementById("timerStatus").textContent = "å‘è¨€ä¸­...";
        document.getElementById("timerDisplay").classList.add("running");

        timerInterval = setInterval(() => {
          timeLeft--;
          totalElapsed++;

          if (currentIndex >= 0 && currentIndex < members.length) {
            members[currentIndex].time++;
          }

          updateDisplay();
          updateProgress();

          if (timeLeft <= 0) {
            markCurrentDone();
            nextPerson();
          }
        }, 1000);
      }

      function pauseTimer() {
        isRunning = false;
        document.getElementById("playBtn").textContent = "â–¶";
        document.getElementById("timerStatus").textContent = "å·²æš‚åœ";
        document.getElementById("timerDisplay").classList.remove("running");

        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      function resetTimer() {
        pauseTimer();
        timeLeft = totalTimePerPerson;
        updateDisplay();
        document.getElementById("timerStatus").textContent = "å·²é‡ç½®";
      }

      function markCurrentDone() {
        if (currentIndex >= 0 && currentIndex < members.length) {
          members[currentIndex].done = true;
          playSound();
          saveToStorage();
        }
      }

      function nextPerson() {
        markCurrentDone();

        // Find next undone member
        let nextIndex = -1;
        for (let i = currentIndex + 1; i < members.length; i++) {
          if (!members[i].done) {
            nextIndex = i;
            break;
          }
        }

        if (nextIndex === -1) {
          // All done
          pauseTimer();
          currentIndex = -1;
          document.getElementById("currentSpeaker").textContent = "ä¼šè®®ç»“æŸ!";
          document.getElementById("timerStatus").textContent = "å…¨éƒ¨å®Œæˆ";
          showToast("ç«™ä¼šç»“æŸ!");
        } else {
          selectMember(nextIndex);
          if (isRunning) {
            startTimer();
          }
        }

        renderMembers();
        updateStats();
      }

      function prevPerson() {
        if (currentIndex > 0) {
          pauseTimer();
          // Reset current person
          if (currentIndex >= 0 && currentIndex < members.length) {
            members[currentIndex].done = false;
            members[currentIndex].time = 0;
          }
          currentIndex--;
          members[currentIndex].done = false;
          timeLeft = totalTimePerPerson - members[currentIndex].time;
          if (timeLeft < 0) timeLeft = totalTimePerPerson;
          renderMembers();
          updateDisplay();
          document.getElementById("currentSpeaker").textContent =
            members[currentIndex]?.name || "æˆå‘˜";
        }
      }

      function updateDisplay() {
        document.getElementById("timerTime").textContent = formatTime(timeLeft);

        const circumference = 2 * Math.PI * 110;
        const progress = timeLeft / totalTimePerPerson;
        const offset = circumference * (1 - progress);

        const progressCircle = document.getElementById("progressCircle");
        progressCircle.style.strokeDashoffset = offset;

        const warningTime = parseInt(document.getElementById("warningTime").value) || 30;
        progressCircle.classList.remove("warning", "danger");
        if (timeLeft <= 10) {
          progressCircle.classList.add("danger");
        } else if (timeLeft <= warningTime) {
          progressCircle.classList.add("warning");
        }
      }

      function updateProgress() {
        const completed = members.filter((m) => m.done).length;
        const total = members.length;
        const percent = total > 0 ? (completed / total) * 100 : 0;

        document.getElementById("overallProgress").style.width = percent + "%";
        document.getElementById("progressText").textContent = completed + " / " + total;
      }

      function updateStats() {
        const completed = members.filter((m) => m.done).length;
        const totalTime = members.reduce((sum, m) => sum + m.time, 0);
        const avgTime = completed > 0 ? Math.round(totalTime / completed) : 0;

        document.getElementById("totalMembers").textContent = members.length;
        document.getElementById("completedCount").textContent = completed;
        document.getElementById("totalTime").textContent = formatTime(totalTime);
        document.getElementById("avgTime").textContent = formatTime(avgTime);

        updateProgress();
      }

      function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return mins + ":" + String(secs).padStart(2, "0");
      }

      function shuffleMembers() {
        pauseTimer();
        currentIndex = -1;

        // Reset all
        members.forEach((m) => {
          m.done = false;
          m.time = 0;
        });

        // Fisher-Yates shuffle
        for (let i = members.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [members[i], members[j]] = [members[j], members[i]];
        }

        timeLeft = totalTimePerPerson;
        totalElapsed = 0;
        renderMembers();
        updateDisplay();
        updateStats();
        saveToStorage();

        document.getElementById("currentSpeaker").textContent = "å·²éšæœºæ’åº";
        document.getElementById("timerStatus").textContent = "ç‚¹å‡»å¼€å§‹";
      }

      function resetAll() {
        if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ")) {
          pauseTimer();
          currentIndex = -1;
          totalElapsed = 0;

          members.forEach((m) => {
            m.done = false;
            m.time = 0;
          });

          timeLeft = totalTimePerPerson;
          renderMembers();
          updateDisplay();
          updateStats();
          saveToStorage();

          document.getElementById("currentSpeaker").textContent = "å‡†å¤‡å¼€å§‹";
          document.getElementById("timerStatus").textContent = "ç‚¹å‡»å¼€å§‹";
        }
      }

      function playSound() {
        try {
          const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          const oscillator = audioCtx.createOscillator();
          const gainNode = audioCtx.createGain();

          oscillator.connect(gainNode);
          gainNode.connect(audioCtx.destination);

          oscillator.frequency.value = 800;
          oscillator.type = "sine";
          gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);

          oscillator.start(audioCtx.currentTime);
          oscillator.stop(audioCtx.currentTime + 0.3);
        } catch (e) {
          console.log("Sound not supported");
        }
      }

      function saveToStorage() {
        const data = {
          members: members,
          timePerPerson: parseInt(document.getElementById("timePerPerson").value) || 120,
          warningTime: parseInt(document.getElementById("warningTime").value) || 30
        };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      function loadFromStorage() {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            if (data.members) members = data.members;
            if (data.timePerPerson) {
              totalTimePerPerson = data.timePerPerson;
              document.getElementById("timePerPerson").value = data.timePerPerson;
              timeLeft = data.timePerPerson;
            }
            if (data.warningTime) {
              document.getElementById("warningTime").value = data.warningTime;
            }
          } catch (e) {
            console.error("Failed to load from storage:", e);
          }
        }
      }

      function showToast(message) {
        const toast = document.createElement("div");
        toast.style.cssText =
          "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-color);color:#000;padding:12px 24px;border-radius:8px;z-index:1000;font-size:14px;";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      }

      window.toggleTheme = function () {
        const body = document.body;
        const currentTheme = body.getAttribute("data-theme");
        const newTheme = currentTheme === "light" ? "dark" : "light";
        body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      };

      init();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>IP 地址工具 - WebUtils</title>
  <style>
    :root {
      --bg: #f8f9fa;
      --card-bg: #fff;
      --text: #212529;
      --text-muted: #6c757d;
      --border: #dee2e6;
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --success: #198754;
      --danger: #dc3545;
      --shadow: 0 2px 8px rgb(0,0,0,0.08);
      --radius: 8px;
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      min-height: 100vh;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 16px;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    h1 {
      font-size: 1.75rem;
      margin: 0 0 8px;
    }

    .desc {
      color: var(--text-muted);
      margin: 0 0 24px;
      font-size: 0.95rem;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }

    .card h3 {
      margin: 0 0 16px;
      font-size: 1rem;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    button {
      padding: 10px 16px;
      font-size: 0.95rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    button.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }

    button.primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: #fff;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }

    input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(13,110,253,0.15);
    }

    .result-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-top: 16px;
    }

    .result-item {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 12px;
    }

    .result-item .label {
      font-size: 0.8rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .result-item .value {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 0.9rem;
      word-break: break-all;
    }

    .status {
      font-size: 0.85rem;
      margin-top: 12px;
      min-height: 20px;
    }

    .status.success { color: var(--success); }
    .status.error { color: var(--danger); }

    .my-ip {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 20px;
      text-align: center;
      margin-bottom: 16px;
    }

    .my-ip .ip {
      font-size: 1.5rem;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      margin-bottom: 8px;
    }

    .my-ip .info {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }

    .tab {
      padding: 8px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.9rem;
      border-radius: var(--radius) var(--radius) 0 0;
    }

    .tab.active {
      background: var(--primary);
      color: #fff;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../../index.html" class="back-link">← 返回工具列表</a>
    <h1>IP 地址工具</h1>
    <p class="desc">IP 地址格式转换、子网计算、IPv4/IPv6 转换</p>

    <div class="card">
      <h3>我的 IP 地址</h3>
      <div class="my-ip">
        <div class="ip" id="myIp">检测中...</div>
        <div class="info" id="myIpInfo"></div>
      </div>
      <button id="btnRefreshIp">刷新</button>
      <button id="btnCopyIp">复制 IP</button>
    </div>

    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="convert">格式转换</button>
        <button class="tab" data-tab="subnet">子网计算</button>
        <button class="tab" data-tab="ipv6">IPv6 工具</button>
      </div>

      <div id="convertTab" class="tab-content active">
        <label for="ipInput">输入 IPv4 地址</label>
        <input type="text" id="ipInput" placeholder="例如: 192.168.1.1 或 3232235777" />
        <div class="btn-row" style="margin-top: 12px;">
          <button id="btnConvert" class="primary">转换</button>
          <button id="btnPaste">粘贴</button>
          <button id="btnClear">清空</button>
        </div>
        <div class="result-grid" id="convertResults">
          <div class="result-item">
            <div class="label">点分十进制</div>
            <div class="value" id="dotDecimal">-</div>
          </div>
          <div class="result-item">
            <div class="label">十进制</div>
            <div class="value" id="decimal">-</div>
          </div>
          <div class="result-item">
            <div class="label">十六进制</div>
            <div class="value" id="hex">-</div>
          </div>
          <div class="result-item">
            <div class="label">二进制</div>
            <div class="value" id="binary">-</div>
          </div>
          <div class="result-item">
            <div class="label">八进制</div>
            <div class="value" id="octal">-</div>
          </div>
          <div class="result-item">
            <div class="label">IPv6 映射</div>
            <div class="value" id="ipv6Mapped">-</div>
          </div>
        </div>
      </div>

      <div id="subnetTab" class="tab-content">
        <label for="cidrInput">输入 CIDR 表示法</label>
        <input type="text" id="cidrInput" placeholder="例如: 192.168.1.0/24" />
        <div class="btn-row" style="margin-top: 12px;">
          <button id="btnCalcSubnet" class="primary">计算</button>
        </div>
        <div class="result-grid" id="subnetResults">
          <div class="result-item">
            <div class="label">网络地址</div>
            <div class="value" id="networkAddr">-</div>
          </div>
          <div class="result-item">
            <div class="label">广播地址</div>
            <div class="value" id="broadcastAddr">-</div>
          </div>
          <div class="result-item">
            <div class="label">子网掩码</div>
            <div class="value" id="subnetMask">-</div>
          </div>
          <div class="result-item">
            <div class="label">可用 IP 范围</div>
            <div class="value" id="ipRange">-</div>
          </div>
          <div class="result-item">
            <div class="label">可用主机数</div>
            <div class="value" id="hostCount">-</div>
          </div>
          <div class="result-item">
            <div class="label">IP 类型</div>
            <div class="value" id="ipClass">-</div>
          </div>
        </div>
      </div>

      <div id="ipv6Tab" class="tab-content">
        <label for="ipv6Input">输入 IPv6 地址</label>
        <input type="text" id="ipv6Input" placeholder="例如: 2001:db8::1 或 ::ffff:192.168.1.1" />
        <div class="btn-row" style="margin-top: 12px;">
          <button id="btnExpandIpv6" class="primary">展开/压缩</button>
        </div>
        <div class="result-grid" id="ipv6Results">
          <div class="result-item">
            <div class="label">完整格式</div>
            <div class="value" id="ipv6Full">-</div>
          </div>
          <div class="result-item">
            <div class="label">压缩格式</div>
            <div class="value" id="ipv6Compressed">-</div>
          </div>
          <div class="result-item">
            <div class="label">IPv4 映射</div>
            <div class="value" id="ipv4FromIpv6">-</div>
          </div>
          <div class="result-item">
            <div class="label">类型</div>
            <div class="value" id="ipv6Type">-</div>
          </div>
        </div>
      </div>

      <div id="status" class="status"></div>
    </div>

    <footer>
      <a href="https://github.com/chicogong/html-tools" target="_blank" rel="noreferrer">View source</a>
      · 纯前端工具 · 无服务器 · 
      <a href="../../index.html">WebUtils</a>
    </footer>
  </div>

  <script>
    // Elements
    const myIpEl = document.getElementById('myIp');
    const myIpInfoEl = document.getElementById('myIpInfo');
    const ipInput = document.getElementById('ipInput');
    const cidrInput = document.getElementById('cidrInput');
    const ipv6Input = document.getElementById('ipv6Input');
    const statusEl = document.getElementById('status');

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.onclick = () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      };
    });

    // Get my IP
    async function getMyIp() {
      myIpEl.textContent = '检测中...';
      myIpInfoEl.textContent = '';
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        myIpEl.textContent = data.ip;
        myIpInfoEl.textContent = 'IPv4 公网地址';
      } catch (e) {
        try {
          const response = await fetch('https://api64.ipify.org?format=json');
          const data = await response.json();
          myIpEl.textContent = data.ip;
          myIpInfoEl.textContent = data.ip.includes(':') ? 'IPv6 公网地址' : 'IPv4 公网地址';
        } catch (e2) {
          myIpEl.textContent = '无法获取';
          myIpInfoEl.textContent = '请检查网络连接';
        }
      }
    }

    // IPv4 utilities
    function ipToInt(ip) {
      const parts = ip.split('.').map(Number);
      if (parts.length !== 4 || parts.some(p => isNaN(p) || p < 0 || p > 255)) {
        return null;
      }
      return ((parts[0] << 24) | (parts[1] << 16) | (parts[2] << 8) | parts[3]) >>> 0;
    }

    function intToIp(int) {
      return [
        (int >>> 24) & 255,
        (int >>> 16) & 255,
        (int >>> 8) & 255,
        int & 255
      ].join('.');
    }

    function parseIpInput(input) {
      input = input.trim();
      
      // Dotted decimal
      if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(input)) {
        return ipToInt(input);
      }
      
      // Decimal
      if (/^\d+$/.test(input)) {
        const num = parseInt(input, 10);
        if (num >= 0 && num <= 4294967295) {
          return num;
        }
      }
      
      // Hex
      if (/^0x[0-9a-fA-F]+$/i.test(input)) {
        const num = parseInt(input, 16);
        if (num >= 0 && num <= 4294967295) {
          return num;
        }
      }
      
      return null;
    }

    function convertIp() {
      const input = ipInput.value.trim();
      if (!input) {
        showStatus('请输入 IP 地址', 'error');
        return;
      }

      const ipInt = parseIpInput(input);
      if (ipInt === null) {
        showStatus('无效的 IP 地址格式', 'error');
        return;
      }

      const dotDecimal = intToIp(ipInt);
      document.getElementById('dotDecimal').textContent = dotDecimal;
      document.getElementById('decimal').textContent = ipInt;
      document.getElementById('hex').textContent = '0x' + ipInt.toString(16).padStart(8, '0').toUpperCase();
      document.getElementById('binary').textContent = ipInt.toString(2).padStart(32, '0').match(/.{8}/g).join('.');
      document.getElementById('octal').textContent = '0' + ipInt.toString(8);
      document.getElementById('ipv6Mapped').textContent = '::ffff:' + dotDecimal;

      showStatus('转换成功', 'success');
    }

    // Subnet calculation
    function calcSubnet() {
      const input = cidrInput.value.trim();
      const match = input.match(/^(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})\/(\d{1,2})$/);
      
      if (!match) {
        showStatus('请输入有效的 CIDR 表示法 (如 192.168.1.0/24)', 'error');
        return;
      }

      const ipInt = ipToInt(match[1]);
      const prefix = parseInt(match[2], 10);

      if (ipInt === null || prefix < 0 || prefix > 32) {
        showStatus('无效的 IP 地址或前缀长度', 'error');
        return;
      }

      const mask = prefix === 0 ? 0 : (0xFFFFFFFF << (32 - prefix)) >>> 0;
      const network = (ipInt & mask) >>> 0;
      const broadcast = (network | (~mask >>> 0)) >>> 0;
      const firstHost = prefix < 31 ? network + 1 : network;
      const lastHost = prefix < 31 ? broadcast - 1 : broadcast;
      const hostCount = prefix < 31 ? Math.pow(2, 32 - prefix) - 2 : Math.pow(2, 32 - prefix);

      document.getElementById('networkAddr').textContent = intToIp(network);
      document.getElementById('broadcastAddr').textContent = intToIp(broadcast);
      document.getElementById('subnetMask').textContent = intToIp(mask);
      document.getElementById('ipRange').textContent = intToIp(firstHost) + ' - ' + intToIp(lastHost);
      document.getElementById('hostCount').textContent = hostCount.toLocaleString();

      // Determine IP class
      const firstOctet = (ipInt >>> 24) & 255;
      let ipClass = 'N/A';
      if (firstOctet >= 1 && firstOctet <= 126) ipClass = 'A 类';
      else if (firstOctet >= 128 && firstOctet <= 191) ipClass = 'B 类';
      else if (firstOctet >= 192 && firstOctet <= 223) ipClass = 'C 类';
      else if (firstOctet >= 224 && firstOctet <= 239) ipClass = 'D 类 (组播)';
      else if (firstOctet >= 240 && firstOctet <= 255) ipClass = 'E 类 (保留)';
      
      // Check for private ranges
      if ((ipInt >= 0x0A000000 && ipInt <= 0x0AFFFFFF) ||
          (ipInt >= 0xAC100000 && ipInt <= 0xAC1FFFFF) ||
          (ipInt >= 0xC0A80000 && ipInt <= 0xC0A8FFFF)) {
        ipClass += ' / 私有';
      }
      
      document.getElementById('ipClass').textContent = ipClass;
      showStatus('计算完成', 'success');
    }

    // IPv6 utilities
    function expandIPv6(ip) {
      ip = ip.toLowerCase();
      
      // Handle IPv4-mapped IPv6
      const ipv4Match = ip.match(/::ffff:(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})$/i);
      if (ipv4Match) {
        const parts = ipv4Match[1].split('.').map(Number);
        const hex1 = ((parts[0] << 8) | parts[1]).toString(16).padStart(4, '0');
        const hex2 = ((parts[2] << 8) | parts[3]).toString(16).padStart(4, '0');
        ip = ip.replace(ipv4Match[0], '::ffff:' + hex1 + ':' + hex2);
      }

      // Expand :: notation
      if (ip.includes('::')) {
        const parts = ip.split('::');
        const left = parts[0] ? parts[0].split(':') : [];
        const right = parts[1] ? parts[1].split(':') : [];
        const missing = 8 - left.length - right.length;
        const middle = Array(missing).fill('0000');
        ip = [...left, ...middle, ...right].join(':');
      }

      // Pad each group
      return ip.split(':').map(g => g.padStart(4, '0')).join(':');
    }

    function compressIPv6(ip) {
      const full = expandIPv6(ip);
      let groups = full.split(':').map(g => g.replace(/^0+/, '') || '0');
      
      // Find longest run of zeros
      let maxStart = -1, maxLen = 0, curStart = -1, curLen = 0;
      for (let i = 0; i < groups.length; i++) {
        if (groups[i] === '0') {
          if (curStart === -1) curStart = i;
          curLen++;
        } else {
          if (curLen > maxLen) {
            maxStart = curStart;
            maxLen = curLen;
          }
          curStart = -1;
          curLen = 0;
        }
      }
      if (curLen > maxLen) {
        maxStart = curStart;
        maxLen = curLen;
      }

      if (maxLen > 1) {
        const before = groups.slice(0, maxStart).join(':');
        const after = groups.slice(maxStart + maxLen).join(':');
        return (before || '') + '::' + (after || '');
      }

      return groups.join(':');
    }

    function processIPv6() {
      const input = ipv6Input.value.trim();
      if (!input) {
        showStatus('请输入 IPv6 地址', 'error');
        return;
      }

      try {
        const full = expandIPv6(input);
        const compressed = compressIPv6(input);
        
        document.getElementById('ipv6Full').textContent = full;
        document.getElementById('ipv6Compressed').textContent = compressed;

        // Check for IPv4-mapped
        if (full.startsWith('0000:0000:0000:0000:0000:ffff:')) {
          const lastTwo = full.split(':').slice(-2);
          const ipv4 = [
            parseInt(lastTwo[0].slice(0, 2), 16),
            parseInt(lastTwo[0].slice(2, 4), 16),
            parseInt(lastTwo[1].slice(0, 2), 16),
            parseInt(lastTwo[1].slice(2, 4), 16)
          ].join('.');
          document.getElementById('ipv4FromIpv6').textContent = ipv4;
        } else {
          document.getElementById('ipv4FromIpv6').textContent = 'N/A';
        }

        // Determine type
        let type = '全球单播';
        if (full.startsWith('fe80')) type = '链路本地';
        else if (full.startsWith('fc') || full.startsWith('fd')) type = '唯一本地';
        else if (full.startsWith('ff')) type = '组播';
        else if (full === '0000:0000:0000:0000:0000:0000:0000:0001') type = '环回地址';
        else if (full === '0000:0000:0000:0000:0000:0000:0000:0000') type = '未指定地址';
        else if (full.startsWith('0000:0000:0000:0000:0000:ffff')) type = 'IPv4 映射';
        
        document.getElementById('ipv6Type').textContent = type;
        showStatus('处理完成', 'success');
      } catch (e) {
        showStatus('无效的 IPv6 地址', 'error');
      }
    }

    function showStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type || '');
    }

    // Event bindings
    document.getElementById('btnRefreshIp').onclick = getMyIp;
    document.getElementById('btnCopyIp').onclick = async () => {
      const ip = myIpEl.textContent;
      if (ip && ip !== '检测中...' && ip !== '无法获取') {
        try {
          await navigator.clipboard.writeText(ip);
          showStatus('IP 已复制', 'success');
        } catch (e) {
          showStatus('复制失败', 'error');
        }
      }
    };

    document.getElementById('btnConvert').onclick = convertIp;
    document.getElementById('btnPaste').onclick = async () => {
      try {
        ipInput.value = await navigator.clipboard.readText();
        showStatus('已粘贴', 'success');
      } catch (e) {
        showStatus('无法访问剪贴板', 'error');
      }
    };
    document.getElementById('btnClear').onclick = () => {
      ipInput.value = '';
      ['dotDecimal', 'decimal', 'hex', 'binary', 'octal', 'ipv6Mapped'].forEach(id => {
        document.getElementById(id).textContent = '-';
      });
      showStatus('已清空', 'success');
    };

    document.getElementById('btnCalcSubnet').onclick = calcSubnet;
    document.getElementById('btnExpandIpv6').onclick = processIPv6;

    ipInput.addEventListener('keydown', e => { if (e.key === 'Enter') convertIp(); });
    cidrInput.addEventListener('keydown', e => { if (e.key === 'Enter') calcSubnet(); });
    ipv6Input.addEventListener('keydown', e => { if (e.key === 'Enter') processIPv6(); });

    // Init
    getMyIp();
  </script>
</body>
</html>

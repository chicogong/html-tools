<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¢é˜ŸæŠ•ç¥¨å·¥å…· - WebUtils</title>
    <style>
      :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --text-color: #e0e0e0;
        --primary-color: #0f3460;
        --accent-color: #00d9ff;
        --border-color: #0f3460;
        --input-bg: #1a1a2e;
        --success-color: #4ade80;
        --warning-color: #fbbf24;
        --danger-color: #f87171;
      }

      [data-theme="light"] {
        --bg-color: #f0f4f8;
        --card-bg: #fff;
        --text-color: #1a1a2e;
        --primary-color: #e0e7ff;
        --accent-color: #0891b2;
        --border-color: #c7d2fe;
        --input-bg: #f8fafc;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 900px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--accent-color), #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-toggle {
        position: absolute;
        right: 0;
        top: 0;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
      }

      .back-link {
        position: absolute;
        left: 0;
        top: 0;
        color: var(--accent-color);
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
      }

      .panel-title {
        font-size: 1rem;
        margin-bottom: 15px;
        color: var(--accent-color);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-group input,
      .form-group textarea,
      .form-group select {
        width: 100%;
        padding: 12px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
      }

      .form-group input:focus,
      .form-group textarea:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
      }

      @media (max-width: 600px) {
        .form-row {
          grid-template-columns: 1fr;
        }
      }

      .option-item {
        display: flex;
        gap: 10px;
        align-items: center;
        padding: 12px;
        background: var(--input-bg);
        border-radius: 8px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
      }

      .option-item:hover {
        border-color: var(--accent-color);
      }

      .option-item.selected {
        border-color: var(--success-color);
        background: rgba(74, 222, 128, 0.1);
      }

      .option-item.voted {
        cursor: default;
      }

      .option-checkbox {
        width: 24px;
        height: 24px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .option-item.selected .option-checkbox {
        background: var(--success-color);
        border-color: var(--success-color);
      }

      .option-item.selected .option-checkbox::after {
        content: "âœ“";
        color: #000;
        font-weight: bold;
      }

      .option-content {
        flex: 1;
      }

      .option-text {
        font-size: 14px;
        margin-bottom: 5px;
      }

      .option-bar {
        height: 8px;
        background: var(--border-color);
        border-radius: 4px;
        overflow: hidden;
      }

      .option-bar-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color), #a855f7);
        transition: width 0.5s ease;
      }

      .option-stats {
        display: flex;
        justify-content: space-between;
        font-size: 12px;
        margin-top: 5px;
        opacity: 0.7;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--accent-color);
        color: #000;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: var(--primary-color);
        color: var(--text-color);
      }

      .btn-danger {
        background: transparent;
        color: var(--danger-color);
        padding: 6px 10px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .vote-type-toggle {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .vote-type-btn {
        flex: 1;
        padding: 12px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
      }

      .vote-type-btn.active {
        background: var(--accent-color);
        color: #000;
        border-color: var(--accent-color);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
        gap: 15px;
      }

      .stat-card {
        background: var(--input-bg);
        padding: 15px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--accent-color);
      }

      .stat-label {
        font-size: 11px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .voter-list {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        margin-top: 10px;
      }

      .voter-tag {
        background: var(--primary-color);
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
      }

      .new-option-row {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .new-option-row input {
        flex: 1;
        padding: 10px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
      }

      .vote-mode {
        padding: 10px 15px;
        background: rgba(0, 217, 255, 0.1);
        border-radius: 8px;
        display: inline-block;
        font-size: 13px;
        margin-bottom: 15px;
      }

      .winner-banner {
        background: linear-gradient(135deg, var(--success-color), #22c55e);
        color: #000;
        padding: 15px 20px;
        border-radius: 8px;
        text-align: center;
        margin-bottom: 15px;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a href="../../index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
        <h1>å›¢é˜ŸæŠ•ç¥¨å·¥å…·</h1>
        <p>å¿«é€Ÿè¿›è¡Œå›¢é˜Ÿå†³ç­–æŠ•ç¥¨</p>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“‹ æŠ•ç¥¨è®¾ç½®</div>
        <div class="form-group">
          <label>æŠ•ç¥¨ä¸»é¢˜</label>
          <input type="text" id="voteTitle" placeholder="ä¾‹å¦‚ï¼šä¸‹å‘¨å›¢å»ºæ´»åŠ¨é€‰æ‹©" />
        </div>
        <div class="form-group">
          <label>æŠ•ç¥¨ç±»å‹</label>
          <div class="vote-type-toggle">
            <button class="vote-type-btn active" onclick="setVoteType('single', this)">
              å•é€‰æŠ•ç¥¨
            </button>
            <button class="vote-type-btn" onclick="setVoteType('multi', this)">å¤šé€‰æŠ•ç¥¨</button>
            <button class="vote-type-btn" onclick="setVoteType('score', this)">è¯„åˆ†æŠ•ç¥¨</button>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>æœ€å¤§å¯é€‰æ•°é‡ (å¤šé€‰æ—¶)</label>
            <input type="number" id="maxSelections" value="3" min="1" />
          </div>
          <div class="form-group">
            <label>å½“å‰æŠ•ç¥¨äºº</label>
            <input type="text" id="voterName" placeholder="è¾“å…¥æ‚¨çš„åå­—" />
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ—³ï¸ æŠ•ç¥¨é€‰é¡¹</div>
        <div id="optionsList"></div>
        <div class="new-option-row">
          <input
            type="text"
            id="newOptionInput"
            placeholder="è¾“å…¥æ–°é€‰é¡¹"
            onkeypress="handleOptionKeypress(event)"
          />
          <button class="btn btn-secondary" onclick="addOption()">+ æ·»åŠ </button>
        </div>
      </div>

      <div class="panel" id="votingPanel" style="display: none">
        <div class="panel-title">âœ… è¿›è¡ŒæŠ•ç¥¨</div>
        <div class="vote-mode" id="voteMode">å•é€‰æ¨¡å¼ - è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹</div>
        <div id="votingOptions"></div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="submitVote()">æäº¤æŠ•ç¥¨</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“Š æŠ•ç¥¨ç»“æœ</div>
        <div id="winnerBanner"></div>
        <div id="resultsList"></div>
        <div class="stats-grid" style="margin-top: 20px">
          <div class="stat-card">
            <div class="stat-value" id="totalVoters">0</div>
            <div class="stat-label">æŠ•ç¥¨äººæ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="totalVotes">0</div>
            <div class="stat-label">æ€»ç¥¨æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="optionCount">0</div>
            <div class="stat-label">é€‰é¡¹æ•°</div>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ”§ æ“ä½œ</div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="shareLink()">ğŸ”— åˆ†äº«æŠ•ç¥¨</button>
          <button class="btn btn-secondary" onclick="exportResults()">ğŸ“¤ å¯¼å‡ºç»“æœ</button>
          <button class="btn btn-danger" onclick="resetVote()">ğŸ—‘ï¸ é‡ç½®æŠ•ç¥¨</button>
        </div>
      </div>
    </div>

    <script>
      var LS_KEY = "team-vote-data";
      var voteType = "single";
      var options = [];
      var votes = {};
      var currentSelections = [];

      function init() {
        var savedTheme = localStorage.getItem("theme") || "dark";
        if (savedTheme === "light") {
          document.body.setAttribute("data-theme", "light");
        }

        loadFromUrl() || loadFromStorage();

        if (options.length === 0) {
          options = [
            { id: generateId(), text: "é€‰é¡¹ A", score: 0 },
            { id: generateId(), text: "é€‰é¡¹ B", score: 0 },
            { id: generateId(), text: "é€‰é¡¹ C", score: 0 }
          ];
        }

        document.getElementById("voteTitle").addEventListener("input", function () {
          saveToStorage();
        });

        renderAll();
      }

      function generateId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
      }

      function setVoteType(type, btn) {
        voteType = type;
        currentSelections = [];
        document.querySelectorAll(".vote-type-btn").forEach(function (b) {
          b.classList.remove("active");
        });
        btn.classList.add("active");

        var modeText = {
          single: "å•é€‰æ¨¡å¼ - è¯·é€‰æ‹©ä¸€ä¸ªé€‰é¡¹",
          multi:
            "å¤šé€‰æ¨¡å¼ - æœ€å¤šé€‰æ‹© " + document.getElementById("maxSelections").value + " ä¸ªé€‰é¡¹",
          score: "è¯„åˆ†æ¨¡å¼ - ä¸ºæ¯ä¸ªé€‰é¡¹æ‰“åˆ† (1-5åˆ†)"
        };
        document.getElementById("voteMode").textContent = modeText[type];

        renderVotingOptions();
        saveToStorage();
      }

      function addOption() {
        var input = document.getElementById("newOptionInput");
        var text = input.value.trim();
        if (text) {
          options.push({ id: generateId(), text: text, score: 0 });
          input.value = "";
          renderAll();
          saveToStorage();
        }
      }

      function handleOptionKeypress(e) {
        if (e.key === "Enter") {
          addOption();
        }
      }

      function removeOption(id) {
        options = options.filter(function (opt) {
          return opt.id !== id;
        });
        renderAll();
        saveToStorage();
      }

      function renderAll() {
        renderOptionsList();
        renderVotingOptions();
        renderResults();
      }

      function renderOptionsList() {
        var container = document.getElementById("optionsList");
        container.textContent = "";

        options.forEach(function (opt, index) {
          var div = document.createElement("div");
          div.className = "option-item";
          div.style.cursor = "default";

          var number = document.createElement("div");
          number.className = "option-checkbox";
          number.style.background = "var(--accent-color)";
          number.style.border = "none";
          number.style.color = "#000";
          number.style.fontWeight = "bold";
          number.style.fontSize = "12px";
          number.textContent = index + 1;

          var content = document.createElement("div");
          content.className = "option-content";

          var input = document.createElement("input");
          input.type = "text";
          input.value = opt.text;
          input.style.background = "var(--card-bg)";
          input.style.border = "1px solid var(--border-color)";
          input.style.borderRadius = "6px";
          input.style.padding = "8px";
          input.style.color = "var(--text-color)";
          input.style.width = "100%";
          input.addEventListener("input", function (e) {
            opt.text = e.target.value;
            renderVotingOptions();
            renderResults();
            saveToStorage();
          });

          content.appendChild(input);

          var deleteBtn = document.createElement("button");
          deleteBtn.className = "btn btn-danger";
          deleteBtn.textContent = "Ã—";
          deleteBtn.onclick = function () {
            removeOption(opt.id);
          };

          div.appendChild(number);
          div.appendChild(content);
          div.appendChild(deleteBtn);
          container.appendChild(div);
        });

        document.getElementById("optionCount").textContent = options.length;

        if (options.length > 0) {
          document.getElementById("votingPanel").style.display = "block";
        }
      }

      function renderVotingOptions() {
        var container = document.getElementById("votingOptions");
        container.textContent = "";

        var voterName = document.getElementById("voterName").value.trim();
        var hasVoted = voterName && votes[voterName];

        options.forEach(function (opt) {
          var div = document.createElement("div");
          var isSelected = currentSelections.indexOf(opt.id) !== -1;
          div.className =
            "option-item" + (isSelected ? " selected" : "") + (hasVoted ? " voted" : "");

          if (!hasVoted) {
            div.onclick = function () {
              toggleSelection(opt.id);
            };
          }

          var checkbox = document.createElement("div");
          checkbox.className = "option-checkbox";

          var content = document.createElement("div");
          content.className = "option-content";

          var text = document.createElement("div");
          text.className = "option-text";
          text.textContent = opt.text;
          content.appendChild(text);

          if (voteType === "score" && !hasVoted) {
            var scoreRow = document.createElement("div");
            scoreRow.style.display = "flex";
            scoreRow.style.gap = "5px";
            scoreRow.style.marginTop = "8px";

            for (var i = 1; i <= 5; i++) {
              (function (score) {
                var starBtn = document.createElement("button");
                starBtn.style.cssText =
                  "width:30px;height:30px;border-radius:50%;border:1px solid var(--border-color);background:var(--input-bg);color:var(--text-color);cursor:pointer;font-size:14px;";
                starBtn.textContent = score;
                starBtn.onclick = function (e) {
                  e.stopPropagation();
                  setScore(opt.id, score);
                };
                if (getScore(opt.id) === score) {
                  starBtn.style.background = "var(--accent-color)";
                  starBtn.style.color = "#000";
                }
                scoreRow.appendChild(starBtn);
              })(i);
            }
            content.appendChild(scoreRow);
          }

          div.appendChild(checkbox);
          div.appendChild(content);
          container.appendChild(div);
        });
      }

      function toggleSelection(id) {
        if (voteType === "score") return;

        var index = currentSelections.indexOf(id);

        if (voteType === "single") {
          currentSelections = index !== -1 ? [] : [id];
        } else {
          var maxSelections = parseInt(document.getElementById("maxSelections").value) || 3;
          if (index !== -1) {
            currentSelections.splice(index, 1);
          } else if (currentSelections.length < maxSelections) {
            currentSelections.push(id);
          } else {
            showToast("æœ€å¤šåªèƒ½é€‰æ‹© " + maxSelections + " ä¸ªé€‰é¡¹");
            return;
          }
        }

        renderVotingOptions();
      }

      var scores = {};

      function setScore(optId, score) {
        scores[optId] = score;
        renderVotingOptions();
      }

      function getScore(optId) {
        return scores[optId] || 0;
      }

      function submitVote() {
        var voterName = document.getElementById("voterName").value.trim();
        if (!voterName) {
          showToast("è¯·è¾“å…¥æ‚¨çš„åå­—");
          return;
        }

        if (votes[voterName]) {
          showToast("æ‚¨å·²ç»æŠ•è¿‡ç¥¨äº†");
          return;
        }

        if (voteType === "score") {
          var hasAnyScore = options.some(function (opt) {
            return scores[opt.id] > 0;
          });
          if (!hasAnyScore) {
            showToast("è¯·è‡³å°‘ä¸ºä¸€ä¸ªé€‰é¡¹æ‰“åˆ†");
            return;
          }
          votes[voterName] = { type: "score", scores: Object.assign({}, scores) };
        } else {
          if (currentSelections.length === 0) {
            showToast("è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªé€‰é¡¹");
            return;
          }
          votes[voterName] = { type: voteType, selections: currentSelections.slice() };
        }

        currentSelections = [];
        scores = {};

        renderAll();
        saveToStorage();
        showToast("æŠ•ç¥¨æˆåŠŸï¼");
      }

      function renderResults() {
        var container = document.getElementById("resultsList");
        container.textContent = "";

        var optionVotes = {};
        var optionVoters = {};
        var optionScores = {};
        var totalVotes = 0;
        var voterNames = Object.keys(votes);

        options.forEach(function (opt) {
          optionVotes[opt.id] = 0;
          optionVoters[opt.id] = [];
          optionScores[opt.id] = 0;
        });

        voterNames.forEach(function (voter) {
          var vote = votes[voter];
          if (vote.type === "score") {
            Object.keys(vote.scores).forEach(function (optId) {
              if (optionScores[optId] !== undefined) {
                optionScores[optId] += vote.scores[optId];
                optionVoters[optId].push(voter + "(" + vote.scores[optId] + "åˆ†)");
              }
            });
          } else {
            vote.selections.forEach(function (optId) {
              if (optionVotes[optId] !== undefined) {
                optionVotes[optId]++;
                optionVoters[optId].push(voter);
                totalVotes++;
              }
            });
          }
        });

        var maxVotes = Math.max.apply(
          null,
          options.map(function (opt) {
            return voteType === "score" ? optionScores[opt.id] : optionVotes[opt.id];
          })
        );

        var winnerBanner = document.getElementById("winnerBanner");
        if (voterNames.length > 0 && maxVotes > 0) {
          var winners = options.filter(function (opt) {
            return (voteType === "score" ? optionScores[opt.id] : optionVotes[opt.id]) === maxVotes;
          });
          if (winners.length === 1) {
            winnerBanner.textContent = "ğŸ† é¢†å…ˆé€‰é¡¹: " + winners[0].text;
            winnerBanner.style.display = "block";
          } else if (winners.length > 1) {
            winnerBanner.textContent =
              "âš–ï¸ å¹³å±€: " +
              winners
                .map(function (w) {
                  return w.text;
                })
                .join(", ");
            winnerBanner.style.display = "block";
          }
        } else {
          winnerBanner.style.display = "none";
        }

        options.forEach(function (opt) {
          var div = document.createElement("div");
          div.className = "option-item";
          div.style.cursor = "default";

          var content = document.createElement("div");
          content.className = "option-content";

          var text = document.createElement("div");
          text.className = "option-text";
          text.textContent = opt.text;

          var bar = document.createElement("div");
          bar.className = "option-bar";

          var fill = document.createElement("div");
          fill.className = "option-bar-fill";
          var voteCount = voteType === "score" ? optionScores[opt.id] : optionVotes[opt.id];
          var percent = maxVotes > 0 ? (voteCount / maxVotes) * 100 : 0;
          fill.style.width = percent + "%";
          bar.appendChild(fill);

          var stats = document.createElement("div");
          stats.className = "option-stats";
          if (voteType === "score") {
            stats.textContent =
              "æ€»åˆ†: " +
              optionScores[opt.id] +
              " | å¹³å‡: " +
              (voterNames.length > 0 ? (optionScores[opt.id] / voterNames.length).toFixed(1) : 0);
          } else {
            var percentage =
              totalVotes > 0 ? ((optionVotes[opt.id] / totalVotes) * 100).toFixed(1) : 0;
            stats.textContent = optionVotes[opt.id] + " ç¥¨ (" + percentage + "%)";
          }

          content.appendChild(text);
          content.appendChild(bar);
          content.appendChild(stats);

          if (optionVoters[opt.id].length > 0) {
            var voterList = document.createElement("div");
            voterList.className = "voter-list";
            optionVoters[opt.id].forEach(function (voter) {
              var tag = document.createElement("span");
              tag.className = "voter-tag";
              tag.textContent = voter;
              voterList.appendChild(tag);
            });
            content.appendChild(voterList);
          }

          div.appendChild(content);
          container.appendChild(div);
        });

        document.getElementById("totalVoters").textContent = voterNames.length;
        document.getElementById("totalVotes").textContent = totalVotes;
      }

      function shareLink() {
        var data = {
          title: document.getElementById("voteTitle").value,
          type: voteType,
          maxSelections: parseInt(document.getElementById("maxSelections").value),
          options: options,
          votes: votes
        };

        try {
          var encoded = btoa(encodeURIComponent(JSON.stringify(data)));
          var url = location.origin + location.pathname + "#" + encoded;
          navigator.clipboard.writeText(url);
          showToast("åˆ†äº«é“¾æ¥å·²å¤åˆ¶");
        } catch (e) {
          showToast("ç”Ÿæˆé“¾æ¥å¤±è´¥");
        }
      }

      function exportResults() {
        var title = document.getElementById("voteTitle").value || "å›¢é˜ŸæŠ•ç¥¨";
        var lines = [];
        lines.push("æŠ•ç¥¨ä¸»é¢˜: " + title);
        lines.push(
          "æŠ•ç¥¨ç±»å‹: " + (voteType === "single" ? "å•é€‰" : voteType === "multi" ? "å¤šé€‰" : "è¯„åˆ†")
        );
        lines.push("æŠ•ç¥¨äººæ•°: " + Object.keys(votes).length);
        lines.push("");
        lines.push("æŠ•ç¥¨ç»“æœ:");
        lines.push("â”€".repeat(40));

        options.forEach(function (opt, index) {
          var count = 0;
          var voters = [];
          Object.keys(votes).forEach(function (voter) {
            var vote = votes[voter];
            if (vote.type === "score") {
              if (vote.scores[opt.id]) {
                count += vote.scores[opt.id];
                voters.push(voter + "(" + vote.scores[opt.id] + "åˆ†)");
              }
            } else {
              if (vote.selections.indexOf(opt.id) !== -1) {
                count++;
                voters.push(voter);
              }
            }
          });
          lines.push(
            index + 1 + ". " + opt.text + ": " + count + (voteType === "score" ? "åˆ†" : "ç¥¨")
          );
          if (voters.length > 0) {
            lines.push("   æŠ•ç¥¨äºº: " + voters.join(", "));
          }
        });

        var content = lines.join("\n");
        var blob = new Blob([content], { type: "text/plain;charset=utf-8" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = title + "_æŠ•ç¥¨ç»“æœ.txt";
        a.click();
        URL.revokeObjectURL(url);
      }

      function resetVote() {
        if (confirm("ç¡®å®šè¦é‡ç½®æ‰€æœ‰æŠ•ç¥¨æ•°æ®å—ï¼Ÿ")) {
          votes = {};
          currentSelections = [];
          scores = {};
          renderAll();
          saveToStorage();
          showToast("å·²é‡ç½®");
        }
      }

      function loadFromUrl() {
        var hash = location.hash.slice(1);
        if (!hash) return false;
        try {
          var data = JSON.parse(decodeURIComponent(atob(hash)));
          document.getElementById("voteTitle").value = data.title || "";
          voteType = data.type || "single";
          document.getElementById("maxSelections").value = data.maxSelections || 3;
          if (data.options) options = data.options;
          if (data.votes) votes = data.votes;

          document.querySelectorAll(".vote-type-btn").forEach(function (btn) {
            btn.classList.remove("active");
            if (
              btn.textContent.indexOf(
                voteType === "single" ? "å•é€‰" : voteType === "multi" ? "å¤šé€‰" : "è¯„åˆ†"
              ) !== -1
            ) {
              btn.classList.add("active");
            }
          });

          return true;
        } catch (e) {
          return false;
        }
      }

      function saveToStorage() {
        var data = {
          title: document.getElementById("voteTitle").value,
          type: voteType,
          maxSelections: parseInt(document.getElementById("maxSelections").value),
          options: options,
          votes: votes
        };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      function loadFromStorage() {
        var saved = localStorage.getItem(LS_KEY);
        if (saved) {
          try {
            var data = JSON.parse(saved);
            document.getElementById("voteTitle").value = data.title || "";
            voteType = data.type || "single";
            document.getElementById("maxSelections").value = data.maxSelections || 3;
            if (data.options) options = data.options;
            if (data.votes) votes = data.votes;

            document.querySelectorAll(".vote-type-btn").forEach(function (btn) {
              btn.classList.remove("active");
              if (
                btn.textContent.indexOf(
                  voteType === "single" ? "å•é€‰" : voteType === "multi" ? "å¤šé€‰" : "è¯„åˆ†"
                ) !== -1
              ) {
                btn.classList.add("active");
              }
            });
          } catch (e) {
            console.error("Failed to load from storage");
          }
        }
      }

      function showToast(message) {
        var toast = document.createElement("div");
        toast.style.cssText =
          "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-color);color:#000;padding:12px 24px;border-radius:8px;z-index:1000;font-size:14px;";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function () {
          toast.remove();
        }, 2000);
      }

      window.toggleTheme = function () {
        var body = document.body;
        var currentTheme = body.getAttribute("data-theme");
        var newTheme = currentTheme === "light" ? "dark" : "light";
        body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      };

      init();
    </script>
  </body>
</html>

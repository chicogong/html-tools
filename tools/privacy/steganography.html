<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å›¾ç‰‡éšå†™æœ¯å·¥å…· - WebUtils</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="å›¾ç‰‡éšå†™æœ¯å·¥å…· - WebUtils" />
    <meta name="keywords" content="steganography,privacy,tools,webutils" />
    <meta name="author" content="WebUtils" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://tools.realtime-ai.chat/tools/privacy/steganography.html" />

    <!-- Open Graph -->
    <meta property="og:title" content="å›¾ç‰‡éšå†™æœ¯å·¥å…· - WebUtils" />
    <meta property="og:description" content="å›¾ç‰‡éšå†™æœ¯å·¥å…· - WebUtils" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://tools.realtime-ai.chat/tools/privacy/steganography.html"
    />
    <meta property="og:site_name" content="WebUtils" />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:image" content="https://tools.realtime-ai.chat/social-preview.png" />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="640" />
    <meta property="og:image:type" content="image/png" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="å›¾ç‰‡éšå†™æœ¯å·¥å…· - WebUtils" />
    <meta name="twitter:description" content="å›¾ç‰‡éšå†™æœ¯å·¥å…· - WebUtils" />
    <meta name="twitter:image" content="https://tools.realtime-ai.chat/social-preview.png" />

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css" />
    <style>
      :root {
        --bg-deep: #0a0a0f;
        --bg-surface: #12121a;
        --bg-card: #1a1a24;
        --bg-input: #0e0e14;
        --text-primary: #e8e8ed;
        --text-secondary: #8888a0;
        --text-muted: #55556a;
        --border-subtle: #2a2a3a;
        --border-strong: #3a3a4a;
        --accent-cyan: #00f5d4;
        --accent-green: #10b981;
        --accent-red: #f43f5e;
        --accent-yellow: #fbbf24;
        --accent-purple: #a855f7;
        --glow-cyan: rgb(0, 245, 212, 0.15);
        --glow-green: rgb(16, 185, 129, 0.15);
        --glow-red: rgb(244, 63, 94, 0.15);
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
      }

      [data-theme='light'] {
        --bg-deep: #fafafa;
        --bg-surface: #fff;
        --bg-card: #fff;
        --bg-input: #f5f5f5;
        --bg-hover: #f5f5f5;
        --text-primary: #1a1a1a;
        --text-secondary: #666;
        --text-muted: #999;
        --border-subtle: #e5e5e5;
        --border-strong: #d5d5d5;
      }

      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--border-subtle);
        background: var(--bg-card);
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 100;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .theme-toggle:hover {
        transform: scale(1.1);
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
      }
      header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }
      .tabs {
        display: flex;
        gap: 0;
        margin-bottom: 2rem;
      }
      .tab-btn {
        flex: 1;
        padding: 1rem;
        border: 1px solid var(--pico-muted-border-color);
        background: var(--pico-background-color);
        cursor: pointer;
        transition: all 0.2s;
      }
      .tab-btn:first-child {
        border-radius: 8px 0 0 8px;
      }
      .tab-btn:last-child {
        border-radius: 0 8px 8px 0;
      }
      .tab-btn.active {
        background: var(--pico-primary);
        color: white;
        border-color: var(--pico-primary);
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }
      .panel {
        background: var(--pico-card-background-color);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
      }
      .panel h3 {
        margin-top: 0;
        margin-bottom: 1rem;
      }
      .drop-zone {
        border: 2px dashed var(--pico-muted-border-color);
        border-radius: 8px;
        padding: 3rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
      }
      .drop-zone:hover,
      .drop-zone.dragover {
        border-color: var(--pico-primary);
        background: var(--pico-secondary-background);
      }
      .drop-zone input {
        display: none;
      }
      .image-preview {
        max-width: 100%;
        max-height: 300px;
        margin-top: 1rem;
        border-radius: 8px;
      }
      .message-input {
        min-height: 100px;
        resize: vertical;
      }
      .stats-row {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        font-size: 0.9rem;
        flex-wrap: wrap;
      }
      .stat-item {
        padding: 0.5rem 1rem;
        background: var(--pico-background-color);
        border-radius: 4px;
      }
      .stat-value {
        font-weight: bold;
        color: var(--pico-primary);
      }
      .action-row {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }
      .result-panel {
        margin-top: 1.5rem;
        padding: 1rem;
        background: var(--pico-secondary-background);
        border-radius: 8px;
      }
      .result-panel h4 {
        margin-top: 0;
      }
      .decoded-message {
        padding: 1rem;
        background: var(--pico-card-background-color);
        border-radius: 4px;
        white-space: pre-wrap;
        word-break: break-all;
      }
      .warning-box {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin-bottom: 1rem;
      }
      [data-theme='dark'] .warning-box {
        background: #78350f;
      }
      .info-box {
        background: #dbeafe;
        border-left: 4px solid #3b82f6;
        padding: 1rem;
        border-radius: 0 8px 8px 0;
        margin-bottom: 1rem;
        font-size: 0.9rem;
      }
      [data-theme='dark'] .info-box {
        background: #1e3a5f;
      }
      .encryption-options {
        margin-top: 1rem;
        padding: 1rem;
        background: var(--pico-background-color);
        border-radius: 8px;
      }
      .encryption-options label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      .password-input {
        margin-top: 0.5rem;
      }
      .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--pico-muted-border-color);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 1rem;
        display: none;
      }
      .progress-bar.active {
        display: block;
      }
      .progress-fill {
        height: 100%;
        background: var(--pico-primary);
        width: 0%;
        transition: width 0.3s;
      }
      canvas {
        display: none;
      }

      .breadcrumb {
        background: rgba(255, 255, 255, 0.95);
        padding: 8px 15px;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        font-size: 0.85rem;
      }
      .breadcrumb a {
        color: #667eea;
        text-decoration: none;
      }
      .breadcrumb a:hover {
        text-decoration: underline;
      }
      .breadcrumb span {
        color: #999;
        margin: 0 5px;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="åˆ‡æ¢ä¸»é¢˜">
      <span id="theme-icon">ğŸŒ™</span>
    </button>

    <nav class="breadcrumb">
      <a href="../../index.html">é¦–é¡µ</a>
      <span>â€º</span>
      å›¾ç‰‡éšå†™æœ¯å·¥å…·
    </nav>
    <div class="container">
      <a
        href="../../index.html"
        style="
          display: inline-block;
          margin-bottom: 1rem;
          color: var(--pico-primary);
          text-decoration: none;
        "
      >
        â† è¿”å›é¦–é¡µ
      </a>
      <header>
        <h1>å›¾ç‰‡éšå†™æœ¯å·¥å…·</h1>
        <button id="themeToggle" class="outline">åˆ‡æ¢ä¸»é¢˜</button>
      </header>

      <div class="info-box">
        <strong>ä»€ä¹ˆæ˜¯éšå†™æœ¯ï¼Ÿ</strong>
        <br />
        éšå†™æœ¯æ˜¯ä¸€ç§å°†ç§˜å¯†ä¿¡æ¯éšè—åœ¨æ™®é€šè½½ä½“ï¼ˆå¦‚å›¾ç‰‡ï¼‰ä¸­çš„æŠ€æœ¯ã€‚æœ¬å·¥å…·ä½¿ç”¨LSBï¼ˆæœ€ä½æœ‰æ•ˆä½ï¼‰ç®—æ³•ï¼Œå°†ä¿¡æ¯ç¼–ç åˆ°å›¾ç‰‡åƒç´ çš„æœ€ä½ä½ä¸­ï¼Œè‚‰çœ¼æ— æ³•å¯Ÿè§‰å˜åŒ–ã€‚
      </div>

      <div class="tabs">
        <button class="tab-btn active" data-tab="encode">éšè—ä¿¡æ¯</button>
        <button class="tab-btn" data-tab="decode">æå–ä¿¡æ¯</button>
      </div>

      <!-- éšè—ä¿¡æ¯æ ‡ç­¾é¡µ -->
      <div class="tab-content active" id="encodeTab">
        <div class="panel">
          <h3>1. é€‰æ‹©è½½ä½“å›¾ç‰‡</h3>
          <div class="drop-zone" id="encodeDropZone">
            <input type="file" id="encodeFileInput" accept="image/png,image/bmp" />
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
            <small>æ”¯æŒ PNG æ ¼å¼ï¼ˆæ¨èï¼‰</small>
          </div>
          <img id="encodePreview" class="image-preview" alt="ç¼–ç é¢„è§ˆå›¾" style="display: none" />
          <div class="stats-row" id="encodeStats" style="display: none">
            <div class="stat-item">
              å°ºå¯¸:
              <span class="stat-value" id="imgSize">-</span>
            </div>
            <div class="stat-item">
              å¯éšè—å®¹é‡:
              <span class="stat-value" id="maxCapacity">-</span>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>2. è¾“å…¥è¦éšè—çš„ä¿¡æ¯</h3>
          <textarea
            id="secretMessage"
            class="message-input"
            placeholder="è¾“å…¥è¦éšè—çš„ç§˜å¯†ä¿¡æ¯..."
          ></textarea>
          <div class="stats-row">
            <div class="stat-item">
              å­—ç¬¦æ•°:
              <span class="stat-value" id="charCount">0</span>
            </div>
            <div class="stat-item">
              æ‰€éœ€å®¹é‡:
              <span class="stat-value" id="requiredCapacity">0</span>
              ä½
            </div>
          </div>

          <div class="encryption-options">
            <label>
              <input type="checkbox" id="useEncryption" />
              ä½¿ç”¨å¯†ç åŠ å¯†
            </label>
            <div id="passwordSection" style="display: none">
              <input
                type="password"
                id="encryptPassword"
                class="password-input"
                placeholder="è¾“å…¥åŠ å¯†å¯†ç "
              />
              <small>å¯†ç å°†ç”¨äºåŠ å¯†ä¿¡æ¯ï¼Œæå–æ—¶éœ€è¦ç›¸åŒå¯†ç </small>
            </div>
          </div>
        </div>

        <div class="warning-box">
          <strong>æ³¨æ„ï¼š</strong>
          ç”Ÿæˆçš„å›¾ç‰‡å¿…é¡»ä¿å­˜ä¸º PNG æ ¼å¼ã€‚JPEG ç­‰æœ‰æŸå‹ç¼©æ ¼å¼ä¼šç ´åéšè—çš„ä¿¡æ¯ã€‚
        </div>

        <div class="action-row">
          <button id="encodeBtn" disabled>ç”Ÿæˆéšå†™å›¾ç‰‡</button>
          <button id="downloadBtn" class="secondary" style="display: none">ä¸‹è½½å›¾ç‰‡</button>
        </div>

        <div class="progress-bar" id="encodeProgress">
          <div class="progress-fill" id="encodeProgressFill"></div>
        </div>

        <div class="result-panel" id="encodeResult" style="display: none">
          <h4>ç”ŸæˆæˆåŠŸ</h4>
          <img id="resultPreview" class="image-preview" alt="ç»“æœé¢„è§ˆå›¾" />
        </div>
      </div>

      <!-- æå–ä¿¡æ¯æ ‡ç­¾é¡µ -->
      <div class="tab-content" id="decodeTab">
        <div class="panel">
          <h3>é€‰æ‹©åŒ…å«éšè—ä¿¡æ¯çš„å›¾ç‰‡</h3>
          <div class="drop-zone" id="decodeDropZone">
            <input type="file" id="decodeFileInput" accept="image/png,image/bmp" />
            <p>ç‚¹å‡»æˆ–æ‹–æ‹½å›¾ç‰‡åˆ°æ­¤å¤„</p>
            <small>ä»…æ”¯æŒ PNG æ ¼å¼</small>
          </div>
          <img id="decodePreview" class="image-preview" alt="è§£ç é¢„è§ˆå›¾" style="display: none" />

          <div class="encryption-options" style="margin-top: 1rem">
            <label>
              <input type="checkbox" id="needDecryption" />
              éœ€è¦å¯†ç è§£å¯†
            </label>
            <div id="decryptSection" style="display: none">
              <input
                type="password"
                id="decryptPassword"
                class="password-input"
                placeholder="è¾“å…¥è§£å¯†å¯†ç "
              />
            </div>
          </div>
        </div>

        <div class="action-row">
          <button id="decodeBtn" disabled>æå–éšè—ä¿¡æ¯</button>
        </div>

        <div class="progress-bar" id="decodeProgress">
          <div class="progress-fill" id="decodeProgressFill"></div>
        </div>

        <div class="result-panel" id="decodeResult" style="display: none">
          <h4>æå–çš„ä¿¡æ¯</h4>
          <div class="decoded-message" id="decodedMessage"></div>
          <div class="action-row">
            <button id="copyMessageBtn" class="secondary">å¤åˆ¶ä¿¡æ¯</button>
          </div>
        </div>
      </div>
    </div>

    <canvas id="canvas"></canvas>

    <script>
      // çŠ¶æ€
      let encodeImage = null;
      let decodeImage = null;
      let encodedImageData = null;

      // æ ‡è®°å¤´ï¼ˆç”¨äºè¯†åˆ«æ˜¯å¦æœ‰éšè—æ•°æ®ï¼‰
      const MARKER = 'STEG';

      // ä¸»é¢˜åˆ‡æ¢
      document.getElementById('themeToggle').addEventListener('click', function () {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      });

      const savedTheme = localStorage.getItem('theme');
      if (savedTheme) {
        document.documentElement.setAttribute('data-theme', savedTheme);
      }

      // Tabåˆ‡æ¢
      document.querySelectorAll('.tab-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
          document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach((c) => c.classList.remove('active'));

          this.classList.add('active');
          document.getElementById(this.dataset.tab + 'Tab').classList.add('active');
        });
      });

      // æ–‡ä»¶æ‹–æ”¾
      function setupDropZone(dropZone, fileInput, callback) {
        dropZone.addEventListener('click', function () {
          fileInput.click();
        });

        dropZone.addEventListener('dragover', function (e) {
          e.preventDefault();
          this.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', function () {
          this.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', function (e) {
          e.preventDefault();
          this.classList.remove('dragover');
          const file = e.dataTransfer.files[0];
          if (file) callback(file);
        });

        fileInput.addEventListener('change', function () {
          if (this.files[0]) callback(this.files[0]);
        });
      }

      // åŠ è½½å›¾ç‰‡
      window.loadImage = function (file) {
        return new Promise(function (resolve, reject) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const img = new Image();
            img.onload = function () {
              resolve(img);
            };
            img.onerror = reject;
            img.src = e.target.result;
          };
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      };

      // å­—ç¬¦ä¸²è½¬äºŒè¿›åˆ¶
      function stringToBinary(str) {
        const encoder = new TextEncoder();
        const bytes = encoder.encode(str);
        let binary = '';
        bytes.forEach(function (byte) {
          binary += byte.toString(2).padStart(8, '0');
        });
        return binary;
      }

      // äºŒè¿›åˆ¶è½¬å­—ç¬¦ä¸²
      function binaryToString(binary) {
        const bytes = [];
        for (let i = 0; i < binary.length; i += 8) {
          const byte = binary.substr(i, 8);
          if (byte.length === 8) {
            bytes.push(parseInt(byte, 2));
          }
        }
        const decoder = new TextDecoder();
        return decoder.decode(new Uint8Array(bytes));
      }

      // ç®€å•åŠ å¯†ï¼ˆXORï¼‰
      function xorEncrypt(str, password) {
        let result = '';
        for (let i = 0; i < str.length; i++) {
          const charCode = str.charCodeAt(i) ^ password.charCodeAt(i % password.length);
          result += String.fromCharCode(charCode);
        }
        return result;
      }

      // ç¼–ç ä¿¡æ¯åˆ°å›¾ç‰‡
      function encodeMessage(imageData, message) {
        const data = imageData.data;
        const binary = stringToBinary(
          MARKER + message.length.toString().padStart(8, '0') + message
        );

        if (binary.length > (data.length / 4) * 3) {
          throw new Error('ä¿¡æ¯å¤ªé•¿ï¼Œæ— æ³•éšè—åœ¨æ­¤å›¾ç‰‡ä¸­');
        }

        let bitIndex = 0;
        for (let i = 0; i < data.length && bitIndex < binary.length; i += 4) {
          // åªä¿®æ”¹ RGB é€šé“çš„æœ€ä½ä½ï¼Œè·³è¿‡ Alpha é€šé“
          for (let j = 0; j < 3 && bitIndex < binary.length; j++) {
            const bit = parseInt(binary[bitIndex]);
            data[i + j] = (data[i + j] & 0xfe) | bit;
            bitIndex++;
          }
        }

        return imageData;
      }

      // ä»å›¾ç‰‡è§£ç ä¿¡æ¯
      function decodeMessage(imageData) {
        const data = imageData.data;
        let binary = '';

        // å…ˆæå–è¶³å¤Ÿçš„ä½æ¥æ£€æŸ¥æ ‡è®°å’Œé•¿åº¦
        for (
          let i = 0;
          i < data.length && binary.length < (MARKER.length + 8) * 8 + 1000000;
          i += 4
        ) {
          for (let j = 0; j < 3; j++) {
            binary += (data[i + j] & 1).toString();
          }
        }

        // æ£€æŸ¥æ ‡è®°
        const markerBinary = binary.substr(0, MARKER.length * 8);
        const marker = binaryToString(markerBinary);

        if (marker !== MARKER) {
          throw new Error('æœªæ£€æµ‹åˆ°éšè—ä¿¡æ¯ï¼Œæˆ–å›¾ç‰‡å·²æŸå');
        }

        // è·å–æ¶ˆæ¯é•¿åº¦
        const lengthBinary = binary.substr(MARKER.length * 8, 8 * 8);
        const messageLength = parseInt(binaryToString(lengthBinary));

        if (isNaN(messageLength) || messageLength <= 0 || messageLength > 10000000) {
          throw new Error('ä¿¡æ¯æ ¼å¼é”™è¯¯');
        }

        // æå–æ¶ˆæ¯
        const messageBinary = binary.substr((MARKER.length + 8) * 8, messageLength * 8);
        return binaryToString(messageBinary);
      }

      // è®¾ç½®ç¼–ç æ‹–æ”¾åŒº
      setupDropZone(
        document.getElementById('encodeDropZone'),
        document.getElementById('encodeFileInput'),
        async function (file) {
          try {
            encodeImage = await loadImage(file);
            document.getElementById('encodePreview').src = encodeImage.src;
            document.getElementById('encodePreview').style.display = 'block';
            document.getElementById('encodeStats').style.display = 'flex';

            document.getElementById('imgSize').textContent =
              encodeImage.width + ' Ã— ' + encodeImage.height;
            const maxBits = encodeImage.width * encodeImage.height * 3;
            const maxChars = Math.floor(maxBits / 8) - MARKER.length - 8;
            document.getElementById('maxCapacity').textContent = maxChars + ' å­—ç¬¦';

            updateEncodeButton();
          } catch (err) {
            alert('æ— æ³•åŠ è½½å›¾ç‰‡: ' + err.message);
          }
        }
      );

      // è®¾ç½®è§£ç æ‹–æ”¾åŒº
      setupDropZone(
        document.getElementById('decodeDropZone'),
        document.getElementById('decodeFileInput'),
        async function (file) {
          try {
            decodeImage = await loadImage(file);
            document.getElementById('decodePreview').src = decodeImage.src;
            document.getElementById('decodePreview').style.display = 'block';
            document.getElementById('decodeBtn').disabled = false;
            document.getElementById('decodeResult').style.display = 'none';
          } catch (err) {
            alert('æ— æ³•åŠ è½½å›¾ç‰‡: ' + err.message);
          }
        }
      );

      // æ›´æ–°ç¼–ç æŒ‰é’®çŠ¶æ€
      function updateEncodeButton() {
        const message = document.getElementById('secretMessage').value;
        document.getElementById('encodeBtn').disabled = !encodeImage || !message;
      }

      // æ¶ˆæ¯è¾“å…¥ç›‘å¬
      document.getElementById('secretMessage').addEventListener('input', function () {
        const text = this.value;
        document.getElementById('charCount').textContent = text.length;
        document.getElementById('requiredCapacity').textContent = text.length * 8;
        updateEncodeButton();
      });

      // åŠ å¯†é€‰é¡¹
      document.getElementById('useEncryption').addEventListener('change', function () {
        document.getElementById('passwordSection').style.display = this.checked ? 'block' : 'none';
      });

      document.getElementById('needDecryption').addEventListener('change', function () {
        document.getElementById('decryptSection').style.display = this.checked ? 'block' : 'none';
      });

      // ç¼–ç æŒ‰é’®
      document.getElementById('encodeBtn').addEventListener('click', function () {
        const message = document.getElementById('secretMessage').value;
        if (!encodeImage || !message) return;

        const progressBar = document.getElementById('encodeProgress');
        const progressFill = document.getElementById('encodeProgressFill');
        progressBar.classList.add('active');
        progressFill.style.width = '30%';

        setTimeout(function () {
          try {
            let finalMessage = message;

            // åŠ å¯†
            if (document.getElementById('useEncryption').checked) {
              const password = document.getElementById('encryptPassword').value;
              if (!password) {
                throw new Error('è¯·è¾“å…¥åŠ å¯†å¯†ç ');
              }
              finalMessage = 'ENC:' + xorEncrypt(message, password);
            }

            progressFill.style.width = '50%';

            const canvas = document.getElementById('canvas');
            canvas.width = encodeImage.width;
            canvas.height = encodeImage.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(encodeImage, 0, 0);

            let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);

            progressFill.style.width = '70%';

            imageData = encodeMessage(imageData, finalMessage);
            ctx.putImageData(imageData, 0, 0);

            progressFill.style.width = '90%';

            encodedImageData = canvas.toDataURL('image/png');
            document.getElementById('resultPreview').src = encodedImageData;
            document.getElementById('encodeResult').style.display = 'block';
            document.getElementById('downloadBtn').style.display = 'inline-block';

            progressFill.style.width = '100%';
            setTimeout(function () {
              progressBar.classList.remove('active');
              progressFill.style.width = '0%';
            }, 500);
          } catch (err) {
            progressBar.classList.remove('active');
            alert('ç¼–ç å¤±è´¥: ' + err.message);
          }
        }, 100);
      });

      // ä¸‹è½½æŒ‰é’®
      document.getElementById('downloadBtn').addEventListener('click', function () {
        if (!encodedImageData) return;

        const a = document.createElement('a');
        a.href = encodedImageData;
        a.download = 'steganography_' + Date.now() + '.png';
        a.click();
      });

      // è§£ç æŒ‰é’®
      document.getElementById('decodeBtn').addEventListener('click', function () {
        if (!decodeImage) return;

        const progressBar = document.getElementById('decodeProgress');
        const progressFill = document.getElementById('decodeProgressFill');
        progressBar.classList.add('active');
        progressFill.style.width = '30%';

        setTimeout(function () {
          try {
            const canvas = document.getElementById('canvas');
            canvas.width = decodeImage.width;
            canvas.height = decodeImage.height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(decodeImage, 0, 0);

            progressFill.style.width = '50%';

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let message = decodeMessage(imageData);

            progressFill.style.width = '80%';

            // æ£€æŸ¥æ˜¯å¦åŠ å¯†
            if (message.startsWith('ENC:')) {
              if (!document.getElementById('needDecryption').checked) {
                throw new Error('æ­¤ä¿¡æ¯å·²åŠ å¯†ï¼Œè¯·å‹¾é€‰"éœ€è¦å¯†ç è§£å¯†"å¹¶è¾“å…¥æ­£ç¡®å¯†ç ');
              }
              const password = document.getElementById('decryptPassword').value;
              if (!password) {
                throw new Error('è¯·è¾“å…¥è§£å¯†å¯†ç ');
              }
              message = xorEncrypt(message.substr(4), password);
            }

            document.getElementById('decodedMessage').textContent = message;
            document.getElementById('decodeResult').style.display = 'block';

            progressFill.style.width = '100%';
            setTimeout(function () {
              progressBar.classList.remove('active');
              progressFill.style.width = '0%';
            }, 500);
          } catch (err) {
            progressBar.classList.remove('active');
            alert('è§£ç å¤±è´¥: ' + err.message);
          }
        }, 100);
      });

      // å¤åˆ¶ä¿¡æ¯
      document.getElementById('copyMessageBtn').addEventListener('click', function () {
        const message = document.getElementById('decodedMessage').textContent;
        navigator.clipboard.writeText(message).then(function () {
          alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        });
      });

      // Theme toggle
      function toggleTheme() {
        const html = document.documentElement;
        const currentTheme = html.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        html.setAttribute('data-theme', newTheme);
        document.getElementById('theme-icon').textContent = newTheme === 'light' ? 'â˜€ï¸' : 'ğŸŒ™';
        localStorage.setItem('theme', newTheme);
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Schema éªŒè¯å™¨ | HTML Tools</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root { --valid-color: #22c55e; --error-color: #ef4444; }
        body { padding: 1rem; }
        .container { max-width: 1400px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        header h1 { margin: 0; font-size: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } }
        .editor-section { display: flex; flex-direction: column; }
        .editor-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .editor-header h3 { margin: 0; font-size: 1rem; }
        textarea { font-family: Monaco, Menlo, monospace; font-size: 0.85rem; min-height: 350px; resize: vertical; }
        .result-panel { margin-top: 1rem; padding: 1rem; border-radius: 8px; border: 2px solid var(--pico-muted-border-color); }
        .result-panel.valid { border-color: var(--valid-color); background: rgba(34, 197, 94, 0.1); }
        .result-panel.invalid { border-color: var(--error-color); background: rgba(239, 68, 68, 0.1); }
        .result-header { display: flex; align-items: center; gap: 0.5rem; font-weight: bold; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .result-header.valid { color: var(--valid-color); }
        .result-header.invalid { color: var(--error-color); }
        .error-list { list-style: none; padding: 0; margin: 0.5rem 0 0; }
        .error-item { padding: 0.5rem; margin-bottom: 0.5rem; background: rgba(239, 68, 68, 0.1); border-radius: 4px; border-left: 3px solid var(--error-color); }
        .error-path { font-family: monospace; font-weight: bold; color: var(--error-color); }
        .error-message { margin-top: 0.25rem; font-size: 0.9rem; }
        .schema-templates { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem; }
        .schema-templates button { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-group { display: flex; gap: 0.5rem; }
        .btn-group button { padding: 0.25rem 0.5rem; font-size: 0.75rem; margin: 0; }
        .stats { display: flex; gap: 1rem; font-size: 0.85rem; color: var(--pico-muted-color); margin-top: 0.5rem; }
        .draft-info { font-size: 0.8rem; color: var(--pico-muted-color); margin-bottom: 0.5rem; }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>ğŸ“‹ JSON Schema éªŒè¯å™¨</h1>
            <button id="themeToggle" class="outline" style="padding: 0.5rem;">ğŸŒ“</button>
        </header>
        <div class="draft-info">æ”¯æŒ JSON Schema Draft-07 éªŒè¯è§„èŒƒ</div>
        <div class="schema-templates">
            <span style="line-height: 2;">ç¤ºä¾‹æ¨¡æ¿ï¼š</span>
            <button class="outline" onclick="loadTemplate('user')">ç”¨æˆ·å¯¹è±¡</button>
            <button class="outline" onclick="loadTemplate('product')">å•†å“ä¿¡æ¯</button>
            <button class="outline" onclick="loadTemplate('api')">API å“åº”</button>
            <button class="outline" onclick="loadTemplate('config')">é…ç½®æ–‡ä»¶</button>
        </div>
        <div class="grid-2">
            <div class="editor-section">
                <div class="editor-header">
                    <h3>JSON Schema</h3>
                    <div class="btn-group">
                        <button class="outline" onclick="formatSchema()">æ ¼å¼åŒ–</button>
                        <button class="outline" onclick="clearSchema()">æ¸…ç©º</button>
                    </div>
                </div>
                <textarea id="schemaInput" placeholder="è¾“å…¥ JSON Schema...">{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "type": "object",
  "properties": {
    "name": { "type": "string", "minLength": 1 },
    "age": { "type": "integer", "minimum": 0, "maximum": 150 },
    "email": { "type": "string", "format": "email" }
  },
  "required": ["name", "email"]
}</textarea>
                <div class="stats" id="schemaStats"></div>
            </div>
            <div class="editor-section">
                <div class="editor-header">
                    <h3>JSON æ•°æ®</h3>
                    <div class="btn-group">
                        <button class="outline" onclick="formatData()">æ ¼å¼åŒ–</button>
                        <button class="outline" onclick="clearData()">æ¸…ç©º</button>
                    </div>
                </div>
                <textarea id="dataInput" placeholder="è¾“å…¥è¦éªŒè¯çš„ JSON æ•°æ®...">{
  "name": "å¼ ä¸‰",
  "age": 25,
  "email": "zhangsan@example.com"
}</textarea>
                <div class="stats" id="dataStats"></div>
            </div>
        </div>
        <div style="margin-top: 1rem; text-align: center;">
            <button id="validateBtn" onclick="validate()">ğŸ” éªŒè¯</button>
        </div>
        <div id="result" class="result-panel" style="display: none;"></div>
    </main>
    <script>
        class JSONSchemaValidator {
            constructor(schema) { this.schema = schema; this.errors = []; }
            validate(data) {
                this.errors = [];
                this.validateNode(this.schema, data, '#');
                return { valid: this.errors.length === 0, errors: this.errors };
            }
            validateNode(schema, data, path) {
                if (schema === true) return;
                if (schema === false) { this.addError(path, 'Schema ç¦æ­¢ä»»ä½•å€¼'); return; }
                if (schema.type && !this.validateType(schema.type, data, path)) return;
                if (schema.enum && !schema.enum.some(v => JSON.stringify(v) === JSON.stringify(data))) {
                    this.addError(path, 'å€¼å¿…é¡»æ˜¯ä»¥ä¸‹ä¹‹ä¸€: ' + schema.enum.map(v => JSON.stringify(v)).join(', '));
                }
                if (schema.const !== undefined && JSON.stringify(data) !== JSON.stringify(schema.const)) {
                    this.addError(path, 'å€¼å¿…é¡»ç­‰äº ' + JSON.stringify(schema.const));
                }
                const type = this.getType(data);
                if (type === 'string') this.validateString(schema, data, path);
                else if (type === 'number' || type === 'integer') this.validateNumber(schema, data, path);
                else if (type === 'array') this.validateArray(schema, data, path);
                else if (type === 'object') this.validateObject(schema, data, path);
                if (schema.allOf) schema.allOf.forEach(s => this.validateNode(s, data, path));
                if (schema.anyOf) {
                    const results = schema.anyOf.map(s => new JSONSchemaValidator(s).validate(data));
                    if (!results.some(r => r.valid)) this.addError(path, 'å€¼ä¸æ»¡è¶³ä»»ä½• anyOf æ¡ä»¶');
                }
                if (schema.oneOf) {
                    const results = schema.oneOf.map(s => new JSONSchemaValidator(s).validate(data));
                    const validCount = results.filter(r => r.valid).length;
                    if (validCount !== 1) this.addError(path, 'å€¼å¿…é¡»æ°å¥½æ»¡è¶³ä¸€ä¸ª oneOf æ¡ä»¶ï¼Œå½“å‰æ»¡è¶³ ' + validCount + ' ä¸ª');
                }
            }
            validateType(types, data, path) {
                const typeArray = Array.isArray(types) ? types : [types];
                const actualType = this.getType(data);
                for (const type of typeArray) {
                    if (type === actualType) return true;
                    if (type === 'integer' && actualType === 'number' && Number.isInteger(data)) return true;
                    if (type === 'number' && actualType === 'integer') return true;
                }
                this.addError(path, 'ç±»å‹é”™è¯¯: æœŸæœ› ' + typeArray.join(' æˆ– ') + ', å®é™…æ˜¯ ' + actualType);
                return false;
            }
            validateString(schema, data, path) {
                if (typeof data !== 'string') return;
                if (schema.minLength !== undefined && data.length < schema.minLength)
                    this.addError(path, 'å­—ç¬¦ä¸²é•¿åº¦è‡³å°‘ä¸º ' + schema.minLength + 'ï¼Œå½“å‰ä¸º ' + data.length);
                if (schema.maxLength !== undefined && data.length > schema.maxLength)
                    this.addError(path, 'å­—ç¬¦ä¸²é•¿åº¦æœ€å¤šä¸º ' + schema.maxLength + 'ï¼Œå½“å‰ä¸º ' + data.length);
                if (schema.pattern && !new RegExp(schema.pattern).test(data))
                    this.addError(path, 'å­—ç¬¦ä¸²ä¸åŒ¹é…æ­£åˆ™: ' + schema.pattern);
                if (schema.format) this.validateFormat(schema.format, data, path);
            }
            validateFormat(format, data, path) {
                const formats = {
                    'email': /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
                    'uri': /^https?:\/\/.+/, 'uuid': /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,
                    'date': /^\d{4}-\d{2}-\d{2}$/, 'date-time': /^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/,
                    'ipv4': /^(\d{1,3}\.){3}\d{1,3}$/
                };
                if (formats[format] && !formats[format].test(data))
                    this.addError(path, 'å­—ç¬¦ä¸²æ ¼å¼ä¸ç¬¦åˆ "' + format + '" è§„èŒƒ');
            }
            validateNumber(schema, data, path) {
                if (typeof data !== 'number') return;
                if (schema.minimum !== undefined && data < schema.minimum) this.addError(path, 'æ•°å€¼ä¸èƒ½å°äº ' + schema.minimum);
                if (schema.maximum !== undefined && data > schema.maximum) this.addError(path, 'æ•°å€¼ä¸èƒ½å¤§äº ' + schema.maximum);
                if (schema.exclusiveMinimum !== undefined && data <= schema.exclusiveMinimum) this.addError(path, 'æ•°å€¼å¿…é¡»å¤§äº ' + schema.exclusiveMinimum);
                if (schema.exclusiveMaximum !== undefined && data >= schema.exclusiveMaximum) this.addError(path, 'æ•°å€¼å¿…é¡»å°äº ' + schema.exclusiveMaximum);
                if (schema.multipleOf !== undefined && data % schema.multipleOf !== 0) this.addError(path, 'æ•°å€¼å¿…é¡»æ˜¯ ' + schema.multipleOf + ' çš„å€æ•°');
            }
            validateArray(schema, data, path) {
                if (!Array.isArray(data)) return;
                if (schema.minItems !== undefined && data.length < schema.minItems)
                    this.addError(path, 'æ•°ç»„è‡³å°‘éœ€è¦ ' + schema.minItems + ' é¡¹ï¼Œå½“å‰æœ‰ ' + data.length + ' é¡¹');
                if (schema.maxItems !== undefined && data.length > schema.maxItems)
                    this.addError(path, 'æ•°ç»„æœ€å¤šåªèƒ½æœ‰ ' + schema.maxItems + ' é¡¹ï¼Œå½“å‰æœ‰ ' + data.length + ' é¡¹');
                if (schema.uniqueItems) {
                    const seen = new Set();
                    data.forEach((item, i) => {
                        const str = JSON.stringify(item);
                        if (seen.has(str)) this.addError(path + '[' + i + ']', 'æ•°ç»„é¡¹å¿…é¡»å”¯ä¸€');
                        seen.add(str);
                    });
                }
                if (schema.items && !Array.isArray(schema.items)) {
                    data.forEach((item, i) => this.validateNode(schema.items, item, path + '[' + i + ']'));
                }
            }
            validateObject(schema, data, path) {
                if (typeof data !== 'object' || data === null || Array.isArray(data)) return;
                const keys = Object.keys(data);
                if (schema.required) {
                    schema.required.forEach(key => {
                        if (!(key in data)) this.addError(path, 'ç¼ºå°‘å¿…éœ€å±æ€§: ' + key);
                    });
                }
                if (schema.minProperties !== undefined && keys.length < schema.minProperties)
                    this.addError(path, 'å¯¹è±¡è‡³å°‘éœ€è¦ ' + schema.minProperties + ' ä¸ªå±æ€§ï¼Œå½“å‰æœ‰ ' + keys.length + ' ä¸ª');
                if (schema.maxProperties !== undefined && keys.length > schema.maxProperties)
                    this.addError(path, 'å¯¹è±¡æœ€å¤šåªèƒ½æœ‰ ' + schema.maxProperties + ' ä¸ªå±æ€§ï¼Œå½“å‰æœ‰ ' + keys.length + ' ä¸ª');
                if (schema.properties) {
                    Object.keys(schema.properties).forEach(key => {
                        if (key in data) this.validateNode(schema.properties[key], data[key], path + '/' + key);
                    });
                }
                if (schema.additionalProperties === false) {
                    const definedKeys = new Set(Object.keys(schema.properties || {}));
                    keys.forEach(key => {
                        if (!definedKeys.has(key)) this.addError(path, 'ä¸å…è®¸é¢å¤–å±æ€§: ' + key);
                    });
                }
            }
            getType(value) {
                if (value === null) return 'null';
                if (Array.isArray(value)) return 'array';
                if (typeof value === 'number') return Number.isInteger(value) ? 'integer' : 'number';
                return typeof value;
            }
            addError(path, message) { this.errors.push({ path, message }); }
        }
        const templates = {
            user: {
                schema: { '$schema': 'http://json-schema.org/draft-07/schema#', 'type': 'object',
                    'properties': { 'id': { 'type': 'integer', 'minimum': 1 }, 'username': { 'type': 'string', 'minLength': 3, 'maxLength': 20 },
                        'email': { 'type': 'string', 'format': 'email' }, 'age': { 'type': 'integer', 'minimum': 0, 'maximum': 150 },
                        'role': { 'type': 'string', 'enum': ['admin', 'user', 'guest'] } }, 'required': ['id', 'username', 'email'] },
                data: { 'id': 1, 'username': 'john_doe', 'email': 'john@example.com', 'age': 28, 'role': 'user' }
            },
            product: {
                schema: { '$schema': 'http://json-schema.org/draft-07/schema#', 'type': 'object',
                    'properties': { 'sku': { 'type': 'string', 'pattern': '^[A-Z]{3}-\\d{4}$' }, 'name': { 'type': 'string', 'minLength': 1 },
                        'price': { 'type': 'number', 'minimum': 0 }, 'stock': { 'type': 'integer', 'minimum': 0 },
                        'tags': { 'type': 'array', 'items': { 'type': 'string' }, 'uniqueItems': true } }, 'required': ['sku', 'name', 'price'] },
                data: { 'sku': 'ABC-1234', 'name': 'æ™ºèƒ½æ‰‹è¡¨', 'price': 299.99, 'stock': 100, 'tags': ['ç”µå­äº§å“', 'æ™ºèƒ½ç©¿æˆ´'] }
            },
            api: {
                schema: { '$schema': 'http://json-schema.org/draft-07/schema#', 'type': 'object',
                    'properties': { 'code': { 'type': 'integer' }, 'message': { 'type': 'string' }, 'data': { 'type': ['object', 'array', 'null'] },
                        'timestamp': { 'type': 'string', 'format': 'date-time' }, 'requestId': { 'type': 'string', 'format': 'uuid' } },
                    'required': ['code', 'message'] },
                data: { 'code': 200, 'message': 'success', 'data': { 'items': [] }, 'timestamp': '2024-01-15T10:30:00Z', 'requestId': '550e8400-e29b-41d4-a716-446655440000' }
            },
            config: {
                schema: { '$schema': 'http://json-schema.org/draft-07/schema#', 'type': 'object',
                    'properties': { 'server': { 'type': 'object', 'properties': { 'host': { 'type': 'string' }, 'port': { 'type': 'integer', 'minimum': 1, 'maximum': 65535 } }, 'required': ['host', 'port'] },
                        'database': { 'type': 'object', 'properties': { 'url': { 'type': 'string', 'format': 'uri' }, 'poolSize': { 'type': 'integer', 'minimum': 1 } }, 'required': ['url'] } },
                    'required': ['server'] },
                data: { 'server': { 'host': 'localhost', 'port': 8080 }, 'database': { 'url': 'https://db.example.com', 'poolSize': 10 } }
            }
        };
        window.loadTemplate = function(name) {
            const t = templates[name];
            if (t) { document.getElementById('schemaInput').value = JSON.stringify(t.schema, null, 2);
                document.getElementById('dataInput').value = JSON.stringify(t.data, null, 2); updateStats(); }
        };
        window.formatSchema = function() {
            try { const s = JSON.parse(document.getElementById('schemaInput').value);
                document.getElementById('schemaInput').value = JSON.stringify(s, null, 2);
            } catch (e) { alert('Schema JSON æ ¼å¼é”™è¯¯: ' + e.message); }
        };
        window.formatData = function() {
            try { const d = JSON.parse(document.getElementById('dataInput').value);
                document.getElementById('dataInput').value = JSON.stringify(d, null, 2);
            } catch (e) { alert('æ•°æ® JSON æ ¼å¼é”™è¯¯: ' + e.message); }
        };
        window.clearSchema = function() { document.getElementById('schemaInput').value = ''; updateStats(); };
        window.clearData = function() { document.getElementById('dataInput').value = ''; updateStats(); };
        window.validate = function() {
            const schemaInput = document.getElementById('schemaInput').value.trim();
            const dataInput = document.getElementById('dataInput').value.trim();
            const resultPanel = document.getElementById('result');
            if (!schemaInput || !dataInput) {
                resultPanel.style.display = 'block'; resultPanel.className = 'result-panel invalid';
                resultPanel.textContent = 'âš ï¸ è¯·è¾“å…¥ JSON Schema å’Œè¦éªŒè¯çš„æ•°æ®'; return;
            }
            let schema, data;
            try { schema = JSON.parse(schemaInput); } catch (e) {
                resultPanel.style.display = 'block'; resultPanel.className = 'result-panel invalid';
                resultPanel.textContent = 'âŒ Schema è§£æé”™è¯¯: ' + e.message; return;
            }
            try { data = JSON.parse(dataInput); } catch (e) {
                resultPanel.style.display = 'block'; resultPanel.className = 'result-panel invalid';
                resultPanel.textContent = 'âŒ æ•°æ®è§£æé”™è¯¯: ' + e.message; return;
            }
            const validator = new JSONSchemaValidator(schema);
            const result = validator.validate(data);
            resultPanel.style.display = 'block';
            if (result.valid) {
                resultPanel.className = 'result-panel valid';
                resultPanel.textContent = 'âœ… éªŒè¯é€šè¿‡ - æ•°æ®å®Œå…¨ç¬¦åˆ Schema å®šä¹‰';
            } else {
                resultPanel.className = 'result-panel invalid';
                const errorDiv = document.createElement('div');
                const header = document.createElement('div');
                header.className = 'result-header invalid';
                header.textContent = 'âŒ éªŒè¯å¤±è´¥ (' + result.errors.length + ' ä¸ªé”™è¯¯)';
                errorDiv.appendChild(header);
                const list = document.createElement('ul');
                list.className = 'error-list';
                result.errors.forEach(err => {
                    const li = document.createElement('li');
                    li.className = 'error-item';
                    const pathDiv = document.createElement('div');
                    pathDiv.className = 'error-path';
                    pathDiv.textContent = err.path;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = 'error-message';
                    msgDiv.textContent = err.message;
                    li.appendChild(pathDiv);
                    li.appendChild(msgDiv);
                    list.appendChild(li);
                });
                errorDiv.appendChild(list);
                resultPanel.textContent = '';
                resultPanel.appendChild(errorDiv);
            }
        };
        function updateStats() {
            try { const s = JSON.parse(document.getElementById('schemaInput').value);
                const propCount = s.properties ? Object.keys(s.properties).length : 0;
                const reqCount = s.required ? s.required.length : 0;
                document.getElementById('schemaStats').textContent = propCount + ' ä¸ªå±æ€§, ' + reqCount + ' ä¸ªå¿…éœ€';
            } catch { document.getElementById('schemaStats').textContent = ''; }
            try { const d = JSON.parse(document.getElementById('dataInput').value);
                const keyCount = typeof d === 'object' && d !== null ? Object.keys(d).length : 0;
                document.getElementById('dataStats').textContent = keyCount + ' ä¸ªå­—æ®µ';
            } catch { document.getElementById('dataStats').textContent = ''; }
        }
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        themeToggle.addEventListener('click', () => {
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        });
        document.getElementById('schemaInput').addEventListener('input', updateStats);
        document.getElementById('dataInput').addEventListener('input', updateStats);
        updateStats();
    </script>
</body>
</html>

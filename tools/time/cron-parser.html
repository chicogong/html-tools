<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cron 表达式验证器 - WebUtils</title>
  <style>
    :root {
      --bg: #f8f9fa;
      --card-bg: #fff;
      --text: #212529;
      --text-muted: #6c757d;
      --border: #dee2e6;
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --success: #198754;
      --danger: #dc3545;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      min-height: 100vh;
    }
    .container { max-width: 900px; margin: 0 auto; }
    .back-link {
      display: inline-block;
      margin-bottom: 16px;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }
    h1 { font-size: 1.75rem; margin: 0 0 8px; }
    .desc { color: var(--text-muted); margin: 0 0 24px; font-size: 0.95rem; }
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 20px;
    }
    .input-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.95rem;
    }
    .input-row {
      display: flex;
      gap: 12px;
    }
    .input-row input {
      flex: 1;
      padding: 12px 16px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 1.1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
    }
    .input-row input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(13,110,253,0.15);
    }
    button {
      padding: 10px 16px;
      font-size: 0.95rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { border-color: var(--primary); color: var(--primary); }
    button.primary {
      background: var(--primary);
      border-color: var(--primary);
      color: #fff;
    }
    button.primary:hover {
      background: var(--primary-hover);
      border-color: var(--primary-hover);
      color: #fff;
    }
    .description {
      background: var(--bg);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 20px;
      font-size: 1rem;
    }
    .description.valid {
      border-left: 4px solid var(--success);
    }
    .description.invalid {
      border-left: 4px solid var(--danger);
      color: var(--danger);
    }
    .next-runs {
      margin-bottom: 20px;
    }
    .next-runs h3 {
      font-size: 1rem;
      margin: 0 0 12px;
    }
    .run-item {
      padding: 10px 12px;
      background: var(--bg);
      border-radius: var(--radius);
      margin-bottom: 8px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 0.9rem;
    }
    .fields-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }
    @media (max-width: 600px) {
      .fields-grid { grid-template-columns: repeat(3, 1fr); }
    }
    .field-item {
      text-align: center;
      padding: 12px 8px;
      background: var(--bg);
      border-radius: var(--radius);
    }
    .field-item .label {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .field-item .value {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 0.9rem;
      font-weight: 600;
    }
    .presets {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid var(--border);
    }
    .presets h3 {
      font-size: 1rem;
      margin: 0 0 12px;
    }
    .preset-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }
    .preset-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg);
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
    }
    .preset-item:hover {
      background: #e9ecef;
    }
    .preset-item .expr {
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      color: var(--primary);
    }
    .status {
      font-size: 0.85rem;
      margin-top: 12px;
      min-height: 20px;
    }
    .status.success { color: var(--success); }
    footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.85rem;
    }
    footer a { color: var(--primary); text-decoration: none; }
    footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <a href="../../index.html" class="back-link">← 返回工具列表</a>
    <h1>Cron 表达式验证器</h1>
    <p class="desc">解析 Cron 表达式，显示人类可读的描述和下次执行时间</p>

    <div class="card">
      <div class="input-group">
        <label for="cronInput">Cron 表达式 (5 或 6 个字段)</label>
        <div class="input-row">
          <input type="text" id="cronInput" value="0 0 * * *" placeholder="* * * * *" />
          <button id="btnParse" class="primary">解析</button>
        </div>
      </div>

      <div class="fields-grid" id="fieldsGrid">
        <div class="field-item"><div class="label">分钟</div><div class="value" id="f-min">0</div></div>
        <div class="field-item"><div class="label">小时</div><div class="value" id="f-hour">0</div></div>
        <div class="field-item"><div class="label">日</div><div class="value" id="f-day">*</div></div>
        <div class="field-item"><div class="label">月</div><div class="value" id="f-month">*</div></div>
        <div class="field-item"><div class="label">星期</div><div class="value" id="f-dow">*</div></div>
        <div class="field-item"><div class="label">秒(可选)</div><div class="value" id="f-sec">-</div></div>
      </div>

      <div class="description" id="description">每天 00:00 执行</div>

      <div class="next-runs">
        <h3>下次执行时间</h3>
        <div id="nextRuns"></div>
      </div>

      <div id="status" class="status"></div>

      <div class="presets">
        <h3>常用表达式（点击使用）</h3>
        <div class="preset-grid" id="presetGrid"></div>
      </div>
    </div>

    <footer>
      <a href="https://github.com/chicogong/html-tools" target="_blank" rel="noreferrer">View source</a>
      · 纯前端工具 · 无服务器 · 
      <a href="../../index.html">WebUtils</a>
    </footer>
  </div>

  <script>
    const cronInput = document.getElementById('cronInput');
    const descriptionEl = document.getElementById('description');
    const nextRunsEl = document.getElementById('nextRuns');
    const statusEl = document.getElementById('status');
    const presetGrid = document.getElementById('presetGrid');

    const PRESETS = [
      ['* * * * *', '每分钟'],
      ['0 * * * *', '每小时'],
      ['0 0 * * *', '每天 00:00'],
      ['0 12 * * *', '每天 12:00'],
      ['0 0 * * 0', '每周日 00:00'],
      ['0 0 * * 1', '每周一 00:00'],
      ['0 0 1 * *', '每月1日 00:00'],
      ['0 0 1 1 *', '每年1月1日'],
      ['*/5 * * * *', '每5分钟'],
      ['*/15 * * * *', '每15分钟'],
      ['0 */2 * * *', '每2小时'],
      ['0 9-17 * * 1-5', '工作日 9-17点整']
    ];

    const DAYS = ['日', '一', '二', '三', '四', '五', '六'];
    const MONTHS = ['', '1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];

    function parseCron(expr) {
      const parts = expr.trim().split(/\s+/);
      
      if (parts.length < 5 || parts.length > 6) {
        return { valid: false, error: '需要 5 或 6 个字段' };
      }

      const hasSeconds = parts.length === 6;
      const offset = hasSeconds ? 1 : 0;

      const fields = {
        second: hasSeconds ? parts[0] : null,
        minute: parts[offset],
        hour: parts[offset + 1],
        day: parts[offset + 2],
        month: parts[offset + 3],
        dow: parts[offset + 4]
      };

      // 验证字段格式
      const validations = {
        minute: { min: 0, max: 59, name: '分钟' },
        hour: { min: 0, max: 23, name: '小时' },
        day: { min: 1, max: 31, name: '日' },
        month: { min: 1, max: 12, name: '月' },
        dow: { min: 0, max: 7, name: '星期' }
      };

      if (hasSeconds) {
        validations.second = { min: 0, max: 59, name: '秒' };
      }

      for (const [field, rules] of Object.entries(validations)) {
        if (!validateField(fields[field], rules.min, rules.max)) {
          return { valid: false, error: rules.name + ' 字段格式无效' };
        }
      }

      return { valid: true, fields, hasSeconds };
    }

    function validateField(value, min, max) {
      if (value === '*') return true;
      
      // 支持 */n 格式
      if (/^\*\/\d+$/.test(value)) {
        const step = parseInt(value.slice(2));
        return step > 0 && step <= max;
      }

      // 支持范围 n-m
      if (/^\d+-\d+$/.test(value)) {
        const [start, end] = value.split('-').map(Number);
        return start >= min && end <= max && start <= end;
      }

      // 支持列表 n,m,p
      if (/^[\d,]+$/.test(value)) {
        return value.split(',').every(n => {
          const num = parseInt(n);
          return num >= min && num <= max;
        });
      }

      // 支持组合 n-m/s
      if (/^\d+-\d+\/\d+$/.test(value)) {
        return true;
      }

      // 单个数字
      if (/^\d+$/.test(value)) {
        const num = parseInt(value);
        return num >= min && num <= max;
      }

      return false;
    }

    function describeField(value, type) {
      if (value === '*') return '每' + type;
      if (value.startsWith('*/')) return '每 ' + value.slice(2) + ' ' + type;
      if (value.includes('-')) {
        const [start, end] = value.split('-');
        return start + '-' + end + ' ' + type;
      }
      if (value.includes(',')) return value + ' ' + type;
      return value + ' ' + type;
    }

    function describeCron(result) {
      if (!result.valid) return result.error;

      const { fields, hasSeconds } = result;
      let desc = '';

      // 简化描述逻辑
      const isAll = (f) => f === '*';
      const isEvery = (f) => f && f.startsWith('*/');

      if (isAll(fields.minute) && isAll(fields.hour) && isAll(fields.day) && isAll(fields.month) && isAll(fields.dow)) {
        desc = '每分钟执行';
      } else if (fields.minute === '0' && isAll(fields.hour) && isAll(fields.day) && isAll(fields.month) && isAll(fields.dow)) {
        desc = '每小时整点执行';
      } else if (fields.minute === '0' && fields.hour === '0' && isAll(fields.day) && isAll(fields.month) && isAll(fields.dow)) {
        desc = '每天 00:00 执行';
      } else if (isEvery(fields.minute)) {
        desc = '每 ' + fields.minute.slice(2) + ' 分钟执行';
      } else {
        // 通用描述
        const parts = [];
        if (!isAll(fields.month)) parts.push(fields.month + '月');
        if (!isAll(fields.day)) parts.push(fields.day + '日');
        if (!isAll(fields.dow)) {
          const dow = fields.dow.split(',').map(d => '周' + DAYS[parseInt(d) % 7]).join('、');
          parts.push(dow);
        }
        if (!isAll(fields.hour) || !isAll(fields.minute)) {
          parts.push(fields.hour + ':' + fields.minute.padStart(2, '0'));
        }
        desc = parts.join(' ') + ' 执行';
      }

      if (hasSeconds && fields.second !== '0') {
        desc += ' (秒: ' + fields.second + ')';
      }

      return desc;
    }

    function getNextRuns(expr, count = 5) {
      const result = parseCron(expr);
      if (!result.valid) return [];

      const { fields, hasSeconds } = result;
      const runs = [];
      let date = new Date();
      date.setSeconds(0);
      date.setMilliseconds(0);

      const maxIterations = 10000;
      let iterations = 0;

      while (runs.length < count && iterations < maxIterations) {
        iterations++;
        date = new Date(date.getTime() + 60000); // 增加1分钟

        if (matchesCron(date, fields)) {
          runs.push(new Date(date));
        }
      }

      return runs;
    }

    function matchesCron(date, fields) {
      return matchField(date.getMinutes(), fields.minute) &&
             matchField(date.getHours(), fields.hour) &&
             matchField(date.getDate(), fields.day) &&
             matchField(date.getMonth() + 1, fields.month) &&
             matchField(date.getDay(), fields.dow);
    }

    function matchField(value, pattern) {
      if (pattern === '*') return true;
      if (pattern.startsWith('*/')) {
        const step = parseInt(pattern.slice(2));
        return value % step === 0;
      }
      if (pattern.includes('-')) {
        const [start, end] = pattern.split('-').map(Number);
        return value >= start && value <= end;
      }
      if (pattern.includes(',')) {
        return pattern.split(',').map(Number).includes(value);
      }
      return parseInt(pattern) === value;
    }

    function parse() {
      const expr = cronInput.value.trim();
      const result = parseCron(expr);

      // 更新字段显示
      if (result.valid) {
        document.getElementById('f-min').textContent = result.fields.minute;
        document.getElementById('f-hour').textContent = result.fields.hour;
        document.getElementById('f-day').textContent = result.fields.day;
        document.getElementById('f-month').textContent = result.fields.month;
        document.getElementById('f-dow').textContent = result.fields.dow;
        document.getElementById('f-sec').textContent = result.fields.second || '-';
      }

      // 更新描述
      const desc = describeCron(result);
      descriptionEl.textContent = desc;
      descriptionEl.className = 'description ' + (result.valid ? 'valid' : 'invalid');

      // 更新下次执行时间
      nextRunsEl.textContent = '';
      if (result.valid) {
        const runs = getNextRuns(expr);
        runs.forEach(date => {
          const div = document.createElement('div');
          div.className = 'run-item';
          div.textContent = formatDate(date);
          nextRunsEl.appendChild(div);
        });
        showStatus('解析成功', 'success');
      } else {
        const div = document.createElement('div');
        div.className = 'run-item';
        div.textContent = '无法计算';
        nextRunsEl.appendChild(div);
        showStatus(result.error, 'error');
      }

      // 保存到 URL
      history.replaceState(null, '', '#' + encodeURIComponent(expr));
    }

    function formatDate(date) {
      const pad = (n) => n.toString().padStart(2, '0');
      return date.getFullYear() + '-' + 
             pad(date.getMonth() + 1) + '-' + 
             pad(date.getDate()) + ' ' + 
             pad(date.getHours()) + ':' + 
             pad(date.getMinutes()) + ' 周' + DAYS[date.getDay()];
    }

    function showStatus(msg, type) {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + (type || '');
    }

    // 渲染预设
    PRESETS.forEach(([expr, desc]) => {
      const item = document.createElement('div');
      item.className = 'preset-item';
      item.onclick = () => {
        cronInput.value = expr;
        parse();
      };

      const exprSpan = document.createElement('span');
      exprSpan.className = 'expr';
      exprSpan.textContent = expr;

      const descSpan = document.createElement('span');
      descSpan.textContent = desc;

      item.appendChild(exprSpan);
      item.appendChild(descSpan);
      presetGrid.appendChild(item);
    });

    // 事件绑定
    document.getElementById('btnParse').onclick = parse;
    cronInput.addEventListener('keyup', (e) => {
      if (e.key === 'Enter') parse();
    });

    // 从 URL 加载
    const hash = decodeURIComponent(location.hash.slice(1));
    if (hash) {
      cronInput.value = hash;
    }

    // 初始解析
    parse();
  </script>
</body>
</html>

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>条形码标签 - WebUtils</title>

    <!-- SEO Meta Tags -->
    <meta name="description" content="生成条形码标签，支持 Code128 编码" />
    <meta name="keywords" content="条形码 barcode label 标签 打印" />
    <meta name="author" content="WebUtils" />
    <meta name="robots" content="index, follow" />
    <link
      rel="canonical"
      href="https://tools.realtime-ai.chat/tools/office/barcode-label.html"
    />

    <!-- Open Graph -->
    <meta property="og:title" content="条形码标签 - WebUtils" />
    <meta property="og:description" content="生成条形码标签，支持 Code128 编码" />
    <meta property="og:type" content="website" />
    <meta
      property="og:url"
      content="https://tools.realtime-ai.chat/tools/office/barcode-label.html"
    />
    <meta property="og:site_name" content="WebUtils" />
    <meta property="og:locale" content="zh_CN" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="条形码标签 - WebUtils" />
    <meta name="twitter:description" content="生成条形码标签，支持 Code128 编码" />

    <!-- Preload fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
      rel="stylesheet"
    />

    <style>
      /* ============================================
         Design System - CSS Variables
         ============================================ */
      :root {
        /* Dark Theme (Default) */
        --color-bg-deep: #0a0a0f;
        --color-bg-surface: #1a1a22;
        --color-bg-subtle: #242430;
        --color-bg-input: #0e0e14;
        --color-text-primary: #f5f5f7;
        --color-text-secondary: #a1a1aa;
        --color-text-muted: #71717a;
        --color-border-default: rgba(255, 255, 255, 0.08);
        --color-border-subtle: rgba(255, 255, 255, 0.04);
        --color-border-strong: rgba(255, 255, 255, 0.12);
        --color-accent-primary: #00d4aa;
        --color-accent-secondary: #8b5cf6;
        --color-accent-tertiary: #3b82f6;
        --color-success: #22c55e;
        --color-warning: #f59e0b;
        --color-error: #ef4444;

        /* Glassmorphism */
        --glass-bg: rgba(26, 26, 34, 0.72);
        --glass-border: rgba(255, 255, 255, 0.08);
        --glass-blur: 24px;
        --glass-saturate: 180%;

        /* Shadows */
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.4);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
        --shadow-glow: 0 0 20px rgba(0, 212, 170, 0.15);

        /* Spacing */
        --space-1: 4px;
        --space-2: 8px;
        --space-3: 12px;
        --space-4: 16px;
        --space-5: 20px;
        --space-6: 24px;
        --space-8: 32px;

        /* Border Radius */
        --radius-sm: 6px;
        --radius-md: 10px;
        --radius-lg: 16px;
        --radius-xl: 24px;
        --radius-full: 9999px;

        /* Typography */
        --font-sans: "Inter", -apple-system, blinkmacsystemfont, "Segoe UI", sans-serif;
        --font-mono: "JetBrains Mono", "SF Mono", "Fira Code", monospace;

        /* Transitions */
        --transition-fast: 150ms ease;
        --transition-normal: 250ms ease;

        /* Layout */
        --nav-height: 56px;
        --container-max: 900px;
        --safe-area-top: env(safe-area-inset-top, 0px);
        --safe-area-bottom: env(safe-area-inset-bottom, 0px);
      }

      /* Light Theme */
      [data-theme="light"] {
        --color-bg-deep: #f8fafc;
        --color-bg-surface: #fff;
        --color-bg-subtle: #f1f5f9;
        --color-bg-input: #f8fafc;
        --color-text-primary: #0f172a;
        --color-text-secondary: #475569;
        --color-text-muted: #94a3b8;
        --color-border-default: rgba(0, 0, 0, 0.08);
        --color-border-subtle: rgba(0, 0, 0, 0.04);
        --color-border-strong: rgba(0, 0, 0, 0.12);
        --color-accent-primary: #00b894;
        --glass-bg: rgba(255, 255, 255, 0.78);
        --glass-border: rgba(0, 0, 0, 0.06);
        --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.06);
        --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
        --shadow-glow: 0 0 20px rgba(0, 184, 148, 0.12);
      }

      /* ============================================
         Base Styles
         ============================================ */
      *,
      *::before,
      *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html {
        font-size: 16px;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        font-family: var(--font-sans);
        background: var(--color-bg-deep);
        color: var(--color-text-primary);
        min-height: 100vh;
        min-height: 100dvh;
        line-height: 1.5;
        transition:
          background-color var(--transition-normal),
          color var(--transition-normal);
      }

      /* Subtle background gradient */
      body::before {
        content: "";
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 0;
        background:
          radial-gradient(circle at 20% 20%, rgba(0, 212, 170, 0.03) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.03) 0%, transparent 50%);
      }

      [data-theme="light"] body::before {
        background:
          radial-gradient(circle at 20% 20%, rgba(0, 184, 148, 0.05) 0%, transparent 50%),
          radial-gradient(circle at 80% 80%, rgba(124, 58, 237, 0.05) 0%, transparent 50%);
      }

      /* ============================================
         Navigation Bar
         ============================================ */
      .nav-bar {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        z-index: 1000;
        height: calc(var(--nav-height) + var(--safe-area-top));
        padding-top: var(--safe-area-top);
        background: var(--glass-bg);
        backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
        -webkit-backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
        border-bottom: 1px solid var(--glass-border);
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background var(--transition-normal);
      }

      .nav-content {
        width: 100%;
        max-width: var(--container-max);
        height: var(--nav-height);
        padding: 0 var(--space-6);
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        align-items: center;
        gap: var(--space-4);
      }

      /* Back Button */
      .nav-back {
        display: flex;
        align-items: center;
        gap: var(--space-1);
        color: var(--color-accent-primary);
        text-decoration: none;
        font-size: 0.9375rem;
        font-weight: 500;
        padding: var(--space-2) var(--space-1);
        margin-left: calc(var(--space-2) * -1);
        border-radius: var(--radius-sm);
        transition: all var(--transition-fast);
        justify-self: start;
      }

      .nav-back:hover {
        background: var(--color-border-subtle);
      }

      .nav-back-icon {
        width: 20px;
        height: 20px;
        stroke-width: 2.5;
      }

      .nav-back-text {
        display: inline;
      }

      /* Nav Title */
      .nav-title {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-text-primary);
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* Nav Actions */
      .nav-actions {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        justify-self: end;
      }

      /* Theme Toggle */
      .theme-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 36px;
        height: 36px;
        border: none;
        border-radius: var(--radius-full);
        background: var(--color-bg-subtle);
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all var(--transition-fast);
      }

      .theme-toggle:hover {
        background: var(--color-border-strong);
        color: var(--color-text-primary);
        transform: scale(1.05);
      }

      .theme-toggle svg {
        width: 18px;
        height: 18px;
      }

      .theme-icon-dark,
      .theme-icon-light {
        display: none;
      }

      [data-theme="dark"] .theme-icon-light,
      :root:not([data-theme]) .theme-icon-light {
        display: block;
      }

      [data-theme="light"] .theme-icon-dark {
        display: block;
      }

      /* ============================================
         Main Content
         ============================================ */
      .main-content {
        position: relative;
        z-index: 1;
        min-height: 100vh;
        min-height: 100dvh;
        padding-top: calc(var(--nav-height) + var(--safe-area-top) + var(--space-6));
        padding-bottom: calc(var(--space-8) + var(--safe-area-bottom));
        padding-left: var(--space-6);
        padding-right: var(--space-6);
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .container {
        width: 100%;
        max-width: var(--container-max);
      }

      /* ============================================
         Card Styles
         ============================================ */
      .card {
        background: var(--glass-bg);
        backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
        -webkit-backdrop-filter: saturate(var(--glass-saturate)) blur(var(--glass-blur));
        border: 1px solid var(--color-border-default);
        border-radius: var(--radius-lg);
        padding: var(--space-6);
        margin-bottom: var(--space-5);
        box-shadow: var(--shadow-md);
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: var(--space-5);
        color: var(--color-text-primary);
      }

      /* ============================================
         Form Elements
         ============================================ */
      .input-group {
        margin-bottom: var(--space-4);
      }

      .input-group label {
        display: block;
        font-weight: 500;
        margin-bottom: var(--space-2);
        font-size: 0.9375rem;
        color: var(--color-text-secondary);
      }

      input[type="text"],
      input[type="number"],
      select {
        padding: var(--space-3) var(--space-4);
        font-size: 0.9375rem;
        border: 1px solid var(--color-border-default);
        border-radius: var(--radius-md);
        background: var(--color-bg-input);
        color: var(--color-text-primary);
        transition: all var(--transition-fast);
        font-family: var(--font-mono);
      }

      input[type="text"] {
        width: 100%;
      }

      input[type="number"] {
        width: 100px;
      }

      select {
        min-width: 150px;
        cursor: pointer;
        font-family: var(--font-sans);
      }

      input:focus,
      select:focus {
        outline: none;
        border-color: var(--color-accent-primary);
        box-shadow: 0 0 0 3px rgba(0, 212, 170, 0.1);
      }

      .form-row {
        display: flex;
        gap: var(--space-4);
        flex-wrap: wrap;
        align-items: flex-end;
      }

      .checkbox-group {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-bottom: var(--space-4);
      }

      .checkbox-group input[type="checkbox"] {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }

      .checkbox-group label {
        font-size: 0.9375rem;
        color: var(--color-text-secondary);
        cursor: pointer;
      }

      /* Buttons */
      button {
        padding: var(--space-3) var(--space-4);
        font-size: 0.9375rem;
        font-weight: 500;
        border: 1px solid var(--color-border-default);
        border-radius: var(--radius-md);
        background: var(--color-bg-subtle);
        color: var(--color-text-primary);
        cursor: pointer;
        transition: all var(--transition-fast);
        font-family: var(--font-sans);
      }

      button:hover {
        border-color: var(--color-accent-primary);
        background: var(--color-bg-surface);
        transform: translateY(-1px);
      }

      button:active {
        transform: translateY(0);
      }

      button.primary {
        background: var(--color-accent-primary);
        border-color: var(--color-accent-primary);
        color: #fff;
        font-weight: 600;
      }

      button.primary:hover {
        background: #00c299;
        border-color: #00c299;
        box-shadow: var(--shadow-glow);
      }

      button.success {
        background: var(--color-success);
        border-color: var(--color-success);
        color: #fff;
        font-weight: 600;
      }

      button.success:hover {
        background: #16a34a;
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.15);
      }

      .btn-row {
        display: flex;
        gap: var(--space-3);
        flex-wrap: wrap;
        margin-top: var(--space-4);
      }

      /* ============================================
         Barcode Preview
         ============================================ */
      .barcode-preview {
        background: white;
        border-radius: var(--radius-md);
        padding: var(--space-6);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 200px;
      }

      #barcodeCanvas {
        max-width: 100%;
        height: auto;
      }

      .barcode-text {
        margin-top: var(--space-3);
        font-family: var(--font-mono);
        font-size: 16px;
        color: #333;
        letter-spacing: 2px;
      }

      .info-text {
        font-size: 0.875rem;
        color: var(--color-text-muted);
        text-align: center;
        margin-top: var(--space-3);
      }

      /* ============================================
         Print Styles
         ============================================ */
      @media print {
        body {
          background: white !important;
        }

        body::before {
          display: none !important;
        }

        .nav-bar,
        .card:first-child,
        .btn-row {
          display: none !important;
        }

        .main-content {
          padding: 0 !important;
        }

        .card {
          background: none !important;
          border: none !important;
          box-shadow: none !important;
          padding: 0 !important;
        }

        .barcode-preview {
          padding: 20px !important;
        }
      }

      /* ============================================
         Grid Layout
         ============================================ */
      .grid-2col {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-6);
      }

      /* ============================================
         Mobile Responsive
         ============================================ */
      @media (max-width: 768px) {
        :root {
          --nav-height: 52px;
        }

        .nav-content {
          padding: 0 var(--space-4);
        }

        .nav-back-text {
          display: none;
        }

        .main-content {
          padding-top: calc(var(--nav-height) + var(--safe-area-top) + var(--space-4));
          padding-left: var(--space-4);
          padding-right: var(--space-4);
        }

        .card {
          padding: var(--space-4);
        }

        .grid-2col {
          grid-template-columns: 1fr;
          gap: var(--space-4);
        }

        .form-row {
          flex-direction: column;
          align-items: stretch;
        }

        .form-row .input-group {
          width: 100%;
        }

        select,
        input[type="number"] {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        .btn-row {
          flex-direction: column;
        }

        button {
          width: 100%;
        }
      }

      /* Desktop */
      @media (min-width: 768px) {
        .nav-back-text {
          display: inline;
        }
      }

      @media (min-width: 1024px) {
        .main-content {
          padding-top: calc(var(--nav-height) + var(--safe-area-top) + var(--space-8));
        }
      }

      /* ============================================
         Accessibility
         ============================================ */
      @media (prefers-reduced-motion: reduce) {
        *,
        *::before,
        *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }

      :focus-visible {
        outline: 2px solid var(--color-accent-primary);
        outline-offset: 2px;
      }

      button:focus:not(:focus-visible),
      a:focus:not(:focus-visible),
      input:focus:not(:focus-visible) {
        outline: none;
      }
    </style>
  </head>
  <body>
    <!-- Navigation Bar -->
    <nav class="nav-bar">
      <div class="nav-content">
        <a href="../../index.html" class="nav-back" aria-label="返回首页">
          <svg
            class="nav-back-icon"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="15 18 9 12 15 6"></polyline>
          </svg>
          <span class="nav-back-text">首页</span>
        </a>

        <h1 class="nav-title">条形码标签</h1>

        <div class="nav-actions">
          <button class="theme-toggle" onclick="toggleTheme()" aria-label="切换主题">
            <svg
              class="theme-icon-light"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
            <svg
              class="theme-icon-dark"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <circle cx="12" cy="12" r="5"></circle>
              <line x1="12" y1="1" x2="12" y2="3"></line>
              <line x1="12" y1="21" x2="12" y2="23"></line>
              <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
              <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
              <line x1="1" y1="12" x2="3" y2="12"></line>
              <line x1="21" y1="12" x2="23" y2="12"></line>
              <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
              <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </svg>
          </button>
        </div>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <div class="container">
        <!-- Two Column Layout -->
        <div class="grid-2col">
          <!-- Input Panel -->
          <div class="card">
            <h2 class="card-title">条形码设置</h2>

            <div class="input-group">
              <label for="barcodeText">条形码内容</label>
              <input type="text" id="barcodeText" placeholder="输入文本或数字..." />
            </div>

            <div class="form-row">
              <div class="input-group">
                <label for="barcodeWidth">宽度 (px)</label>
                <input type="number" id="barcodeWidth" value="300" min="100" max="600" step="10" />
              </div>

              <div class="input-group">
                <label for="barcodeHeight">高度 (px)</label>
                <input type="number" id="barcodeHeight" value="100" min="40" max="200" step="10" />
              </div>
            </div>

            <div class="checkbox-group">
              <input type="checkbox" id="showText" checked />
              <label for="showText">显示文本</label>
            </div>

            <div class="btn-row">
              <button class="primary" onclick="generateBarcode()">生成条形码</button>
              <button onclick="clearAll()">清空</button>
            </div>
          </div>

          <!-- Preview Panel -->
          <div class="card">
            <h2 class="card-title">预览</h2>

            <div class="barcode-preview">
              <canvas id="barcodeCanvas" width="300" height="100"></canvas>
              <div class="barcode-text" id="barcodeTextDisplay"></div>
            </div>

            <div class="btn-row">
              <button class="success" onclick="downloadBarcode()">下载 PNG</button>
              <button onclick="printBarcode()">打印</button>
            </div>

            <div class="info-text" id="infoText"></div>
          </div>
        </div>
      </div>
    </main>

    <script>
      // ============================================
      // Code128 Encoder (Vanilla JS Implementation)
      // ============================================
      var CODE128 = {
        PATTERNS: [
          "11011001100", "11001101100", "11001100110", "10010011000", "10010001100",
          "10001001100", "10011001000", "10011000100", "10001100100", "11001001000",
          "11001000100", "11000100100", "10110011100", "10011011100", "10011001110",
          "10111001100", "10011101100", "10011100110", "11001110010", "11001011100",
          "11001001110", "11011100100", "11001110100", "11101101110", "11101001100",
          "11100101100", "11100100110", "11101100100", "11100110100", "11100110010",
          "11011011000", "11011000110", "11000110110", "10100011000", "10001011000",
          "10001000110", "10110001000", "10001101000", "10001100010", "11010001000",
          "11000101000", "11000100010", "10110111000", "10110001110", "10001101110",
          "10111011000", "10111000110", "10001110110", "11101110110", "11010001110",
          "11000101110", "11011101000", "11011100010", "11011101110", "11101011000",
          "11101000110", "11100010110", "11101101000", "11101100010", "11100011010",
          "11101111010", "11001000010", "11110001010", "10100110000", "10100001100",
          "10010110000", "10010000110", "10000101100", "10000100110", "10110010000",
          "10110000100", "10011010000", "10011000010", "10000110100", "10000110010",
          "11000010010", "11001010000", "11110111010", "11000010100", "10001111010",
          "10100111100", "10010111100", "10010011110", "10111100100", "10011110100",
          "10011110010", "11110100100", "11110010100", "11110010010", "11011011110",
          "11011110110", "11110110110", "10101111000", "10100011110", "10001011110",
          "10111101000", "10111100010", "11110101000", "11110100010", "10111011110",
          "10111101110", "11101011110", "11110101110", "11010000100", "11010010000",
          "11010011100"
        ],
        START_B: 104,
        STOP: 106,

        encode: function(text) {
          var codes = [];
          var checksum = this.START_B;

          // Add start code B
          codes.push(this.PATTERNS[this.START_B]);

          // Encode each character
          for (var i = 0; i < text.length; i++) {
            var charCode = text.charCodeAt(i) - 32;
            if (charCode < 0 || charCode > 95) {
              charCode = 0; // Replace invalid chars with space
            }
            codes.push(this.PATTERNS[charCode]);
            checksum += charCode * (i + 1);
          }

          // Add checksum
          checksum = checksum % 103;
          codes.push(this.PATTERNS[checksum]);

          // Add stop code
          codes.push(this.PATTERNS[this.STOP]);

          return codes.join("");
        }
      };

      // ============================================
      // Elements
      // ============================================
      var barcodeText = document.getElementById("barcodeText");
      var barcodeWidth = document.getElementById("barcodeWidth");
      var barcodeHeight = document.getElementById("barcodeHeight");
      var showText = document.getElementById("showText");
      var canvas = document.getElementById("barcodeCanvas");
      var textDisplay = document.getElementById("barcodeTextDisplay");
      var infoText = document.getElementById("infoText");
      var ctx = canvas.getContext("2d");

      // ============================================
      // Generate Barcode
      // ============================================
      function generateBarcode() {
        var text = barcodeText.value.trim();
        if (!text) {
          infoText.textContent = "请输入条形码内容";
          return;
        }

        var width = parseInt(barcodeWidth.value) || 300;
        var height = parseInt(barcodeHeight.value) || 100;

        // Encode the text
        var encoded = CODE128.encode(text);
        var barWidth = width / encoded.length;

        // Setup canvas
        canvas.width = width;
        canvas.height = height;

        // Clear canvas
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, width, height);

        // Draw barcode
        ctx.fillStyle = "black";
        for (var i = 0; i < encoded.length; i++) {
          if (encoded[i] === "1") {
            ctx.fillRect(i * barWidth, 0, barWidth, height);
          }
        }

        // Show/hide text
        if (showText.checked) {
          textDisplay.textContent = text;
          textDisplay.style.display = "block";
        } else {
          textDisplay.style.display = "none";
        }

        infoText.textContent = "Code128 编码 · " + width + " × " + height + " px";
        saveState();
      }

      // ============================================
      // Download Barcode
      // ============================================
      function downloadBarcode() {
        // Create a combined canvas with text if needed
        var combinedCanvas = document.createElement("canvas");
        var combinedCtx = combinedCanvas.getContext("2d");
        var textHeight = showText.checked ? 30 : 0;

        combinedCanvas.width = canvas.width;
        combinedCanvas.height = canvas.height + textHeight;

        // Fill white background
        combinedCtx.fillStyle = "white";
        combinedCtx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);

        // Draw barcode
        combinedCtx.drawImage(canvas, 0, 0);

        // Draw text if needed
        if (showText.checked && barcodeText.value.trim()) {
          combinedCtx.fillStyle = "black";
          combinedCtx.font = "16px JetBrains Mono, monospace";
          combinedCtx.textAlign = "center";
          combinedCtx.fillText(barcodeText.value.trim(), combinedCanvas.width / 2, canvas.height + 22);
        }

        var link = document.createElement("a");
        link.download = "barcode.png";
        link.href = combinedCanvas.toDataURL("image/png");
        link.click();
      }

      // ============================================
      // Print Barcode
      // ============================================
      function printBarcode() {
        window.print();
      }

      // ============================================
      // Clear All
      // ============================================
      function clearAll() {
        barcodeText.value = "";
        barcodeWidth.value = "300";
        barcodeHeight.value = "100";
        showText.checked = true;
        ctx.fillStyle = "white";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        textDisplay.textContent = "";
        infoText.textContent = "";
        saveState();
      }

      // ============================================
      // State Persistence
      // ============================================
      function saveState() {
        var state = {
          text: barcodeText.value,
          width: barcodeWidth.value,
          height: barcodeHeight.value,
          showText: showText.checked
        };
        try {
          var hash = btoa(encodeURIComponent(JSON.stringify(state)));
          history.replaceState(null, "", "#" + hash);
        } catch (e) {
          console.error("保存状态失败:", e);
        }
      }

      function loadState() {
        var hash = window.location.hash.slice(1);
        if (hash) {
          try {
            var state = JSON.parse(decodeURIComponent(atob(hash)));
            if (state.text) barcodeText.value = state.text;
            if (state.width) barcodeWidth.value = state.width;
            if (state.height) barcodeHeight.value = state.height;
            if (typeof state.showText === "boolean") showText.checked = state.showText;
            if (state.text) generateBarcode();
          } catch (e) {
            console.error("加载状态失败:", e);
          }
        }
      }

      // ============================================
      // Auto-generate on Input Change
      // ============================================
      var generateTimeout;
      barcodeText.addEventListener("input", function () {
        clearTimeout(generateTimeout);
        generateTimeout = setTimeout(function () {
          if (barcodeText.value.trim()) {
            generateBarcode();
          }
        }, 300);
      });

      [barcodeWidth, barcodeHeight].forEach(function (el) {
        el.addEventListener("change", function () {
          if (barcodeText.value.trim()) {
            generateBarcode();
          }
        });
      });

      showText.addEventListener("change", function () {
        if (barcodeText.value.trim()) {
          generateBarcode();
        }
      });

      // ============================================
      // Theme Management
      // ============================================
      function toggleTheme() {
        var html = document.documentElement;
        var currentTheme = html.getAttribute("data-theme") || "dark";
        var newTheme = currentTheme === "light" ? "dark" : "light";

        html.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      }

      function initTheme() {
        var savedTheme = localStorage.getItem("theme");
        var prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
        var theme = savedTheme || (prefersDark ? "dark" : "light");

        document.documentElement.setAttribute("data-theme", theme);
      }

      // ============================================
      // Initialize
      // ============================================
      initTheme();
      loadState();
    </script>
  </body>
</html>

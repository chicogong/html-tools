<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Markdown 预览 - WebUtils</title>
  <style>
    :root {
      --bg: #f8f9fa;
      --card-bg: #fff;
      --text: #212529;
      --text-muted: #6c757d;
      --border: #dee2e6;
      --primary: #0d6efd;
      --primary-hover: #0b5ed7;
      --success: #198754;
      --shadow: 0 2px 8px rgb(0,0,0,0.08);
      --radius: 8px;
    }
    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 24px;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .back-link {
      display: inline-block;
      margin-bottom: 16px;
      color: var(--primary);
      text-decoration: none;
      font-size: 0.9rem;
    }

    .back-link:hover {
      text-decoration: underline;
    }

    h1 {
      font-size: 1.75rem;
      margin: 0 0 8px;
    }

    .desc {
      color: var(--text-muted);
      margin: 0 0 24px;
      font-size: 0.95rem;
    }

    .btn-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

    button {
      padding: 10px 16px;
      font-size: 0.95rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card-bg);
      cursor: pointer;
      transition: all 0.2s;
    }

    button:hover {
      border-color: var(--primary);
      color: var(--primary);
    }

    .panels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      min-height: 500px;
    }

    @media (width <= 900px) {
      .panels {
        grid-template-columns: 1fr;
      }
    }

    .panel {
      display: flex;
      flex-direction: column;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .panel-header label {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .panel-header span {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    textarea {
      flex: 1;
      min-height: 500px;
      padding: 16px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 0.9rem;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      resize: none;
      line-height: 1.6;
      background: var(--card-bg);
      box-shadow: var(--shadow);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgb(13,110,253,0.15);
    }

    .preview {
      flex: 1;
      min-height: 500px;
      padding: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card-bg);
      box-shadow: var(--shadow);
      overflow: auto;
      line-height: 1.6;
    }

    .preview h1, .preview h2, .preview h3, .preview h4, .preview h5, .preview h6 {
      margin-top: 24px;
      margin-bottom: 16px;
      font-weight: 600;
      line-height: 1.25;
    }
    .preview h1 { font-size: 2em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
    .preview h2 { font-size: 1.5em; border-bottom: 1px solid var(--border); padding-bottom: 0.3em; }
    .preview h3 { font-size: 1.25em; }
    .preview p { margin: 0 0 16px; }

    .preview code {
      background: var(--bg);
      padding: 0.2em 0.4em;
      border-radius: 4px;
      font-family: ui-monospace, SFMono-Regular, "SF Mono", Menlo, monospace;
      font-size: 0.85em;
    }

    .preview pre {
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 16px;
      border-radius: var(--radius);
      overflow-x: auto;
      margin: 0 0 16px;
    }

    .preview pre code {
      background: none;
      padding: 0;
      color: inherit;
    }

    .preview blockquote {
      margin: 0 0 16px;
      padding: 0 16px;
      border-left: 4px solid var(--border);
      color: var(--text-muted);
    }

    .preview ul, .preview ol {
      margin: 0 0 16px;
      padding-left: 2em;
    }
    .preview li { margin: 4px 0; }

    .preview table {
      border-collapse: collapse;
      width: 100%;
      margin: 0 0 16px;
    }

    .preview th, .preview td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
    }

    .preview th {
      background: var(--bg);
      font-weight: 600;
    }

    .preview a {
      color: var(--primary);
    }

    .preview img {
      max-width: 100%;
    }

    .preview hr {
      border: none;
      border-top: 1px solid var(--border);
      margin: 24px 0;
    }

    .status {
      font-size: 0.85rem;
      margin-top: 8px;
      color: var(--success);
    }

    footer {
      text-align: center;
      margin-top: 32px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 0.85rem;
    }

    footer a {
      color: var(--primary);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../../index.html" class="back-link">← 返回工具列表</a>
    <h1>Markdown 预览</h1>
    <p class="desc">实时预览 Markdown 内容，支持 GFM 语法，自动保存</p>

    <div class="btn-row">
      <button id="btnClear">清空</button>
      <button id="btnCopyHtml">复制 HTML</button>
      <button id="btnDownload">下载 HTML</button>
    </div>

    <div class="panels">
      <div class="panel">
        <div class="panel-header">
          <label for="input">Markdown</label>
          <span id="wordCount">0 字</span>
        </div>
        <textarea id="input" placeholder="在此输入 Markdown..."></textarea>
      </div>
      <div class="panel">
        <div class="panel-header">
          <label>预览</label>
        </div>
        <div class="preview" id="preview"></div>
      </div>
    </div>

    <div id="status" class="status"></div>

    <footer>
      <a href="https://github.com/chicogong/html-tools/blob/main/tools/markdown-preview.html" target="_blank" rel="noreferrer">View source</a>
      · 纯前端工具 · 无服务器 · 
      <a href="../../index.html">WebUtils</a>
    </footer>
  </div>

  <!-- marked.js + DOMPurify CDN -->
  <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

  <script>
    const inputEl = document.getElementById('input');
    const previewEl = document.getElementById('preview');
    const wordCountEl = document.getElementById('wordCount');
    const statusEl = document.getElementById('status');

    const LS_KEY = 'markdown_preview_v1';

    // 配置 marked
    marked.setOptions({
      breaks: true,
      gfm: true
    });

    function updatePreview() {
      const md = inputEl.value;
      const rawHtml = marked.parse(md);
      // 使用 DOMPurify 清理 HTML
      const cleanHtml = DOMPurify.sanitize(rawHtml);
      previewEl.innerHTML = cleanHtml;
      
      // 字数统计
      const text = md.trim();
      const chars = text.length;
      const words = text ? text.split(/\s+/).length : 0;
      wordCountEl.textContent = chars + ' 字 / ' + words + ' 词';
    }

    function loadFromStorage() {
      const saved = localStorage.getItem(LS_KEY);
      if (saved) {
        inputEl.value = saved;
        updatePreview();
      }
    }

    function saveToStorage() {
      localStorage.setItem(LS_KEY, inputEl.value);
    }

    function showStatus(msg) {
      statusEl.textContent = msg;
      setTimeout(function() {
        statusEl.textContent = '';
      }, 2000);
    }

    inputEl.addEventListener('input', function() {
      updatePreview();
      saveToStorage();
    });

    document.getElementById('btnClear').onclick = function() {
      if (confirm('确定要清空内容吗？')) {
        inputEl.value = '';
        updatePreview();
        localStorage.removeItem(LS_KEY);
        showStatus('已清空');
      }
    };

    document.getElementById('btnCopyHtml').onclick = async function() {
      const html = previewEl.innerHTML;
      try {
        await navigator.clipboard.writeText(html);
        showStatus('HTML 已复制到剪贴板');
      } catch (e) {
        showStatus('复制失败');
      }
    };

    document.getElementById('btnDownload').onclick = function() {
      var htmlDoc = '<!DOCTYPE html>\n<html>\n<head>\n<meta charset="utf-8">\n<title>Markdown Export</title>\n<style>\nbody { font-family: system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 20px; line-height: 1.6; }\npre { background: #f6f8fa; padding: 16px; border-radius: 6px; overflow-x: auto; }\ncode { background: #f6f8fa; padding: 0.2em 0.4em; border-radius: 3px; }\nblockquote { border-left: 4px solid #ddd; margin: 0; padding-left: 16px; color: #666; }\ntable { border-collapse: collapse; width: 100%; }\nth, td { border: 1px solid #ddd; padding: 8px; text-align: left; }\nth { background: #f6f8fa; }\n</style>\n</head>\n<body>\n' + previewEl.innerHTML + '\n</body>\n</html>';
      
      var blob = new Blob([htmlDoc], { type: 'text/html' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'markdown-export.html';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showStatus('已下载');
    };

    // 初始化
    loadFromStorage();
    
    // 如果为空，显示示例
    if (!inputEl.value) {
      inputEl.value = '# Markdown 预览\n\n这是一个 **实时预览** 的 Markdown 编辑器。\n\n## 功能\n\n- 支持 GFM 语法\n- 自动保存到 localStorage\n- 导出 HTML\n\n## 代码示例\n\n```javascript\nconst hello = "world";\nconsole.log(hello);\n```\n\n## 表格\n\n| 名称 | 描述 |\n|------|------|\n| A | 第一项 |\n| B | 第二项 |\n\n> 引用文本\n\n---\n\n[链接示例](https://example.com)';
      updatePreview();
    }
  </script>
</body>
</html>

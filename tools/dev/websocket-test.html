<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket测试客户端 - WebUtils</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --msg-sent-bg: #dbeafe;
            --msg-received-bg: #dcfce7;
            --msg-error-bg: #fee2e2;
            --msg-system-bg: #f3f4f6;
        }
        [data-theme="dark"] {
            --msg-sent-bg: #1e3a5f;
            --msg-received-bg: #14532d;
            --msg-error-bg: #7f1d1d;
            --msg-system-bg: #374151;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 2rem;
        }
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        .connection-panel {
            background: var(--pico-card-background-color);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        .connection-row {
            display: flex;
            gap: 0.5rem;
            align-items: flex-end;
        }
        .connection-row input {
            flex: 1;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            background: var(--pico-card-background-color);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #9ca3af;
        }
        .status-dot.connected {
            background: #22c55e;
            animation: pulse 2s infinite;
        }
        .status-dot.connecting {
            background: #eab308;
            animation: pulse 1s infinite;
        }
        .status-dot.error {
            background: #ef4444;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .messages-container {
            background: var(--pico-card-background-color);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            height: 500px;
        }
        .messages-header {
            padding: 1rem;
            border-bottom: 1px solid var(--pico-muted-border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .messages-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .message-item {
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            word-break: break-all;
        }
        .message-item.sent {
            background: var(--msg-sent-bg);
            margin-left: 2rem;
        }
        .message-item.received {
            background: var(--msg-received-bg);
            margin-right: 2rem;
        }
        .message-item.error {
            background: var(--msg-error-bg);
        }
        .message-item.system {
            background: var(--msg-system-bg);
            text-align: center;
            font-style: italic;
        }
        .message-meta {
            font-size: 0.75rem;
            color: var(--pico-muted-color);
            margin-bottom: 0.25rem;
        }
        .message-content {
            white-space: pre-wrap;
        }
        .send-panel {
            padding: 1rem;
            border-top: 1px solid var(--pico-muted-border-color);
        }
        .send-row {
            display: flex;
            gap: 0.5rem;
        }
        .send-row textarea {
            flex: 1;
            resize: none;
            min-height: 60px;
        }
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .panel {
            background: var(--pico-card-background-color);
            padding: 1rem;
            border-radius: 8px;
        }
        .panel h3 {
            margin-top: 0;
            margin-bottom: 1rem;
            font-size: 1rem;
        }
        .saved-messages {
            max-height: 200px;
            overflow-y: auto;
        }
        .saved-message {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--pico-background-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .saved-message:hover {
            background: var(--pico-secondary-background);
        }
        .saved-message-text {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--pico-background-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .history-item:hover {
            background: var(--pico-secondary-background);
        }
        .stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            font-size: 0.85rem;
        }
        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: var(--pico-background-color);
            border-radius: 4px;
        }
        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--pico-primary);
        }
        .protocol-select {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .protocol-select button {
            flex: 1;
            padding: 0.5rem;
        }
        .protocol-select button.active {
            background: var(--pico-primary);
            border-color: var(--pico-primary);
            color: white;
        }
        .format-options {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .format-options label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85rem;
        }
    
        .breadcrumb { position: fixed; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 0.85rem; }
        .breadcrumb a { color: #667eea; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: #999; margin: 0 5px; }
    </style>
</head>
<body>
    <nav class="breadcrumb"><a href="../../index.html">首页</a><span>›</span><a href="../../index.html#dev">开发工具</a><span>›</span>WebSocket测试客户端</nav>
    <div class="container">
        <a href="../../index.html" style="display:inline-block;margin-bottom:1rem;color:var(--pico-primary);text-decoration:none;">← 返回首页</a>
        <header>
            <h1>WebSocket测试客户端</h1>
            <button id="themeToggle" class="outline">切换主题</button>
        </header>

        <div class="connection-panel">
            <div class="protocol-select">
                <button id="wsBtn" class="active outline">WS (不安全)</button>
                <button id="wssBtn" class="outline">WSS (安全)</button>
            </div>
            <div class="connection-row">
                <label style="flex: 1;">
                    服务器地址
                    <input type="text" id="wsUrl" placeholder="localhost:8080/ws">
                </label>
                <button id="connectBtn">连接</button>
                <button id="disconnectBtn" class="secondary" disabled>断开</button>
            </div>
            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                <div class="status-indicator">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">未连接</span>
                </div>
                <small id="connectionInfo" style="color: var(--pico-muted-color);"></small>
            </div>
        </div>

        <div class="main-content">
            <div class="chat-panel">
                <div class="messages-container">
                    <div class="messages-header">
                        <span>消息记录</span>
                        <button id="clearMessagesBtn" class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;">清空</button>
                    </div>
                    <div class="messages-list" id="messagesList"></div>
                    <div class="send-panel">
                        <div class="format-options">
                            <label>
                                <input type="radio" name="msgFormat" value="text" checked> 文本
                            </label>
                            <label>
                                <input type="radio" name="msgFormat" value="json"> JSON
                            </label>
                            <label>
                                <input type="checkbox" id="prettyJson"> 美化JSON
                            </label>
                        </div>
                        <div class="send-row">
                            <textarea id="messageInput" placeholder="输入要发送的消息..." disabled></textarea>
                            <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                                <button id="sendBtn" disabled>发送</button>
                                <button id="saveMessageBtn" class="outline" style="padding: 0.5rem;">保存</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar">
                <div class="panel">
                    <h3>连接统计</h3>
                    <div class="stats">
                        <div class="stat-item">
                            <div class="stat-value" id="sentCount">0</div>
                            <div>已发送</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="receivedCount">0</div>
                            <div>已接收</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="sentBytes">0</div>
                            <div>发送字节</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-value" id="receivedBytes">0</div>
                            <div>接收字节</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h3>保存的消息</h3>
                    <div class="saved-messages" id="savedMessages">
                        <p style="color: var(--pico-muted-color); font-size: 0.85rem; text-align: center;">暂无保存的消息</p>
                    </div>
                </div>

                <div class="panel">
                    <h3>连接历史</h3>
                    <div id="connectionHistory">
                        <p style="color: var(--pico-muted-color); font-size: 0.85rem; text-align: center;">暂无历史记录</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 状态
        let ws = null;
        let protocol = 'ws';
        let stats = {
            sent: 0,
            received: 0,
            sentBytes: 0,
            receivedBytes: 0
        };
        let savedMessages = JSON.parse(localStorage.getItem('wsSavedMessages') || '[]');
        let connectionHistory = JSON.parse(localStorage.getItem('wsConnectionHistory') || '[]');

        // 初始化
        function init() {
            renderSavedMessages();
            renderConnectionHistory();
            bindEvents();
        }

        // 主题切换
        document.getElementById('themeToggle').addEventListener('click', function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            document.documentElement.setAttribute('data-theme', savedTheme);
        }

        // 绑定事件
        function bindEvents() {
            // 协议切换
            document.getElementById('wsBtn').addEventListener('click', function() {
                protocol = 'ws';
                this.classList.add('active');
                document.getElementById('wssBtn').classList.remove('active');
            });

            document.getElementById('wssBtn').addEventListener('click', function() {
                protocol = 'wss';
                this.classList.add('active');
                document.getElementById('wsBtn').classList.remove('active');
            });

            // 连接
            document.getElementById('connectBtn').addEventListener('click', connect);
            document.getElementById('disconnectBtn').addEventListener('click', disconnect);

            // 发送消息
            document.getElementById('sendBtn').addEventListener('click', sendMessage);
            document.getElementById('messageInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && e.ctrlKey) {
                    sendMessage();
                }
            });

            // 保存消息
            document.getElementById('saveMessageBtn').addEventListener('click', saveCurrentMessage);

            // 清空消息
            document.getElementById('clearMessagesBtn').addEventListener('click', function() {
                document.getElementById('messagesList').replaceChildren();
            });

            // 回车连接
            document.getElementById('wsUrl').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    connect();
                }
            });
        }

        // 连接WebSocket
        function connect() {
            const urlInput = document.getElementById('wsUrl').value.trim();
            if (!urlInput) {
                addSystemMessage('请输入服务器地址');
                return;
            }

            const url = protocol + '://' + urlInput;
            
            updateStatus('connecting', '连接中...');
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = function() {
                    updateStatus('connected', '已连接');
                    document.getElementById('connectBtn').disabled = true;
                    document.getElementById('disconnectBtn').disabled = false;
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('connectionInfo').textContent = '连接时间: ' + new Date().toLocaleTimeString();
                    
                    addSystemMessage('已连接到 ' + url);
                    
                    // 保存到历史
                    addToHistory(urlInput);
                };
                
                ws.onmessage = function(event) {
                    stats.received++;
                    stats.receivedBytes += event.data.length;
                    updateStats();
                    
                    let content = event.data;
                    const prettyJson = document.getElementById('prettyJson').checked;
                    
                    if (prettyJson) {
                        try {
                            const parsed = JSON.parse(event.data);
                            content = JSON.stringify(parsed, null, 2);
                        } catch (e) {
                            // 不是JSON，保持原样
                        }
                    }
                    
                    addMessage('received', content);
                };
                
                ws.onerror = function(error) {
                    updateStatus('error', '连接错误');
                    addSystemMessage('连接发生错误', 'error');
                };
                
                ws.onclose = function(event) {
                    updateStatus('disconnected', '未连接');
                    document.getElementById('connectBtn').disabled = false;
                    document.getElementById('disconnectBtn').disabled = true;
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendBtn').disabled = true;
                    
                    let reason = event.reason || '连接关闭';
                    addSystemMessage('连接已关闭: ' + reason + ' (代码: ' + event.code + ')');
                    
                    ws = null;
                };
            } catch (error) {
                updateStatus('error', '连接失败');
                addSystemMessage('无法创建WebSocket连接: ' + error.message, 'error');
            }
        }

        // 断开连接
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }

        // 发送消息
        function sendMessage() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addSystemMessage('未连接到服务器', 'error');
                return;
            }
            
            const input = document.getElementById('messageInput');
            let message = input.value.trim();
            
            if (!message) return;
            
            const format = document.querySelector('input[name="msgFormat"]:checked').value;
            
            if (format === 'json') {
                try {
                    JSON.parse(message);
                } catch (e) {
                    addSystemMessage('JSON格式错误: ' + e.message, 'error');
                    return;
                }
            }
            
            ws.send(message);
            stats.sent++;
            stats.sentBytes += message.length;
            updateStats();
            
            addMessage('sent', message);
            input.value = '';
        }

        // 添加消息到列表
        function addMessage(type, content) {
            const list = document.getElementById('messagesList');
            const item = document.createElement('div');
            item.className = 'message-item ' + type;
            
            const meta = document.createElement('div');
            meta.className = 'message-meta';
            meta.textContent = (type === 'sent' ? '发送' : '接收') + ' - ' + new Date().toLocaleTimeString();
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = content;
            
            item.appendChild(meta);
            item.appendChild(contentDiv);
            list.appendChild(item);
            
            list.scrollTop = list.scrollHeight;
        }

        // 添加系统消息
        function addSystemMessage(text, type) {
            const list = document.getElementById('messagesList');
            const item = document.createElement('div');
            item.className = 'message-item ' + (type || 'system');
            item.textContent = text;
            list.appendChild(item);
            list.scrollTop = list.scrollHeight;
        }

        // 更新状态
        function updateStatus(state, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            dot.className = 'status-dot';
            if (state === 'connected') {
                dot.classList.add('connected');
            } else if (state === 'connecting') {
                dot.classList.add('connecting');
            } else if (state === 'error') {
                dot.classList.add('error');
            }
            
            statusText.textContent = text;
        }

        // 更新统计
        function updateStats() {
            document.getElementById('sentCount').textContent = stats.sent;
            document.getElementById('receivedCount').textContent = stats.received;
            document.getElementById('sentBytes').textContent = formatBytes(stats.sentBytes);
            document.getElementById('receivedBytes').textContent = formatBytes(stats.receivedBytes);
        }

        // 格式化字节
        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'K';
            return (bytes / (1024 * 1024)).toFixed(1) + 'M';
        }

        // 保存当前消息
        function saveCurrentMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('请先输入要保存的消息');
                return;
            }
            
            if (savedMessages.length >= 10) {
                savedMessages.shift();
            }
            
            savedMessages.push({
                content: message,
                time: new Date().toLocaleString()
            });
            
            localStorage.setItem('wsSavedMessages', JSON.stringify(savedMessages));
            renderSavedMessages();
            alert('消息已保存');
        }

        // 渲染保存的消息
        function renderSavedMessages() {
            const container = document.getElementById('savedMessages');
            container.replaceChildren();
            
            if (savedMessages.length === 0) {
                const p = document.createElement('p');
                p.style.cssText = 'color: var(--pico-muted-color); font-size: 0.85rem; text-align: center;';
                p.textContent = '暂无保存的消息';
                container.appendChild(p);
                return;
            }
            
            savedMessages.forEach(function(msg, index) {
                const item = document.createElement('div');
                item.className = 'saved-message';
                
                const text = document.createElement('span');
                text.className = 'saved-message-text';
                text.textContent = msg.content;
                text.addEventListener('click', function() {
                    document.getElementById('messageInput').value = msg.content;
                });
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'outline';
                deleteBtn.style.cssText = 'padding: 0.1rem 0.3rem; font-size: 0.7rem;';
                deleteBtn.textContent = '×';
                deleteBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    savedMessages.splice(index, 1);
                    localStorage.setItem('wsSavedMessages', JSON.stringify(savedMessages));
                    renderSavedMessages();
                });
                
                item.appendChild(text);
                item.appendChild(deleteBtn);
                container.appendChild(item);
            });
        }

        // 添加到连接历史
        function addToHistory(url) {
            connectionHistory = connectionHistory.filter(function(h) { return h !== url; });
            connectionHistory.unshift(url);
            if (connectionHistory.length > 5) {
                connectionHistory.pop();
            }
            localStorage.setItem('wsConnectionHistory', JSON.stringify(connectionHistory));
            renderConnectionHistory();
        }

        // 渲染连接历史
        function renderConnectionHistory() {
            const container = document.getElementById('connectionHistory');
            container.replaceChildren();
            
            if (connectionHistory.length === 0) {
                const p = document.createElement('p');
                p.style.cssText = 'color: var(--pico-muted-color); font-size: 0.85rem; text-align: center;';
                p.textContent = '暂无历史记录';
                container.appendChild(p);
                return;
            }
            
            connectionHistory.forEach(function(url) {
                const item = document.createElement('div');
                item.className = 'history-item';
                item.textContent = url;
                item.addEventListener('click', function() {
                    document.getElementById('wsUrl').value = url;
                });
                container.appendChild(item);
            });
        }

        // 启动
        init();
    </script>
</body>
</html>

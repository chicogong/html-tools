<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç§‘å­¦è®¡ç®—å™¨</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --btn-spacing: 0.5rem;
        }
        body {
            min-height: 100vh;
            padding: 2rem 1rem;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .display {
            background: var(--pico-muted-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 80px;
        }
        .display-expression {
            font-size: 0.9rem;
            color: var(--pico-muted-color);
            min-height: 1.5em;
            word-break: break-all;
        }
        .display-result {
            font-size: 2rem;
            font-weight: bold;
            text-align: right;
            word-break: break-all;
        }
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--btn-spacing);
        }
        .btn-grid button {
            padding: 0.75rem 0.5rem;
            font-size: 1rem;
            margin: 0;
            width: 100%;
        }
        .btn-grid button.secondary {
            --pico-background-color: var(--pico-secondary-background);
        }
        .btn-grid button.contrast {
            --pico-background-color: var(--pico-contrast-background);
        }
        .memory-display {
            font-size: 0.8rem;
            color: var(--pico-muted-color);
            margin-bottom: 0.5rem;
        }
        .angle-mode {
            margin-bottom: 1rem;
        }
        .angle-mode label {
            margin-right: 1rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <a href="../../index.html" style="display:inline-block;margin-bottom:1rem;color:var(--pico-primary);text-decoration:none;">â† è¿”å›é¦–é¡µ</a>
        <header>
            <h1>ç§‘å­¦è®¡ç®—å™¨</h1>
            <button id="themeToggle" class="outline" onclick="toggleTheme()">ğŸŒ™</button>
        </header>

        <div class="angle-mode">
            <label>
                <input type="radio" name="angleMode" value="deg" checked onchange="setAngleMode('deg')">
                è§’åº¦ (DEG)
            </label>
            <label>
                <input type="radio" name="angleMode" value="rad" onchange="setAngleMode('rad')">
                å¼§åº¦ (RAD)
            </label>
        </div>

        <div class="memory-display" id="memoryDisplay"></div>

        <div class="display">
            <div class="display-expression" id="expression"></div>
            <div class="display-result" id="result">0</div>
        </div>

        <div class="btn-grid">
            <button class="secondary" onclick="inputFunc('sin')">sin</button>
            <button class="secondary" onclick="inputFunc('cos')">cos</button>
            <button class="secondary" onclick="inputFunc('tan')">tan</button>
            <button class="secondary" onclick="inputFunc('log')">log</button>
            <button class="secondary" onclick="inputFunc('ln')">ln</button>

            <button class="secondary" onclick="inputFunc('asin')">sinâ»Â¹</button>
            <button class="secondary" onclick="inputFunc('acos')">cosâ»Â¹</button>
            <button class="secondary" onclick="inputFunc('atan')">tanâ»Â¹</button>
            <button class="secondary" onclick="inputFunc('exp')">eË£</button>
            <button class="secondary" onclick="inputFunc('sqrt')">âˆš</button>

            <button class="secondary" onclick="inputValue('Math.PI')">Ï€</button>
            <button class="secondary" onclick="inputValue('Math.E')">e</button>
            <button class="secondary" onclick="inputOp('^')">xÊ¸</button>
            <button class="secondary" onclick="inputFunc('pow10')">10Ë£</button>
            <button class="secondary" onclick="inputFunc('fact')">n!</button>

            <button onclick="inputValue('7')">7</button>
            <button onclick="inputValue('8')">8</button>
            <button onclick="inputValue('9')">9</button>
            <button class="contrast" onclick="clearAll()">C</button>
            <button class="contrast" onclick="backspace()">âŒ«</button>

            <button onclick="inputValue('4')">4</button>
            <button onclick="inputValue('5')">5</button>
            <button onclick="inputValue('6')">6</button>
            <button class="secondary" onclick="inputOp('*')">Ã—</button>
            <button class="secondary" onclick="inputOp('/')">Ã·</button>

            <button onclick="inputValue('1')">1</button>
            <button onclick="inputValue('2')">2</button>
            <button onclick="inputValue('3')">3</button>
            <button class="secondary" onclick="inputOp('+')">+</button>
            <button class="secondary" onclick="inputOp('-')">âˆ’</button>

            <button onclick="inputValue('0')">0</button>
            <button onclick="inputValue('.')">.</button>
            <button onclick="inputValue('(')">(</button>
            <button onclick="inputValue(')')">)</button>
            <button class="primary" onclick="calculate()">=</button>

            <button class="outline" onclick="memoryClear()">MC</button>
            <button class="outline" onclick="memoryRecall()">MR</button>
            <button class="outline" onclick="memoryAdd()">M+</button>
            <button class="outline" onclick="memorySubtract()">Mâˆ’</button>
            <button class="outline" onclick="memoryStore()">MS</button>
        </div>

        <article style="margin-top: 2rem;">
            <h4>ä½¿ç”¨è¯´æ˜</h4>
            <ul>
                <li><strong>ä¸‰è§’å‡½æ•°</strong>ï¼šsin, cos, tan åŠå…¶åå‡½æ•°</li>
                <li><strong>å¯¹æ•°</strong>ï¼šlog (å¸¸ç”¨å¯¹æ•°), ln (è‡ªç„¶å¯¹æ•°)</li>
                <li><strong>å¹‚è¿ç®—</strong>ï¼šxÊ¸ (ä»»æ„å¹‚), eË£, 10Ë£, âˆš (å¹³æ–¹æ ¹)</li>
                <li><strong>å¸¸æ•°</strong>ï¼šÏ€ (åœ†å‘¨ç‡), e (è‡ªç„¶å¸¸æ•°)</li>
                <li><strong>é˜¶ä¹˜</strong>ï¼šn! (ä»…æ”¯æŒéè´Ÿæ•´æ•°)</li>
            </ul>
        </article>
    </main>

    <script>
        let expression = '';
        let memory = 0;
        let angleMode = 'deg';

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            document.getElementById('themeToggle').textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.getElementById('themeToggle').textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        }

        function setAngleMode(mode) {
            angleMode = mode;
        }

        function toRadians(deg) {
            return deg * Math.PI / 180;
        }

        function toDegrees(rad) {
            return rad * 180 / Math.PI;
        }

        function factorial(n) {
            if (n < 0 || !Number.isInteger(n)) return NaN;
            if (n === 0 || n === 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function updateDisplay() {
            document.getElementById('expression').textContent = expression;
        }

        function inputValue(val) {
            expression += val;
            updateDisplay();
        }

        function inputOp(op) {
            expression += op;
            updateDisplay();
        }

        function inputFunc(func) {
            expression += func + '(';
            updateDisplay();
        }

        function clearAll() {
            expression = '';
            document.getElementById('result').textContent = '0';
            document.getElementById('expression').textContent = '';
        }

        function backspace() {
            expression = expression.slice(0, -1);
            updateDisplay();
        }

        function calculate() {
            try {
                let expr = expression;
                expr = expr.replace(/Ã—/g, '*').replace(/Ã·/g, '/');
                expr = expr.replace(/\^/g, '**');
                
                if (angleMode === 'deg') {
                    expr = expr.replace(/sin\(/g, 'Math.sin(toRadians(');
                    expr = expr.replace(/cos\(/g, 'Math.cos(toRadians(');
                    expr = expr.replace(/tan\(/g, 'Math.tan(toRadians(');
                    expr = expr.replace(/asin\(/g, 'toDegrees(Math.asin(');
                    expr = expr.replace(/acos\(/g, 'toDegrees(Math.acos(');
                    expr = expr.replace(/atan\(/g, 'toDegrees(Math.atan(');
                } else {
                    expr = expr.replace(/sin\(/g, 'Math.sin(');
                    expr = expr.replace(/cos\(/g, 'Math.cos(');
                    expr = expr.replace(/tan\(/g, 'Math.tan(');
                    expr = expr.replace(/asin\(/g, 'Math.asin(');
                    expr = expr.replace(/acos\(/g, 'Math.acos(');
                    expr = expr.replace(/atan\(/g, 'Math.atan(');
                }
                
                expr = expr.replace(/log\(/g, 'Math.log10(');
                expr = expr.replace(/ln\(/g, 'Math.log(');
                expr = expr.replace(/sqrt\(/g, 'Math.sqrt(');
                expr = expr.replace(/exp\(/g, 'Math.exp(');
                expr = expr.replace(/pow10\(/g, 'Math.pow(10,');
                expr = expr.replace(/fact\(/g, 'factorial(');
                
                if (angleMode === 'deg') {
                    const sinCosMatches = (expr.match(/toRadians\(/g) || []).length;
                    const asinMatches = (expr.match(/toDegrees\(Math\.a(sin|cos|tan)\(/g) || []).length;
                    for (let i = 0; i < sinCosMatches + asinMatches; i++) {
                        expr += ')';
                    }
                }
                
                const result = Function('"use strict"; return (' + expr + ')')();
                const displayResult = Number.isFinite(result) ? 
                    (Math.abs(result) < 1e-10 ? 0 : Number(result.toPrecision(12))) : 
                    result;
                document.getElementById('result').textContent = displayResult;
            } catch (e) {
                document.getElementById('result').textContent = 'é”™è¯¯';
            }
        }

        function updateMemoryDisplay() {
            document.getElementById('memoryDisplay').textContent = memory !== 0 ? 'M = ' + memory : '';
        }

        function memoryClear() {
            memory = 0;
            updateMemoryDisplay();
        }

        function memoryRecall() {
            expression += memory;
            updateDisplay();
        }

        function memoryAdd() {
            const result = parseFloat(document.getElementById('result').textContent);
            if (!isNaN(result)) {
                memory += result;
                updateMemoryDisplay();
            }
        }

        function memorySubtract() {
            const result = parseFloat(document.getElementById('result').textContent);
            if (!isNaN(result)) {
                memory -= result;
                updateMemoryDisplay();
            }
        }

        function memoryStore() {
            const result = parseFloat(document.getElementById('result').textContent);
            if (!isNaN(result)) {
                memory = result;
                updateMemoryDisplay();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key >= '0' && e.key <= '9') inputValue(e.key);
            else if (e.key === '.') inputValue('.');
            else if (e.key === '+') inputOp('+');
            else if (e.key === '-') inputOp('-');
            else if (e.key === '*') inputOp('*');
            else if (e.key === '/') inputOp('/');
            else if (e.key === '(') inputValue('(');
            else if (e.key === ')') inputValue(')');
            else if (e.key === '^') inputOp('^');
            else if (e.key === 'Enter' || e.key === '=') calculate();
            else if (e.key === 'Escape') clearAll();
            else if (e.key === 'Backspace') backspace();
        });

        loadTheme();
    </script>
</body>
</html>

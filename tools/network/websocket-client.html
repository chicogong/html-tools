<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket è°ƒè¯•å™¨ - WebUtils</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root { --tool-primary: #8b5cf6; }
        body { padding: 1rem; min-height: 100vh; }
        .container { max-width: 1000px; margin: 0 auto; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
        h1 { margin: 0; font-size: 1.75rem; color: var(--tool-primary); }
        .theme-toggle { background: none; border: 2px solid var(--tool-primary); color: var(--tool-primary); cursor: pointer; padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; }
        .back-link { color: var(--tool-primary); text-decoration: none; font-size: 0.9rem; }
        .connect-bar { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .url-input { flex: 1; min-width: 250px; font-family: monospace; }
        .connect-btn { padding: 0.5rem 1.5rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .connect-btn.connect { background: var(--tool-primary); color: white; }
        .connect-btn.disconnect { background: #ef4444; color: white; }
        .connect-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; padding: 0.5rem 1rem; background: var(--pico-secondary-background); border-radius: 6px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; }
        .status-dot.disconnected { background: #6b7280; }
        .status-dot.connecting { background: #f59e0b; animation: pulse 1s infinite; }
        .status-dot.connected { background: #22c55e; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .panel { background: var(--pico-card-background-color); border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 1rem; }
        .panel-header { padding: 0.75rem 1rem; background: var(--pico-secondary-background); border-bottom: 1px solid var(--pico-muted-border-color); font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
        .messages-container { height: 400px; overflow-y: auto; padding: 1rem; }
        .message { padding: 0.75rem; margin-bottom: 0.5rem; border-radius: 8px; font-family: monospace; font-size: 0.85rem; word-break: break-all; }
        .message-sent { background: rgba(139, 92, 246, 0.1); border-left: 3px solid var(--tool-primary); }
        .message-received { background: rgba(34, 197, 94, 0.1); border-left: 3px solid #22c55e; }
        .message-system { background: var(--pico-code-background-color); border-left: 3px solid #6b7280; color: var(--pico-muted-color); }
        .message-error { background: rgba(239, 68, 68, 0.1); border-left: 3px solid #ef4444; color: #ef4444; }
        .message-header { display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--pico-muted-color); margin-bottom: 0.25rem; }
        .message-content { white-space: pre-wrap; }
        .send-section { padding: 1rem; border-top: 1px solid var(--pico-muted-border-color); }
        .send-row { display: flex; gap: 0.5rem; }
        .message-input { flex: 1; font-family: monospace; }
        .send-btn { background: var(--tool-primary); border-color: var(--tool-primary); color: white; padding: 0.5rem 1.5rem; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .presets { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
        .preset-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; background: var(--pico-secondary-background); border: 1px solid var(--pico-muted-border-color); border-radius: 4px; cursor: pointer; }
        .preset-btn:hover { border-color: var(--tool-primary); color: var(--tool-primary); }
        .format-toggle { display: flex; gap: 0.25rem; }
        .format-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; background: none; border: 1px solid var(--pico-muted-border-color); cursor: pointer; border-radius: 4px; }
        .format-btn.active { background: var(--tool-primary); color: white; border-color: var(--tool-primary); }
        .clear-btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; background: none; border: 1px solid var(--pico-muted-border-color); border-radius: 4px; cursor: pointer; }
        .clear-btn:hover { background: #ef4444; color: white; border-color: #ef4444; }
        .stats { font-size: 0.8rem; color: var(--pico-muted-color); display: flex; gap: 1rem; }
        .empty-state { text-align: center; color: var(--pico-muted-color); padding: 3rem; }
    
        .breadcrumb { position: fixed; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 0.85rem; }
        .breadcrumb a { color: #667eea; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: #999; margin: 0 5px; }
    </style>
</head>
<body>
    <nav class="breadcrumb"><a href="../../index.html">é¦–é¡µ</a><span>â€º</span><a href="../../index.html#network">ç½‘ç»œå·¥å…·</a><span>â€º</span>WebSocket è°ƒè¯•å™¨</nav>
    <div class="container">
        <header>
            <div>
                <a href="../../index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
                <h1>WebSocket è°ƒè¯•å™¨</h1>
            </div>
            <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
                <span class="theme-icon">ğŸŒ™</span>
            </button>
        </header>
        
        <div class="connect-bar">
            <input type="text" id="wsUrl" class="url-input" placeholder="wss://example.com/socket" value="wss://echo.websocket.org">
            <button id="connectBtn" class="connect-btn connect" onclick="toggleConnection()">è¿æ¥</button>
            <div class="status-indicator">
                <span id="statusDot" class="status-dot disconnected"></span>
                <span id="statusText">æœªè¿æ¥</span>
            </div>
        </div>
        
        <div class="presets">
            <span style="font-size: 0.85rem; color: var(--pico-muted-color);">æµ‹è¯•æœåŠ¡å™¨:</span>
            <button class="preset-btn" onclick="setUrl('wss://echo.websocket.org')">Echo Server</button>
            <button class="preset-btn" onclick="setUrl('wss://ws.postman-echo.com/raw')">Postman Echo</button>
            <button class="preset-btn" onclick="setUrl('wss://socketsbay.com/wss/v2/1/demo/')">SocketsBay</button>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <span>æ¶ˆæ¯</span>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <div class="stats">
                        <span>å‘é€: <strong id="sentCount">0</strong></span>
                        <span>æ¥æ”¶: <strong id="receivedCount">0</strong></span>
                    </div>
                    <div class="format-toggle">
                        <button class="format-btn active" data-format="raw" onclick="setFormat('raw')">åŸå§‹</button>
                        <button class="format-btn" data-format="json" onclick="setFormat('json')">JSON</button>
                    </div>
                    <button class="clear-btn" onclick="clearMessages()">æ¸…ç©º</button>
                </div>
            </div>
            <div id="messagesContainer" class="messages-container">
                <div class="empty-state">è¿æ¥ WebSocket æœåŠ¡å™¨å¼€å§‹è°ƒè¯•</div>
            </div>
            <div class="send-section">
                <div class="presets" style="margin-bottom: 0.5rem;">
                    <span style="font-size: 0.85rem; color: var(--pico-muted-color);">å¿«æ·æ¶ˆæ¯:</span>
                    <button class="preset-btn" onclick="setMessage('Hello, WebSocket!')">Hello</button>
                    <button class="preset-btn" onclick="setMessage('{&quot;type&quot;:&quot;ping&quot;}')">Ping JSON</button>
                    <button class="preset-btn" onclick="setMessage('{&quot;action&quot;:&quot;subscribe&quot;,&quot;channel&quot;:&quot;test&quot;}')">Subscribe</button>
                </div>
                <div class="send-row">
                    <textarea id="messageInput" class="message-input" rows="2" placeholder="è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯..." onkeydown="handleKeyDown(event)"></textarea>
                    <button id="sendBtn" class="send-btn" onclick="sendMessage()" disabled>å‘é€</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        var ws = null;
        var messages = [];
        var sentCount = 0;
        var receivedCount = 0;
        var displayFormat = 'raw';
        
        window.toggleTheme = function() {
            var html = document.documentElement;
            var newTheme = html.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            document.querySelector('.theme-icon').textContent = newTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        };
        (function() {
            var savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.querySelector('.theme-icon').textContent = savedTheme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸';
        })();
        
        window.setUrl = function(url) {
            document.getElementById('wsUrl').value = url;
        };
        
        window.setMessage = function(msg) {
            document.getElementById('messageInput').value = msg;
        };
        
        window.setFormat = function(format) {
            displayFormat = format;
            document.querySelectorAll('.format-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.format === format);
            });
            renderMessages();
        };
        
        window.toggleConnection = function() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            } else {
                connect();
            }
        };
        
        function connect() {
            var url = document.getElementById('wsUrl').value.trim();
            if (!url) { alert('è¯·è¾“å…¥ WebSocket URL'); return; }
            
            updateStatus('connecting');
            addSystemMessage('æ­£åœ¨è¿æ¥ ' + url + '...');
            
            try {
                ws = new WebSocket(url);
                
                ws.onopen = function() {
                    updateStatus('connected');
                    addSystemMessage('è¿æ¥æˆåŠŸ');
                };
                
                ws.onmessage = function(e) {
                    receivedCount++;
                    document.getElementById('receivedCount').textContent = receivedCount;
                    addMessage('received', e.data);
                };
                
                ws.onerror = function() {
                    addErrorMessage('è¿æ¥é”™è¯¯');
                };
                
                ws.onclose = function(e) {
                    updateStatus('disconnected');
                    addSystemMessage('è¿æ¥å·²å…³é—­ (Code: ' + e.code + ')');
                };
            } catch (err) {
                addErrorMessage('åˆ›å»ºè¿æ¥å¤±è´¥: ' + err.message);
                updateStatus('disconnected');
            }
        }
        
        function updateStatus(status) {
            var dot = document.getElementById('statusDot');
            var text = document.getElementById('statusText');
            var btn = document.getElementById('connectBtn');
            var sendBtn = document.getElementById('sendBtn');
            
            dot.className = 'status-dot ' + status;
            
            if (status === 'connected') {
                text.textContent = 'å·²è¿æ¥';
                btn.textContent = 'æ–­å¼€';
                btn.className = 'connect-btn disconnect';
                sendBtn.disabled = false;
            } else if (status === 'connecting') {
                text.textContent = 'è¿æ¥ä¸­...';
                btn.disabled = true;
                sendBtn.disabled = true;
            } else {
                text.textContent = 'æœªè¿æ¥';
                btn.textContent = 'è¿æ¥';
                btn.className = 'connect-btn connect';
                btn.disabled = false;
                sendBtn.disabled = true;
            }
        }
        
        function sendMessage() {
            var input = document.getElementById('messageInput');
            var msg = input.value.trim();
            if (!msg || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            ws.send(msg);
            sentCount++;
            document.getElementById('sentCount').textContent = sentCount;
            addMessage('sent', msg);
            input.value = '';
        }
        
        window.handleKeyDown = function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };
        
        function addMessage(type, content) {
            messages.push({ type: type, content: content, time: new Date() });
            renderMessages();
            scrollToBottom();
        }
        
        function addSystemMessage(content) {
            messages.push({ type: 'system', content: content, time: new Date() });
            renderMessages();
            scrollToBottom();
        }
        
        function addErrorMessage(content) {
            messages.push({ type: 'error', content: content, time: new Date() });
            renderMessages();
            scrollToBottom();
        }
        
        function renderMessages() {
            var container = document.getElementById('messagesContainer');
            if (!messages.length) {
                container.innerHTML = '<div class="empty-state">è¿æ¥ WebSocket æœåŠ¡å™¨å¼€å§‹è°ƒè¯•</div>';
                return;
            }
            
            container.innerHTML = messages.map(function(msg) {
                var typeLabel = msg.type === 'sent' ? 'å‘é€' : msg.type === 'received' ? 'æ¥æ”¶' : msg.type === 'error' ? 'é”™è¯¯' : 'ç³»ç»Ÿ';
                var content = msg.content;
                
                if ((msg.type === 'sent' || msg.type === 'received') && displayFormat === 'json') {
                    try {
                        var parsed = JSON.parse(content);
                        content = JSON.stringify(parsed, null, 2);
                    } catch(e) {}
                }
                
                return '<div class="message message-' + msg.type + '">' +
                    '<div class="message-header"><span>' + typeLabel + '</span><span>' + formatTime(msg.time) + '</span></div>' +
                    '<div class="message-content">' + escapeHtml(content) + '</div></div>';
            }).join('');
        }
        
        function scrollToBottom() {
            var container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }
        
        window.clearMessages = function() {
            messages = [];
            sentCount = 0;
            receivedCount = 0;
            document.getElementById('sentCount').textContent = '0';
            document.getElementById('receivedCount').textContent = '0';
            renderMessages();
        };
        
        function formatTime(date) {
            return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit', second: '2-digit', fractionalSecondDigits: 3 });
        }
        
        window.escapeHtml = function(str) {
            return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        };
        
        window.addEventListener('beforeunload', function() {
            if (ws) ws.close();
        });
    </script>
</body>
</html>

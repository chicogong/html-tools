<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡Œç¨‹ç¢‘è¿½è¸ªå™¨ - WebUtils</title>
    <style>
        :root {
            --bg-color: #1a1a2e;
            --card-bg: #16213e;
            --text-color: #e0e0e0;
            --primary-color: #0f3460;
            --accent-color: #00d9ff;
            --border-color: #0f3460;
            --input-bg: #1a1a2e;
            --success-color: #4ade80;
            --warning-color: #fbbf24;
            --danger-color: #f87171;
        }

        [data-theme="light"] {
            --bg-color: #f0f4f8;
            --card-bg: #fff;
            --text-color: #1a1a2e;
            --primary-color: #e0e7ff;
            --accent-color: #0891b2;
            --border-color: #c7d2fe;
            --input-bg: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-color), #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .theme-toggle {
            position: absolute;
            right: 0;
            top: 0;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
        }

        .back-link {
            position: absolute;
            left: 0;
            top: 0;
            color: var(--accent-color);
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            text-decoration: underline;
        }

        .panel {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 1rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-color);
            font-size: 14px;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--accent-color);
            color: #000;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--primary-color);
            color: var(--text-color);
        }

        .btn-danger {
            background: transparent;
            color: var(--danger-color);
            padding: 6px 10px;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }

        .stat-card {
            background: var(--input-bg);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .milestone-item {
            position: relative;
            padding: 20px;
            background: var(--input-bg);
            border-radius: 12px;
            margin-bottom: 20px;
            border-left: 3px solid var(--border-color);
        }

        .milestone-item::before {
            content: '';
            position: absolute;
            left: -27px;
            top: 25px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--border-color);
            border: 3px solid var(--card-bg);
        }

        .milestone-item.completed {
            border-left-color: var(--success-color);
        }

        .milestone-item.completed::before {
            background: var(--success-color);
        }

        .milestone-item.in-progress {
            border-left-color: var(--accent-color);
        }

        .milestone-item.in-progress::before {
            background: var(--accent-color);
            animation: pulse 2s infinite;
        }

        .milestone-item.overdue {
            border-left-color: var(--danger-color);
        }

        .milestone-item.overdue::before {
            background: var(--danger-color);
        }

        .milestone-item.upcoming {
            border-left-color: var(--warning-color);
        }

        .milestone-item.upcoming::before {
            background: var(--warning-color);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
        }

        .milestone-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 10px;
        }

        .milestone-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .milestone-date {
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
        }

        .milestone-description {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .milestone-progress {
            margin-top: 10px;
        }

        .progress-bar {
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), #a855f7);
            transition: width 0.5s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            margin-top: 5px;
            opacity: 0.7;
        }

        .milestone-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-completed {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success-color);
        }

        .status-in-progress {
            background: rgba(0, 217, 255, 0.2);
            color: var(--accent-color);
        }

        .status-overdue {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger-color);
        }

        .status-upcoming {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning-color);
        }

        .status-pending {
            background: rgba(128, 128, 128, 0.2);
            color: #888;
        }

        .add-form {
            display: none;
            padding: 20px;
            background: var(--input-bg);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .add-form.show {
            display: block;
        }

        .overall-progress {
            margin-bottom: 20px;
        }

        .overall-bar {
            height: 20px;
            background: var(--input-bg);
            border-radius: 10px;
            overflow: hidden;
            display: flex;
        }

        .overall-segment {
            height: 100%;
            transition: width 0.5s ease;
        }

        .overall-segment.completed {
            background: var(--success-color);
        }

        .overall-segment.in-progress {
            background: var(--accent-color);
        }

        .overall-segment.overdue {
            background: var(--danger-color);
        }

        .legend {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-tab {
            padding: 8px 16px;
            background: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: var(--accent-color);
            color: #000;
            border-color: var(--accent-color);
        }

        .countdown {
            font-size: 12px;
            padding: 4px 8px;
            background: var(--card-bg);
            border-radius: 4px;
            display: inline-block;
        }

        .countdown.urgent {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="../../index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
            <h1>é‡Œç¨‹ç¢‘è¿½è¸ªå™¨</h1>
            <p>é¡¹ç›®è¿›åº¦å¯è§†åŒ–ç®¡ç†</p>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ“Š é¡¹ç›®æ¦‚è§ˆ</div>
            <div class="form-row" style="margin-bottom: 20px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label>é¡¹ç›®åç§°</label>
                    <input type="text" id="projectName" placeholder="è¾“å…¥é¡¹ç›®åç§°" onchange="saveToStorage()" />
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label>é¡¹ç›®æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="projectDeadline" onchange="saveToStorage(); updateStats();" />
                </div>
            </div>
            <div class="overall-progress">
                <div class="overall-bar" id="overallBar"></div>
                <div class="legend">
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--success-color);"></div>
                        <span>å·²å®Œæˆ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--accent-color);"></div>
                        <span>è¿›è¡Œä¸­</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--danger-color);"></div>
                        <span>å·²é€¾æœŸ</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: var(--warning-color);"></div>
                        <span>å¾…å¼€å§‹</span>
                    </div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalMilestones">0</div>
                    <div class="stat-label">æ€»é‡Œç¨‹ç¢‘</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="completedCount">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="inProgressCount">0</div>
                    <div class="stat-label">è¿›è¡Œä¸­</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="overdueCount">0</div>
                    <div class="stat-label">å·²é€¾æœŸ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="daysRemaining">-</div>
                    <div class="stat-label">å‰©ä½™å¤©æ•°</div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ¯ é‡Œç¨‹ç¢‘åˆ—è¡¨</div>
            
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="setFilter('all', this)">å…¨éƒ¨</button>
                <button class="filter-tab" onclick="setFilter('in-progress', this)">è¿›è¡Œä¸­</button>
                <button class="filter-tab" onclick="setFilter('upcoming', this)">å¾…å¼€å§‹</button>
                <button class="filter-tab" onclick="setFilter('completed', this)">å·²å®Œæˆ</button>
                <button class="filter-tab" onclick="setFilter('overdue', this)">å·²é€¾æœŸ</button>
            </div>

            <div class="btn-group" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="toggleAddForm()">+ æ·»åŠ é‡Œç¨‹ç¢‘</button>
            </div>

            <div class="add-form" id="addForm">
                <div class="form-group">
                    <label>é‡Œç¨‹ç¢‘åç§°</label>
                    <input type="text" id="newTitle" placeholder="ä¾‹å¦‚ï¼šäº§å“åŸå‹å®Œæˆ" />
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="newDescription" rows="2" placeholder="é‡Œç¨‹ç¢‘æè¿°..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" id="newDueDate" />
                    </div>
                    <div class="form-group">
                        <label>è´Ÿè´£äºº</label>
                        <input type="text" id="newOwner" placeholder="è´Ÿè´£äººå§“å" />
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="addMilestone()">æ·»åŠ </button>
                    <button class="btn btn-secondary" onclick="toggleAddForm()">å–æ¶ˆ</button>
                </div>
            </div>

            <div class="timeline" id="timeline"></div>
        </div>

        <div class="panel">
            <div class="panel-title">ğŸ’¾ æ“ä½œ</div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="exportReport()">ğŸ“Š å¯¼å‡ºæŠ¥å‘Š</button>
                <button class="btn btn-secondary" onclick="shareLink()">ğŸ”— åˆ†äº«é“¾æ¥</button>
                <button class="btn btn-danger" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            </div>
        </div>
    </div>

    <script>
        var LS_KEY = 'milestone-tracker-data';
        var milestones = [];
        var currentFilter = 'all';

        function init() {
            var savedTheme = localStorage.getItem('theme') || 'dark';
            if (savedTheme === 'light') {
                document.body.setAttribute('data-theme', 'light');
            }

            loadFromUrl() || loadFromStorage();
            renderMilestones();
            updateStats();
        }

        function generateId() {
            return Date.now() + Math.random().toString(36).substr(2, 9);
        }

        function toggleAddForm() {
            var form = document.getElementById('addForm');
            form.classList.toggle('show');
            if (form.classList.contains('show')) {
                document.getElementById('newDueDate').valueAsDate = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000);
            }
        }

        function addMilestone() {
            var title = document.getElementById('newTitle').value.trim();
            var description = document.getElementById('newDescription').value.trim();
            var dueDate = document.getElementById('newDueDate').value;
            var owner = document.getElementById('newOwner').value.trim();

            if (!title || !dueDate) {
                showToast('è¯·å¡«å†™åç§°å’Œæˆªæ­¢æ—¥æœŸ');
                return;
            }

            milestones.push({
                id: generateId(),
                title: title,
                description: description,
                dueDate: dueDate,
                owner: owner,
                progress: 0,
                status: 'pending',
                createdAt: new Date().toISOString()
            });

            document.getElementById('newTitle').value = '';
            document.getElementById('newDescription').value = '';
            document.getElementById('newOwner').value = '';
            toggleAddForm();

            sortMilestones();
            renderMilestones();
            updateStats();
            saveToStorage();
            showToast('é‡Œç¨‹ç¢‘å·²æ·»åŠ ');
        }

        function removeMilestone(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé‡Œç¨‹ç¢‘å—ï¼Ÿ')) {
                milestones = milestones.filter(function(m) { return m.id !== id; });
                renderMilestones();
                updateStats();
                saveToStorage();
            }
        }

        function updateMilestoneProgress(id, progress) {
            var milestone = milestones.find(function(m) { return m.id === id; });
            if (milestone) {
                milestone.progress = parseInt(progress);
                if (milestone.progress >= 100) {
                    milestone.status = 'completed';
                    milestone.completedAt = new Date().toISOString();
                } else if (milestone.progress > 0) {
                    milestone.status = 'in-progress';
                } else {
                    milestone.status = 'pending';
                }
                renderMilestones();
                updateStats();
                saveToStorage();
            }
        }

        function toggleMilestoneStatus(id) {
            var milestone = milestones.find(function(m) { return m.id === id; });
            if (milestone) {
                if (milestone.status === 'completed') {
                    milestone.status = 'pending';
                    milestone.progress = 0;
                    milestone.completedAt = null;
                } else {
                    milestone.status = 'completed';
                    milestone.progress = 100;
                    milestone.completedAt = new Date().toISOString();
                }
                renderMilestones();
                updateStats();
                saveToStorage();
            }
        }

        function getMilestoneStatus(milestone) {
            var today = new Date();
            today.setHours(0, 0, 0, 0);
            var dueDate = new Date(milestone.dueDate);
            dueDate.setHours(0, 0, 0, 0);

            if (milestone.status === 'completed') return 'completed';
            if (dueDate < today) return 'overdue';
            if (milestone.progress > 0) return 'in-progress';
            
            var daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            if (daysUntil <= 7) return 'upcoming';
            return 'pending';
        }

        function setFilter(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(function(tab) { tab.classList.remove('active'); });
            btn.classList.add('active');
            renderMilestones();
        }

        function sortMilestones() {
            milestones.sort(function(a, b) {
                return new Date(a.dueDate) - new Date(b.dueDate);
            });
        }

        function renderMilestones() {
            var container = document.getElementById('timeline');
            container.textContent = '';

            var filtered = milestones.filter(function(m) {
                var status = getMilestoneStatus(m);
                if (currentFilter === 'all') return true;
                return status === currentFilter;
            });

            if (filtered.length === 0) {
                var empty = document.createElement('div');
                empty.className = 'empty-state';
                empty.textContent = currentFilter === 'all' ? 'è¿˜æ²¡æœ‰é‡Œç¨‹ç¢‘ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ' : 'æ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„é‡Œç¨‹ç¢‘';
                container.appendChild(empty);
                return;
            }

            filtered.forEach(function(milestone) {
                var status = getMilestoneStatus(milestone);
                var div = document.createElement('div');
                div.className = 'milestone-item ' + status;

                var header = document.createElement('div');
                header.className = 'milestone-header';

                var titleDiv = document.createElement('div');
                var title = document.createElement('div');
                title.className = 'milestone-title';
                title.textContent = milestone.title;
                titleDiv.appendChild(title);

                var badge = document.createElement('span');
                badge.className = 'status-badge status-' + status;
                var statusLabels = {
                    completed: 'å·²å®Œæˆ',
                    'in-progress': 'è¿›è¡Œä¸­',
                    overdue: 'å·²é€¾æœŸ',
                    upcoming: 'å³å°†åˆ°æœŸ',
                    pending: 'å¾…å¼€å§‹'
                };
                badge.textContent = statusLabels[status];
                titleDiv.appendChild(badge);

                var dateDiv = document.createElement('div');
                var dateSpan = document.createElement('div');
                dateSpan.className = 'milestone-date';
                dateSpan.textContent = 'ğŸ“… ' + milestone.dueDate;
                dateDiv.appendChild(dateSpan);

                var today = new Date();
                today.setHours(0, 0, 0, 0);
                var dueDate = new Date(milestone.dueDate);
                dueDate.setHours(0, 0, 0, 0);
                var daysUntil = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));

                if (status !== 'completed') {
                    var countdown = document.createElement('div');
                    countdown.className = 'countdown' + (daysUntil < 0 || daysUntil <= 3 ? ' urgent' : '');
                    if (daysUntil < 0) {
                        countdown.textContent = 'é€¾æœŸ ' + Math.abs(daysUntil) + ' å¤©';
                    } else if (daysUntil === 0) {
                        countdown.textContent = 'ä»Šå¤©åˆ°æœŸ';
                    } else {
                        countdown.textContent = 'å‰©ä½™ ' + daysUntil + ' å¤©';
                    }
                    dateDiv.appendChild(countdown);
                }

                header.appendChild(titleDiv);
                header.appendChild(dateDiv);
                div.appendChild(header);

                if (milestone.description) {
                    var desc = document.createElement('div');
                    desc.className = 'milestone-description';
                    desc.textContent = milestone.description;
                    div.appendChild(desc);
                }

                if (milestone.owner) {
                    var ownerDiv = document.createElement('div');
                    ownerDiv.style.fontSize = '13px';
                    ownerDiv.style.opacity = '0.7';
                    ownerDiv.textContent = 'ğŸ‘¤ è´Ÿè´£äºº: ' + milestone.owner;
                    div.appendChild(ownerDiv);
                }

                var progressDiv = document.createElement('div');
                progressDiv.className = 'milestone-progress';

                var bar = document.createElement('div');
                bar.className = 'progress-bar';
                var fill = document.createElement('div');
                fill.className = 'progress-fill';
                fill.style.width = milestone.progress + '%';
                bar.appendChild(fill);
                progressDiv.appendChild(bar);

                var progressText = document.createElement('div');
                progressText.className = 'progress-text';

                var progressLabel = document.createElement('span');
                progressLabel.textContent = 'è¿›åº¦: ' + milestone.progress + '%';

                var progressInput = document.createElement('input');
                progressInput.type = 'range';
                progressInput.min = '0';
                progressInput.max = '100';
                progressInput.value = milestone.progress;
                progressInput.style.width = '100px';
                progressInput.onchange = function() {
                    updateMilestoneProgress(milestone.id, progressInput.value);
                };

                progressText.appendChild(progressLabel);
                progressText.appendChild(progressInput);
                progressDiv.appendChild(progressText);
                div.appendChild(progressDiv);

                var actions = document.createElement('div');
                actions.className = 'milestone-actions';

                var completeBtn = document.createElement('button');
                completeBtn.className = 'btn btn-secondary';
                completeBtn.style.padding = '6px 12px';
                completeBtn.style.fontSize = '12px';
                completeBtn.textContent = status === 'completed' ? 'â†©ï¸ æ ‡è®°æœªå®Œæˆ' : 'âœ… æ ‡è®°å®Œæˆ';
                completeBtn.onclick = function() { toggleMilestoneStatus(milestone.id); };

                var deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.textContent = 'åˆ é™¤';
                deleteBtn.onclick = function() { removeMilestone(milestone.id); };

                actions.appendChild(completeBtn);
                actions.appendChild(deleteBtn);
                div.appendChild(actions);

                container.appendChild(div);
            });
        }

        function updateStats() {
            var total = milestones.length;
            var completed = 0;
            var inProgress = 0;
            var overdue = 0;

            milestones.forEach(function(m) {
                var status = getMilestoneStatus(m);
                if (status === 'completed') completed++;
                else if (status === 'in-progress') inProgress++;
                else if (status === 'overdue') overdue++;
            });

            document.getElementById('totalMilestones').textContent = total;
            document.getElementById('completedCount').textContent = completed;
            document.getElementById('inProgressCount').textContent = inProgress;
            document.getElementById('overdueCount').textContent = overdue;

            var deadline = document.getElementById('projectDeadline').value;
            if (deadline) {
                var today = new Date();
                today.setHours(0, 0, 0, 0);
                var endDate = new Date(deadline);
                endDate.setHours(0, 0, 0, 0);
                var daysRemaining = Math.ceil((endDate - today) / (1000 * 60 * 60 * 24));
                document.getElementById('daysRemaining').textContent = daysRemaining >= 0 ? daysRemaining : 'å·²è¿‡æœŸ';
            }

            var overallBar = document.getElementById('overallBar');
            overallBar.textContent = '';

            if (total > 0) {
                var completedWidth = (completed / total * 100);
                var inProgressWidth = (inProgress / total * 100);
                var overdueWidth = (overdue / total * 100);

                if (completedWidth > 0) {
                    var seg1 = document.createElement('div');
                    seg1.className = 'overall-segment completed';
                    seg1.style.width = completedWidth + '%';
                    overallBar.appendChild(seg1);
                }
                if (inProgressWidth > 0) {
                    var seg2 = document.createElement('div');
                    seg2.className = 'overall-segment in-progress';
                    seg2.style.width = inProgressWidth + '%';
                    overallBar.appendChild(seg2);
                }
                if (overdueWidth > 0) {
                    var seg3 = document.createElement('div');
                    seg3.className = 'overall-segment overdue';
                    seg3.style.width = overdueWidth + '%';
                    overallBar.appendChild(seg3);
                }
            }
        }

        function exportReport() {
            var projectName = document.getElementById('projectName').value || 'é¡¹ç›®';
            var lines = [];
            lines.push('# ' + projectName + ' - é‡Œç¨‹ç¢‘æŠ¥å‘Š');
            lines.push('');
            lines.push('ç”Ÿæˆæ—¶é—´: ' + new Date().toLocaleString());
            lines.push('');
            lines.push('## æ¦‚è§ˆ');
            lines.push('- æ€»é‡Œç¨‹ç¢‘: ' + milestones.length);
            lines.push('- å·²å®Œæˆ: ' + document.getElementById('completedCount').textContent);
            lines.push('- è¿›è¡Œä¸­: ' + document.getElementById('inProgressCount').textContent);
            lines.push('- å·²é€¾æœŸ: ' + document.getElementById('overdueCount').textContent);
            lines.push('');
            lines.push('## è¯¦ç»†åˆ—è¡¨');
            lines.push('');
            lines.push('| é‡Œç¨‹ç¢‘ | æˆªæ­¢æ—¥æœŸ | çŠ¶æ€ | è¿›åº¦ | è´Ÿè´£äºº |');
            lines.push('|--------|----------|------|------|--------|');

            milestones.forEach(function(m) {
                var status = getMilestoneStatus(m);
                var statusLabels = {
                    completed: 'å·²å®Œæˆ',
                    'in-progress': 'è¿›è¡Œä¸­',
                    overdue: 'å·²é€¾æœŸ',
                    upcoming: 'å³å°†åˆ°æœŸ',
                    pending: 'å¾…å¼€å§‹'
                };
                lines.push('| ' + m.title + ' | ' + m.dueDate + ' | ' + statusLabels[status] + ' | ' + m.progress + '% | ' + (m.owner || '-') + ' |');
            });

            var content = lines.join('\n');
            var blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = projectName + '_é‡Œç¨‹ç¢‘æŠ¥å‘Š.md';
            a.click();
            URL.revokeObjectURL(url);
        }

        function shareLink() {
            var data = {
                projectName: document.getElementById('projectName').value,
                projectDeadline: document.getElementById('projectDeadline').value,
                milestones: milestones
            };

            try {
                var encoded = btoa(encodeURIComponent(JSON.stringify(data)));
                var url = location.origin + location.pathname + '#' + encoded;
                navigator.clipboard.writeText(url);
                showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶');
            } catch (e) {
                showToast('ç”Ÿæˆé“¾æ¥å¤±è´¥');
            }
        }

        function clearAll() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ')) {
                milestones = [];
                document.getElementById('projectName').value = '';
                document.getElementById('projectDeadline').value = '';
                renderMilestones();
                updateStats();
                saveToStorage();
                showToast('å·²æ¸…ç©º');
            }
        }

        function loadFromUrl() {
            var hash = location.hash.slice(1);
            if (!hash) return false;
            try {
                var data = JSON.parse(decodeURIComponent(atob(hash)));
                document.getElementById('projectName').value = data.projectName || '';
                document.getElementById('projectDeadline').value = data.projectDeadline || '';
                if (data.milestones) milestones = data.milestones;
                return true;
            } catch (e) {
                return false;
            }
        }

        function saveToStorage() {
            var data = {
                projectName: document.getElementById('projectName').value,
                projectDeadline: document.getElementById('projectDeadline').value,
                milestones: milestones
            };
            localStorage.setItem(LS_KEY, JSON.stringify(data));
        }

        function loadFromStorage() {
            var saved = localStorage.getItem(LS_KEY);
            if (saved) {
                try {
                    var data = JSON.parse(saved);
                    document.getElementById('projectName').value = data.projectName || '';
                    document.getElementById('projectDeadline').value = data.projectDeadline || '';
                    if (data.milestones) milestones = data.milestones;
                } catch (e) {
                    console.error('Failed to load from storage');
                }
            }
        }

        function showToast(message) {
            var toast = document.createElement('div');
            toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-color);color:#000;padding:12px 24px;border-radius:8px;z-index:1000;font-size:14px;';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(function() { toast.remove(); }, 2000);
        }

        window.toggleTheme = function() {
            var body = document.body;
            var currentTheme = body.getAttribute('data-theme');
            var newTheme = currentTheme === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        init();
    </script>
</body>
</html>

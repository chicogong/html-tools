<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLåœ¨çº¿æ‰§è¡Œå™¨ - WebUtils</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a25;
            --text-primary: #fff;
            --text-secondary: #88a;
            --accent: #f97316;
            --border: #2a2a3a;
            --success: #22c55e;
            --error: #ef4444;
        }
        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #fff;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #f97316, #ea580c);
            padding: 2rem;
            text-align: center;
        }
        .nav {
            max-width: 1400px;
            margin: 0 auto 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .back-link {
            color: rgba(255,255,255,0.9);
            text-decoration: none;
            font-size: 0.9rem;
        }
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
        }
        .header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        .header p { opacity: 0.9; }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1.5rem;
        }
        .sidebar {
            background: var(--bg-secondary);
            border-radius: 1rem;
            border: 1px solid var(--border);
            padding: 1rem;
            height: fit-content;
        }
        .sidebar h3 {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            padding: 0 0.5rem;
        }
        .table-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        .table-item {
            padding: 0.5rem 0.75rem;
            background: var(--bg-tertiary);
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .table-item:hover { background: var(--border); }
        .table-item.active { border-left: 3px solid var(--accent); }
        .table-icon { font-size: 0.8rem; }
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .editor-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .editor-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-header h3 {
            font-size: 0.9rem;
            font-weight: 600;
        }
        .editor-actions {
            display: flex;
            gap: 0.5rem;
        }
        .btn {
            padding: 0.5rem 1rem;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .btn:hover { opacity: 0.9; }
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        .editor-content {
            position: relative;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 1rem;
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            font-family: Monaco, Menlo, monospace;
            font-size: 0.9rem;
            resize: vertical;
            line-height: 1.5;
        }
        textarea:focus { outline: none; }
        .results-section {
            background: var(--bg-secondary);
            border-radius: 1rem;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .results-header {
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .results-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        .results-content {
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        th {
            background: var(--bg-tertiary);
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        tr:hover td {
            background: var(--bg-tertiary);
        }
        .message {
            padding: 1rem;
            font-size: 0.9rem;
        }
        .message.success { color: var(--success); }
        .message.error { color: var(--error); }
        .examples {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            padding: 0.5rem 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }
        .example-btn {
            padding: 0.375rem 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 0.375rem;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
        }
        .example-btn:hover { border-color: var(--accent); color: var(--text-primary); }
        .loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
        .schema-info {
            padding: 1rem;
            font-size: 0.85rem;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            margin-top: 0.5rem;
        }
        .column-item {
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem 0;
        }
        .column-name { color: var(--accent); }
        .column-type { color: var(--text-secondary); font-size: 0.8rem; }
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="nav">
            <a href="../../index.html" class="back-link">â† è¿”å›é¦–é¡µ</a>
            <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ ä¸»é¢˜</button>
        </div>
        <h1>ğŸ—„ï¸ SQLåœ¨çº¿æ‰§è¡Œå™¨</h1>
        <p>åŸºäºSQLiteçš„åœ¨çº¿SQLæŸ¥è¯¢æµ‹è¯•å·¥å…·</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <h3>ğŸ“Š æ•°æ®è¡¨</h3>
            <div class="table-list" id="tableList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
            <div id="schemaInfo"></div>
        </div>

        <div class="main-content">
            <div class="editor-section">
                <div class="editor-header">
                    <h3>ğŸ“ SQLç¼–è¾‘å™¨</h3>
                    <div class="editor-actions">
                        <button class="btn btn-secondary" onclick="formatSQL()">æ ¼å¼åŒ–</button>
                        <button class="btn btn-secondary" onclick="clearEditor()">æ¸…ç©º</button>
                        <button class="btn" onclick="executeSQL()">â–¶ æ‰§è¡Œ (Ctrl+Enter)</button>
                    </div>
                </div>
                <div class="examples">
                    <button class="example-btn" onclick="loadExample('select')">SELECT</button>
                    <button class="example-btn" onclick="loadExample('insert')">INSERT</button>
                    <button class="example-btn" onclick="loadExample('update')">UPDATE</button>
                    <button class="example-btn" onclick="loadExample('create')">CREATE TABLE</button>
                    <button class="example-btn" onclick="loadExample('join')">JOIN</button>
                    <button class="example-btn" onclick="loadExample('group')">GROUP BY</button>
                </div>
                <div class="editor-content">
                    <textarea id="sqlEditor" placeholder="è¾“å…¥SQLè¯­å¥...">SELECT * FROM users;</textarea>
                </div>
            </div>

            <div class="results-section">
                <div class="results-header">
                    <h3>ğŸ“‹ æ‰§è¡Œç»“æœ</h3>
                    <span class="results-meta" id="resultsMeta"></span>
                </div>
                <div class="results-content" id="resultsContent">
                    <div class="message">æ‰§è¡ŒSQLæŸ¥è¯¢åï¼Œç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.toggleTheme = function() {
            const theme = document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
        };
        document.body.setAttribute('data-theme', localStorage.getItem('theme') || 'dark');

        let db = null;

        // Initialize SQL.js
        async function initDB() {
            try {
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });
                db = new SQL.Database();
                
                // Create sample tables
                db.run(`
                    CREATE TABLE users (
                        id INTEGER PRIMARY KEY,
                        name TEXT NOT NULL,
                        email TEXT UNIQUE,
                        age INTEGER,
                        created_at TEXT DEFAULT CURRENT_TIMESTAMP
                    );
                    
                    CREATE TABLE posts (
                        id INTEGER PRIMARY KEY,
                        user_id INTEGER,
                        title TEXT NOT NULL,
                        content TEXT,
                        views INTEGER DEFAULT 0,
                        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (user_id) REFERENCES users(id)
                    );
                    
                    CREATE TABLE comments (
                        id INTEGER PRIMARY KEY,
                        post_id INTEGER,
                        user_id INTEGER,
                        content TEXT NOT NULL,
                        created_at TEXT DEFAULT CURRENT_TIMESTAMP,
                        FOREIGN KEY (post_id) REFERENCES posts(id),
                        FOREIGN KEY (user_id) REFERENCES users(id)
                    );
                    
                    INSERT INTO users (name, email, age) VALUES 
                        ('å¼ ä¸‰', 'zhangsan@example.com', 28),
                        ('æå››', 'lisi@example.com', 32),
                        ('ç‹äº”', 'wangwu@example.com', 25),
                        ('èµµå…­', 'zhaoliu@example.com', 35),
                        ('é™ˆä¸ƒ', 'chenqi@example.com', 29);
                    
                    INSERT INTO posts (user_id, title, content, views) VALUES 
                        (1, 'Hello World', 'è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ç¯‡æ–‡ç« ', 100),
                        (1, 'SQLå…¥é—¨æ•™ç¨‹', 'ä»Šå¤©å­¦ä¹ äº†åŸºç¡€SQLè¯­æ³•', 250),
                        (2, 'å‰ç«¯å¼€å‘å¿ƒå¾—', 'åˆ†äº«ä¸€äº›å‰ç«¯å¼€å‘ç»éªŒ', 180),
                        (3, 'åç«¯æ¶æ„è®¾è®¡', 'å¾®æœåŠ¡æ¶æ„å®è·µ', 320),
                        (4, 'æ•°æ®åº“ä¼˜åŒ–', 'MySQLæ€§èƒ½ä¼˜åŒ–æŠ€å·§', 420);
                    
                    INSERT INTO comments (post_id, user_id, content) VALUES 
                        (1, 2, 'å†™å¾—å¾ˆå¥½ï¼'),
                        (1, 3, 'æœŸå¾…æ›´å¤šæ–‡ç« '),
                        (2, 4, 'éå¸¸å®ç”¨'),
                        (3, 1, 'å­¦ä¹ äº†'),
                        (4, 5, 'å¹²è´§æ»¡æ»¡');
                `);

                updateTableList();
            } catch (e) {
                document.getElementById('tableList').innerHTML = `<div class="message error">åˆå§‹åŒ–å¤±è´¥: ${e.message}</div>`;
            }
        }

        function updateTableList() {
            const result = db.exec("SELECT name FROM sqlite_master WHERE type='table' ORDER BY name");
            const tables = result.length ? result[0].values.map(v => v[0]) : [];
            
            const list = document.getElementById('tableList');
            if (tables.length === 0) {
                list.innerHTML = '<div class="message">æš‚æ— æ•°æ®è¡¨</div>';
                return;
            }

            list.innerHTML = tables.map(t => `
                <div class="table-item" onclick="showTableSchema('${t}')">
                    <span class="table-icon">ğŸ“„</span>
                    <span>${t}</span>
                </div>
            `).join('');
        }

        window.showTableSchema = function(tableName) {
            document.querySelectorAll('.table-item').forEach(i => i.classList.remove('active'));
            event.currentTarget.classList.add('active');

            const result = db.exec(`PRAGMA table_info(${tableName})`);
            if (!result.length) return;

            const columns = result[0].values;
            const schemaInfo = document.getElementById('schemaInfo');
            schemaInfo.innerHTML = `
                <div class="schema-info">
                    <strong>${tableName}</strong>
                    ${columns.map(col => `
                        <div class="column-item">
                            <span class="column-name">${col[1]}</span>
                            <span class="column-type">${col[2]}${col[3] ? ' NOT NULL' : ''}${col[5] ? ' PK' : ''}</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Quick select
            document.getElementById('sqlEditor').value = `SELECT * FROM ${tableName} LIMIT 100;`;
        };

        function executeSQL() {
            const sql = document.getElementById('sqlEditor').value.trim();
            if (!sql) {
                showMessage('è¯·è¾“å…¥SQLè¯­å¥', 'error');
                return;
            }

            const startTime = performance.now();
            
            try {
                // Split multiple statements
                const statements = sql.split(';').filter(s => s.trim());
                let lastResult = null;
                let affectedRows = 0;

                for (const stmt of statements) {
                    if (!stmt.trim()) continue;
                    
                    const isSelect = stmt.trim().toUpperCase().startsWith('SELECT');
                    
                    if (isSelect) {
                        lastResult = db.exec(stmt);
                    } else {
                        db.run(stmt);
                        affectedRows += db.getRowsModified();
                    }
                }

                const endTime = performance.now();
                const execTime = (endTime - startTime).toFixed(2);

                if (lastResult && lastResult.length > 0) {
                    showResults(lastResult[0], execTime);
                } else {
                    showMessage(`æ‰§è¡ŒæˆåŠŸï¼Œå½±å“ ${affectedRows} è¡Œ (${execTime}ms)`, 'success');
                    updateTableList();
                }

            } catch (e) {
                showMessage(`é”™è¯¯: ${e.message}`, 'error');
            }
        }

        function showResults(result, time) {
            const { columns, values } = result;
            const meta = document.getElementById('resultsMeta');
            meta.textContent = `${values.length} è¡Œ Â· ${time}ms`;

            const content = document.getElementById('resultsContent');
            
            if (values.length === 0) {
                content.innerHTML = '<div class="message">æŸ¥è¯¢ç»“æœä¸ºç©º</div>';
                return;
            }

            content.innerHTML = `
                <table>
                    <thead>
                        <tr>${columns.map(c => `<th>${escapeHtml(c)}</th>`).join('')}</tr>
                    </thead>
                    <tbody>
                        ${values.map(row => `
                            <tr>${row.map(cell => `<td>${cell === null ? '<span style="color:var(--text-secondary)">NULL</span>' : escapeHtml(String(cell))}</td>`).join('')}</tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function showMessage(msg, type) {
            document.getElementById('resultsMeta').textContent = '';
            document.getElementById('resultsContent').innerHTML = `<div class="message ${type}">${escapeHtml(msg)}</div>`;
        }

        window.escapeHtml = function(str) {
            return str.replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            })[m]);
        };

        window.formatSQL = function() {
            let sql = document.getElementById('sqlEditor').value;
            // Basic formatting
            const keywords = ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER BY', 'GROUP BY', 'HAVING', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'INNER JOIN', 'INSERT INTO', 'VALUES', 'UPDATE', 'SET', 'DELETE FROM', 'CREATE TABLE', 'ALTER TABLE', 'DROP TABLE', 'LIMIT', 'OFFSET'];
            
            keywords.forEach(kw => {
                sql = sql.replace(new RegExp('\\b' + kw + '\\b', 'gi'), '\n' + kw);
            });
            
            sql = sql.trim().replace(/\n+/g, '\n');
            document.getElementById('sqlEditor').value = sql;
        };

        window.clearEditor = function() {
            document.getElementById('sqlEditor').value = '';
        };

        window.loadExample = function(type) {
            const examples = {
                select: 'SELECT id, name, email, age\nFROM users\nWHERE age > 25\nORDER BY age DESC;',
                insert: "INSERT INTO users (name, email, age)\nVALUES ('æ–°ç”¨æˆ·', 'new@example.com', 30);",
                update: "UPDATE users\nSET age = age + 1\nWHERE name = 'å¼ ä¸‰';",
                create: 'CREATE TABLE products (\n  id INTEGER PRIMARY KEY,\n  name TEXT NOT NULL,\n  price REAL,\n  stock INTEGER DEFAULT 0\n);',
                join: 'SELECT u.name, p.title, p.views\nFROM users u\nJOIN posts p ON u.id = p.user_id\nORDER BY p.views DESC;',
                group: 'SELECT u.name, COUNT(p.id) as post_count, SUM(p.views) as total_views\nFROM users u\nLEFT JOIN posts p ON u.id = p.user_id\nGROUP BY u.id\nORDER BY total_views DESC;'
            };
            document.getElementById('sqlEditor').value = examples[type] || '';
        };

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                executeSQL();
            }
        });

        // Initialize
        initDB();
    </script>
</body>
</html>

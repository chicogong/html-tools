<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提前还款计算器 - WebUtils</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --bg: #0a0a0f; 
            --card: #12121a; 
            --border: #2a2a3a; 
            --text: #fff; 
            --text2: #888; 
            --accent: #f59e0b; 
            --accent2: #10b981; 
            --danger: #ef4444;
        }
        @media (prefers-color-scheme: light) { 
            :root { 
                --bg: #f5f5f5; 
                --card: #fff; 
                --border: #e0e0e0; 
                --text: #333; 
                --text2: #666; 
            } 
        }
        body { 
            font-family: system-ui, -apple-system, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { max-width: 900px; margin: 0 auto; }
        .back-link { 
            display: inline-block; 
            margin-bottom: 16px; 
            color: var(--accent); 
            text-decoration: none; 
            font-size: 0.9rem; 
        }
        .back-link:hover { text-decoration: underline; }
        h1 { text-align: center; margin-bottom: 8px; font-size: 1.8rem; }
        .subtitle { text-align: center; color: var(--text2); margin-bottom: 24px; }
        .tabs { display: flex; gap: 8px; margin-bottom: 20px; }
        .tab { 
            flex: 1; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--bg); 
            color: var(--text); 
            cursor: pointer; 
            text-align: center; 
            transition: all 0.2s;
        }
        .tab:hover { border-color: var(--accent); }
        .tab.active { background: var(--accent); border-color: var(--accent); color: white; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .card { 
            background: var(--card); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 24px; 
            margin-bottom: 20px; 
        }
        .card-title { font-size: 1rem; color: var(--text2); margin-bottom: 16px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 6px; font-size: 0.9rem; color: var(--text2); }
        input, select { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            background: var(--bg); 
            color: var(--text); 
            font-size: 1rem; 
        }
        input:focus, select:focus { outline: none; border-color: var(--accent); }
        .input-group { display: flex; gap: 8px; }
        .input-group input, .input-group select { flex: 1; }
        .input-group .unit { 
            padding: 12px 16px; 
            background: var(--border); 
            border-radius: 8px; 
            color: var(--text2); 
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            min-width: 50px;
            justify-content: center;
        }
        .quick-btns { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
        .quick-btn { 
            padding: 6px 12px; 
            border: 1px solid var(--border); 
            border-radius: 4px; 
            background: var(--bg); 
            color: var(--text); 
            cursor: pointer; 
            font-size: 0.8rem; 
            transition: all 0.2s;
        }
        .quick-btn:hover { border-color: var(--accent); background: var(--accent); color: white; }
        .result-hero { 
            background: linear-gradient(135deg, var(--accent2), #059669); 
            padding: 24px; 
            border-radius: 12px; 
            text-align: center; 
            color: white; 
            margin-bottom: 20px;
        }
        .result-hero .big { font-size: 2.2rem; font-weight: 700; }
        .result-hero .label { opacity: 0.9; margin-bottom: 4px; font-size: 0.9rem; }
        .result-hero .note { font-size: 0.8rem; opacity: 0.8; margin-top: 8px; }
        .result-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 12px; 
            background: var(--bg); 
            border-radius: 8px; 
            margin-bottom: 8px; 
        }
        .result-row .label { color: var(--text2); }
        .result-row .value { font-weight: 600; }
        .result-row.highlight { background: rgba(16, 185, 129, 0.1); }
        .result-row.highlight .value { color: var(--accent2); }
        .result-row.danger { background: rgba(239, 68, 68, 0.1); }
        .result-row.danger .value { color: var(--danger); }
        .section-title { 
            font-size: 0.9rem; 
            color: var(--text2); 
            margin: 20px 0 12px; 
            padding-bottom: 8px; 
            border-bottom: 1px solid var(--border);
        }
        .compare-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .compare-card {
            background: var(--bg);
            border-radius: 8px;
            padding: 16px;
            text-align: center;
        }
        .compare-card .title { font-size: 0.8rem; color: var(--text2); margin-bottom: 8px; }
        .compare-card .value { font-size: 1.2rem; font-weight: 600; }
        .compare-card.before { border-left: 3px solid var(--danger); }
        .compare-card.after { border-left: 3px solid var(--accent2); }
        .tip-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--accent);
            border-radius: 8px;
            padding: 12px 16px;
            margin-top: 16px;
            font-size: 0.85rem;
            color: var(--accent);
        }
    
        .breadcrumb { position: fixed; top: 10px; left: 10px; z-index: 1000; background: rgba(255,255,255,0.95); padding: 8px 15px; border-radius: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); font-size: 0.85rem; }
        .breadcrumb a { color: #667eea; text-decoration: none; }
        .breadcrumb a:hover { text-decoration: underline; }
        .breadcrumb span { color: #999; margin: 0 5px; }
    </style>
</head>
<body>
    <nav class="breadcrumb"><a href="../../index.html">首页</a><span>›</span><a href="../../index.html#realestate">房产工具</a><span>›</span>提前还款计算器</nav>
    <div class="container">
        <a href="../../index.html" class="back-link">← 返回工具列表</a>
        <h1>⏰ 提前还款计算器</h1>
        <p class="subtitle">计算提前还款后节省的利息和新还款计划</p>
        
        <div class="tabs">
            <button class="tab active" data-mode="reduce-term">缩短年限</button>
            <button class="tab" data-mode="reduce-payment">减少月供</button>
        </div>
        
        <div class="grid">
            <div class="card">
                <div class="card-title">原贷款信息</div>
                <div class="form-group">
                    <label>贷款总额</label>
                    <div class="input-group">
                        <input type="number" id="loanAmount" value="100" min="0" step="1">
                        <span class="unit">万元</span>
                    </div>
                    <div class="quick-btns">
                        <button class="quick-btn" data-loan="50">50万</button>
                        <button class="quick-btn" data-loan="100">100万</button>
                        <button class="quick-btn" data-loan="150">150万</button>
                        <button class="quick-btn" data-loan="200">200万</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>贷款年限</label>
                    <div class="input-group">
                        <input type="number" id="totalYears" value="30" min="1" max="30" step="1">
                        <span class="unit">年</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>年利率</label>
                    <div class="input-group">
                        <input type="number" id="rate" value="3.1" min="0" max="20" step="0.01">
                        <span class="unit">%</span>
                    </div>
                </div>
                <div class="form-group">
                    <label>还款方式</label>
                    <select id="loanType">
                        <option value="equal-payment">等额本息</option>
                        <option value="equal-principal">等额本金</option>
                    </select>
                </div>
                
                <div class="section-title">提前还款信息</div>
                <div class="form-group">
                    <label>已还期数</label>
                    <div class="input-group">
                        <input type="number" id="paidMonths" value="24" min="0" step="1">
                        <span class="unit">期</span>
                    </div>
                    <div class="quick-btns">
                        <button class="quick-btn" data-paid="12">1年</button>
                        <button class="quick-btn" data-paid="24">2年</button>
                        <button class="quick-btn" data-paid="36">3年</button>
                        <button class="quick-btn" data-paid="60">5年</button>
                    </div>
                </div>
                <div class="form-group">
                    <label>提前还款金额</label>
                    <div class="input-group">
                        <input type="number" id="prepayAmount" value="10" min="0" step="1">
                        <span class="unit">万元</span>
                    </div>
                    <div class="quick-btns">
                        <button class="quick-btn" data-prepay="5">5万</button>
                        <button class="quick-btn" data-prepay="10">10万</button>
                        <button class="quick-btn" data-prepay="20">20万</button>
                        <button class="quick-btn" data-prepay="50">50万</button>
                    </div>
                </div>
            </div>
            
            <div>
                <div class="result-hero">
                    <div class="label">节省利息</div>
                    <div class="big" id="savedInterest">¥0.00万</div>
                    <div class="note" id="savedNote">提前还款后可节省的利息总额</div>
                </div>
                
                <div class="card">
                    <div class="card-title">当前还款状态</div>
                    <div class="result-row">
                        <span class="label">原月供</span>
                        <span class="value" id="originalMonthly">¥0.00</span>
                    </div>
                    <div class="result-row">
                        <span class="label">已还本金</span>
                        <span class="value" id="paidPrincipal">¥0.00万</span>
                    </div>
                    <div class="result-row">
                        <span class="label">已还利息</span>
                        <span class="value" id="paidInterest">¥0.00万</span>
                    </div>
                    <div class="result-row">
                        <span class="label">剩余本金</span>
                        <span class="value" id="remainingPrincipal">¥0.00万</span>
                    </div>
                    
                    <div class="section-title">提前还款后</div>
                    <div class="compare-grid">
                        <div class="compare-card before">
                            <div class="title">原剩余期数</div>
                            <div class="value" id="oldRemainMonths">0 期</div>
                        </div>
                        <div class="compare-card after">
                            <div class="title">新剩余期数</div>
                            <div class="value" id="newRemainMonths">0 期</div>
                        </div>
                        <div class="compare-card before">
                            <div class="title">原月供</div>
                            <div class="value" id="oldMonthly">¥0.00</div>
                        </div>
                        <div class="compare-card after">
                            <div class="title">新月供</div>
                            <div class="value" id="newMonthly">¥0.00</div>
                        </div>
                    </div>
                    
                    <div class="section-title">利息对比</div>
                    <div class="result-row danger">
                        <span class="label">不提前还款总利息</span>
                        <span class="value" id="totalInterestWithout">¥0.00万</span>
                    </div>
                    <div class="result-row highlight">
                        <span class="label">提前还款后总利息</span>
                        <span class="value" id="totalInterestWith">¥0.00万</span>
                    </div>
                    
                    <div class="tip-box" id="tipBox">
                        提示：提前还款通常需要提前申请，部分银行可能收取违约金，建议提前咨询银行。
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        (function() {
            let mode = 'reduce-term'; // reduce-term: 缩短年限, reduce-payment: 减少月供
            
            const $ = (id) => document.getElementById(id);
            
            // 格式化金额（万元）
            function formatWan(value) {
                return '¥' + value.toLocaleString('zh-CN', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                }) + '万';
            }
            
            // 格式化金额（元）
            function formatYuan(value) {
                return '¥' + value.toLocaleString('zh-CN', { 
                    minimumFractionDigits: 2, 
                    maximumFractionDigits: 2 
                });
            }
            
            // 等额本息计算详情
            function calcEqualPaymentDetail(principal, totalMonths, monthlyRate, paidMonths) {
                if (monthlyRate === 0) {
                    const monthly = principal / totalMonths;
                    return {
                        monthlyPayment: monthly,
                        paidPrincipal: monthly * paidMonths,
                        paidInterest: 0,
                        remainingPrincipal: principal - monthly * paidMonths,
                        totalInterest: 0
                    };
                }
                
                const monthlyPayment = principal * monthlyRate * Math.pow(1 + monthlyRate, totalMonths) 
                    / (Math.pow(1 + monthlyRate, totalMonths) - 1);
                
                let remaining = principal;
                let paidPrincipal = 0;
                let paidInterest = 0;
                let totalInterest = 0;
                
                for (let i = 1; i <= totalMonths; i++) {
                    const interest = remaining * monthlyRate;
                    const principalPart = monthlyPayment - interest;
                    
                    if (i <= paidMonths) {
                        paidPrincipal += principalPart;
                        paidInterest += interest;
                    }
                    totalInterest += interest;
                    remaining -= principalPart;
                }
                
                return {
                    monthlyPayment,
                    paidPrincipal,
                    paidInterest,
                    remainingPrincipal: principal - paidPrincipal,
                    totalInterest
                };
            }
            
            // 等额本金计算详情
            function calcEqualPrincipalDetail(principal, totalMonths, monthlyRate, paidMonths) {
                const monthlyPrincipal = principal / totalMonths;
                let remaining = principal;
                let paidPrincipal = 0;
                let paidInterest = 0;
                let totalInterest = 0;
                let firstMonthPayment = 0;
                
                for (let i = 1; i <= totalMonths; i++) {
                    const interest = remaining * monthlyRate;
                    const payment = monthlyPrincipal + interest;
                    
                    if (i === 1) firstMonthPayment = payment;
                    
                    if (i <= paidMonths) {
                        paidPrincipal += monthlyPrincipal;
                        paidInterest += interest;
                    }
                    totalInterest += interest;
                    remaining -= monthlyPrincipal;
                }
                
                return {
                    monthlyPayment: firstMonthPayment,
                    paidPrincipal,
                    paidInterest,
                    remainingPrincipal: principal - paidPrincipal,
                    totalInterest
                };
            }
            
            // 计算新还款计划
            function calcNewPlan(newPrincipal, monthlyRate, oldMonthlyPayment, mode, loanType) {
                if (newPrincipal <= 0) {
                    return { newMonths: 0, newMonthlyPayment: 0, newTotalInterest: 0 };
                }
                
                if (monthlyRate === 0) {
                    if (mode === 'reduce-term') {
                        const newMonths = Math.ceil(newPrincipal / oldMonthlyPayment);
                        return { newMonths, newMonthlyPayment: oldMonthlyPayment, newTotalInterest: 0 };
                    } else {
                        // 使用原剩余期数
                        return { newMonths: 0, newMonthlyPayment: 0, newTotalInterest: 0 };
                    }
                }
                
                if (loanType === 'equal-payment') {
                    if (mode === 'reduce-term') {
                        // 缩短年限：保持月供不变，计算新期数
                        // 公式: n = -ln(1 - P*r/M) / ln(1+r)
                        const temp = 1 - newPrincipal * monthlyRate / oldMonthlyPayment;
                        if (temp <= 0) {
                            return { newMonths: 0, newMonthlyPayment: oldMonthlyPayment, newTotalInterest: 0 };
                        }
                        const newMonths = Math.ceil(-Math.log(temp) / Math.log(1 + monthlyRate));
                        const newTotalInterest = oldMonthlyPayment * newMonths - newPrincipal;
                        return { newMonths, newMonthlyPayment: oldMonthlyPayment, newTotalInterest };
                    } else {
                        // 减少月供：保持期数不变，计算新月供
                        // 需要获取剩余期数
                        return { newMonths: 0, newMonthlyPayment: 0, newTotalInterest: 0 };
                    }
                } else {
                    // 等额本金
                    if (mode === 'reduce-term') {
                        const newMonths = Math.ceil(newPrincipal / (oldMonthlyPayment - newPrincipal * monthlyRate));
                        let totalInterest = 0;
                        let remaining = newPrincipal;
                        const monthlyPrincipal = newPrincipal / newMonths;
                        for (let i = 0; i < newMonths; i++) {
                            totalInterest += remaining * monthlyRate;
                            remaining -= monthlyPrincipal;
                        }
                        return { newMonths, newMonthlyPayment: monthlyPrincipal + newPrincipal * monthlyRate, newTotalInterest: totalInterest };
                    } else {
                        return { newMonths: 0, newMonthlyPayment: 0, newTotalInterest: 0 };
                    }
                }
            }
            
            // 主计算函数
            function calculate() {
                const loanAmount = parseFloat($('loanAmount').value) * 10000 || 0;
                const totalYears = parseInt($('totalYears').value) || 30;
                const annualRate = parseFloat($('rate').value) / 100 || 0;
                const loanType = $('loanType').value;
                const paidMonths = parseInt($('paidMonths').value) || 0;
                const prepayAmount = parseFloat($('prepayAmount').value) * 10000 || 0;
                
                const totalMonths = totalYears * 12;
                const monthlyRate = annualRate / 12;
                const remainMonths = totalMonths - paidMonths;
                
                // 计算当前状态
                let detail;
                if (loanType === 'equal-payment') {
                    detail = calcEqualPaymentDetail(loanAmount, totalMonths, monthlyRate, paidMonths);
                } else {
                    detail = calcEqualPrincipalDetail(loanAmount, totalMonths, monthlyRate, paidMonths);
                }
                
                // 更新当前状态显示
                $('originalMonthly').textContent = formatYuan(detail.monthlyPayment);
                $('paidPrincipal').textContent = formatWan(detail.paidPrincipal / 10000);
                $('paidInterest').textContent = formatWan(detail.paidInterest / 10000);
                $('remainingPrincipal').textContent = formatWan(detail.remainingPrincipal / 10000);
                
                // 提前还款后的新本金
                const newPrincipal = Math.max(0, detail.remainingPrincipal - prepayAmount);
                
                // 计算不提前还款的剩余利息
                let remainingInterestWithout = detail.totalInterest - detail.paidInterest;
                
                // 计算提前还款后的新计划
                let newMonths, newMonthlyPayment, newTotalInterest;
                
                if (newPrincipal <= 0) {
                    // 一次性还清
                    newMonths = 0;
                    newMonthlyPayment = 0;
                    newTotalInterest = 0;
                } else if (mode === 'reduce-term') {
                    // 缩短年限模式
                    if (loanType === 'equal-payment') {
                        if (monthlyRate > 0) {
                            const temp = 1 - newPrincipal * monthlyRate / detail.monthlyPayment;
                            if (temp > 0) {
                                newMonths = Math.ceil(-Math.log(temp) / Math.log(1 + monthlyRate));
                                newMonthlyPayment = detail.monthlyPayment;
                                newTotalInterest = detail.monthlyPayment * newMonths - newPrincipal;
                            } else {
                                newMonths = remainMonths;
                                newMonthlyPayment = detail.monthlyPayment;
                                newTotalInterest = remainingInterestWithout;
                            }
                        } else {
                            newMonths = Math.ceil(newPrincipal / detail.monthlyPayment);
                            newMonthlyPayment = detail.monthlyPayment;
                            newTotalInterest = 0;
                        }
                    } else {
                        // 等额本金 - 缩短年限
                        const oldMonthlyPrincipal = loanAmount / totalMonths;
                        newMonths = Math.ceil(newPrincipal / oldMonthlyPrincipal);
                        newMonthlyPayment = oldMonthlyPrincipal + newPrincipal * monthlyRate;
                        newTotalInterest = 0;
                        let remaining = newPrincipal;
                        for (let i = 0; i < newMonths; i++) {
                            newTotalInterest += remaining * monthlyRate;
                            remaining -= oldMonthlyPrincipal;
                        }
                    }
                } else {
                    // 减少月供模式
                    newMonths = remainMonths;
                    if (loanType === 'equal-payment') {
                        if (monthlyRate > 0 && newMonths > 0) {
                            newMonthlyPayment = newPrincipal * monthlyRate * Math.pow(1 + monthlyRate, newMonths) 
                                / (Math.pow(1 + monthlyRate, newMonths) - 1);
                        } else {
                            newMonthlyPayment = newMonths > 0 ? newPrincipal / newMonths : 0;
                        }
                        newTotalInterest = newMonthlyPayment * newMonths - newPrincipal;
                    } else {
                        // 等额本金 - 减少月供
                        const newMonthlyPrincipal = newPrincipal / newMonths;
                        newMonthlyPayment = newMonthlyPrincipal + newPrincipal * monthlyRate;
                        newTotalInterest = 0;
                        let remaining = newPrincipal;
                        for (let i = 0; i < newMonths; i++) {
                            newTotalInterest += remaining * monthlyRate;
                            remaining -= newMonthlyPrincipal;
                        }
                    }
                }
                
                // 节省的利息 = 不提前还款的剩余利息 - 提前还款后的总利息
                const savedInterest = Math.max(0, remainingInterestWithout - newTotalInterest);
                
                // 更新结果显示
                $('savedInterest').textContent = formatWan(savedInterest / 10000);
                $('oldRemainMonths').textContent = remainMonths + ' 期';
                $('newRemainMonths').textContent = newMonths + ' 期';
                $('oldMonthly').textContent = formatYuan(detail.monthlyPayment);
                $('newMonthly').textContent = formatYuan(newMonthlyPayment);
                
                // 总利息对比
                $('totalInterestWithout').textContent = formatWan(detail.totalInterest / 10000);
                $('totalInterestWith').textContent = formatWan((detail.paidInterest + newTotalInterest) / 10000);
                
                // 更新提示
                updateTip(savedInterest, prepayAmount, mode);
            }
            
            // 更新提示信息
            function updateTip(saved, prepay, mode) {
                const tipBox = $('tipBox');
                const savedPercent = prepay > 0 ? (saved / prepay * 100).toFixed(1) : 0;
                
                if (mode === 'reduce-term') {
                    tipBox.textContent = '缩短年限模式：保持月供不变，减少还款期数。每提前还款1万元约节省利息 ' + 
                        (prepay > 0 ? (saved / prepay * 10000).toFixed(0) : 0) + ' 元。';
                } else {
                    tipBox.textContent = '减少月供模式：保持还款期数不变，降低每月还款额。适合希望减轻月供压力的情况。';
                }
            }
            
            // 切换模式
            function switchMode(newMode) {
                mode = newMode;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelector('[data-mode="' + newMode + '"]').classList.add('active');
                
                calculate();
            }
            
            // 事件绑定
            function bindEvents() {
                // Tab 切换
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.addEventListener('click', function() {
                        switchMode(this.dataset.mode);
                    });
                });
                
                // 输入框变化
                ['loanAmount', 'totalYears', 'rate', 'loanType', 'paidMonths', 'prepayAmount'].forEach(id => {
                    $(id).addEventListener('input', calculate);
                    $(id).addEventListener('change', calculate);
                });
                
                // 快捷按钮
                document.querySelectorAll('.quick-btn[data-loan]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        $('loanAmount').value = this.dataset.loan;
                        calculate();
                    });
                });
                
                document.querySelectorAll('.quick-btn[data-paid]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        $('paidMonths').value = this.dataset.paid;
                        calculate();
                    });
                });
                
                document.querySelectorAll('.quick-btn[data-prepay]').forEach(btn => {
                    btn.addEventListener('click', function() {
                        $('prepayAmount').value = this.dataset.prepay;
                        calculate();
                    });
                });
            }
            
            // 初始化
            bindEvents();
            calculate();
        })();
    </script>
</body>
</html>

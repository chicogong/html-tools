<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data URL è½¬æ¢å™¨ - WebUtils</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        body { padding: 1rem; }
        .container { max-width: 1000px; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        header h1 { margin: 0; font-size: 1.5rem; }
        .tabs { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
        .tabs button { padding: 0.5rem 1rem; }
        .tabs button.active { background: var(--pico-primary); color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .drop-zone { border: 2px dashed var(--pico-muted-border-color); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.3s; margin-bottom: 1rem; }
        .drop-zone:hover, .drop-zone.dragover { border-color: var(--pico-primary); background: var(--pico-primary-background); }
        .drop-zone input { display: none; }
        .preview-area { background: repeating-conic-gradient(#ccc 0% 25%, white 0% 50%) 50% / 20px 20px; border-radius: 8px; padding: 1rem; min-height: 150px; display: flex; align-items: center; justify-content: center; margin-bottom: 1rem; }
        .preview-area img { max-width: 100%; max-height: 300px; border-radius: 4px; }
        .output-area { position: relative; }
        .output-area textarea { font-family: Monaco, Menlo, monospace; font-size: 0.8rem; min-height: 150px; resize: vertical; }
        .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; }
        .info-card { background: var(--pico-card-background-color); padding: 0.75rem; border-radius: 8px; text-align: center; }
        .info-value { font-size: 1.1rem; font-weight: bold; color: var(--pico-primary); }
        .info-label { font-size: 0.8rem; color: var(--pico-muted-color); }
        .btn-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .btn-group button { flex: 1; min-width: 120px; }
        .format-options { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; align-items: center; }
        .format-options label { display: flex; align-items: center; gap: 0.5rem; margin: 0; }
        .format-options select { width: auto; margin: 0; padding: 0.5rem; }
        .decode-input textarea { font-family: Monaco, Menlo, monospace; font-size: 0.8rem; min-height: 120px; }
        .error-msg { color: #ef4444; font-size: 0.85rem; margin-top: 0.5rem; }
        .success-msg { color: #22c55e; font-size: 0.85rem; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <main class="container">
        <header>
            <h1>ğŸ”— Data URL è½¬æ¢å™¨</h1>
            <button id="themeToggle" class="outline" style="padding: 0.5rem;">ğŸŒ“</button>
        </header>

        <div class="tabs">
            <button class="active" onclick="switchTab('encode')">æ–‡ä»¶ â†’ Data URL</button>
            <button onclick="switchTab('decode')">Data URL â†’ æ–‡ä»¶</button>
        </div>

        <!-- ç¼–ç æ ‡ç­¾ -->
        <div id="encodeTab" class="tab-content active">
            <div class="drop-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" accept="image/*,audio/*,video/*,application/pdf,.svg,.json,.xml,.txt,.css,.js,.html">
                <p style="margin: 0;">ğŸ“ ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</p>
                <small style="color: var(--pico-muted-color);">æ”¯æŒå›¾ç‰‡ã€éŸ³é¢‘ã€è§†é¢‘ã€PDFã€SVGã€æ–‡æœ¬ç­‰æ ¼å¼</small>
            </div>

            <div class="format-options">
                <label>
                    è¾“å‡ºæ ¼å¼ï¼š
                    <select id="outputFormat">
                        <option value="dataurl">Data URL</option>
                        <option value="base64">çº¯ Base64</option>
                        <option value="css">CSS background-image</option>
                        <option value="html-img">HTML img æ ‡ç­¾</option>
                        <option value="markdown">Markdown å›¾ç‰‡</option>
                    </select>
                </label>
                <label>
                    <input type="checkbox" id="wrapLines" checked>
                    è‡ªåŠ¨æ¢è¡Œï¼ˆæ¯ 76 å­—ç¬¦ï¼‰
                </label>
            </div>

            <div class="info-grid" id="fileInfo" style="display: none;">
                <div class="info-card">
                    <div class="info-value" id="fileName">-</div>
                    <div class="info-label">æ–‡ä»¶å</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="fileSize">-</div>
                    <div class="info-label">åŸå§‹å¤§å°</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="mimeType">-</div>
                    <div class="info-label">MIME ç±»å‹</div>
                </div>
                <div class="info-card">
                    <div class="info-value" id="encodedSize">-</div>
                    <div class="info-label">ç¼–ç åå¤§å°</div>
                </div>
            </div>

            <div class="preview-area" id="previewArea" style="display: none;"></div>

            <div class="output-area">
                <textarea id="encodeOutput" readonly placeholder="Data URL å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <button class="outline copy-btn" onclick="copyOutput('encodeOutput')">å¤åˆ¶</button>
            </div>

            <div class="btn-group" style="margin-top: 1rem;">
                <button class="outline" onclick="clearEncode()">æ¸…ç©º</button>
                <button class="outline" onclick="downloadAsFile()">ä¸‹è½½ä¸ºæ–‡ä»¶</button>
            </div>
        </div>

        <!-- è§£ç æ ‡ç­¾ -->
        <div id="decodeTab" class="tab-content">
            <div class="decode-input">
                <textarea id="decodeInput" placeholder="ç²˜è´´ Data URL æˆ– Base64 ç¼–ç ..."></textarea>
            </div>

            <div class="format-options" style="margin-top: 1rem;">
                <label>
                    æŒ‡å®š MIME ç±»å‹ï¼ˆå¯é€‰ï¼‰ï¼š
                    <select id="decodeMime">
                        <option value="">è‡ªåŠ¨æ£€æµ‹</option>
                        <option value="image/png">image/png</option>
                        <option value="image/jpeg">image/jpeg</option>
                        <option value="image/gif">image/gif</option>
                        <option value="image/svg+xml">image/svg+xml</option>
                        <option value="image/webp">image/webp</option>
                        <option value="application/pdf">application/pdf</option>
                        <option value="text/plain">text/plain</option>
                        <option value="text/html">text/html</option>
                        <option value="text/css">text/css</option>
                        <option value="application/json">application/json</option>
                    </select>
                </label>
                <button onclick="decodeDataUrl()">è§£ç </button>
            </div>

            <div id="decodeResult" style="margin-top: 1rem; display: none;">
                <div class="info-grid">
                    <div class="info-card">
                        <div class="info-value" id="decodeMimeType">-</div>
                        <div class="info-label">MIME ç±»å‹</div>
                    </div>
                    <div class="info-card">
                        <div class="info-value" id="decodeSize">-</div>
                        <div class="info-label">è§£ç åå¤§å°</div>
                    </div>
                </div>

                <div class="preview-area" id="decodePreview"></div>

                <div class="btn-group">
                    <button onclick="downloadDecoded()">ä¸‹è½½æ–‡ä»¶</button>
                    <button class="outline" onclick="clearDecode()">æ¸…ç©º</button>
                </div>
            </div>

            <div id="decodeError" class="error-msg"></div>
        </div>
    </main>

    <script>
        let currentFile = null;
        let currentDataUrl = null;
        let decodedBlob = null;
        let decodedMime = null;

        // æ ‡ç­¾åˆ‡æ¢
        window.switchTab = function(tab) {
            document.querySelectorAll('.tabs button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.tabs button[onclick*="' + tab + '"]').classList.add('active');
            document.getElementById(tab + 'Tab').classList.add('active');
        };

        // æ–‡ä»¶å¤„ç†
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', e => {
            handleFile(e.target.files[0]);
        });

        function handleFile(file) {
            if (!file) return;
            currentFile = file;

            const reader = new FileReader();
            reader.onload = function(e) {
                currentDataUrl = e.target.result;
                updateOutput();
                showFileInfo(file);
                showPreview(file, currentDataUrl);
            };
            reader.readAsDataURL(file);
        }

        function showFileInfo(file) {
            document.getElementById('fileInfo').style.display = 'grid';
            document.getElementById('fileName').textContent = file.name.length > 20 ? file.name.slice(0, 20) + '...' : file.name;
            document.getElementById('fileName').title = file.name;
            document.getElementById('fileSize').textContent = formatSize(file.size);
            document.getElementById('mimeType').textContent = file.type || 'unknown';
        }

        function showPreview(file, dataUrl) {
            const preview = document.getElementById('previewArea');
            preview.style.display = 'flex';
            preview.textContent = '';

            if (file.type.startsWith('image/')) {
                const img = document.createElement('img');
                img.src = dataUrl;
                preview.appendChild(img);
            } else if (file.type.startsWith('audio/')) {
                const audio = document.createElement('audio');
                audio.src = dataUrl;
                audio.controls = true;
                preview.appendChild(audio);
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.src = dataUrl;
                video.controls = true;
                video.style.maxWidth = '100%';
                video.style.maxHeight = '300px';
                preview.appendChild(video);
            } else {
                preview.textContent = 'é¢„è§ˆä¸å¯ç”¨ (' + (file.type || 'æœªçŸ¥ç±»å‹') + ')';
            }
        }

        function updateOutput() {
            if (!currentDataUrl) return;

            const format = document.getElementById('outputFormat').value;
            const wrapLines = document.getElementById('wrapLines').checked;
            let output = '';

            switch (format) {
                case 'dataurl':
                    output = currentDataUrl;
                    break;
                case 'base64':
                    output = currentDataUrl.split(',')[1] || '';
                    break;
                case 'css':
                    output = 'background-image: url("' + currentDataUrl + '");';
                    break;
                case 'html-img':
                    output = '<img src="' + currentDataUrl + '" alt="image">';
                    break;
                case 'markdown':
                    output = '![image](' + currentDataUrl + ')';
                    break;
            }

            if (wrapLines && (format === 'dataurl' || format === 'base64')) {
                output = output.match(/.{1,76}/g).join('\n');
            }

            document.getElementById('encodeOutput').value = output;
            document.getElementById('encodedSize').textContent = formatSize(output.length);
        }

        document.getElementById('outputFormat').addEventListener('change', updateOutput);
        document.getElementById('wrapLines').addEventListener('change', updateOutput);

        window.copyOutput = function(id) {
            const textarea = document.getElementById(id);
            navigator.clipboard.writeText(textarea.value).then(() => {
                const btn = textarea.nextElementSibling;
                btn.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => btn.textContent = 'å¤åˆ¶', 1500);
            });
        };

        window.clearEncode = function() {
            currentFile = null;
            currentDataUrl = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('encodeOutput').value = '';
            document.getElementById('fileInfo').style.display = 'none';
            document.getElementById('previewArea').style.display = 'none';
        };

        window.downloadAsFile = function() {
            const output = document.getElementById('encodeOutput').value;
            if (!output) return;
            
            const blob = new Blob([output], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'data-url.txt';
            a.click();
            URL.revokeObjectURL(url);
        };

        // è§£ç åŠŸèƒ½
        window.decodeDataUrl = function() {
            const input = document.getElementById('decodeInput').value.trim();
            const errorDiv = document.getElementById('decodeError');
            const resultDiv = document.getElementById('decodeResult');
            
            errorDiv.textContent = '';
            resultDiv.style.display = 'none';

            if (!input) {
                errorDiv.textContent = 'è¯·è¾“å…¥ Data URL æˆ– Base64 ç¼–ç ';
                return;
            }

            try {
                let base64Data, mimeType;
                
                // æ£€æµ‹æ˜¯å¦ä¸ºå®Œæ•´çš„ Data URL
                if (input.startsWith('data:')) {
                    const match = input.match(/^data:([^;,]+)?(?:;base64)?,(.*)$/);
                    if (!match) throw new Error('æ— æ•ˆçš„ Data URL æ ¼å¼');
                    mimeType = match[1] || 'application/octet-stream';
                    base64Data = match[2];
                } else {
                    // å‡è®¾æ˜¯çº¯ Base64
                    base64Data = input.replace(/\s/g, '');
                    mimeType = document.getElementById('decodeMime').value || 'application/octet-stream';
                }

                // è§£ç  Base64
                const binaryStr = atob(base64Data);
                const bytes = new Uint8Array(binaryStr.length);
                for (let i = 0; i < binaryStr.length; i++) {
                    bytes[i] = binaryStr.charCodeAt(i);
                }

                decodedBlob = new Blob([bytes], { type: mimeType });
                decodedMime = mimeType;

                // æ˜¾ç¤ºç»“æœ
                document.getElementById('decodeMimeType').textContent = mimeType;
                document.getElementById('decodeSize').textContent = formatSize(decodedBlob.size);
                resultDiv.style.display = 'block';

                // é¢„è§ˆ
                const preview = document.getElementById('decodePreview');
                preview.textContent = '';
                const blobUrl = URL.createObjectURL(decodedBlob);

                if (mimeType.startsWith('image/')) {
                    const img = document.createElement('img');
                    img.src = blobUrl;
                    preview.appendChild(img);
                } else if (mimeType.startsWith('audio/')) {
                    const audio = document.createElement('audio');
                    audio.src = blobUrl;
                    audio.controls = true;
                    preview.appendChild(audio);
                } else if (mimeType.startsWith('video/')) {
                    const video = document.createElement('video');
                    video.src = blobUrl;
                    video.controls = true;
                    video.style.maxWidth = '100%';
                    preview.appendChild(video);
                } else if (mimeType.startsWith('text/') || mimeType === 'application/json') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const pre = document.createElement('pre');
                        pre.style.textAlign = 'left';
                        pre.style.maxHeight = '200px';
                        pre.style.overflow = 'auto';
                        pre.style.padding = '1rem';
                        pre.style.background = 'var(--pico-card-background-color)';
                        pre.style.borderRadius = '4px';
                        pre.textContent = e.target.result.slice(0, 5000) + (e.target.result.length > 5000 ? '\n...(truncated)' : '');
                        preview.appendChild(pre);
                    };
                    reader.readAsText(decodedBlob);
                } else {
                    preview.textContent = 'é¢„è§ˆä¸å¯ç”¨ (' + mimeType + ')';
                }

            } catch (e) {
                errorDiv.textContent = 'è§£ç å¤±è´¥: ' + e.message;
            }
        };

        window.downloadDecoded = function() {
            if (!decodedBlob) return;
            
            const ext = getExtension(decodedMime);
            const url = URL.createObjectURL(decodedBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'decoded' + ext;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.clearDecode = function() {
            decodedBlob = null;
            decodedMime = null;
            document.getElementById('decodeInput').value = '';
            document.getElementById('decodeResult').style.display = 'none';
            document.getElementById('decodeError').textContent = '';
        };

        function getExtension(mime) {
            const map = {
                'image/png': '.png', 'image/jpeg': '.jpg', 'image/gif': '.gif',
                'image/webp': '.webp', 'image/svg+xml': '.svg', 'application/pdf': '.pdf',
                'text/plain': '.txt', 'text/html': '.html', 'text/css': '.css',
                'application/json': '.json', 'audio/mpeg': '.mp3', 'audio/wav': '.wav',
                'video/mp4': '.mp4', 'video/webm': '.webm'
            };
            return map[mime] || '.bin';
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / 1024 / 1024).toFixed(2) + ' MB';
        }

        // ä¸»é¢˜åˆ‡æ¢
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        
        themeToggle.addEventListener('click', function() {
            const current = html.getAttribute('data-theme');
            const next = current === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        });
    </script>
</body>
</html>

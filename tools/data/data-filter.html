<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>æ•°æ®ç­›é€‰å™¨ - WebUtils</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="å¼ºå¤§çš„æ•°æ®ç­›é€‰å·¥å…·ï¼Œæ”¯æŒCSV/æ–‡æœ¬ç­›é€‰ï¼Œå¤šç§åŒ¹é…æ¨¡å¼ï¼Œå¤šæ¡ä»¶ç»„åˆ" />
    <meta name="keywords" content="data filter ç­›é€‰ è¿‡æ»¤ CSV regex contains" />
    <meta name="author" content="WebUtils" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="https://tools.realtime-ai.chat/tools/data/data-filter.html" />

    <!-- Open Graph -->
    <meta property="og:title" content="æ•°æ®ç­›é€‰å™¨ - WebUtils" />
    <meta property="og:description" content="å¼ºå¤§çš„æ•°æ®ç­›é€‰å·¥å…·ï¼Œæ”¯æŒCSV/æ–‡æœ¬ç­›é€‰ï¼Œå¤šç§åŒ¹é…æ¨¡å¼ï¼Œå¤šæ¡ä»¶ç»„åˆ" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content="https://tools.realtime-ai.chat/tools/data/data-filter.html" />
    <meta property="og:site_name" content="WebUtils" />
    <meta property="og:locale" content="zh_CN" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="æ•°æ®ç­›é€‰å™¨ - WebUtils" />
    <meta name="twitter:description" content="å¼ºå¤§çš„æ•°æ®ç­›é€‰å·¥å…·ï¼Œæ”¯æŒCSV/æ–‡æœ¬ç­›é€‰ï¼Œå¤šç§åŒ¹é…æ¨¡å¼ï¼Œå¤šæ¡ä»¶ç»„åˆ" />
    <!-- OG Image -->
    <meta property="og:image" content="https://tools.realtime-ai.chat/social-preview.png" />
    <meta property="og:image:width" content="1280" />
    <meta property="og:image:height" content="640" />
    <meta property="og:image:type" content="image/png" />
    <meta name="twitter:image" content="https://tools.realtime-ai.chat/social-preview.png" />

    <!-- JSON-LD BreadcrumbList Schema -->
    <script type="application/ld+json">
      {
        "@context": "https://schema.org",
        "@type": "BreadcrumbList",
        "itemListElement": [
          {
            "@type": "ListItem",
            "position": 1,
            "name": "é¦–é¡µ",
            "item": "https://tools.realtime-ai.chat/"
          },
          {
            "@type": "ListItem",
            "position": 2,
            "name": "æ•°æ®å·¥å…·",
            "item": "https://tools.realtime-ai.chat/#data"
          },
          {
            "@type": "ListItem",
            "position": 3,
            "name": "æ•°æ®ç­›é€‰å™¨",
            "item": "https://tools.realtime-ai.chat/tools/data/data-filter.html"
          }
        ]
      }
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-bg-deep: #0a0a0f;
        --color-bg-surface: #12121a;
        --color-bg-card: #1a1a24;
        --bg-input: #0e0e14;
        --bg-hover: #22222e;
        --color-text-primary: #e8e8ed;
        --color-text-secondary: #8888a0;
        --color-text-muted: #55556a;
        --border-subtle: #2a2a3a;
        --border-strong: #3a3a4a;
        --color-accent-cyan: #00f5d4;
        --accent-green: #10b981;
        --accent-red: #f43f5e;
        --accent-yellow: #fbbf24;
        --accent-blue: #3b82f6;
        --color-accent-purple: #a855f7;
        --glow-cyan: rgb(0, 245, 212, 0.15);
        --glow-green: rgb(16, 185, 129, 0.15);
        --glow-red: rgb(244, 63, 94, 0.15);
        --radius-sm: 4px;
        --radius-md: 8px;
        --radius-lg: 12px;
        --font-sans:
          "Space Grotesk", -apple-system, blinkmacsystemfont, "Segoe UI", roboto, sans-serif;
        --font-mono: "JetBrains Mono", "Courier New", monospace;
      }
      [data-theme="light"] {
        --color-bg-deep: #fafafa;
        --color-bg-surface: #fff;
        --color-bg-card: #fff;
        --bg-input: #f5f5f5;
        --bg-hover: #f0f0f0;
        --color-text-primary: #1a1a1a;
        --color-text-secondary: #666;
        --color-text-muted: #999;
        --border-subtle: #e5e5e5;
        --border-strong: #d5d5d5;
      }
      .theme-toggle {
        position: fixed;
        top: 1rem;
        right: 1rem;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 1px solid var(--border-subtle);
        background: var(--color-bg-card);
        cursor: pointer;
        font-size: 1.2rem;
        z-index: 100;
        transition: all 0.2s;
      }
      .theme-toggle:hover {
        transform: scale(1.1);
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: var(--font-sans);
        background: var(--color-bg-deep);
        color: var(--color-text-primary);
        min-height: 100vh;
        line-height: 1.6;
      }

      .bg-grid {
        position: fixed;
        inset: 0;
        background-image:
          linear-gradient(rgb(0, 245, 212, 0.02) 1px, transparent 1px),
          linear-gradient(90deg, rgb(0, 245, 212, 0.02) 1px, transparent 1px);
        background-size: 40px 40px;
        pointer-events: none;
        z-index: 0;
      }

      .container {
        position: relative;
        z-index: 1;
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-bottom: 24px;
        flex-wrap: wrap;
      }

      .breadcrumb {
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        padding: 8px 14px;
        background: var(--color-bg-surface);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        flex-wrap: wrap;
      }

      .breadcrumb a {
        color: var(--color-text-secondary);
        text-decoration: none;
        transition: color 0.2s ease;
      }

      .breadcrumb a:hover {
        color: var(--color-accent-cyan);
      }

      .breadcrumb-separator {
        color: var(--color-text-muted);
        user-select: none;
      }

      .breadcrumb-current {
        color: var(--color-text-primary);
        font-weight: 500;
      }

      .title-section {
        flex: 1;
      }

      .title-section h1 {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .title-section h1 .icon {
        font-size: 1.8rem;
      }

      .title-section p {
        color: var(--color-text-secondary);
        margin-top: 4px;
        font-size: 0.9rem;
      }

      .main-content {
        background: var(--color-bg-card);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-lg);
        padding: 24px;
        flex: 1;
      }

      .tool-section {
        margin-bottom: 24px;
      }

      .section-title {
        font-family: var(--font-mono);
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--color-text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-subtle);
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .input-group {
        margin-bottom: 16px;
      }

      .input-label {
        display: block;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        margin-bottom: 8px;
      }

      input[type="text"],
      input[type="number"],
      select,
      textarea {
        width: 100%;
        padding: 10px 14px;
        font-family: var(--font-mono);
        font-size: 0.9rem;
        background: var(--bg-input);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        color: var(--color-text-primary);
        transition: border-color 0.2s;
      }

      input:focus,
      select:focus,
      textarea:focus {
        outline: none;
        border-color: var(--color-accent-cyan);
      }

      textarea {
        min-height: 150px;
        resize: vertical;
      }

      .row {
        display: flex;
        gap: 16px;
        flex-wrap: wrap;
      }

      .row > * {
        flex: 1;
        min-width: 200px;
      }

      .btn-row {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
      }

      .btn {
        flex: 1;
        min-width: 120px;
        padding: 12px 20px;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        font-weight: 500;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-primary {
        background: var(--color-accent-cyan);
        color: var(--color-bg-deep);
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px var(--glow-cyan);
      }

      .btn-secondary {
        background: var(--color-bg-surface);
        color: var(--color-text-primary);
        border: 1px solid var(--border-subtle);
      }

      .btn-secondary:hover {
        border-color: var(--color-accent-cyan);
        color: var(--color-accent-cyan);
      }

      .btn-danger {
        background: var(--accent-red);
        color: #fff;
      }

      .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px var(--glow-red);
      }

      .btn-small {
        flex: 0;
        min-width: auto;
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      /* Filter conditions */
      .conditions-container {
        margin-bottom: 16px;
      }

      .condition-item {
        display: flex;
        gap: 12px;
        align-items: center;
        padding: 12px;
        background: var(--bg-input);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        margin-bottom: 12px;
        flex-wrap: wrap;
      }

      .condition-item select,
      .condition-item input {
        flex: 1;
        min-width: 100px;
      }

      .condition-item .pattern-input {
        flex: 2;
        min-width: 200px;
      }

      .condition-item .column-select {
        flex: 0.8;
        min-width: 80px;
      }

      .remove-condition {
        background: var(--accent-red);
        color: #fff;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
      }

      .remove-condition:hover {
        transform: scale(1.1);
      }

      .logic-operator {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
      }

      .logic-btn {
        padding: 8px 16px;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        font-weight: 600;
        border: 2px solid var(--border-subtle);
        border-radius: var(--radius-sm);
        background: transparent;
        color: var(--color-text-secondary);
        cursor: pointer;
        transition: all 0.2s;
      }

      .logic-btn.active {
        border-color: var(--color-accent-cyan);
        color: var(--color-accent-cyan);
        background: rgba(0, 245, 212, 0.1);
      }

      .logic-btn:hover:not(.active) {
        border-color: var(--color-text-secondary);
      }

      /* Options row */
      .options-row {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        margin-bottom: 16px;
      }

      .option-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .option-item input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: var(--color-accent-cyan);
        cursor: pointer;
      }

      .option-item label {
        font-family: var(--font-mono);
        font-size: 0.85rem;
        color: var(--color-text-secondary);
        cursor: pointer;
      }

      /* Statistics */
      .stats-bar {
        display: flex;
        gap: 24px;
        flex-wrap: wrap;
        padding: 16px;
        background: var(--bg-input);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        margin-bottom: 16px;
      }

      .stat-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .stat-value {
        font-family: var(--font-mono);
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-accent-cyan);
      }

      .stat-value.matched {
        color: var(--accent-green);
      }

      .stat-value.unmatched {
        color: var(--accent-red);
      }

      .stat-label {
        font-family: var(--font-mono);
        font-size: 0.75rem;
        color: var(--color-text-muted);
        text-transform: uppercase;
      }

      /* Result panels */
      .result-panels {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 16px;
      }

      .result-panel {
        display: flex;
        flex-direction: column;
      }

      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
      }

      .result-title {
        font-family: var(--font-mono);
        font-size: 0.85rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .result-title.matched {
        color: var(--accent-green);
      }

      .result-title.unmatched {
        color: var(--accent-red);
      }

      .result-box {
        background: var(--bg-input);
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        padding: 16px;
        font-family: var(--font-mono);
        font-size: 0.85rem;
        color: var(--color-text-primary);
        min-height: 200px;
        max-height: 400px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-all;
      }

      .result-box.matched-box {
        border-color: rgba(16, 185, 129, 0.3);
      }

      .result-box.unmatched-box {
        border-color: rgba(244, 63, 94, 0.3);
      }

      .toast {
        position: fixed;
        bottom: 24px;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--accent-green);
        color: var(--color-bg-deep);
        padding: 12px 24px;
        border-radius: var(--radius-md);
        font-family: var(--font-mono);
        font-size: 0.85rem;
        font-weight: 500;
        opacity: 0;
        transition: all 0.3s ease;
        z-index: 1000;
      }

      .toast.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .toast.error {
        background: var(--accent-red);
      }

      /* CSV mode indicator */
      .mode-indicator {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        font-family: var(--font-mono);
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: var(--radius-sm);
        margin-left: auto;
      }

      .mode-indicator.csv-mode {
        background: rgba(59, 130, 246, 0.2);
        color: var(--accent-blue);
        border: 1px solid var(--accent-blue);
      }

      .mode-indicator.text-mode {
        background: rgba(168, 85, 247, 0.2);
        color: var(--color-accent-purple);
        border: 1px solid var(--color-accent-purple);
      }

      @media (max-width: 900px) {
        .result-panels {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 600px) {
        .container {
          padding: 16px;
        }

        .btn-row {
          flex-direction: column;
        }

        .btn {
          width: 100%;
        }

        .condition-item {
          flex-direction: column;
          align-items: stretch;
        }

        .condition-item select,
        .condition-item input {
          width: 100%;
        }

        .remove-condition {
          align-self: flex-end;
        }

        .stats-bar {
          justify-content: space-around;
        }
      }
    </style>
  </head>
  <body>
    <div class="bg-grid"></div>
    <button class="theme-toggle" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>

    <div class="container">
      <header class="header">
        <nav class="breadcrumb" aria-label="Breadcrumb">
          <a href="../../index.html">é¦–é¡µ</a>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-current">æ•°æ®ç­›é€‰å™¨</span>
        </nav>
        <div class="title-section">
          <h1>
            <span class="icon">ğŸ”</span>
            æ•°æ®ç­›é€‰å™¨
          </h1>
          <p>å¼ºå¤§çš„æ•°æ®ç­›é€‰å·¥å…·ï¼Œæ”¯æŒCSV/æ–‡æœ¬ç­›é€‰ï¼Œå¤šç§åŒ¹é…æ¨¡å¼ï¼Œå¤šæ¡ä»¶ç»„åˆ</p>
        </div>
      </header>

      <main class="main-content">
        <!-- Input Section -->
        <div class="tool-section">
          <div class="section-title">
            æ•°æ®è¾“å…¥
            <span id="modeIndicator" class="mode-indicator text-mode">æ–‡æœ¬æ¨¡å¼</span>
          </div>
          <div class="input-group">
            <label class="input-label">è¾“å…¥æ•°æ®ï¼ˆæ”¯æŒçº¯æ–‡æœ¬æˆ– CSV æ ¼å¼ï¼‰</label>
            <textarea
              id="inputData"
              placeholder="ç²˜è´´æ‚¨çš„æ•°æ®...&#10;&#10;æ–‡æœ¬æ¨¡å¼: æ¯è¡Œä¸€æ¡æ•°æ®&#10;CSVæ¨¡å¼: è‡ªåŠ¨æ£€æµ‹é€—å·/åˆ¶è¡¨ç¬¦åˆ†éš”çš„æ•°æ®"
            ></textarea>
          </div>
          <div class="row">
            <div class="input-group">
              <label class="input-label">CSV åˆ†éš”ç¬¦</label>
              <select id="delimiter">
                <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                <option value=",">é€—å· (,)</option>
                <option value="	">åˆ¶è¡¨ç¬¦ (Tab)</option>
                <option value=";">åˆ†å· (;)</option>
                <option value="|">ç«–çº¿ (|)</option>
              </select>
            </div>
            <div class="input-group">
              <label class="input-label">é¦–è¡Œæ˜¯å¦ä¸ºæ ‡é¢˜</label>
              <select id="hasHeader">
                <option value="auto">è‡ªåŠ¨æ£€æµ‹</option>
                <option value="yes">æ˜¯</option>
                <option value="no">å¦</option>
              </select>
            </div>
          </div>
          <div class="btn-row">
            <button class="btn btn-secondary" onclick="pasteFromClipboard()">ğŸ“‹ ç²˜è´´</button>
            <button class="btn btn-secondary" onclick="parseData()">ğŸ”„ è§£ææ•°æ®</button>
          </div>
        </div>

        <!-- Filter Conditions Section -->
        <div class="tool-section">
          <div class="section-title">ç­›é€‰æ¡ä»¶</div>

          <div class="logic-operator">
            <span class="input-label" style="margin-bottom: 0">æ¡ä»¶ç»„åˆæ–¹å¼:</span>
            <button class="logic-btn active" data-logic="and" onclick="setLogic('and')">
              AND (å…¨éƒ¨æ»¡è¶³)
            </button>
            <button class="logic-btn" data-logic="or" onclick="setLogic('or')">OR (ä»»ä¸€æ»¡è¶³)</button>
          </div>

          <div id="conditionsContainer" class="conditions-container">
            <!-- Conditions will be added here -->
          </div>

          <button class="btn btn-secondary btn-small" onclick="addCondition()">+ æ·»åŠ æ¡ä»¶</button>

          <div class="options-row" style="margin-top: 16px">
            <div class="option-item">
              <input type="checkbox" id="caseSensitive" />
              <label for="caseSensitive">åŒºåˆ†å¤§å°å†™</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="trimWhitespace" checked />
              <label for="trimWhitespace">å¿½ç•¥é¦–å°¾ç©ºæ ¼</label>
            </div>
            <div class="option-item">
              <input type="checkbox" id="skipEmpty" checked />
              <label for="skipEmpty">è·³è¿‡ç©ºè¡Œ</label>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="tool-section">
          <div class="btn-row">
            <button class="btn btn-primary" onclick="applyFilter()">ğŸ” æ‰§è¡Œç­›é€‰</button>
            <button class="btn btn-secondary" onclick="clearAll()">ğŸ”„ æ¸…ç©ºå…¨éƒ¨</button>
            <button class="btn btn-secondary" onclick="shareState()">ğŸ”— åˆ†äº«</button>
          </div>
        </div>

        <!-- Statistics -->
        <div class="tool-section">
          <div class="section-title">ç­›é€‰ç»Ÿè®¡</div>
          <div class="stats-bar">
            <div class="stat-item">
              <span class="stat-value" id="statTotal">0</span>
              <span class="stat-label">æ€»è¡Œæ•°</span>
            </div>
            <div class="stat-item">
              <span class="stat-value matched" id="statMatched">0</span>
              <span class="stat-label">åŒ¹é…</span>
            </div>
            <div class="stat-item">
              <span class="stat-value unmatched" id="statUnmatched">0</span>
              <span class="stat-label">ä¸åŒ¹é…</span>
            </div>
            <div class="stat-item">
              <span class="stat-value" id="statPercent">0%</span>
              <span class="stat-label">åŒ¹é…ç‡</span>
            </div>
          </div>
        </div>

        <!-- Results -->
        <div class="tool-section">
          <div class="section-title">ç­›é€‰ç»“æœ</div>
          <div class="result-panels">
            <div class="result-panel">
              <div class="result-header">
                <span class="result-title matched">âœ“ åŒ¹é…æ•°æ®</span>
                <button class="btn btn-secondary btn-small" onclick="copyResult('matched')">
                  å¤åˆ¶
                </button>
              </div>
              <div class="result-box matched-box" id="matchedResult">åŒ¹é…çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
            </div>
            <div class="result-panel">
              <div class="result-header">
                <span class="result-title unmatched">âœ— ä¸åŒ¹é…æ•°æ®</span>
                <button class="btn btn-secondary btn-small" onclick="copyResult('unmatched')">
                  å¤åˆ¶
                </button>
              </div>
              <div class="result-box unmatched-box" id="unmatchedResult">
                ä¸åŒ¹é…çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>

    <div class="toast" id="toast">æ“ä½œæˆåŠŸ</div>

    <script>
      // State
      const state = {
        parsedData: [],
        headers: [],
        isCSV: false,
        delimiter: ",",
        hasHeader: false,
        logic: "and",
        conditions: [],
      };

      const LS_KEY = "data_filter_state_v1";

      // Filter modes
      const FILTER_MODES = {
        contains: { label: "åŒ…å«", fn: function (val, pat) { return val.includes(pat); } },
        not_contains: { label: "ä¸åŒ…å«", fn: function (val, pat) { return !val.includes(pat); } },
        starts_with: { label: "å¼€å¤´æ˜¯", fn: function (val, pat) { return val.startsWith(pat); } },
        ends_with: { label: "ç»“å°¾æ˜¯", fn: function (val, pat) { return val.endsWith(pat); } },
        exact: { label: "ç²¾ç¡®åŒ¹é…", fn: function (val, pat) { return val === pat; } },
        regex: {
          label: "æ­£åˆ™è¡¨è¾¾å¼",
          fn: function (val, pat, flags) {
            try {
              var regex = new RegExp(pat, flags);
              return regex.test(val);
            } catch (e) {
              return false;
            }
          },
        },
      };

      // Theme toggle
      function toggleTheme() {
        var body = document.body;
        var isDark = body.getAttribute("data-theme") !== "light";
        body.setAttribute("data-theme", isDark ? "light" : "dark");
        localStorage.setItem("theme", isDark ? "light" : "dark");
      }

      // Load theme
      (function () {
        var saved = localStorage.getItem("theme");
        if (saved === "light") {
          document.body.setAttribute("data-theme", "light");
        }
      })();

      // Toast notification
      function showToast(msg, isError) {
        var toast = document.getElementById("toast");
        toast.textContent = msg;
        toast.className = "toast" + (isError ? " error" : "");
        toast.classList.add("show");
        setTimeout(function () { toast.classList.remove("show"); }, 2000);
      }

      // Paste from clipboard
      function pasteFromClipboard() {
        navigator.clipboard.readText().then(function (text) {
          document.getElementById("inputData").value = text;
          parseData();
          showToast("å·²ç²˜è´´");
        }).catch(function () {
          showToast("æ— æ³•è®¿é—®å‰ªè´´æ¿", true);
        });
      }

      // Detect delimiter
      function detectDelimiter(text) {
        var firstLine = text.split("\n")[0];
        var delimiters = [",", "\t", ";", "|"];
        var counts = delimiters.map(function (d) {
          var escaped = d === "|" ? "\\|" : d;
          var matches = firstLine.match(new RegExp(escaped, "g"));
          return { d: d, count: matches ? matches.length : 0 };
        });
        counts.sort(function (a, b) { return b.count - a.count; });
        return counts[0].count > 0 ? counts[0].d : null;
      }

      // Detect if first row is header
      function detectHeader(rows, delimiter) {
        if (rows.length < 2) return false;
        var firstRow = rows[0].split(delimiter);
        var secondRow = rows[1].split(delimiter);

        var firstRowNumeric = firstRow.filter(function (cell) {
          return !isNaN(parseFloat(cell));
        }).length;
        var secondRowNumeric = secondRow.filter(function (cell) {
          return !isNaN(parseFloat(cell));
        }).length;

        return firstRowNumeric < secondRowNumeric;
      }

      // Parse CSV line handling quoted fields
      function parseCSVLine(line, delimiter) {
        var result = [];
        var current = "";
        var inQuotes = false;

        for (var i = 0; i < line.length; i++) {
          var char = line[i];
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === delimiter && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      }

      // Parse data
      function parseData() {
        var input = document.getElementById("inputData").value;
        var delimiterSelect = document.getElementById("delimiter").value;
        var hasHeaderSelect = document.getElementById("hasHeader").value;

        if (!input.trim()) {
          showToast("è¯·è¾“å…¥æ•°æ®", true);
          return;
        }

        var lines = input.split("\n").filter(function (line) { return line.trim(); });

        // Detect delimiter
        var delimiter;
        if (delimiterSelect === "auto") {
          delimiter = detectDelimiter(input);
        } else {
          delimiter = delimiterSelect;
        }

        // Check if CSV
        state.isCSV = delimiter !== null;
        state.delimiter = delimiter || ",";

        if (state.isCSV) {
          // Parse CSV
          var rows = lines.map(function (line) {
            return parseCSVLine(line, state.delimiter);
          });

          // Detect or set header
          if (hasHeaderSelect === "auto") {
            state.hasHeader = detectHeader(lines, state.delimiter);
          } else {
            state.hasHeader = hasHeaderSelect === "yes";
          }

          if (state.hasHeader && rows.length > 0) {
            state.headers = rows[0].map(function (h, i) {
              return h.trim() || ("åˆ—" + (i + 1));
            });
            state.parsedData = rows.slice(1);
          } else {
            var colCount = rows[0] ? rows[0].length : 0;
            state.headers = [];
            for (var i = 0; i < colCount; i++) {
              state.headers.push("åˆ—" + (i + 1));
            }
            state.parsedData = rows;
          }

          updateModeIndicator(true);
        } else {
          // Plain text mode
          state.headers = ["å†…å®¹"];
          state.parsedData = lines.map(function (line) { return [line]; });
          updateModeIndicator(false);
        }

        // Update column selectors in conditions
        updateColumnSelectors();

        showToast("å·²è§£æ " + state.parsedData.length + " è¡Œæ•°æ®");
        saveToStorage();
      }

      // Update mode indicator
      function updateModeIndicator(isCSV) {
        var indicator = document.getElementById("modeIndicator");
        if (isCSV) {
          indicator.className = "mode-indicator csv-mode";
          indicator.textContent = "CSVæ¨¡å¼ (" + state.headers.length + "åˆ—)";
        } else {
          indicator.className = "mode-indicator text-mode";
          indicator.textContent = "æ–‡æœ¬æ¨¡å¼";
        }
      }

      // Update column selectors
      function updateColumnSelectors() {
        var selects = document.querySelectorAll(".column-select");
        selects.forEach(function (select) {
          var currentValue = select.value;
          // Clear and rebuild options
          while (select.firstChild) {
            select.removeChild(select.firstChild);
          }
          var allOption = document.createElement("option");
          allOption.value = "all";
          allOption.textContent = "æ‰€æœ‰åˆ—";
          select.appendChild(allOption);

          state.headers.forEach(function (header, i) {
            var option = document.createElement("option");
            option.value = i;
            option.textContent = header;
            select.appendChild(option);
          });
          select.value = currentValue;
        });
      }

      // Create a condition element
      function createConditionElement(conditionData) {
        var div = document.createElement("div");
        div.className = "condition-item";
        div.dataset.id = Date.now();

        // Column select
        var columnSelect = document.createElement("select");
        columnSelect.className = "column-select";
        columnSelect.title = "é€‰æ‹©åˆ—";
        var allOption = document.createElement("option");
        allOption.value = "all";
        allOption.textContent = "æ‰€æœ‰åˆ—";
        columnSelect.appendChild(allOption);
        state.headers.forEach(function (h, i) {
          var opt = document.createElement("option");
          opt.value = i;
          opt.textContent = h;
          columnSelect.appendChild(opt);
        });

        // Mode select
        var modeSelect = document.createElement("select");
        modeSelect.className = "mode-select";
        modeSelect.title = "åŒ¹é…æ¨¡å¼";
        Object.keys(FILTER_MODES).forEach(function (key) {
          var opt = document.createElement("option");
          opt.value = key;
          opt.textContent = FILTER_MODES[key].label;
          modeSelect.appendChild(opt);
        });

        // Pattern input
        var patternInput = document.createElement("input");
        patternInput.type = "text";
        patternInput.className = "pattern-input";
        patternInput.placeholder = "åŒ¹é…å†…å®¹/æ­£åˆ™è¡¨è¾¾å¼...";

        // Remove button
        var removeBtn = document.createElement("button");
        removeBtn.className = "remove-condition";
        removeBtn.title = "åˆ é™¤æ¡ä»¶";
        removeBtn.textContent = "Ã—";
        removeBtn.onclick = function () {
          div.remove();
          saveToStorage();
        };

        // Set values if provided
        if (conditionData) {
          columnSelect.value = conditionData.column || "all";
          modeSelect.value = conditionData.mode || "contains";
          patternInput.value = conditionData.pattern || "";
        }

        // Auto-save on change
        [columnSelect, modeSelect, patternInput].forEach(function (el) {
          el.addEventListener("change", saveToStorage);
          el.addEventListener("input", saveToStorage);
        });

        div.appendChild(columnSelect);
        div.appendChild(modeSelect);
        div.appendChild(patternInput);
        div.appendChild(removeBtn);

        return div;
      }

      // Add condition
      function addCondition(conditionData) {
        var container = document.getElementById("conditionsContainer");
        var conditionEl = createConditionElement(conditionData);
        container.appendChild(conditionEl);
        saveToStorage();
      }

      // Set logic operator
      function setLogic(logic) {
        state.logic = logic;
        var buttons = document.querySelectorAll(".logic-btn");
        buttons.forEach(function (btn) {
          if (btn.dataset.logic === logic) {
            btn.classList.add("active");
          } else {
            btn.classList.remove("active");
          }
        });
        saveToStorage();
      }

      // Get conditions from UI
      function getConditions() {
        var conditions = [];
        var items = document.querySelectorAll(".condition-item");
        items.forEach(function (item) {
          var column = item.querySelector(".column-select").value;
          var mode = item.querySelector(".mode-select").value;
          var pattern = item.querySelector(".pattern-input").value;
          if (pattern) {
            conditions.push({ column: column, mode: mode, pattern: pattern });
          }
        });
        return conditions;
      }

      // Apply filter
      function applyFilter() {
        var conditions = getConditions();

        if (conditions.length === 0) {
          showToast("è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ªç­›é€‰æ¡ä»¶", true);
          return;
        }

        if (state.parsedData.length === 0) {
          parseData();
          if (state.parsedData.length === 0) {
            showToast("è¯·å…ˆè¾“å…¥å¹¶è§£ææ•°æ®", true);
            return;
          }
        }

        var caseSensitive = document.getElementById("caseSensitive").checked;
        var trimWhitespace = document.getElementById("trimWhitespace").checked;
        var skipEmpty = document.getElementById("skipEmpty").checked;

        var matched = [];
        var unmatched = [];

        state.parsedData.forEach(function (row) {
          // Skip empty rows if option is checked
          if (skipEmpty && row.every(function (cell) { return !cell.trim(); })) {
            return;
          }

          var results = conditions.map(function (cond) {
            var filterFn = FILTER_MODES[cond.mode].fn;
            var pattern = cond.pattern;
            var flags = caseSensitive ? "" : "i";

            if (!caseSensitive && cond.mode !== "regex") {
              pattern = pattern.toLowerCase();
            }

            // Get values to check
            var valuesToCheck = [];
            if (cond.column === "all") {
              valuesToCheck = row;
            } else {
              var colIndex = parseInt(cond.column);
              valuesToCheck = [row[colIndex] || ""];
            }

            // Check if any value matches
            return valuesToCheck.some(function (val) {
              var value = val;
              if (trimWhitespace) value = value.trim();
              if (!caseSensitive && cond.mode !== "regex") value = value.toLowerCase();
              return filterFn(value, pattern, flags);
            });
          });

          // Apply logic (AND/OR)
          var isMatch;
          if (state.logic === "and") {
            isMatch = results.every(function (r) { return r; });
          } else {
            isMatch = results.some(function (r) { return r; });
          }

          if (isMatch) {
            matched.push(row);
          } else {
            unmatched.push(row);
          }
        });

        // Update statistics
        updateStats(state.parsedData.length, matched.length, unmatched.length);

        // Display results
        displayResults(matched, unmatched);

        showToast("ç­›é€‰å®Œæˆ: " + matched.length + " æ¡åŒ¹é…");
        saveToStorage();
      }

      // Update statistics
      function updateStats(total, matchedCount, unmatchedCount) {
        document.getElementById("statTotal").textContent = total;
        document.getElementById("statMatched").textContent = matchedCount;
        document.getElementById("statUnmatched").textContent = unmatchedCount;
        document.getElementById("statPercent").textContent =
          total > 0 ? Math.round((matchedCount / total) * 100) + "%" : "0%";
      }

      // Display results
      function displayResults(matched, unmatched) {
        var formatRow = function (row) {
          if (state.isCSV) {
            return row
              .map(function (cell) {
                if (cell.includes(state.delimiter) || cell.includes('"') || cell.includes("\n")) {
                  return '"' + cell.replace(/"/g, '""') + '"';
                }
                return cell;
              })
              .join(state.delimiter);
          }
          return row[0];
        };

        var matchedText;
        if (matched.length > 0) {
          var matchedLines = [];
          if (state.isCSV && state.hasHeader) {
            matchedLines.push(state.headers.join(state.delimiter));
          }
          matched.forEach(function (row) {
            matchedLines.push(formatRow(row));
          });
          matchedText = matchedLines.join("\n");
        } else {
          matchedText = "æ— åŒ¹é…æ•°æ®";
        }

        var unmatchedText;
        if (unmatched.length > 0) {
          var unmatchedLines = [];
          if (state.isCSV && state.hasHeader) {
            unmatchedLines.push(state.headers.join(state.delimiter));
          }
          unmatched.forEach(function (row) {
            unmatchedLines.push(formatRow(row));
          });
          unmatchedText = unmatchedLines.join("\n");
        } else {
          unmatchedText = "æ— ä¸åŒ¹é…æ•°æ®";
        }

        document.getElementById("matchedResult").textContent = matchedText;
        document.getElementById("unmatchedResult").textContent = unmatchedText;
      }

      // Copy result
      function copyResult(type) {
        var resultEl = document.getElementById(type === "matched" ? "matchedResult" : "unmatchedResult");
        var text = resultEl.textContent;

        if (text === "æ— åŒ¹é…æ•°æ®" || text === "æ— ä¸åŒ¹é…æ•°æ®" || text.indexOf("å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ") >= 0) {
          showToast("æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹", true);
          return;
        }

        navigator.clipboard.writeText(text).then(function () {
          showToast("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
        });
      }

      // Clear all
      function clearAll() {
        document.getElementById("inputData").value = "";
        var container = document.getElementById("conditionsContainer");
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
        document.getElementById("matchedResult").textContent = "åŒ¹é…çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...";
        document.getElementById("unmatchedResult").textContent = "ä¸åŒ¹é…çš„æ•°æ®å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...";

        state.parsedData = [];
        state.headers = [];
        state.isCSV = false;

        updateStats(0, 0, 0);
        updateModeIndicator(false);
        addCondition();

        localStorage.removeItem(LS_KEY);
        history.replaceState(null, "", location.pathname);
        showToast("å·²æ¸…ç©º");
      }

      // Save to storage
      function saveToStorage() {
        var data = {
          input: document.getElementById("inputData").value,
          delimiter: document.getElementById("delimiter").value,
          hasHeader: document.getElementById("hasHeader").value,
          logic: state.logic,
          caseSensitive: document.getElementById("caseSensitive").checked,
          trimWhitespace: document.getElementById("trimWhitespace").checked,
          skipEmpty: document.getElementById("skipEmpty").checked,
          conditions: getConditions(),
        };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      // Load from storage
      function loadFromStorage() {
        var saved = localStorage.getItem(LS_KEY);
        if (!saved) return false;

        try {
          var data = JSON.parse(saved);
          document.getElementById("inputData").value = data.input || "";
          document.getElementById("delimiter").value = data.delimiter || "auto";
          document.getElementById("hasHeader").value = data.hasHeader || "auto";
          document.getElementById("caseSensitive").checked = data.caseSensitive || false;
          document.getElementById("trimWhitespace").checked =
            data.trimWhitespace !== undefined ? data.trimWhitespace : true;
          document.getElementById("skipEmpty").checked =
            data.skipEmpty !== undefined ? data.skipEmpty : true;

          if (data.logic) {
            setLogic(data.logic);
          }

          if (data.input) {
            parseData();
          }

          if (data.conditions && data.conditions.length > 0) {
            data.conditions.forEach(function (cond) { addCondition(cond); });
          } else {
            addCondition();
          }

          return true;
        } catch (e) {
          return false;
        }
      }

      // Save to URL
      function saveToUrl() {
        var data = {
          i: document.getElementById("inputData").value,
          d: document.getElementById("delimiter").value,
          h: document.getElementById("hasHeader").value,
          l: state.logic,
          cs: document.getElementById("caseSensitive").checked,
          tw: document.getElementById("trimWhitespace").checked,
          se: document.getElementById("skipEmpty").checked,
          c: getConditions(),
        };

        try {
          var encoded = btoa(encodeURIComponent(JSON.stringify(data)));
          if (encoded.length < 2000) {
            history.replaceState(null, "", "#" + encoded);
            return true;
          }
        } catch (e) {
          // ignore
        }
        return false;
      }

      // Load from URL
      function loadFromUrl() {
        var hash = location.hash.slice(1);
        if (!hash) return false;

        try {
          var data = JSON.parse(decodeURIComponent(atob(hash)));
          document.getElementById("inputData").value = data.i || "";
          document.getElementById("delimiter").value = data.d || "auto";
          document.getElementById("hasHeader").value = data.h || "auto";
          document.getElementById("caseSensitive").checked = data.cs || false;
          document.getElementById("trimWhitespace").checked = data.tw !== undefined ? data.tw : true;
          document.getElementById("skipEmpty").checked = data.se !== undefined ? data.se : true;

          if (data.l) {
            setLogic(data.l);
          }

          if (data.i) {
            parseData();
          }

          if (data.c && data.c.length > 0) {
            data.c.forEach(function (cond) { addCondition(cond); });
          } else {
            addCondition();
          }

          return true;
        } catch (e) {
          return false;
        }
      }

      // Share state
      function shareState() {
        if (saveToUrl()) {
          navigator.clipboard.writeText(location.href).then(function () {
            showToast("é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿");
          }).catch(function () {
            showToast("è¯·æ‰‹åŠ¨å¤åˆ¶åœ°å€æ é“¾æ¥");
          });
        } else {
          showToast("æ•°æ®è¿‡å¤§ï¼Œæ— æ³•ç”Ÿæˆåˆ†äº«é“¾æ¥", true);
        }
      }

      // Initialize
      (function init() {
        if (!loadFromUrl()) {
          if (!loadFromStorage()) {
            addCondition();
          }
        }

        // Auto-save on input change
        document.getElementById("inputData").addEventListener("input", saveToStorage);
        document.getElementById("delimiter").addEventListener("change", saveToStorage);
        document.getElementById("hasHeader").addEventListener("change", saveToStorage);
        document.getElementById("caseSensitive").addEventListener("change", saveToStorage);
        document.getElementById("trimWhitespace").addEventListener("change", saveToStorage);
        document.getElementById("skipEmpty").addEventListener("change", saveToStorage);

        // Keyboard shortcut
        document.addEventListener("keydown", function (e) {
          if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
            e.preventDefault();
            applyFilter();
          }
        });
      })();
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG 渲染器 - WebUtils</title>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e8e8e8;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        header {
            text-align: center;
            margin-bottom: 30px;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #9b59b6, #3498db);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .subtitle {
            color: #888;
            font-size: 0.95rem;
        }
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 900px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        .panel {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .panel-title {
            font-size: 1rem;
            color: #9b59b6;
        }
        textarea {
            width: 100%;
            height: 300px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 15px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 13px;
            color: #e8e8e8;
            resize: vertical;
            line-height: 1.5;
        }
        textarea:focus {
            outline: none;
            border-color: #9b59b6;
        }
        .preview-container {
            background: #fff;
            border-radius: 8px;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }
        .preview-container.checkerboard {
            background-image: linear-gradient(45deg, #ccc 25%, transparent 25%),
                              linear-gradient(-45deg, #ccc 25%, transparent 25%),
                              linear-gradient(45deg, transparent 75%, #ccc 75%),
                              linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        #preview {
            max-width: 100%;
            max-height: 300px;
        }
        .controls {
            margin-top: 20px;
        }
        .control-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .control-group label {
            font-size: 0.85rem;
            color: #888;
        }
        input[type="number"],
        select {
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            padding: 8px 12px;
            color: #e8e8e8;
            font-size: 0.9rem;
            width: 120px;
        }
        input[type="number"]:focus,
        select:focus {
            outline: none;
            border-color: #9b59b6;
        }
        input[type="color"] {
            width: 50px;
            height: 36px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(155,89,182,0.4);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #e8e8e8;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.15);
        }
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(46,204,113,0.4);
        }
        .examples {
            margin-top: 20px;
        }
        .example-chips {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .chip {
            padding: 6px 12px;
            background: rgba(155,89,182,0.2);
            border: 1px solid rgba(155,89,182,0.3);
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .chip:hover {
            background: rgba(155,89,182,0.3);
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            text-align: center;
            font-size: 0.9rem;
        }
        .info {
            margin-top: 15px;
            padding: 10px;
            background: rgba(52,152,219,0.1);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #888;
        }
        .info span {
            color: #3498db;
        }
        footer {
            text-align: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
            color: #666;
            font-size: 0.85rem;
        }
        footer a {
            color: #9b59b6;
            text-decoration: none;
        }
        footer a:hover {
            text-decoration: underline;
        }
        /* Canvas for export - hidden */
        #exportCanvas {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>SVG 渲染器</h1>
            <p class="subtitle">将 SVG 代码渲染为 PNG/JPEG 图片，支持自定义尺寸和背景</p>
        </header>

        <div class="main-content">
            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">SVG 代码</span>
                    <button class="btn btn-secondary" onclick="clearInput()">清空</button>
                </div>
                <textarea id="svgInput" placeholder="在此粘贴 SVG 代码...&#10;&#10;例如:&#10;<svg width=&quot;100&quot; height=&quot;100&quot;>&#10;  <circle cx=&quot;50&quot; cy=&quot;50&quot; r=&quot;40&quot; fill=&quot;#9b59b6&quot;/>&#10;</svg>"></textarea>
                
                <div class="examples">
                    <div class="panel-title" style="margin-bottom: 10px;">示例</div>
                    <div class="example-chips">
                        <span class="chip" onclick="loadExample('circle')">圆形</span>
                        <span class="chip" onclick="loadExample('gradient')">渐变</span>
                        <span class="chip" onclick="loadExample('star')">五角星</span>
                        <span class="chip" onclick="loadExample('text')">文字</span>
                        <span class="chip" onclick="loadExample('pattern')">图案</span>
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <span class="panel-title">预览</span>
                </div>
                <div class="preview-container" id="previewContainer">
                    <div id="preview"></div>
                </div>
                
                <div class="controls">
                    <div class="control-row">
                        <div class="control-group">
                            <label>导出宽度 (px)</label>
                            <input type="number" id="exportWidth" value="512" min="1" max="4096">
                        </div>
                        <div class="control-group">
                            <label>导出高度 (px)</label>
                            <input type="number" id="exportHeight" value="512" min="1" max="4096">
                        </div>
                        <div class="control-group">
                            <label>格式</label>
                            <select id="exportFormat">
                                <option value="png">PNG</option>
                                <option value="jpeg">JPEG</option>
                                <option value="webp">WebP</option>
                            </select>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>背景颜色</label>
                            <input type="color" id="bgColor" value="#ffffff">
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="transparentBg" checked>
                            <label for="transparentBg">透明背景 (仅 PNG/WebP)</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="showCheckerboard" checked>
                            <label for="showCheckerboard">显示棋盘格</label>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-group">
                            <label>JPEG 质量</label>
                            <input type="number" id="jpegQuality" value="90" min="1" max="100">
                        </div>
                    </div>
                    <div class="btn-row">
                        <button class="btn btn-primary" onclick="renderSVG()">渲染预览</button>
                        <button class="btn btn-success" onclick="downloadImage()">下载图片</button>
                        <button class="btn btn-secondary" onclick="copyToClipboard()">复制到剪贴板</button>
                    </div>
                </div>

                <div class="info" id="svgInfo" style="display: none;">
                    原始尺寸: <span id="originalSize">-</span> | 
                    导出尺寸: <span id="exportSize">-</span>
                </div>
            </div>
        </div>

        <footer>
            <a href="../../index.html">返回工具列表</a> · 
            <a href="https://github.com/chicogong/html-tools/blob/master/tools/svg-render.html" target="_blank">查看源代码</a>
        </footer>
    </div>

    <canvas id="exportCanvas"></canvas>

    <script>
        const svgInput = document.getElementById('svgInput');
        const preview = document.getElementById('preview');
        const previewContainer = document.getElementById('previewContainer');
        const exportWidth = document.getElementById('exportWidth');
        const exportHeight = document.getElementById('exportHeight');
        const exportFormat = document.getElementById('exportFormat');
        const bgColor = document.getElementById('bgColor');
        const transparentBg = document.getElementById('transparentBg');
        const showCheckerboard = document.getElementById('showCheckerboard');
        const jpegQuality = document.getElementById('jpegQuality');
        const svgInfo = document.getElementById('svgInfo');
        const originalSize = document.getElementById('originalSize');
        const exportSize = document.getElementById('exportSize');
        const canvas = document.getElementById('exportCanvas');
        const ctx = canvas.getContext('2d');

        const examples = {
            circle: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <circle cx="100" cy="100" r="80" fill="#9b59b6"/>
  <circle cx="100" cy="100" r="50" fill="#3498db"/>
  <circle cx="100" cy="100" r="20" fill="#e74c3c"/>
</svg>`,
            gradient: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#9b59b6"/>
      <stop offset="100%" style="stop-color:#3498db"/>
    </linearGradient>
  </defs>
  <rect width="200" height="200" fill="url(#grad)" rx="20"/>
</svg>`,
            star: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <polygon 
    points="100,10 40,198 190,78 10,78 160,198" 
    fill="#f1c40f"
    stroke="#e67e22"
    stroke-width="3"/>
</svg>`,
            text: `<svg width="300" height="100" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="textGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" style="stop-color:#9b59b6"/>
      <stop offset="100%" style="stop-color:#e74c3c"/>
    </linearGradient>
  </defs>
  <text x="150" y="60" 
    font-family="Arial, sans-serif" 
    font-size="40" 
    font-weight="bold"
    fill="url(#textGrad)" 
    text-anchor="middle">
    SVG Text
  </text>
</svg>`,
            pattern: `<svg width="200" height="200" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <pattern id="dots" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
      <circle cx="10" cy="10" r="4" fill="#9b59b6"/>
    </pattern>
  </defs>
  <rect width="200" height="200" fill="url(#dots)"/>
  <rect x="50" y="50" width="100" height="100" fill="#3498db" opacity="0.8" rx="10"/>
</svg>`
        };

        // 加载示例
        function loadExample(name) {
            if (examples[name]) {
                svgInput.value = examples[name];
                renderSVG();
                saveState();
            }
        }

        // 显示错误信息
        function showError(message) {
            preview.textContent = '';
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            preview.appendChild(errorDiv);
            svgInfo.style.display = 'none';
        }

        // 渲染 SVG (使用 DOMPurify 进行安全处理)
        function renderSVG() {
            const svg = svgInput.value.trim();
            if (!svg) {
                showError('请输入 SVG 代码');
                return;
            }

            try {
                // 使用 DOMPurify 清理 SVG，只允许 SVG 相关标签和属性
                const cleanSvg = DOMPurify.sanitize(svg, {
                    USE_PROFILES: { svg: true, svgFilters: true },
                    ADD_TAGS: ['use'],
                    ADD_ATTR: ['xlink:href', 'xmlns:xlink']
                });

                // 验证是否为有效的 SVG
                const parser = new DOMParser();
                const doc = parser.parseFromString(cleanSvg, 'image/svg+xml');
                const errorNode = doc.querySelector('parsererror');
                
                if (errorNode) {
                    showError('SVG 解析错误: ' + errorNode.textContent.substring(0, 100));
                    return;
                }

                const svgElement = doc.querySelector('svg');
                if (!svgElement) {
                    showError('未找到有效的 SVG 元素');
                    return;
                }

                // 获取原始尺寸
                let width = svgElement.getAttribute('width');
                let height = svgElement.getAttribute('height');
                const viewBox = svgElement.getAttribute('viewBox');

                if (viewBox && (!width || !height)) {
                    const parts = viewBox.split(/\s+|,/);
                    if (parts.length === 4) {
                        width = width || parts[2];
                        height = height || parts[3];
                    }
                }

                width = parseFloat(width) || 100;
                height = parseFloat(height) || 100;

                // 更新导出尺寸建议
                if (exportWidth.value == 512 && exportHeight.value == 512) {
                    const scale = Math.min(512 / width, 512 / height);
                    exportWidth.value = Math.round(width * scale);
                    exportHeight.value = Math.round(height * scale);
                }

                // 显示信息
                originalSize.textContent = width + ' x ' + height;
                exportSize.textContent = exportWidth.value + ' x ' + exportHeight.value;
                svgInfo.style.display = 'block';

                // 预览 - 使用清理后的 SVG
                preview.textContent = '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = cleanSvg;
                const previewSvg = tempDiv.firstElementChild;
                if (previewSvg) {
                    previewSvg.style.maxWidth = '100%';
                    previewSvg.style.maxHeight = '300px';
                    preview.appendChild(previewSvg);
                }

            } catch (e) {
                showError('渲染错误: ' + e.message);
            }
        }

        // 生成图片数据
        async function generateImageData() {
            const svg = svgInput.value.trim();
            if (!svg) {
                throw new Error('请输入 SVG 代码');
            }

            const width = parseInt(exportWidth.value) || 512;
            const height = parseInt(exportHeight.value) || 512;
            const format = exportFormat.value;
            const isTransparent = transparentBg.checked && format !== 'jpeg';
            const quality = parseInt(jpegQuality.value) / 100;

            // 准备 SVG - 使用 DOMPurify 清理
            let svgData = DOMPurify.sanitize(svg, {
                USE_PROFILES: { svg: true, svgFilters: true },
                ADD_TAGS: ['use'],
                ADD_ATTR: ['xlink:href', 'xmlns:xlink']
            });
            
            // 确保 SVG 有 xmlns
            if (!svgData.includes('xmlns')) {
                svgData = svgData.replace('<svg', '<svg xmlns="http://www.w3.org/2000/svg"');
            }

            // 设置 canvas 尺寸
            canvas.width = width;
            canvas.height = height;

            // 清空并设置背景
            if (!isTransparent) {
                ctx.fillStyle = bgColor.value;
                ctx.fillRect(0, 0, width, height);
            } else {
                ctx.clearRect(0, 0, width, height);
            }

            // 创建图片
            return new Promise((resolve, reject) => {
                const img = new Image();
                const blob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
                const url = URL.createObjectURL(blob);

                img.onload = function() {
                    // 计算缩放以保持比例
                    const scale = Math.min(width / img.width, height / img.height);
                    const scaledWidth = img.width * scale;
                    const scaledHeight = img.height * scale;
                    const x = (width - scaledWidth) / 2;
                    const y = (height - scaledHeight) / 2;

                    ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                    URL.revokeObjectURL(url);

                    const mimeType = format === 'jpeg' ? 'image/jpeg' : 
                                     format === 'webp' ? 'image/webp' : 'image/png';
                    const dataUrl = canvas.toDataURL(mimeType, quality);
                    resolve(dataUrl);
                };

                img.onerror = function() {
                    URL.revokeObjectURL(url);
                    reject(new Error('SVG 加载失败'));
                };

                img.src = url;
            });
        }

        // 下载图片
        async function downloadImage() {
            try {
                const dataUrl = await generateImageData();
                const format = exportFormat.value;
                const link = document.createElement('a');
                link.download = 'svg-export.' + format;
                link.href = dataUrl;
                link.click();
            } catch (e) {
                alert('导出失败: ' + e.message);
            }
        }

        // 复制到剪贴板
        async function copyToClipboard() {
            try {
                const dataUrl = await generateImageData();
                
                // 将 dataUrl 转换为 blob
                const response = await fetch(dataUrl);
                const blob = await response.blob();
                
                await navigator.clipboard.write([
                    new ClipboardItem({ [blob.type]: blob })
                ]);
                
                alert('已复制到剪贴板');
            } catch (e) {
                alert('复制失败: ' + e.message);
            }
        }

        // 清空输入
        function clearInput() {
            svgInput.value = '';
            preview.textContent = '';
            svgInfo.style.display = 'none';
            saveState();
        }

        // 切换棋盘格背景
        showCheckerboard.addEventListener('change', function() {
            previewContainer.classList.toggle('checkerboard', showCheckerboard.checked);
        });

        // 格式改变时更新透明背景选项
        exportFormat.addEventListener('change', function() {
            const format = exportFormat.value;
            if (format === 'jpeg') {
                transparentBg.checked = false;
                transparentBg.disabled = true;
            } else {
                transparentBg.disabled = false;
            }
        });

        // URL 状态持久化
        function saveState() {
            const state = {
                svg: svgInput.value,
                width: exportWidth.value,
                height: exportHeight.value,
                format: exportFormat.value,
                bg: bgColor.value,
                transparent: transparentBg.checked,
                quality: jpegQuality.value
            };
            try {
                const hash = btoa(encodeURIComponent(JSON.stringify(state)));
                history.replaceState(null, '', '#' + hash);
            } catch (e) {
                console.error('保存状态失败:', e);
            }
        }

        function loadState() {
            const hash = window.location.hash.slice(1);
            if (hash) {
                try {
                    const state = JSON.parse(decodeURIComponent(atob(hash)));
                    if (state.svg) svgInput.value = state.svg;
                    if (state.width) exportWidth.value = state.width;
                    if (state.height) exportHeight.value = state.height;
                    if (state.format) exportFormat.value = state.format;
                    if (state.bg) bgColor.value = state.bg;
                    if (state.transparent !== undefined) transparentBg.checked = state.transparent;
                    if (state.quality) jpegQuality.value = state.quality;
                    renderSVG();
                } catch (e) {
                    console.error('加载状态失败:', e);
                }
            }
        }

        // 输入时自动渲染和保存
        var renderTimeout;
        svgInput.addEventListener('input', function() {
            clearTimeout(renderTimeout);
            renderTimeout = setTimeout(function() {
                renderSVG();
                saveState();
            }, 300);
        });

        // 设置改变时保存状态
        [exportWidth, exportHeight, exportFormat, bgColor, transparentBg, jpegQuality].forEach(function(el) {
            el.addEventListener('change', function() {
                exportSize.textContent = exportWidth.value + ' x ' + exportHeight.value;
                saveState();
            });
        });

        // 初始化
        loadState();
        previewContainer.classList.add('checkerboard');
    </script>
</body>
</html>

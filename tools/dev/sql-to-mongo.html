<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQLËΩ¨MongoDBÊü•ËØ¢ËØ≠Ê≥ï - WebUtils</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --code-bg-light: #f4f4f5;
            --code-bg-dark: #1e1e2e;
        }
        [data-theme="light"] {
            --code-bg: var(--code-bg-light);
        }
        [data-theme="dark"] {
            --code-bg: var(--code-bg-dark);
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        .editor-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        @media (max-width: 768px) {
            .editor-container {
                grid-template-columns: 1fr;
            }
        }
        .editor-box {
            display: flex;
            flex-direction: column;
        }
        .editor-box label {
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        textarea {
            font-family: Monaco, Menlo, 'Ubuntu Mono', monospace;
            font-size: 14px;
            min-height: 300px;
            resize: vertical;
        }
        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .examples {
            margin-top: 2rem;
        }
        .example-item {
            background: var(--code-bg);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .example-item:hover {
            transform: translateX(5px);
        }
        .example-item code {
            display: block;
            white-space: pre-wrap;
            word-break: break-all;
        }
        .error {
            color: var(--pico-del-color);
            padding: 1rem;
            border-radius: 8px;
            background: rgba(255, 0, 0, 0.1);
        }
        .success {
            color: var(--pico-ins-color);
        }
        .theme-toggle {
            cursor: pointer;
            background: none;
            border: none;
            font-size: 1.5rem;
            padding: 0.5rem;
        }
        .reference {
            margin-top: 2rem;
        }
        .reference table {
            width: 100%;
        }
        .reference th, .reference td {
            text-align: left;
            padding: 0.5rem;
        }
        #message {
            min-height: 2rem;
        }
    </style>
</head>
<body>
    <main class="container">
        <a href="../../index.html" style="display:inline-block;margin-bottom:1rem;color:var(--pico-primary);text-decoration:none;">‚Üê ËøîÂõûÈ¶ñÈ°µ</a>
        <header>
            <h1>SQLËΩ¨MongoDBÊü•ËØ¢ËØ≠Ê≥ï</h1>
            <button class="theme-toggle" onclick="toggleTheme()" title="ÂàáÊç¢‰∏ªÈ¢ò">üåì</button>
        </header>

        <div class="editor-container">
            <div class="editor-box">
                <label for="sqlInput">SQLÊü•ËØ¢ËØ≠Âè•</label>
                <textarea id="sqlInput" placeholder="ËæìÂÖ•SQLÊü•ËØ¢ËØ≠Âè•Ôºå‰æãÂ¶ÇÔºö
SELECT * FROM users WHERE age > 18 AND status = 'active'
SELECT name, email FROM users WHERE age >= 21 ORDER BY name ASC LIMIT 10"></textarea>
            </div>
            <div class="editor-box">
                <label for="mongoOutput">MongoDBÊü•ËØ¢ËØ≠Ê≥ï</label>
                <textarea id="mongoOutput" readonly placeholder="ËΩ¨Êç¢ÂêéÁöÑMongoDBÊü•ËØ¢Â∞ÜÊòæÁ§∫Âú®ËøôÈáå"></textarea>
            </div>
        </div>

        <div class="btn-group">
            <button onclick="convertSQL()">ËΩ¨Êç¢</button>
            <button class="secondary" onclick="clearAll()">Ê∏ÖÁ©∫</button>
            <button class="secondary" onclick="copyResult()">Â§çÂà∂ÁªìÊûú</button>
            <button class="secondary" onclick="formatSQL()">Ê†ºÂºèÂåñSQL</button>
        </div>

        <div id="message"></div>

        <details class="examples">
            <summary>Á§∫‰æãÊü•ËØ¢ÔºàÁÇπÂáª‰ΩøÁî®Ôºâ</summary>
            <div class="example-item" onclick="useExample(this)">
                <strong>Âü∫Êú¨Êü•ËØ¢</strong>
                <code>SELECT * FROM users WHERE age &gt; 18</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>Â§öÊù°‰ª∂Êü•ËØ¢</strong>
                <code>SELECT * FROM users WHERE age &gt;= 18 AND status = 'active' AND city = 'Beijing'</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>ORÊù°‰ª∂</strong>
                <code>SELECT * FROM users WHERE status = 'active' OR role = 'admin'</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>INÊü•ËØ¢</strong>
                <code>SELECT * FROM products WHERE category IN ('electronics', 'books', 'clothing')</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>LIKEÊü•ËØ¢</strong>
                <code>SELECT * FROM users WHERE name LIKE '%john%'</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>ÊéíÂ∫èÂíåÂàÜÈ°µ</strong>
                <code>SELECT name, email FROM users WHERE active = 1 ORDER BY created_at DESC LIMIT 10 OFFSET 20</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>NULLÊ£ÄÊü•</strong>
                <code>SELECT * FROM orders WHERE shipped_at IS NULL</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>NOT NULLÊ£ÄÊü•</strong>
                <code>SELECT * FROM orders WHERE shipped_at IS NOT NULL</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>BETWEENÊü•ËØ¢</strong>
                <code>SELECT * FROM products WHERE price BETWEEN 100 AND 500</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>COUNTËÅöÂêà</strong>
                <code>SELECT COUNT(*) FROM users WHERE status = 'active'</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>GROUP BYËÅöÂêà</strong>
                <code>SELECT city, COUNT(*) as count FROM users GROUP BY city</code>
            </div>
            <div class="example-item" onclick="useExample(this)">
                <strong>NOT INÊü•ËØ¢</strong>
                <code>SELECT * FROM users WHERE role NOT IN ('guest', 'banned')</code>
            </div>
        </details>

        <details class="reference">
            <summary>SQLÂà∞MongoDBÂØπÁÖßË°®</summary>
            <table>
                <thead>
                    <tr>
                        <th>SQL</th>
                        <th>MongoDB</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>WHERE a = 1</td><td>{ a: 1 }</td></tr>
                    <tr><td>WHERE a != 1</td><td>{ a: { $ne: 1 } }</td></tr>
                    <tr><td>WHERE a &gt; 1</td><td>{ a: { $gt: 1 } }</td></tr>
                    <tr><td>WHERE a &gt;= 1</td><td>{ a: { $gte: 1 } }</td></tr>
                    <tr><td>WHERE a &lt; 1</td><td>{ a: { $lt: 1 } }</td></tr>
                    <tr><td>WHERE a &lt;= 1</td><td>{ a: { $lte: 1 } }</td></tr>
                    <tr><td>WHERE a IN (1,2,3)</td><td>{ a: { $in: [1,2,3] } }</td></tr>
                    <tr><td>WHERE a NOT IN (1,2,3)</td><td>{ a: { $nin: [1,2,3] } }</td></tr>
                    <tr><td>WHERE a LIKE '%text%'</td><td>{ a: /text/ }</td></tr>
                    <tr><td>WHERE a LIKE 'text%'</td><td>{ a: /^text/ }</td></tr>
                    <tr><td>WHERE a LIKE '%text'</td><td>{ a: /text$/ }</td></tr>
                    <tr><td>WHERE a IS NULL</td><td>{ a: null }</td></tr>
                    <tr><td>WHERE a IS NOT NULL</td><td>{ a: { $ne: null } }</td></tr>
                    <tr><td>WHERE a AND b</td><td>{ $and: [{a}, {b}] }</td></tr>
                    <tr><td>WHERE a OR b</td><td>{ $or: [{a}, {b}] }</td></tr>
                    <tr><td>ORDER BY a ASC</td><td>.sort({ a: 1 })</td></tr>
                    <tr><td>ORDER BY a DESC</td><td>.sort({ a: -1 })</td></tr>
                    <tr><td>LIMIT n</td><td>.limit(n)</td></tr>
                    <tr><td>OFFSET n</td><td>.skip(n)</td></tr>
                    <tr><td>SELECT a, b</td><td>.project({ a: 1, b: 1 })</td></tr>
                    <tr><td>COUNT(*)</td><td>.countDocuments()</td></tr>
                </tbody>
            </table>
        </details>
    </main>

    <script>
        // Theme toggle
        window.toggleTheme = function() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        };

        // Load saved theme
        (function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();

        function showMessage(msg, isError) {
            const messageDiv = document.getElementById('message');
            const p = document.createElement('p');
            p.className = isError ? 'error' : 'success';
            p.textContent = msg;
            messageDiv.textContent = '';
            messageDiv.appendChild(p);
            setTimeout(function() { messageDiv.textContent = ''; }, 3000);
        }

        window.useExample = function(element) {
            const code = element.querySelector('code').textContent;
            document.getElementById('sqlInput').value = code;
            convertSQL();
        };

        window.clearAll = function() {
            document.getElementById('sqlInput').value = '';
            document.getElementById('mongoOutput').value = '';
        };

        window.copyResult = function() {
            const output = document.getElementById('mongoOutput');
            if (!output.value) {
                showMessage('Ê≤°ÊúâÂèØÂ§çÂà∂ÁöÑÂÜÖÂÆπ', true);
                return;
            }
            navigator.clipboard.writeText(output.value).then(function() {
                showMessage('Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø', false);
            }).catch(function() {
                showMessage('Â§çÂà∂Â§±Ë¥•', true);
            });
        };

        window.formatSQL = function() {
            const input = document.getElementById('sqlInput');
            let sql = input.value.trim();
            
            // Basic SQL formatting
            const keywords = ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER BY', 'GROUP BY', 'HAVING', 'LIMIT', 'OFFSET', 'JOIN', 'LEFT JOIN', 'RIGHT JOIN', 'INNER JOIN', 'ON'];
            
            keywords.forEach(function(kw) {
                const regex = new RegExp('\\b' + kw + '\\b', 'gi');
                sql = sql.replace(regex, '\n' + kw);
            });
            
            sql = sql.trim();
            input.value = sql;
        };

        // SQL Parser
        function SQLToMongoConverter(sql) {
            this.sql = sql.trim();
            this.tokens = [];
            this.pos = 0;
        }

        SQLToMongoConverter.prototype.tokenize = function() {
            var sql = this.sql;
            var tokens = [];
            var i = 0;
            
            while (i < sql.length) {
                // Skip whitespace
                if (/\s/.test(sql[i])) {
                    i++;
                    continue;
                }
                
                // String literals
                if (sql[i] === "'" || sql[i] === '"') {
                    var quote = sql[i];
                    var str = '';
                    i++;
                    while (i < sql.length && sql[i] !== quote) {
                        if (sql[i] === '\\' && i + 1 < sql.length) {
                            str += sql[i + 1];
                            i += 2;
                        } else {
                            str += sql[i];
                            i++;
                        }
                    }
                    i++; // skip closing quote
                    tokens.push({ type: 'STRING', value: str });
                    continue;
                }
                
                // Numbers
                if (/[\d.-]/.test(sql[i]) && (tokens.length === 0 || tokens[tokens.length-1].type !== 'IDENTIFIER')) {
                    var num = '';
                    while (i < sql.length && /[\d.e+-]/.test(sql[i])) {
                        num += sql[i];
                        i++;
                    }
                    if (!isNaN(parseFloat(num))) {
                        tokens.push({ type: 'NUMBER', value: parseFloat(num) });
                        continue;
                    }
                    i -= num.length;
                }
                
                // Operators
                var ops = ['>=', '<=', '!=', '<>', '=', '>', '<', '(', ')', ',', '*'];
                var foundOp = false;
                for (var j = 0; j < ops.length; j++) {
                    var op = ops[j];
                    if (sql.substring(i, i + op.length) === op) {
                        tokens.push({ type: 'OPERATOR', value: op });
                        i += op.length;
                        foundOp = true;
                        break;
                    }
                }
                if (foundOp) continue;
                
                // Keywords and identifiers
                if (/[a-zA-Z_]/.test(sql[i])) {
                    var word = '';
                    while (i < sql.length && /[a-zA-Z0-9_.]/.test(sql[i])) {
                        word += sql[i];
                        i++;
                    }
                    var upper = word.toUpperCase();
                    var keywords = ['SELECT', 'FROM', 'WHERE', 'AND', 'OR', 'ORDER', 'BY', 'LIMIT', 'OFFSET', 'ASC', 'DESC', 'IN', 'NOT', 'LIKE', 'IS', 'NULL', 'BETWEEN', 'COUNT', 'SUM', 'AVG', 'MIN', 'MAX', 'GROUP', 'HAVING', 'AS', 'DISTINCT'];
                    if (keywords.indexOf(upper) >= 0) {
                        tokens.push({ type: 'KEYWORD', value: upper });
                    } else {
                        tokens.push({ type: 'IDENTIFIER', value: word });
                    }
                    continue;
                }
                
                i++;
            }
            
            this.tokens = tokens;
            return tokens;
        };

        SQLToMongoConverter.prototype.peek = function(offset) {
            offset = offset || 0;
            return this.tokens[this.pos + offset];
        };

        SQLToMongoConverter.prototype.consume = function() {
            return this.tokens[this.pos++];
        };

        SQLToMongoConverter.prototype.expect = function(type, value) {
            var token = this.consume();
            if (!token || token.type !== type || (value && token.value !== value)) {
                throw new Error('Expected ' + type + ' ' + (value || '') + ', got ' + (token ? token.type + ' ' + token.value : 'EOF'));
            }
            return token;
        };

        SQLToMongoConverter.prototype.match = function(type, value) {
            var token = this.peek();
            if (!token) return false;
            if (token.type !== type) return false;
            if (value && token.value !== value) return false;
            return true;
        };

        SQLToMongoConverter.prototype.convert = function() {
            this.tokenize();
            
            if (this.tokens.length === 0) {
                throw new Error('Á©∫ÁöÑSQLËØ≠Âè•');
            }

            var result = {
                collection: '',
                method: 'find',
                query: {},
                projection: null,
                sort: null,
                limit: null,
                skip: null,
                aggregate: null
            };

            // Parse SELECT
            if (this.match('KEYWORD', 'SELECT')) {
                this.consume();
                result.projection = this.parseSelectFields();
            }

            // Parse FROM
            if (this.match('KEYWORD', 'FROM')) {
                this.consume();
                var tableToken = this.consume();
                result.collection = tableToken.value;
            }

            // Parse WHERE
            if (this.match('KEYWORD', 'WHERE')) {
                this.consume();
                result.query = this.parseConditions();
            }

            // Parse GROUP BY
            if (this.match('KEYWORD', 'GROUP')) {
                this.consume();
                if (this.match('KEYWORD', 'BY')) {
                    this.consume();
                    result.aggregate = this.parseGroupBy(result);
                }
            }

            // Parse ORDER BY
            if (this.match('KEYWORD', 'ORDER')) {
                this.consume();
                if (this.match('KEYWORD', 'BY')) {
                    this.consume();
                    result.sort = this.parseOrderBy();
                }
            }

            // Parse LIMIT
            if (this.match('KEYWORD', 'LIMIT')) {
                this.consume();
                var limitToken = this.consume();
                result.limit = limitToken.value;
            }

            // Parse OFFSET
            if (this.match('KEYWORD', 'OFFSET')) {
                this.consume();
                var offsetToken = this.consume();
                result.skip = offsetToken.value;
            }

            return this.formatOutput(result);
        };

        SQLToMongoConverter.prototype.parseSelectFields = function() {
            var fields = [];
            var hasAggregate = false;
            var self = this;
            
            while (true) {
                if (this.match('OPERATOR', '*')) {
                    this.consume();
                    return null; // SELECT * means no projection
                }
                
                // Check for aggregate functions
                if (this.match('KEYWORD', 'COUNT') || this.match('KEYWORD', 'SUM') || 
                    this.match('KEYWORD', 'AVG') || this.match('KEYWORD', 'MIN') || 
                    this.match('KEYWORD', 'MAX')) {
                    var func = this.consume().value;
                    this.expect('OPERATOR', '(');
                    var field = '*';
                    if (!this.match('OPERATOR', '*')) {
                        field = this.consume().value;
                    } else {
                        this.consume();
                    }
                    this.expect('OPERATOR', ')');
                    
                    var alias = func.toLowerCase();
                    if (this.match('KEYWORD', 'AS')) {
                        this.consume();
                        alias = this.consume().value;
                    }
                    
                    fields.push({ type: 'aggregate', func: func, field: field, alias: alias });
                    hasAggregate = true;
                } else if (this.match('KEYWORD', 'DISTINCT')) {
                    this.consume();
                    var distinctField = this.consume().value;
                    fields.push({ type: 'distinct', field: distinctField });
                } else if (this.match('IDENTIFIER')) {
                    var fieldName = this.consume().value;
                    var fieldAlias = fieldName;
                    if (this.match('KEYWORD', 'AS')) {
                        this.consume();
                        fieldAlias = this.consume().value;
                    }
                    fields.push({ type: 'field', field: fieldName, alias: fieldAlias });
                }
                
                if (this.match('OPERATOR', ',')) {
                    this.consume();
                } else {
                    break;
                }
            }
            
            if (hasAggregate) {
                return { _aggregate: fields };
            }
            
            var projection = {};
            fields.forEach(function(f) {
                if (f.type === 'field') {
                    projection[f.field] = 1;
                }
            });
            return Object.keys(projection).length > 0 ? projection : null;
        };

        SQLToMongoConverter.prototype.parseConditions = function() {
            return this.parseOrCondition();
        };

        SQLToMongoConverter.prototype.parseOrCondition = function() {
            var left = this.parseAndCondition();
            
            while (this.match('KEYWORD', 'OR')) {
                this.consume();
                var right = this.parseAndCondition();
                left = { $or: [left, right] };
            }
            
            return left;
        };

        SQLToMongoConverter.prototype.parseAndCondition = function() {
            var left = this.parseSingleCondition();
            
            while (this.match('KEYWORD', 'AND')) {
                this.consume();
                var right = this.parseSingleCondition();
                
                // Merge AND conditions
                if (left.$and) {
                    left.$and.push(right);
                } else if (right.$and) {
                    left = { $and: [left].concat(right.$and) };
                } else {
                    // Try to merge simple conditions
                    var leftKeys = Object.keys(left);
                    var rightKeys = Object.keys(right);
                    var hasOverlap = leftKeys.some(function(k) { return rightKeys.indexOf(k) >= 0; });
                    
                    if (hasOverlap || (leftKeys[0] && leftKeys[0].charAt(0) === '$') || (rightKeys[0] && rightKeys[0].charAt(0) === '$')) {
                        left = { $and: [left, right] };
                    } else {
                        for (var k in right) {
                            left[k] = right[k];
                        }
                    }
                }
            }
            
            return left;
        };

        SQLToMongoConverter.prototype.parseSingleCondition = function() {
            // Handle parentheses
            if (this.match('OPERATOR', '(')) {
                this.consume();
                var condition = this.parseConditions();
                this.expect('OPERATOR', ')');
                return condition;
            }

            var field = this.consume().value;
            
            // IS NULL / IS NOT NULL
            if (this.match('KEYWORD', 'IS')) {
                this.consume();
                if (this.match('KEYWORD', 'NOT')) {
                    this.consume();
                    this.expect('KEYWORD', 'NULL');
                    var result = {};
                    result[field] = { $ne: null };
                    return result;
                }
                this.expect('KEYWORD', 'NULL');
                var result2 = {};
                result2[field] = null;
                return result2;
            }

            // NOT IN / NOT LIKE
            if (this.match('KEYWORD', 'NOT')) {
                this.consume();
                if (this.match('KEYWORD', 'IN')) {
                    this.consume();
                    var values = this.parseInList();
                    var result3 = {};
                    result3[field] = { $nin: values };
                    return result3;
                }
                if (this.match('KEYWORD', 'LIKE')) {
                    this.consume();
                    var pattern = this.consume().value;
                    var result4 = {};
                    result4[field] = { $not: this.likeToRegex(pattern) };
                    return result4;
                }
            }

            // IN
            if (this.match('KEYWORD', 'IN')) {
                this.consume();
                var inValues = this.parseInList();
                var result5 = {};
                result5[field] = { $in: inValues };
                return result5;
            }

            // LIKE
            if (this.match('KEYWORD', 'LIKE')) {
                this.consume();
                var likePattern = this.consume().value;
                var result6 = {};
                result6[field] = this.likeToRegex(likePattern);
                return result6;
            }

            // BETWEEN
            if (this.match('KEYWORD', 'BETWEEN')) {
                this.consume();
                var low = this.consume().value;
                this.expect('KEYWORD', 'AND');
                var high = this.consume().value;
                var result7 = {};
                result7[field] = { $gte: low, $lte: high };
                return result7;
            }

            // Comparison operators
            var op = this.consume();
            var value = this.consume().value;
            var result8 = {};

            switch (op.value) {
                case '=':
                    result8[field] = value;
                    break;
                case '!=':
                case '<>':
                    result8[field] = { $ne: value };
                    break;
                case '>':
                    result8[field] = { $gt: value };
                    break;
                case '>=':
                    result8[field] = { $gte: value };
                    break;
                case '<':
                    result8[field] = { $lt: value };
                    break;
                case '<=':
                    result8[field] = { $lte: value };
                    break;
                default:
                    throw new Error('Unknown operator: ' + op.value);
            }
            return result8;
        };

        SQLToMongoConverter.prototype.parseInList = function() {
            this.expect('OPERATOR', '(');
            var values = [];
            
            while (!this.match('OPERATOR', ')')) {
                var token = this.consume();
                values.push(token.value);
                
                if (this.match('OPERATOR', ',')) {
                    this.consume();
                }
            }
            
            this.expect('OPERATOR', ')');
            return values;
        };

        SQLToMongoConverter.prototype.likeToRegex = function(pattern) {
            var regex = pattern
                .replace(/[.*+?^${}()|[\]\\]/g, '\\$&') // Escape special chars
                .replace(/\\%/g, '.*')  // % -> .*
                .replace(/_/g, '.');     // _ -> .
            
            // Check if it's a prefix, suffix, or contains pattern
            if (pattern.charAt(0) === '%' && pattern.charAt(pattern.length - 1) === '%') {
                regex = regex.slice(2, -2); // Remove .* from both ends
            } else if (pattern.charAt(0) === '%') {
                regex = regex.slice(2) + '$';
            } else if (pattern.charAt(pattern.length - 1) === '%') {
                regex = '^' + regex.slice(0, -2);
            } else {
                regex = '^' + regex + '$';
            }
            
            return { $regex: regex, $options: 'i' };
        };

        SQLToMongoConverter.prototype.parseOrderBy = function() {
            var sort = {};
            
            while (true) {
                var field = this.consume().value;
                var direction = 1;
                
                if (this.match('KEYWORD', 'DESC')) {
                    this.consume();
                    direction = -1;
                } else if (this.match('KEYWORD', 'ASC')) {
                    this.consume();
                }
                
                sort[field] = direction;
                
                if (this.match('OPERATOR', ',')) {
                    this.consume();
                } else {
                    break;
                }
            }
            
            return sort;
        };

        SQLToMongoConverter.prototype.parseGroupBy = function(result) {
            var groupFields = [];
            
            while (true) {
                if (this.match('IDENTIFIER')) {
                    groupFields.push(this.consume().value);
                }
                
                if (this.match('OPERATOR', ',')) {
                    this.consume();
                } else {
                    break;
                }
            }
            
            return { groupFields: groupFields, projection: result.projection };
        };

        SQLToMongoConverter.prototype.formatOutput = function(result) {
            var output = '';
            var self = this;
            
            // Handle aggregate queries
            if (result.aggregate || (result.projection && result.projection._aggregate)) {
                output = this.formatAggregateQuery(result);
            } else {
                // Regular find query
                output = 'db.' + result.collection + '.find(' + this.formatJSON(result.query);
                
                if (result.projection) {
                    output += ', ' + this.formatJSON(result.projection);
                }
                
                output += ')';
                
                if (result.sort) {
                    output += '.sort(' + this.formatJSON(result.sort) + ')';
                }
                
                if (result.skip) {
                    output += '.skip(' + result.skip + ')';
                }
                
                if (result.limit) {
                    output += '.limit(' + result.limit + ')';
                }
            }
            
            return output;
        };

        SQLToMongoConverter.prototype.formatAggregateQuery = function(result) {
            var pipeline = [];
            var self = this;
            
            // $match stage
            if (Object.keys(result.query).length > 0) {
                pipeline.push({ $match: result.query });
            }
            
            // $group stage
            if (result.aggregate) {
                var groupStage = { _id: null };
                
                if (result.aggregate.groupFields && result.aggregate.groupFields.length > 0) {
                    if (result.aggregate.groupFields.length === 1) {
                        groupStage._id = '$' + result.aggregate.groupFields[0];
                    } else {
                        groupStage._id = {};
                        result.aggregate.groupFields.forEach(function(f) {
                            groupStage._id[f] = '$' + f;
                        });
                    }
                }
                
                // Add aggregation expressions from projection
                if (result.projection && result.projection._aggregate) {
                    result.projection._aggregate.forEach(function(agg) {
                        if (agg.type === 'aggregate') {
                            switch (agg.func) {
                                case 'COUNT':
                                    groupStage[agg.alias] = { $sum: 1 };
                                    break;
                                case 'SUM':
                                    groupStage[agg.alias] = { $sum: '$' + agg.field };
                                    break;
                                case 'AVG':
                                    groupStage[agg.alias] = { $avg: '$' + agg.field };
                                    break;
                                case 'MIN':
                                    groupStage[agg.alias] = { $min: '$' + agg.field };
                                    break;
                                case 'MAX':
                                    groupStage[agg.alias] = { $max: '$' + agg.field };
                                    break;
                            }
                        }
                    });
                }
                
                pipeline.push({ $group: groupStage });
            } else if (result.projection && result.projection._aggregate) {
                // Simple aggregate without GROUP BY
                var agg = result.projection._aggregate;
                var countFunc = null;
                for (var i = 0; i < agg.length; i++) {
                    if (agg[i].func === 'COUNT') {
                        countFunc = agg[i];
                        break;
                    }
                }
                if (countFunc && agg.length === 1) {
                    return 'db.' + result.collection + '.countDocuments(' + this.formatJSON(result.query) + ')';
                }
                
                var groupStage2 = { _id: null };
                agg.forEach(function(a) {
                    if (a.type === 'aggregate') {
                        switch (a.func) {
                            case 'COUNT':
                                groupStage2[a.alias] = { $sum: 1 };
                                break;
                            case 'SUM':
                                groupStage2[a.alias] = { $sum: '$' + a.field };
                                break;
                            case 'AVG':
                                groupStage2[a.alias] = { $avg: '$' + a.field };
                                break;
                            case 'MIN':
                                groupStage2[a.alias] = { $min: '$' + a.field };
                                break;
                            case 'MAX':
                                groupStage2[a.alias] = { $max: '$' + a.field };
                                break;
                        }
                    }
                });
                pipeline.push({ $group: groupStage2 });
            }
            
            // $sort stage
            if (result.sort) {
                pipeline.push({ $sort: result.sort });
            }
            
            // $skip stage
            if (result.skip) {
                pipeline.push({ $skip: result.skip });
            }
            
            // $limit stage
            if (result.limit) {
                pipeline.push({ $limit: result.limit });
            }
            
            return 'db.' + result.collection + '.aggregate(' + this.formatJSON(pipeline) + ')';
        };

        SQLToMongoConverter.prototype.formatJSON = function(obj) {
            return JSON.stringify(obj, function(key, value) {
                if (value && value.$regex) {
                    return '/' + value.$regex + '/' + (value.$options || '');
                }
                return value;
            }, 2).replace(/"(\/[^"]+\/[a-z]*)"/g, '$1');
        };

        function convertSQL() {
            var sqlInput = document.getElementById('sqlInput').value.trim();
            var mongoOutput = document.getElementById('mongoOutput');
            
            if (!sqlInput) {
                showMessage('ËØ∑ËæìÂÖ•SQLËØ≠Âè•', true);
                return;
            }
            
            try {
                var converter = new SQLToMongoConverter(sqlInput);
                var result = converter.convert();
                mongoOutput.value = result;
                showMessage('ËΩ¨Êç¢ÊàêÂäü', false);
            } catch (error) {
                mongoOutput.value = '';
                showMessage('ËΩ¨Êç¢ÈîôËØØ: ' + error.message, true);
            }
        }

        // Auto-convert on input (debounced)
        var timeout;
        document.getElementById('sqlInput').addEventListener('input', function() {
            clearTimeout(timeout);
            timeout = setTimeout(function() {
                if (document.getElementById('sqlInput').value.trim()) {
                    convertSQL();
                }
            }, 500);
        });
    </script>
</body>
</html>

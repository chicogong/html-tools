<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å·¥ä½œé‡è¯„ä¼°å™¨ - WebUtils</title>
    <style>
      :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --text-color: #e0e0e0;
        --primary-color: #0f3460;
        --accent-color: #00d9ff;
        --border-color: #0f3460;
        --input-bg: #1a1a2e;
        --success-color: #4ade80;
        --warning-color: #fbbf24;
        --danger-color: #f87171;
      }

      [data-theme="light"] {
        --bg-color: #f0f4f8;
        --card-bg: #fff;
        --text-color: #1a1a2e;
        --primary-color: #e0e7ff;
        --accent-color: #0891b2;
        --border-color: #c7d2fe;
        --input-bg: #f8fafc;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        font-size: 16px;
        line-height: 1.6;
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--accent-color), #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-toggle {
        position: absolute;
        right: 0;
        top: 0;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
      }

      .back-link {
        position: absolute;
        left: 0;
        top: 0;
        color: var(--accent-color);
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
      }

      .panel-title {
        font-size: 1rem;
        margin-bottom: 15px;
        color: var(--accent-color);
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 14px;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 12px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
      }

      .task-item {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 10px;
        align-items: center;
        padding: 15px;
        background: var(--input-bg);
        border-radius: 8px;
        margin-bottom: 10px;
      }

      @media (max-width: 768px) {
        .task-item {
          grid-template-columns: 1fr;
          gap: 8px;
        }
      }

      .task-item input,
      .task-item select {
        padding: 10px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        color: var(--text-color);
        font-size: 14px;
      }

      .task-item input:focus,
      .task-item select:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--accent-color);
        color: #000;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
      }

      .btn-secondary {
        background: var(--primary-color);
        color: var(--text-color);
      }

      .btn-danger {
        background: transparent;
        color: var(--danger-color);
        padding: 8px 12px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .estimate-method {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }

      .method-btn {
        flex: 1;
        min-width: 120px;
        padding: 12px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        text-align: center;
      }

      .method-btn.active {
        background: var(--accent-color);
        color: #000;
        border-color: var(--accent-color);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
      }

      .stat-card {
        background: var(--input-bg);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
      }

      .stat-value {
        font-size: 1.8rem;
        font-weight: bold;
        color: var(--accent-color);
      }

      .stat-label {
        font-size: 12px;
        opacity: 0.7;
        margin-top: 5px;
      }

      .complexity-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: bold;
      }

      .complexity-low {
        background: rgba(74, 222, 128, 0.2);
        color: var(--success-color);
      }

      .complexity-medium {
        background: rgba(251, 191, 36, 0.2);
        color: var(--warning-color);
      }

      .complexity-high {
        background: rgba(248, 113, 113, 0.2);
        color: var(--danger-color);
      }

      .story-points {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .point-btn {
        width: 45px;
        height: 45px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
        background: var(--input-bg);
        color: var(--text-color);
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.3s ease;
      }

      .point-btn.selected {
        background: var(--accent-color);
        color: #000;
        border-color: var(--accent-color);
      }

      .summary-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .summary-table th,
      .summary-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
      }

      .summary-table th {
        font-size: 12px;
        text-transform: uppercase;
        opacity: 0.7;
      }

      .progress-bar {
        height: 8px;
        background: var(--input-bg);
        border-radius: 4px;
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, var(--accent-color), #a855f7);
        transition: width 0.5s ease;
      }

      .task-header {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr auto;
        gap: 10px;
        padding: 10px 15px;
        font-size: 12px;
        opacity: 0.7;
        text-transform: uppercase;
      }

      @media (max-width: 768px) {
        .task-header {
          display: none;
        }
      }

      .velocity-input {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .velocity-input input {
        width: 100px;
      }
      .visually-hidden {
        position: absolute;

        width: 1px;

        height: 1px;

        margin: -1px;

        padding: 0;

        overflow: hidden;

        clip: rect(0, 0, 0, 0);

        white-space: nowrap;

        border: 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a href="../../index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
        <h1>å·¥ä½œé‡è¯„ä¼°å™¨</h1>
        <p>æ•æ·ä¼°ç®—ä¸å·¥ä½œé‡è®¡ç®—</p>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“ è¯„ä¼°æ–¹æ³•</div>
        <div class="estimate-method">
          <button class="method-btn active" onclick="setMethod('storyPoints', this)">
            æ•…äº‹ç‚¹æ•° (SP)
          </button>
          <button class="method-btn" onclick="setMethod('hours', this)">å·¥æ—¶ä¼°ç®—</button>
          <button class="method-btn" onclick="setMethod('tshirt', this)">Tæ¤å°ºç </button>
          <button class="method-btn" onclick="setMethod('threePoint', this)">ä¸‰ç‚¹ä¼°ç®—</button>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>å›¢é˜Ÿé€Ÿåº¦ (æ¯å†²åˆºå¯å®Œæˆ)</label>
            <div class="velocity-input">
              <input type="number" id="velocity" value="30" min="1" onchange="calculate()" />
              <span id="velocityUnit">SP</span>
            </div>
          </div>
          <div class="form-group">
            <label>å†²åˆºé•¿åº¦ (å¤©)</label>
            <input type="number" id="sprintLength" value="14" min="1" onchange="calculate()" />
          </div>
          <div class="form-group">
            <label>å›¢é˜Ÿäººæ•°</label>
            <input type="number" id="teamSize" value="5" min="1" onchange="calculate()" />
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“ ä»»åŠ¡åˆ—è¡¨</div>
        <div class="task-header">
          <span>ä»»åŠ¡åç§°</span>
          <span id="estimateHeader">æ•…äº‹ç‚¹æ•°</span>
          <span>å¤æ‚åº¦</span>
          <span>è´Ÿè´£äºº</span>
          <span></span>
        </div>
        <div id="taskList"></div>
        <div class="btn-group">
          <button class="btn btn-secondary" onclick="addTask()">+ æ·»åŠ ä»»åŠ¡</button>
          <button class="btn btn-secondary" onclick="importTasks()">ğŸ“¥ å¯¼å…¥</button>
          <button class="btn btn-secondary" onclick="clearTasks()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“Š è¯„ä¼°ç»“æœ</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="totalEstimate">0</div>
            <div class="stat-label" id="totalLabel">æ€»æ•…äº‹ç‚¹</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="sprintsNeeded">0</div>
            <div class="stat-label">éœ€è¦å†²åˆºæ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="estimatedDays">0</div>
            <div class="stat-label">é¢„è®¡å¤©æ•°</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="avgPerPerson">0</div>
            <div class="stat-label">äººå‡å·¥ä½œé‡</div>
          </div>
        </div>

        <table class="summary-table">
          <thead>
            <tr>
              <th>å¤æ‚åº¦</th>
              <th>ä»»åŠ¡æ•°</th>
              <th>ä¼°ç®—å€¼</th>
              <th>å æ¯”</th>
            </tr>
          </thead>
          <tbody id="summaryBody"></tbody>
        </table>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ¯ é£é™©è¯„ä¼°</div>
        <div id="riskAnalysis"></div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ’¾ å¯¼å‡º</div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="exportCSV()">ğŸ“Š å¯¼å‡º CSV</button>
          <button class="btn btn-secondary" onclick="exportMarkdown()">ğŸ“ å¯¼å‡º Markdown</button>
          <button class="btn btn-secondary" onclick="shareLink()">ğŸ”— åˆ†äº«é“¾æ¥</button>
        </div>
      </div>
    </div>

    <script>
      var LS_KEY = "workload-calc-data";
      var method = "storyPoints";
      var tasks = [];
      var fibonacciPoints = [1, 2, 3, 5, 8, 13, 21];
      var tshirtSizes = { XS: 1, S: 2, M: 5, L: 8, XL: 13, XXL: 21 };

      function init() {
        var savedTheme = localStorage.getItem("theme") || "dark";
        if (savedTheme === "light") {
          document.body.setAttribute("data-theme", "light");
        }

        loadFromUrl() || loadFromStorage();

        if (tasks.length === 0) {
          addTask();
        }

        renderTasks();
        calculate();
      }

      function generateId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
      }

      function setMethod(newMethod, btn) {
        method = newMethod;
        document.querySelectorAll(".method-btn").forEach(function (b) {
          b.classList.remove("active");
        });
        btn.classList.add("active");

        var labels = {
          storyPoints: { header: "æ•…äº‹ç‚¹æ•°", unit: "SP", total: "æ€»æ•…äº‹ç‚¹" },
          hours: { header: "é¢„è®¡å·¥æ—¶", unit: "å°æ—¶", total: "æ€»å·¥æ—¶" },
          tshirt: { header: "Tæ¤å°ºç ", unit: "SP", total: "æ€»æ•…äº‹ç‚¹" },
          threePoint: { header: "ä¹è§‚/å¯èƒ½/æ‚²è§‚", unit: "å°æ—¶", total: "æ€»å·¥æ—¶" }
        };

        document.getElementById("estimateHeader").textContent = labels[method].header;
        document.getElementById("velocityUnit").textContent = labels[method].unit;
        document.getElementById("totalLabel").textContent = labels[method].total;

        renderTasks();
        calculate();
        saveToStorage();
      }

      function addTask(name, estimate, complexity, owner) {
        tasks.push({
          id: generateId(),
          name: name || "",
          estimate: estimate || (method === "threePoint" ? { o: 0, m: 0, p: 0 } : 0),
          complexity: complexity || "medium",
          owner: owner || ""
        });
        renderTasks();
        saveToStorage();
      }

      function removeTask(id) {
        tasks = tasks.filter(function (t) {
          return t.id !== id;
        });
        renderTasks();
        calculate();
        saveToStorage();
      }

      function createStoryPointsSelector(task) {
        var container = document.createElement("div");
        container.className = "story-points";

        fibonacciPoints.forEach(function (point) {
          var btn = document.createElement("button");
          btn.className = "point-btn" + (task.estimate === point ? " selected" : "");
          btn.textContent = point;
          btn.onclick = function () {
            task.estimate = point;
            renderTasks();
            calculate();
            saveToStorage();
          };
          container.appendChild(btn);
        });

        return container;
      }

      function createTshirtSelector(task) {
        var select = document.createElement("select");
        Object.keys(tshirtSizes).forEach(function (size) {
          var option = document.createElement("option");
          option.value = size;
          option.textContent = size;
          if (task.estimate === size) option.selected = true;
          select.appendChild(option);
        });
        select.onchange = function () {
          task.estimate = select.value;
          calculate();
          saveToStorage();
        };
        return select;
      }

      function createThreePointInputs(task) {
        var container = document.createElement("div");
        container.style.display = "flex";
        container.style.gap = "5px";

        var fields = [
          { key: "o", placeholder: "ä¹è§‚" },
          { key: "m", placeholder: "å¯èƒ½" },
          { key: "p", placeholder: "æ‚²è§‚" }
        ];

        if (typeof task.estimate !== "object") {
          task.estimate = { o: 0, m: 0, p: 0 };
        }

        fields.forEach(function (field) {
          var input = document.createElement("input");
          input.type = "number";
          input.placeholder = field.placeholder;
          input.value = task.estimate[field.key] || "";
          input.style.width = "60px";
          input.min = "0";
          input.onchange = function () {
            task.estimate[field.key] = parseFloat(input.value) || 0;
            calculate();
            saveToStorage();
          };
          container.appendChild(input);
        });

        return container;
      }

      function createHoursInput(task) {
        var input = document.createElement("input");
        input.type = "number";
        input.placeholder = "å·¥æ—¶";
        input.value = task.estimate || "";
        input.min = "0";
        input.step = "0.5";
        input.onchange = function () {
          task.estimate = parseFloat(input.value) || 0;
          calculate();
          saveToStorage();
        };
        return input;
      }

      function createComplexitySelect(task) {
        var select = document.createElement("select");
        var options = [
          { value: "low", label: "ä½" },
          { value: "medium", label: "ä¸­" },
          { value: "high", label: "é«˜" }
        ];
        options.forEach(function (opt) {
          var option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          if (task.complexity === opt.value) option.selected = true;
          select.appendChild(option);
        });
        select.onchange = function () {
          task.complexity = select.value;
          calculate();
          saveToStorage();
        };
        return select;
      }

      function renderTasks() {
        var container = document.getElementById("taskList");
        container.textContent = "";

        tasks.forEach(function (task) {
          var div = document.createElement("div");
          div.className = "task-item";

          var nameInput = document.createElement("input");
          nameInput.type = "text";
          nameInput.placeholder = "ä»»åŠ¡åç§°";
          nameInput.value = task.name;
          nameInput.onchange = function () {
            task.name = nameInput.value;
            saveToStorage();
          };

          var estimateContainer;
          switch (method) {
            case "storyPoints":
              estimateContainer = createStoryPointsSelector(task);
              break;
            case "tshirt":
              estimateContainer = createTshirtSelector(task);
              break;
            case "threePoint":
              estimateContainer = createThreePointInputs(task);
              break;
            default:
              estimateContainer = createHoursInput(task);
          }

          var complexitySelect = createComplexitySelect(task);

          var ownerInput = document.createElement("input");
          ownerInput.type = "text";
          ownerInput.placeholder = "è´Ÿè´£äºº";
          ownerInput.value = task.owner;
          ownerInput.onchange = function () {
            task.owner = ownerInput.value;
            saveToStorage();
          };

          var deleteBtn = document.createElement("button");
          deleteBtn.className = "btn btn-danger";
          deleteBtn.textContent = "Ã—";
          deleteBtn.onclick = function () {
            removeTask(task.id);
          };

          div.appendChild(nameInput);
          div.appendChild(estimateContainer);
          div.appendChild(complexitySelect);
          div.appendChild(ownerInput);
          div.appendChild(deleteBtn);
          container.appendChild(div);
        });
      }

      function getTaskEstimate(task) {
        if (method === "tshirt") {
          return tshirtSizes[task.estimate] || 0;
        }
        if (method === "threePoint" && typeof task.estimate === "object") {
          var o = task.estimate.o || 0;
          var m = task.estimate.m || 0;
          var p = task.estimate.p || 0;
          return (o + 4 * m + p) / 6;
        }
        return parseFloat(task.estimate) || 0;
      }

      function calculate() {
        var velocity = parseFloat(document.getElementById("velocity").value) || 30;
        var sprintLength = parseFloat(document.getElementById("sprintLength").value) || 14;
        var teamSize = parseInt(document.getElementById("teamSize").value) || 5;

        var totalEstimate = 0;
        var complexityCounts = { low: 0, medium: 0, high: 0 };
        var complexityEstimates = { low: 0, medium: 0, high: 0 };

        tasks.forEach(function (task) {
          var estimate = getTaskEstimate(task);
          totalEstimate += estimate;
          complexityCounts[task.complexity]++;
          complexityEstimates[task.complexity] += estimate;
        });

        var sprintsNeeded = Math.ceil(totalEstimate / velocity);
        var estimatedDays = sprintsNeeded * sprintLength;
        var avgPerPerson = tasks.length > 0 ? (totalEstimate / teamSize).toFixed(1) : 0;

        document.getElementById("totalEstimate").textContent = totalEstimate.toFixed(1);
        document.getElementById("sprintsNeeded").textContent = sprintsNeeded;
        document.getElementById("estimatedDays").textContent = estimatedDays;
        document.getElementById("avgPerPerson").textContent = avgPerPerson;

        renderSummary(complexityCounts, complexityEstimates, totalEstimate);
        renderRiskAnalysis(complexityCounts, totalEstimate, sprintsNeeded);
        saveToStorage();
      }

      function renderSummary(counts, estimates, total) {
        var tbody = document.getElementById("summaryBody");
        tbody.textContent = "";

        var complexityLabels = {
          low: { label: "ä½å¤æ‚åº¦", class: "complexity-low" },
          medium: { label: "ä¸­å¤æ‚åº¦", class: "complexity-medium" },
          high: { label: "é«˜å¤æ‚åº¦", class: "complexity-high" }
        };

        Object.keys(complexityLabels).forEach(function (key) {
          var tr = document.createElement("tr");

          var td1 = document.createElement("td");
          var badge = document.createElement("span");
          badge.className = "complexity-badge " + complexityLabels[key].class;
          badge.textContent = complexityLabels[key].label;
          td1.appendChild(badge);

          var td2 = document.createElement("td");
          td2.textContent = counts[key];

          var td3 = document.createElement("td");
          td3.textContent = estimates[key].toFixed(1);

          var td4 = document.createElement("td");
          var percent = total > 0 ? ((estimates[key] / total) * 100).toFixed(1) : 0;
          var progressDiv = document.createElement("div");
          progressDiv.style.display = "flex";
          progressDiv.style.alignItems = "center";
          progressDiv.style.gap = "10px";

          var bar = document.createElement("div");
          bar.className = "progress-bar";
          bar.style.flex = "1";
          var fill = document.createElement("div");
          fill.className = "progress-fill";
          fill.style.width = percent + "%";
          bar.appendChild(fill);

          var percentText = document.createElement("span");
          percentText.textContent = percent + "%";
          percentText.style.fontSize = "12px";
          percentText.style.minWidth = "45px";

          progressDiv.appendChild(bar);
          progressDiv.appendChild(percentText);
          td4.appendChild(progressDiv);

          tr.appendChild(td1);
          tr.appendChild(td2);
          tr.appendChild(td3);
          tr.appendChild(td4);
          tbody.appendChild(tr);
        });
      }

      function renderRiskAnalysis(counts, total, sprints) {
        var container = document.getElementById("riskAnalysis");
        container.textContent = "";

        var risks = [];

        var highRatio = total > 0 ? counts.high / tasks.length : 0;
        if (highRatio > 0.3) {
          risks.push({
            level: "high",
            message:
              "âš ï¸ é«˜å¤æ‚åº¦ä»»åŠ¡å æ¯” " + (highRatio * 100).toFixed(0) + "%ï¼Œå»ºè®®æ‹†åˆ†æˆ–å¢åŠ ç¼“å†²æ—¶é—´"
          });
        }

        if (sprints > 3) {
          risks.push({
            level: "medium",
            message: "ğŸ“… é¡¹ç›®å‘¨æœŸè¾ƒé•¿ (" + sprints + " ä¸ªå†²åˆº)ï¼Œå»ºè®®åˆ†é˜¶æ®µäº¤ä»˜"
          });
        }

        var unassigned = tasks.filter(function (t) {
          return !t.owner;
        }).length;
        if (unassigned > 0) {
          risks.push({
            level: "low",
            message: "ğŸ‘¤ æœ‰ " + unassigned + " ä¸ªä»»åŠ¡æœªåˆ†é…è´Ÿè´£äºº"
          });
        }

        if (method === "threePoint") {
          var variance = 0;
          tasks.forEach(function (task) {
            if (typeof task.estimate === "object") {
              var diff = (task.estimate.p || 0) - (task.estimate.o || 0);
              variance += diff * diff;
            }
          });
          if (variance > 100) {
            risks.push({
              level: "medium",
              message: "ğŸ“Š ä¼°ç®—ä¸ç¡®å®šæ€§è¾ƒé«˜ï¼Œå»ºè®®è¿›ä¸€æ­¥ç»†åŒ–éœ€æ±‚"
            });
          }
        }

        if (risks.length === 0) {
          risks.push({
            level: "success",
            message: "âœ… å½“å‰è¯„ä¼°é£é™©è¾ƒä½"
          });
        }

        risks.forEach(function (risk) {
          var div = document.createElement("div");
          div.style.padding = "12px";
          div.style.borderRadius = "8px";
          div.style.marginBottom = "10px";
          div.style.fontSize = "14px";

          var colors = {
            high: "rgba(248, 113, 113, 0.1)",
            medium: "rgba(251, 191, 36, 0.1)",
            low: "rgba(0, 217, 255, 0.1)",
            success: "rgba(74, 222, 128, 0.1)"
          };
          div.style.background = colors[risk.level];
          div.textContent = risk.message;
          container.appendChild(div);
        });
      }

      function importTasks() {
        var input = prompt("è¯·è¾“å…¥ä»»åŠ¡åˆ—è¡¨ (æ¯è¡Œä¸€ä¸ªä»»åŠ¡åç§°):");
        if (input) {
          var lines = input.split("\n").filter(function (l) {
            return l.trim();
          });
          lines.forEach(function (line) {
            addTask(line.trim());
          });
        }
      }

      function clearTasks() {
        if (confirm("ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ä»»åŠ¡å—ï¼Ÿ")) {
          tasks = [];
          addTask();
          calculate();
        }
      }

      function exportCSV() {
        var lines = ["ä»»åŠ¡åç§°,ä¼°ç®—å€¼,å¤æ‚åº¦,è´Ÿè´£äºº"];
        tasks.forEach(function (task) {
          var estimate = getTaskEstimate(task);
          lines.push(
            '"' + task.name + '",' + estimate + "," + task.complexity + ',"' + task.owner + '"'
          );
        });

        var blob = new Blob([lines.join("\n")], { type: "text/csv;charset=utf-8" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "å·¥ä½œé‡è¯„ä¼°.csv";
        a.click();
        URL.revokeObjectURL(url);
      }

      function exportMarkdown() {
        var velocity = document.getElementById("velocity").value;
        var totalEstimate = parseFloat(document.getElementById("totalEstimate").textContent);
        var sprints = document.getElementById("sprintsNeeded").textContent;
        var days = document.getElementById("estimatedDays").textContent;

        var lines = [];
        lines.push("# å·¥ä½œé‡è¯„ä¼°æŠ¥å‘Š");
        lines.push("");
        lines.push("## åŸºæœ¬ä¿¡æ¯");
        lines.push("- è¯„ä¼°æ–¹æ³•: " + method);
        lines.push("- å›¢é˜Ÿé€Ÿåº¦: " + velocity);
        lines.push("- æ€»å·¥ä½œé‡: " + totalEstimate);
        lines.push("- é¢„è®¡å†²åˆº: " + sprints);
        lines.push("- é¢„è®¡å¤©æ•°: " + days);
        lines.push("");
        lines.push("## ä»»åŠ¡åˆ—è¡¨");
        lines.push("");
        lines.push("| ä»»åŠ¡ | ä¼°ç®— | å¤æ‚åº¦ | è´Ÿè´£äºº |");
        lines.push("|------|------|--------|--------|");

        tasks.forEach(function (task) {
          var estimate = getTaskEstimate(task);
          lines.push(
            "| " +
              (task.name || "-") +
              " | " +
              estimate +
              " | " +
              task.complexity +
              " | " +
              (task.owner || "-") +
              " |"
          );
        });

        var content = lines.join("\n");
        var blob = new Blob([content], { type: "text/markdown;charset=utf-8" });
        var url = URL.createObjectURL(blob);
        var a = document.createElement("a");
        a.href = url;
        a.download = "å·¥ä½œé‡è¯„ä¼°.md";
        a.click();
        URL.revokeObjectURL(url);
      }

      function shareLink() {
        var data = {
          method: method,
          velocity: document.getElementById("velocity").value,
          sprintLength: document.getElementById("sprintLength").value,
          teamSize: document.getElementById("teamSize").value,
          tasks: tasks
        };

        try {
          var encoded = btoa(encodeURIComponent(JSON.stringify(data)));
          var url = location.origin + location.pathname + "#" + encoded;
          navigator.clipboard.writeText(url);
          showToast("åˆ†äº«é“¾æ¥å·²å¤åˆ¶");
        } catch (e) {
          showToast("ç”Ÿæˆé“¾æ¥å¤±è´¥");
        }
      }

      function loadFromUrl() {
        var hash = location.hash.slice(1);
        if (!hash) return false;
        try {
          var data = JSON.parse(decodeURIComponent(atob(hash)));
          method = data.method || "storyPoints";
          document.getElementById("velocity").value = data.velocity || 30;
          document.getElementById("sprintLength").value = data.sprintLength || 14;
          document.getElementById("teamSize").value = data.teamSize || 5;
          if (data.tasks) tasks = data.tasks;

          document.querySelectorAll(".method-btn").forEach(function (btn) {
            btn.classList.remove("active");
          });
          document.querySelectorAll(".method-btn").forEach(function (btn) {
            if (
              (method === "storyPoints" && btn.textContent.indexOf("æ•…äº‹ç‚¹") !== -1) ||
              (method === "hours" && btn.textContent.indexOf("å·¥æ—¶") !== -1) ||
              (method === "tshirt" && btn.textContent.indexOf("Tæ¤") !== -1) ||
              (method === "threePoint" && btn.textContent.indexOf("ä¸‰ç‚¹") !== -1)
            ) {
              btn.classList.add("active");
            }
          });

          return true;
        } catch (e) {
          return false;
        }
      }

      function saveToStorage() {
        var data = {
          method: method,
          velocity: document.getElementById("velocity").value,
          sprintLength: document.getElementById("sprintLength").value,
          teamSize: document.getElementById("teamSize").value,
          tasks: tasks
        };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      function loadFromStorage() {
        var saved = localStorage.getItem(LS_KEY);
        if (saved) {
          try {
            var data = JSON.parse(saved);
            method = data.method || "storyPoints";
            document.getElementById("velocity").value = data.velocity || 30;
            document.getElementById("sprintLength").value = data.sprintLength || 14;
            document.getElementById("teamSize").value = data.teamSize || 5;
            if (data.tasks) tasks = data.tasks;

            document.querySelectorAll(".method-btn").forEach(function (btn) {
              btn.classList.remove("active");
            });
            document.querySelectorAll(".method-btn").forEach(function (btn) {
              if (
                (method === "storyPoints" && btn.textContent.indexOf("æ•…äº‹ç‚¹") !== -1) ||
                (method === "hours" && btn.textContent.indexOf("å·¥æ—¶") !== -1) ||
                (method === "tshirt" && btn.textContent.indexOf("Tæ¤") !== -1) ||
                (method === "threePoint" && btn.textContent.indexOf("ä¸‰ç‚¹") !== -1)
              ) {
                btn.classList.add("active");
              }
            });
          } catch (e) {
            console.error("Failed to load from storage");
          }
        }
      }

      function showToast(message) {
        var toast = document.createElement("div");
        toast.style.cssText =
          "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-color);color:#000;padding:12px 24px;border-radius:8px;z-index:1000;font-size:14px;";
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(function () {
          toast.remove();
        }, 2000);
      }

      window.toggleTheme = function () {
        var body = document.body;
        var currentTheme = body.getAttribute("data-theme");
        var newTheme = currentTheme === "light" ? "dark" : "light";
        body.setAttribute("data-theme", newTheme);
        localStorage.setItem("theme", newTheme);
      };

      init();
    </script>
  </body>
</html>

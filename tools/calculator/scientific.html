<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁßëÂ≠¶ËÆ°ÁÆóÂô®</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --btn-spacing: 0.25rem;
        }
        body {
            min-height: 100vh;
            padding: 1rem;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .display-area {
            background: var(--pico-card-background-color);
            border-radius: var(--pico-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid var(--pico-muted-border-color);
        }
        .history {
            font-size: 0.85rem;
            color: var(--pico-muted-color);
            min-height: 1.5rem;
            text-align: right;
            word-break: break-all;
        }
        .display {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: right;
            word-break: break-all;
            min-height: 3rem;
            font-family: monospace;
        }
        .memory-indicator {
            font-size: 0.75rem;
            color: var(--pico-primary);
        }
        .btn-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--btn-spacing);
        }
        .btn-grid button {
            padding: 0.75rem 0.5rem;
            font-size: 1rem;
            margin: 0;
            width: 100%;
        }
        .btn-grid button.secondary {
            --pico-background-color: var(--pico-secondary-background);
        }
        .btn-grid button.contrast {
            --pico-background-color: var(--pico-contrast-background);
        }
        .history-panel {
            margin-top: 1rem;
            max-height: 200px;
            overflow-y: auto;
        }
        .history-panel ul {
            margin: 0;
            padding: 0;
            list-style: none;
        }
        .history-panel li {
            padding: 0.5rem;
            border-bottom: 1px solid var(--pico-muted-border-color);
            font-family: monospace;
            font-size: 0.9rem;
            cursor: pointer;
        }
        .history-panel li:hover {
            background: var(--pico-card-background-color);
        }
        @media (max-width: 500px) {
            .btn-grid {
                grid-template-columns: repeat(4, 1fr);
            }
            .btn-grid button {
                padding: 0.6rem 0.3rem;
                font-size: 0.85rem;
            }
            .display {
                font-size: 1.8rem;
            }
        }
    </style>
</head>
<body>
    <main class="container">
        <a href="../../index.html" style="display:inline-block;margin-bottom:1rem;color:var(--pico-primary);text-decoration:none;">‚Üê ËøîÂõûÈ¶ñÈ°µ</a>
        <header>
            <h2>ÁßëÂ≠¶ËÆ°ÁÆóÂô®</h2>
            <button class="outline" onclick="toggleTheme()" id="themeBtn">üåô Ê∑±Ëâ≤</button>
        </header>

        <div class="display-area">
            <div class="memory-indicator" id="memoryIndicator"></div>
            <div class="history" id="historyDisplay"></div>
            <div class="display" id="display">0</div>
        </div>

        <div class="btn-grid">
            <button class="secondary" onclick="clearMemory()">MC</button>
            <button class="secondary" onclick="recallMemory()">MR</button>
            <button class="secondary" onclick="addToMemory()">M+</button>
            <button class="secondary" onclick="subtractFromMemory()">M-</button>
            <button class="secondary" onclick="storeMemory()">MS</button>
            
            <button class="secondary" onclick="inputFunction('sin')">sin</button>
            <button class="secondary" onclick="inputFunction('cos')">cos</button>
            <button class="secondary" onclick="inputFunction('tan')">tan</button>
            <button class="secondary" onclick="inputFunction('log')">log</button>
            <button class="secondary" onclick="inputFunction('ln')">ln</button>
            
            <button class="secondary" onclick="inputFunction('asin')">sin‚Åª¬π</button>
            <button class="secondary" onclick="inputFunction('acos')">cos‚Åª¬π</button>
            <button class="secondary" onclick="inputFunction('atan')">tan‚Åª¬π</button>
            <button class="secondary" onclick="inputFunction('sqrt')">‚àö</button>
            <button class="secondary" onclick="inputOperator('^')">x ∏</button>
            
            <button class="secondary" onclick="inputConstant('pi')">œÄ</button>
            <button class="secondary" onclick="inputConstant('e')">e</button>
            <button class="secondary" onclick="inputFunction('abs')">|x|</button>
            <button class="secondary" onclick="inputFunction('fact')">n!</button>
            <button class="secondary" onclick="inputOperator('%')">%</button>
            
            <button class="contrast" onclick="clearAll()">C</button>
            <button class="contrast" onclick="clearEntry()">CE</button>
            <button class="contrast" onclick="backspace()">‚å´</button>
            <button onclick="inputOperator('/')">√∑</button>
            <button onclick="toggleSign()">¬±</button>
            
            <button onclick="inputDigit('7')">7</button>
            <button onclick="inputDigit('8')">8</button>
            <button onclick="inputDigit('9')">9</button>
            <button onclick="inputOperator('*')">√ó</button>
            <button class="secondary" onclick="inputFunction('square')">x¬≤</button>
            
            <button onclick="inputDigit('4')">4</button>
            <button onclick="inputDigit('5')">5</button>
            <button onclick="inputDigit('6')">6</button>
            <button onclick="inputOperator('-')">‚àí</button>
            <button class="secondary" onclick="inputFunction('cube')">x¬≥</button>
            
            <button onclick="inputDigit('1')">1</button>
            <button onclick="inputDigit('2')">2</button>
            <button onclick="inputDigit('3')">3</button>
            <button onclick="inputOperator('+')">+</button>
            <button class="secondary" onclick="inputFunction('inverse')">1/x</button>
            
            <button onclick="inputDigit('0')">0</button>
            <button onclick="inputDigit('00')">00</button>
            <button onclick="inputDecimal()">.</button>
            <button class="primary" onclick="calculate()" style="grid-column: span 2;">=</button>
        </div>

        <details>
            <summary>ËÆ°ÁÆóÂéÜÂè≤</summary>
            <div class="history-panel">
                <ul id="historyList"></ul>
            </div>
            <button class="secondary outline" onclick="clearHistory()">Ê∏ÖÁ©∫ÂéÜÂè≤</button>
        </details>
    </main>

    <script>
        let currentValue = '0';
        let previousValue = '';
        let operator = '';
        let waitingForOperand = false;
        let memory = 0;
        let history = [];
        let lastExpression = '';

        const display = document.getElementById('display');
        const historyDisplay = document.getElementById('historyDisplay');
        const memoryIndicator = document.getElementById('memoryIndicator');
        const historyList = document.getElementById('historyList');

        function updateDisplay() {
            display.textContent = currentValue;
            historyDisplay.textContent = lastExpression;
            memoryIndicator.textContent = memory !== 0 ? 'M' : '';
        }

        function inputDigit(digit) {
            if (waitingForOperand) {
                currentValue = digit;
                waitingForOperand = false;
            } else {
                currentValue = currentValue === '0' ? digit : currentValue + digit;
            }
            updateDisplay();
        }

        function inputDecimal() {
            if (waitingForOperand) {
                currentValue = '0.';
                waitingForOperand = false;
            } else if (!currentValue.includes('.')) {
                currentValue += '.';
            }
            updateDisplay();
        }

        function inputOperator(op) {
            const inputValue = parseFloat(currentValue);
            
            if (previousValue !== '' && !waitingForOperand) {
                const result = performCalculation();
                currentValue = String(result);
                previousValue = result;
            } else {
                previousValue = inputValue;
            }
            
            operator = op;
            waitingForOperand = true;
            lastExpression = previousValue + ' ' + getOperatorSymbol(op);
            updateDisplay();
        }

        function getOperatorSymbol(op) {
            const symbols = {'+': '+', '-': '‚àí', '*': '√ó', '/': '√∑', '^': '^', '%': '%'};
            return symbols[op] || op;
        }

        function performCalculation() {
            const prev = parseFloat(previousValue);
            const current = parseFloat(currentValue);
            
            switch (operator) {
                case '+': return prev + current;
                case '-': return prev - current;
                case '*': return prev * current;
                case '/': return current !== 0 ? prev / current : 'Error';
                case '^': return Math.pow(prev, current);
                case '%': return prev % current;
                default: return current;
            }
        }

        function calculate() {
            if (operator === '' || waitingForOperand) return;
            
            const expression = previousValue + ' ' + getOperatorSymbol(operator) + ' ' + currentValue;
            const result = performCalculation();
            
            if (result === 'Error') {
                currentValue = 'Error';
            } else {
                addToHistory(expression, result);
                currentValue = formatNumber(result);
            }
            
            lastExpression = expression + ' =';
            previousValue = '';
            operator = '';
            waitingForOperand = true;
            updateDisplay();
        }

        function formatNumber(num) {
            if (typeof num !== 'number' || isNaN(num)) return 'Error';
            if (!isFinite(num)) return 'Error';
            
            if (Math.abs(num) < 1e-10 && num !== 0) {
                return num.toExponential(6);
            }
            if (Math.abs(num) >= 1e10) {
                return num.toExponential(6);
            }
            
            const rounded = Math.round(num * 1e10) / 1e10;
            return String(rounded);
        }

        function inputFunction(func) {
            const value = parseFloat(currentValue);
            let result;
            
            switch (func) {
                case 'sin':
                    result = Math.sin(value * Math.PI / 180);
                    lastExpression = 'sin(' + value + '¬∞)';
                    break;
                case 'cos':
                    result = Math.cos(value * Math.PI / 180);
                    lastExpression = 'cos(' + value + '¬∞)';
                    break;
                case 'tan':
                    result = Math.tan(value * Math.PI / 180);
                    lastExpression = 'tan(' + value + '¬∞)';
                    break;
                case 'asin':
                    result = Math.asin(value) * 180 / Math.PI;
                    lastExpression = 'asin(' + value + ')';
                    break;
                case 'acos':
                    result = Math.acos(value) * 180 / Math.PI;
                    lastExpression = 'acos(' + value + ')';
                    break;
                case 'atan':
                    result = Math.atan(value) * 180 / Math.PI;
                    lastExpression = 'atan(' + value + ')';
                    break;
                case 'log':
                    result = Math.log10(value);
                    lastExpression = 'log(' + value + ')';
                    break;
                case 'ln':
                    result = Math.log(value);
                    lastExpression = 'ln(' + value + ')';
                    break;
                case 'sqrt':
                    result = Math.sqrt(value);
                    lastExpression = '‚àö(' + value + ')';
                    break;
                case 'square':
                    result = value * value;
                    lastExpression = value + '¬≤';
                    break;
                case 'cube':
                    result = value * value * value;
                    lastExpression = value + '¬≥';
                    break;
                case 'inverse':
                    result = 1 / value;
                    lastExpression = '1/' + value;
                    break;
                case 'abs':
                    result = Math.abs(value);
                    lastExpression = '|' + value + '|';
                    break;
                case 'fact':
                    result = factorial(Math.floor(value));
                    lastExpression = Math.floor(value) + '!';
                    break;
                default:
                    return;
            }
            
            addToHistory(lastExpression, result);
            currentValue = formatNumber(result);
            waitingForOperand = true;
            updateDisplay();
        }

        function factorial(n) {
            if (n < 0) return NaN;
            if (n === 0 || n === 1) return 1;
            if (n > 170) return Infinity;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }

        function inputConstant(constant) {
            switch (constant) {
                case 'pi':
                    currentValue = String(Math.PI);
                    lastExpression = 'œÄ';
                    break;
                case 'e':
                    currentValue = String(Math.E);
                    lastExpression = 'e';
                    break;
            }
            waitingForOperand = true;
            updateDisplay();
        }

        function toggleSign() {
            currentValue = String(-parseFloat(currentValue));
            updateDisplay();
        }

        function clearAll() {
            currentValue = '0';
            previousValue = '';
            operator = '';
            waitingForOperand = false;
            lastExpression = '';
            updateDisplay();
        }

        function clearEntry() {
            currentValue = '0';
            updateDisplay();
        }

        function backspace() {
            if (waitingForOperand) return;
            currentValue = currentValue.length > 1 ? currentValue.slice(0, -1) : '0';
            updateDisplay();
        }

        function clearMemory() {
            memory = 0;
            updateDisplay();
        }

        function recallMemory() {
            currentValue = String(memory);
            waitingForOperand = true;
            updateDisplay();
        }

        function addToMemory() {
            memory += parseFloat(currentValue);
            waitingForOperand = true;
            updateDisplay();
        }

        function subtractFromMemory() {
            memory -= parseFloat(currentValue);
            waitingForOperand = true;
            updateDisplay();
        }

        function storeMemory() {
            memory = parseFloat(currentValue);
            waitingForOperand = true;
            updateDisplay();
        }

        function addToHistory(expression, result) {
            history.unshift({ expression: expression, result: formatNumber(result) });
            if (history.length > 50) history.pop();
            renderHistory();
        }

        function renderHistory() {
            historyList.textContent = '';
            history.forEach(function(item, index) {
                const li = document.createElement('li');
                li.textContent = item.expression + ' = ' + item.result;
                li.onclick = function() { loadFromHistory(index); };
                historyList.appendChild(li);
            });
        }

        function loadFromHistory(index) {
            currentValue = history[index].result;
            waitingForOperand = true;
            updateDisplay();
        }

        function clearHistory() {
            history = [];
            renderHistory();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const btn = document.getElementById('themeBtn');
            if (html.getAttribute('data-theme') === 'light') {
                html.setAttribute('data-theme', 'dark');
                btn.textContent = '‚òÄÔ∏è ÊµÖËâ≤';
            } else {
                html.setAttribute('data-theme', 'light');
                btn.textContent = 'üåô Ê∑±Ëâ≤';
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key >= '0' && e.key <= '9') inputDigit(e.key);
            else if (e.key === '.') inputDecimal();
            else if (e.key === '+') inputOperator('+');
            else if (e.key === '-') inputOperator('-');
            else if (e.key === '*') inputOperator('*');
            else if (e.key === '/') { e.preventDefault(); inputOperator('/'); }
            else if (e.key === '^') inputOperator('^');
            else if (e.key === '%') inputOperator('%');
            else if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); calculate(); }
            else if (e.key === 'Escape') clearAll();
            else if (e.key === 'Backspace') backspace();
        });

        updateDisplay();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>文本对比工具 | WebUtils</title>
  <meta name="description" content="在线文本对比工具，快速比较两段文本的差异，支持逐行对比">
  <meta name="keywords" content="diff,对比,比较,文本差异,代码对比">
  <link rel="icon" href="../../favicon.svg" type="image/svg+xml">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      min-height: 100vh;
      padding: 20px;
      color: #d4d4d4;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .back-link {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      color: #569cd6;
      text-decoration: none;
      margin-bottom: 20px;
      opacity: 0.9;
    }
    .back-link:hover { opacity: 1; }
    h1 {
      color: #d4d4d4;
      text-align: center;
      margin-bottom: 30px;
      font-size: 2rem;
    }
    .input-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .input-section { grid-template-columns: 1fr; }
    }
    .input-panel {
      background: #252526;
      border-radius: 8px;
      overflow: hidden;
    }
    .panel-header {
      background: #333;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .panel-title {
      font-weight: 600;
      color: #ccc;
    }
    .clear-btn {
      background: transparent;
      border: none;
      color: #888;
      cursor: pointer;
      font-size: 12px;
    }
    .clear-btn:hover { color: #d4d4d4; }
    textarea {
      width: 100%;
      height: 250px;
      background: #1e1e1e;
      border: none;
      padding: 15px;
      color: #d4d4d4;
      font-family: Consolas, Monaco, monospace;
      font-size: 14px;
      resize: vertical;
    }
    textarea:focus { outline: none; }
    textarea::placeholder { color: #6a6a6a; }
    .btn-group {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-bottom: 25px;
    }
    .btn {
      padding: 12px 30px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    .btn-primary {
      background: #0e639c;
      color: white;
    }
    .btn-primary:hover { background: #17b; }
    .btn-secondary {
      background: #3c3c3c;
      color: #d4d4d4;
    }
    .btn-secondary:hover { background: #4c4c4c; }
    .stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .stat-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .stat-dot.added { background: #2ea043; }
    .stat-dot.removed { background: #f85149; }
    .stat-dot.modified { background: #d29922; }
    .result-section {
      background: #252526;
      border-radius: 8px;
      overflow: hidden;
    }
    .result-header {
      background: #333;
      padding: 10px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .view-toggle {
      display: flex;
      gap: 5px;
    }
    .view-btn {
      padding: 5px 12px;
      border: 1px solid #555;
      background: transparent;
      color: #888;
      cursor: pointer;
      font-size: 12px;
      border-radius: 3px;
    }
    .view-btn.active {
      background: #0e639c;
      border-color: #0e639c;
      color: white;
    }
    .diff-container {
      overflow-x: auto;
    }
    .diff-table {
      width: 100%;
      border-collapse: collapse;
      font-family: Consolas, Monaco, monospace;
      font-size: 13px;
    }
    .diff-table td {
      padding: 2px 10px;
      white-space: pre;
      vertical-align: top;
    }
    .line-number {
      width: 50px;
      text-align: right;
      color: #6e7681;
      background: #161b22;
      user-select: none;
      border-right: 1px solid #30363d;
    }
    .line-content {
      min-width: 200px;
    }
    .diff-added {
      background: rgba(46, 160, 67, 0.15);
    }
    .diff-added .line-number { background: rgba(46, 160, 67, 0.3); }
    .diff-removed {
      background: rgba(248, 81, 73, 0.15);
    }
    .diff-removed .line-number { background: rgba(248, 81, 73, 0.3); }
    .diff-modified {
      background: rgba(210, 153, 34, 0.15);
    }
    .diff-modified .line-number { background: rgba(210, 153, 34, 0.3); }
    .char-added {
      background: rgba(46, 160, 67, 0.4);
      border-radius: 2px;
    }
    .char-removed {
      background: rgba(248, 81, 73, 0.4);
      border-radius: 2px;
    }
    .inline-view .diff-row {
      display: grid;
      grid-template-columns: 50px 1fr 50px 1fr;
    }
    .unified-view .diff-row {
      display: grid;
      grid-template-columns: 50px 50px 1fr;
    }
    .empty-cell {
      background: #161b22;
    }
    .no-diff {
      padding: 40px;
      text-align: center;
      color: #6a6a6a;
    }
  </style>
</head>
<body>
  <div class="container">
    <a href="../../index.html" class="back-link">← 返回工具列表</a>
    <h1>文本对比工具</h1>
    
    <div class="input-section">
      <div class="input-panel">
        <div class="panel-header">
          <span class="panel-title">原始文本</span>
          <button class="clear-btn" onclick="clearText('text1')">清空</button>
        </div>
        <textarea id="text1" placeholder="输入或粘贴原始文本..."></textarea>
      </div>
      <div class="input-panel">
        <div class="panel-header">
          <span class="panel-title">修改后文本</span>
          <button class="clear-btn" onclick="clearText('text2')">清空</button>
        </div>
        <textarea id="text2" placeholder="输入或粘贴修改后的文本..."></textarea>
      </div>
    </div>
    
    <div class="btn-group">
      <button class="btn btn-primary" onclick="compareDiff()">对比差异</button>
      <button class="btn btn-secondary" onclick="swapTexts()">交换文本</button>
      <button class="btn btn-secondary" onclick="loadSample()">加载示例</button>
    </div>
    
    <div class="stats" id="stats" style="display: none;">
      <div class="stat-item">
        <span class="stat-dot added"></span>
        <span>新增: <strong id="addedCount">0</strong> 行</span>
      </div>
      <div class="stat-item">
        <span class="stat-dot removed"></span>
        <span>删除: <strong id="removedCount">0</strong> 行</span>
      </div>
      <div class="stat-item">
        <span class="stat-dot modified"></span>
        <span>修改: <strong id="modifiedCount">0</strong> 行</span>
      </div>
    </div>
    
    <div class="result-section">
      <div class="result-header">
        <span class="panel-title">对比结果</span>
        <div class="view-toggle">
          <button class="view-btn active" onclick="setView('inline')">并排视图</button>
          <button class="view-btn" onclick="setView('unified')">统一视图</button>
        </div>
      </div>
      <div class="diff-container" id="diffContainer">
        <div class="no-diff">输入两段文本并点击"对比差异"按钮</div>
      </div>
    </div>
  </div>

  <script>
    let currentView = 'inline';
    let diffResult = null;

    function clearText(id) {
      document.getElementById(id).value = '';
    }

    function swapTexts() {
      const text1 = document.getElementById('text1');
      const text2 = document.getElementById('text2');
      const temp = text1.value;
      text1.value = text2.value;
      text2.value = temp;
    }

    function loadSample() {
      document.getElementById('text1').value = `function greet(name) {
  console.log("Hello, " + name);
  return true;
}

const user = "World";
greet(user);`;

      document.getElementById('text2').value = `function greet(name, greeting = "Hello") {
  console.log(greeting + ", " + name + "!");
  return true;
}

const user = "World";
const message = "Hi";
greet(user, message);`;
    }

    function computeLCS(lines1, lines2) {
      const m = lines1.length;
      const n = lines2.length;
      const dp = Array(m + 1).fill(null).map(() => Array(n + 1).fill(0));
      
      for (let i = 1; i <= m; i++) {
        for (let j = 1; j <= n; j++) {
          if (lines1[i - 1] === lines2[j - 1]) {
            dp[i][j] = dp[i - 1][j - 1] + 1;
          } else {
            dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
          }
        }
      }
      
      return dp;
    }

    function getDiff(lines1, lines2) {
      const dp = computeLCS(lines1, lines2);
      const result = [];
      let i = lines1.length;
      let j = lines2.length;
      
      while (i > 0 || j > 0) {
        if (i > 0 && j > 0 && lines1[i - 1] === lines2[j - 1]) {
          result.unshift({ type: 'same', line1: i, line2: j, content: lines1[i - 1] });
          i--;
          j--;
        } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
          result.unshift({ type: 'added', line1: null, line2: j, content: lines2[j - 1] });
          j--;
        } else if (i > 0) {
          result.unshift({ type: 'removed', line1: i, line2: null, content: lines1[i - 1] });
          i--;
        }
      }
      
      return result;
    }

    function highlightCharDiff(str1, str2) {
      const result1 = [];
      const result2 = [];
      
      let i = 0, j = 0;
      while (i < str1.length || j < str2.length) {
        if (i < str1.length && j < str2.length && str1[i] === str2[j]) {
          result1.push(escapeHtml(str1[i]));
          result2.push(escapeHtml(str2[j]));
          i++;
          j++;
        } else if (j < str2.length && (i >= str1.length || str1.indexOf(str2[j], i) === -1)) {
          result2.push(`<span class="char-added">${escapeHtml(str2[j])}</span>`);
          j++;
        } else if (i < str1.length) {
          result1.push(`<span class="char-removed">${escapeHtml(str1[i])}</span>`);
          i++;
        }
      }
      
      return { html1: result1.join(''), html2: result2.join('') };
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function compareDiff() {
      const text1 = document.getElementById('text1').value;
      const text2 = document.getElementById('text2').value;
      
      const lines1 = text1.split('\n');
      const lines2 = text2.split('\n');
      
      diffResult = getDiff(lines1, lines2);
      
      // 统计
      let added = 0, removed = 0, modified = 0;
      for (let i = 0; i < diffResult.length; i++) {
        const item = diffResult[i];
        if (item.type === 'added') {
          // 检查是否是修改（前一行是删除）
          if (i > 0 && diffResult[i - 1].type === 'removed') {
            modified++;
            diffResult[i - 1].type = 'modified-old';
            item.type = 'modified-new';
          } else {
            added++;
          }
        } else if (item.type === 'removed') {
          // 检查下一行是否是新增（配对为修改）
          if (i < diffResult.length - 1 && diffResult[i + 1].type === 'added') {
            // 会在下一次循环处理
          } else {
            removed++;
          }
        }
      }
      
      document.getElementById('addedCount').textContent = added;
      document.getElementById('removedCount').textContent = removed;
      document.getElementById('modifiedCount').textContent = modified;
      document.getElementById('stats').style.display = 'flex';
      
      renderDiff();
    }

    function renderDiff() {
      if (!diffResult) return;
      
      const container = document.getElementById('diffContainer');
      
      if (diffResult.every(d => d.type === 'same')) {
        container.innerHTML = '<div class="no-diff">两段文本完全相同</div>';
        return;
      }
      
      if (currentView === 'inline') {
        renderInlineView(container);
      } else {
        renderUnifiedView(container);
      }
    }

    function renderInlineView(container) {
      let html = '<table class="diff-table inline-view">';
      
      for (const item of diffResult) {
        const lineNum1 = item.line1 || '';
        const lineNum2 = item.line2 || '';
        const content = escapeHtml(item.content || '');
        
        let rowClass = '';
        let leftContent = content;
        let rightContent = content;
        
        switch (item.type) {
          case 'same':
            html += `<tr>
              <td class="line-number">${lineNum1}</td>
              <td class="line-content">${content}</td>
              <td class="line-number">${lineNum2}</td>
              <td class="line-content">${content}</td>
            </tr>`;
            break;
          case 'added':
            html += `<tr class="diff-added">
              <td class="line-number empty-cell"></td>
              <td class="line-content empty-cell"></td>
              <td class="line-number">${lineNum2}</td>
              <td class="line-content">+ ${content}</td>
            </tr>`;
            break;
          case 'removed':
            html += `<tr class="diff-removed">
              <td class="line-number">${lineNum1}</td>
              <td class="line-content">- ${content}</td>
              <td class="line-number empty-cell"></td>
              <td class="line-content empty-cell"></td>
            </tr>`;
            break;
          case 'modified-old':
            // 找到配对的 modified-new
            const newItem = diffResult.find(d => d.type === 'modified-new' && d.line2 > (item.line1 || 0));
            if (newItem) {
              const charDiff = highlightCharDiff(item.content, newItem.content);
              html += `<tr class="diff-modified">
                <td class="line-number">${item.line1}</td>
                <td class="line-content">- ${charDiff.html1}</td>
                <td class="line-number">${newItem.line2}</td>
                <td class="line-content">+ ${charDiff.html2}</td>
              </tr>`;
            }
            break;
        }
      }
      
      html += '</table>';
      container.innerHTML = html;
    }

    function renderUnifiedView(container) {
      let html = '<table class="diff-table unified-view">';
      
      for (const item of diffResult) {
        const lineNum1 = item.line1 || '';
        const lineNum2 = item.line2 || '';
        const content = escapeHtml(item.content || '');
        
        switch (item.type) {
          case 'same':
            html += `<tr>
              <td class="line-number">${lineNum1}</td>
              <td class="line-number">${lineNum2}</td>
              <td class="line-content">  ${content}</td>
            </tr>`;
            break;
          case 'added':
            html += `<tr class="diff-added">
              <td class="line-number empty-cell"></td>
              <td class="line-number">${lineNum2}</td>
              <td class="line-content">+ ${content}</td>
            </tr>`;
            break;
          case 'removed':
            html += `<tr class="diff-removed">
              <td class="line-number">${lineNum1}</td>
              <td class="line-number empty-cell"></td>
              <td class="line-content">- ${content}</td>
            </tr>`;
            break;
          case 'modified-old':
            html += `<tr class="diff-removed">
              <td class="line-number">${lineNum1}</td>
              <td class="line-number empty-cell"></td>
              <td class="line-content">- ${content}</td>
            </tr>`;
            break;
          case 'modified-new':
            html += `<tr class="diff-added">
              <td class="line-number empty-cell"></td>
              <td class="line-number">${lineNum2}</td>
              <td class="line-content">+ ${content}</td>
            </tr>`;
            break;
        }
      }
      
      html += '</table>';
      container.innerHTML = html;
    }

    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(view === 'inline' ? '并排' : '统一'));
      });
      renderDiff();
    }
  </script>
</body>
</html>

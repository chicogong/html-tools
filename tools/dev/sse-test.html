<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSE测试客户端</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <style>
        :root {
            --event-default: #e2e3e5;
            --event-message: #d4edda;
            --event-custom: #cce5ff;
            --event-error: #f8d7da;
            --event-system: #fff3cd;
        }
        [data-theme="dark"] {
            --event-default: #3a3b3c;
            --event-message: #1e4620;
            --event-custom: #004085;
            --event-error: #58151c;
            --event-system: #664d03;
        }
        .container {
            max-width: 1000px;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .status-bar {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .status-closed .status-dot { background: #dc3545; }
        .status-connecting .status-dot { background: #ffc107; animation: pulse 2s infinite; }
        .status-open .status-dot { background: #28a745; animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .connection-form {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            align-items: end;
        }
        .connection-form input {
            margin-bottom: 0;
        }
        .event-log {
            height: 450px;
            overflow-y: auto;
            border: 1px solid var(--pico-muted-border-color);
            border-radius: var(--pico-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--pico-background-color);
            font-family: monospace;
            font-size: 0.9rem;
        }
        .event-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        .event-default { background: var(--event-default); border-left-color: #6c757d; }
        .event-message { background: var(--event-message); border-left-color: #28a745; }
        .event-custom { background: var(--event-custom); border-left-color: #007bff; }
        .event-error { background: var(--event-error); border-left-color: #dc3545; }
        .event-system { background: var(--event-system); border-left-color: #ffc107; }
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .event-type {
            font-weight: bold;
            text-transform: uppercase;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(0,0,0,0.1);
        }
        .event-data {
            word-break: break-all;
            white-space: pre-wrap;
        }
        .event-id {
            font-size: 0.75rem;
            opacity: 0.6;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .stat-card {
            text-align: center;
            padding: 1rem;
            background: var(--pico-card-background-color);
            border-radius: var(--pico-border-radius);
            border: 1px solid var(--pico-muted-border-color);
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--pico-primary);
        }
        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        .filter-section {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }
        .filter-section label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .btn-group {
            display: flex;
            gap: 8px;
        }
        .custom-events {
            margin-top: 1rem;
        }
        .custom-events input {
            margin-bottom: 0;
        }
        .event-listeners {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 0.5rem;
        }
        .event-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--pico-primary);
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .event-tag button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            margin: 0;
            font-size: 1rem;
            line-height: 1;
        }
        .reconnect-info {
            font-size: 0.85rem;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <main class="container">
        <a href="../../index.html" style="display:inline-block;margin-bottom:1rem;color:var(--pico-primary);text-decoration:none;">← 返回首页</a>
        <div class="header">
            <h1>SSE测试客户端</h1>
            <button id="themeToggle" class="outline">切换主题</button>
        </div>

        <div class="status-bar">
            <div class="status-indicator status-closed" id="statusIndicator">
                <span class="status-dot"></span>
                <span id="statusText">未连接</span>
            </div>
            <span class="reconnect-info" id="reconnectInfo"></span>
        </div>

        <article>
            <header>连接设置</header>
            <div class="connection-form">
                <div>
                    <label>SSE端点URL</label>
                    <input type="text" id="sseUrl" placeholder="https://example.com/events 或 /api/sse">
                </div>
                <div class="btn-group">
                    <button id="connectBtn">连接</button>
                    <button id="disconnectBtn" class="secondary" disabled>断开</button>
                </div>
            </div>
            <details>
                <summary>高级选项</summary>
                <div style="margin-top: 1rem;">
                    <label>
                        <input type="checkbox" id="withCredentials">
                        发送凭证 (withCredentials)
                    </label>
                </div>
                <div class="custom-events">
                    <label>自定义事件监听</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="customEventInput" placeholder="输入事件名称，如: update, notification">
                        <button id="addEventBtn" class="outline">添加</button>
                    </div>
                    <div class="event-listeners" id="eventListeners"></div>
                </div>
            </details>
        </article>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalEvents">0</div>
                <div class="stat-label">总事件数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="messageEvents">0</div>
                <div class="stat-label">message事件</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="customEventsCount">0</div>
                <div class="stat-label">自定义事件</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="errorCount">0</div>
                <div class="stat-label">错误次数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="reconnectCount">0</div>
                <div class="stat-label">重连次数</div>
            </div>
        </div>

        <article>
            <header>
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                    <span>事件日志</span>
                    <div class="filter-section">
                        <label><input type="checkbox" id="filterMessage" checked> message</label>
                        <label><input type="checkbox" id="filterCustom" checked> 自定义</label>
                        <label><input type="checkbox" id="filterSystem" checked> 系统</label>
                        <label><input type="checkbox" id="filterError" checked> 错误</label>
                    </div>
                    <button class="outline secondary" id="clearLog" style="padding: 4px 12px; font-size: 0.85rem;">清空</button>
                </div>
            </header>
            <div class="event-log" id="eventLog">
                <div class="event-item event-system" data-type="system">
                    <div class="event-header">
                        <span class="event-type">系统</span>
                        <span>--:--:--</span>
                    </div>
                    <div class="event-data">等待连接SSE服务器...</div>
                </div>
            </div>
        </article>

        <article>
            <header>使用说明</header>
            <ul>
                <li><strong>SSE (Server-Sent Events)：</strong>服务器向客户端推送实时数据的技术</li>
                <li><strong>自动重连：</strong>连接断开后浏览器会自动尝试重新连接</li>
                <li><strong>事件类型：</strong>
                    <ul>
                        <li><code>message</code> - 默认事件类型</li>
                        <li>自定义事件 - 服务器可发送带有 <code>event:</code> 字段的自定义类型</li>
                    </ul>
                </li>
                <li><strong>事件ID：</strong>服务器可发送 <code>id:</code> 字段用于断点续传</li>
                <li><strong>自定义监听：</strong>添加需要监听的自定义事件名称</li>
            </ul>
        </article>
    </main>

    <script>
        // 主题切换
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        
        const savedTheme = localStorage.getItem('theme') || 'light';
        html.setAttribute('data-theme', savedTheme);
        
        themeToggle.addEventListener('click', () => {
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        });

        // SSE相关
        let eventSource = null;
        let customEventTypes = new Set();
        let lastEventId = null;
        let stats = {
            total: 0,
            message: 0,
            custom: 0,
            error: 0,
            reconnect: 0
        };

        const sseUrl = document.getElementById('sseUrl');
        const withCredentials = document.getElementById('withCredentials');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const reconnectInfo = document.getElementById('reconnectInfo');
        const eventLog = document.getElementById('eventLog');
        const clearLog = document.getElementById('clearLog');
        const customEventInput = document.getElementById('customEventInput');
        const addEventBtn = document.getElementById('addEventBtn');
        const eventListeners = document.getElementById('eventListeners');

        // 筛选器
        const filters = {
            message: document.getElementById('filterMessage'),
            custom: document.getElementById('filterCustom'),
            system: document.getElementById('filterSystem'),
            error: document.getElementById('filterError')
        };

        // 获取当前时间
        function getTime() {
            return new Date().toLocaleTimeString('zh-CN', { hour12: false });
        }

        // 更新统计
        function updateStats() {
            document.getElementById('totalEvents').textContent = stats.total;
            document.getElementById('messageEvents').textContent = stats.message;
            document.getElementById('customEventsCount').textContent = stats.custom;
            document.getElementById('errorCount').textContent = stats.error;
            document.getElementById('reconnectCount').textContent = stats.reconnect;
        }

        // 更新状态
        function updateStatus(status) {
            statusIndicator.className = 'status-indicator status-' + status;
            const statusMap = {
                'closed': '未连接',
                'connecting': '连接中...',
                'open': '已连接'
            };
            statusText.textContent = statusMap[status] || status;
        }

        // 添加日志
        function addLog(type, eventType, data, eventId) {
            const item = document.createElement('div');
            item.className = 'event-item event-' + type;
            item.dataset.type = type;

            const typeLabel = {
                'message': 'MESSAGE',
                'custom': eventType.toUpperCase(),
                'system': '系统',
                'error': '错误',
                'default': eventType.toUpperCase()
            };

            const header = document.createElement('div');
            header.className = 'event-header';
            
            const typeSpan = document.createElement('span');
            typeSpan.className = 'event-type';
            typeSpan.textContent = typeLabel[type] || typeLabel.default;
            
            const timeSpan = document.createElement('span');
            timeSpan.textContent = getTime() + (eventId ? ' | ID: ' + eventId : '');
            
            header.appendChild(typeSpan);
            header.appendChild(timeSpan);
            
            const dataDiv = document.createElement('div');
            dataDiv.className = 'event-data';
            dataDiv.textContent = data;
            
            item.appendChild(header);
            item.appendChild(dataDiv);

            eventLog.appendChild(item);
            eventLog.scrollTop = eventLog.scrollHeight;
            applyFilters();
        }

        // 应用筛选
        function applyFilters() {
            const items = eventLog.querySelectorAll('.event-item');
            items.forEach(item => {
                const type = item.dataset.type;
                if (type === 'message') {
                    item.style.display = filters.message.checked ? '' : 'none';
                } else if (type === 'custom') {
                    item.style.display = filters.custom.checked ? '' : 'none';
                } else if (type === 'system') {
                    item.style.display = filters.system.checked ? '' : 'none';
                } else if (type === 'error') {
                    item.style.display = filters.error.checked ? '' : 'none';
                }
            });
        }

        // 设置控件状态
        function setControlsEnabled(connected) {
            connectBtn.disabled = connected;
            disconnectBtn.disabled = !connected;
            sseUrl.disabled = connected;
            withCredentials.disabled = connected;
        }

        // 添加自定义事件监听标签
        function addEventTag(eventType) {
            const tag = document.createElement('span');
            tag.className = 'event-tag';
            tag.dataset.event = eventType;
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = eventType;
            
            const removeBtn = document.createElement('button');
            removeBtn.textContent = '\u00D7';
            removeBtn.addEventListener('click', () => {
                removeCustomEvent(eventType);
            });
            
            tag.appendChild(nameSpan);
            tag.appendChild(removeBtn);
            eventListeners.appendChild(tag);
        }

        // 添加自定义事件监听
        function addCustomEventListener(eventType) {
            if (!eventType || customEventTypes.has(eventType)) return;
            
            customEventTypes.add(eventType);
            addEventTag(eventType);

            if (eventSource && eventSource.readyState === EventSource.OPEN) {
                attachCustomListener(eventType);
            }
        }

        // 移除自定义事件监听
        function removeCustomEvent(eventType) {
            customEventTypes.delete(eventType);
            const tag = eventListeners.querySelector('[data-event="' + eventType + '"]');
            if (tag) tag.remove();
        }

        // 附加自定义监听器
        function attachCustomListener(eventType) {
            if (!eventSource) return;
            eventSource.addEventListener(eventType, (e) => {
                stats.total++;
                stats.custom++;
                updateStats();
                
                let data = e.data;
                try {
                    const json = JSON.parse(e.data);
                    data = JSON.stringify(json, null, 2);
                } catch (err) {}
                
                addLog('custom', eventType, data, e.lastEventId);
                if (e.lastEventId) lastEventId = e.lastEventId;
            });
        }

        // 连接SSE
        function connect() {
            const url = sseUrl.value.trim();
            if (!url) {
                addLog('error', 'error', '请输入SSE端点URL', null);
                return;
            }

            updateStatus('connecting');
            addLog('system', 'system', '正在连接到 ' + url + '...', null);

            try {
                eventSource = new EventSource(url, {
                    withCredentials: withCredentials.checked
                });

                eventSource.onopen = () => {
                    updateStatus('open');
                    setControlsEnabled(true);
                    addLog('system', 'system', '连接成功！', null);
                    
                    // 附加所有自定义监听器
                    customEventTypes.forEach(type => attachCustomListener(type));
                };

                eventSource.onmessage = (e) => {
                    stats.total++;
                    stats.message++;
                    updateStats();
                    
                    let data = e.data;
                    try {
                        const json = JSON.parse(e.data);
                        data = JSON.stringify(json, null, 2);
                    } catch (err) {}
                    
                    addLog('message', 'message', data, e.lastEventId);
                    if (e.lastEventId) lastEventId = e.lastEventId;
                };

                eventSource.onerror = (e) => {
                    stats.error++;
                    updateStats();

                    if (eventSource.readyState === EventSource.CONNECTING) {
                        stats.reconnect++;
                        updateStats();
                        updateStatus('connecting');
                        addLog('system', 'system', '连接断开，正在尝试重连...', null);
                        reconnectInfo.textContent = '重连次数: ' + stats.reconnect;
                    } else if (eventSource.readyState === EventSource.CLOSED) {
                        updateStatus('closed');
                        setControlsEnabled(false);
                        addLog('error', 'error', '连接已关闭', null);
                    }
                };

            } catch (error) {
                updateStatus('closed');
                addLog('error', 'error', '连接失败: ' + error.message, null);
            }
        }

        // 断开连接
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                updateStatus('closed');
                setControlsEnabled(false);
                addLog('system', 'system', '已手动断开连接', null);
                reconnectInfo.textContent = '';
            }
        }

        // 事件绑定
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        clearLog.addEventListener('click', () => {
            eventLog.textContent = '';
            addLog('system', 'system', '日志已清空', null);
        });

        addEventBtn.addEventListener('click', () => {
            const eventType = customEventInput.value.trim();
            if (eventType) {
                addCustomEventListener(eventType);
                customEventInput.value = '';
            }
        });

        customEventInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                addEventBtn.click();
            }
        });

        sseUrl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                connect();
            }
        });

        // 筛选器事件
        Object.values(filters).forEach(checkbox => {
            checkbox.addEventListener('change', applyFilters);
        });
    </script>
</body>
</html>

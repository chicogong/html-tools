<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>å†³ç­–çŸ©é˜µ - WebUtils</title>
    <style>
      :root {
        --bg-color: #1a1a2e;
        --card-bg: #16213e;
        --text-color: #e0e0e0;
        --primary-color: #0f3460;
        --accent-color: #00d9ff;
        --border-color: #0f3460;
        --input-bg: #1a1a2e;
        --success-color: #4ade80;
        --warning-color: #fbbf24;
        --danger-color: #f87171;
      }

      [data-theme='light'] {
        --bg-color: #f0f4f8;
        --card-bg: #fff;
        --text-color: #1a1a2e;
        --primary-color: #e0e7ff;
        --accent-color: #0891b2;
        --border-color: #c7d2fe;
        --input-bg: #f8fafc;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      .header {
        text-align: center;
        margin-bottom: 30px;
        position: relative;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        background: linear-gradient(135deg, var(--accent-color), #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .theme-toggle {
        position: absolute;
        right: 0;
        top: 0;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        color: var(--text-color);
        padding: 8px 16px;
        border-radius: 8px;
        cursor: pointer;
      }

      .back-link {
        position: absolute;
        left: 0;
        top: 0;
        color: var(--accent-color);
        text-decoration: none;
        font-size: 14px;
      }

      .back-link:hover {
        text-decoration: underline;
      }

      .panel {
        background: var(--card-bg);
        border-radius: 16px;
        padding: 25px;
        border: 1px solid var(--border-color);
        margin-bottom: 20px;
      }

      .panel-title {
        font-size: 1rem;
        margin-bottom: 15px;
        color: var(--accent-color);
      }

      .decision-title {
        width: 100%;
        padding: 12px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 16px;
        margin-bottom: 20px;
      }

      .decision-title:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .criteria-list,
      .option-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .criteria-item,
      .option-item {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .criteria-item input,
      .option-item input {
        flex: 1;
        padding: 10px;
        background: var(--input-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        font-size: 14px;
      }

      .criteria-item input:focus,
      .option-item input:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .weight-input {
        width: 80px !important;
        text-align: center;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: var(--accent-color);
        color: #000;
      }

      .btn-secondary {
        background: var(--primary-color);
        color: var(--text-color);
      }

      .btn-danger {
        background: transparent;
        color: var(--danger-color);
        padding: 8px 12px;
      }

      .btn-group {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        flex-wrap: wrap;
      }

      .matrix-wrapper {
        overflow-x: auto;
      }

      .matrix-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
      }

      .matrix-table th,
      .matrix-table td {
        padding: 12px;
        border: 1px solid var(--border-color);
        text-align: center;
      }

      .matrix-table th {
        background: var(--primary-color);
        font-weight: 600;
      }

      .matrix-table th.criteria-header {
        font-size: 12px;
      }

      .matrix-table th.criteria-header span {
        display: block;
        font-size: 10px;
        opacity: 0.7;
        font-weight: normal;
      }

      .matrix-table td.option-name {
        text-align: left;
        font-weight: 500;
      }

      .matrix-table td.score-cell {
        background: var(--input-bg);
      }

      .matrix-table td.total-cell {
        font-weight: bold;
        background: var(--primary-color);
      }

      .matrix-table tr.winner td {
        background: rgba(74, 222, 128, 0.2);
      }

      .matrix-table tr.winner td.total-cell {
        color: var(--success-color);
      }

      .score-input {
        width: 50px;
        padding: 6px;
        background: var(--card-bg);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        color: var(--text-color);
        text-align: center;
        font-size: 14px;
      }

      .score-input:focus {
        outline: none;
        border-color: var(--accent-color);
      }

      .result-section {
        margin-top: 20px;
        padding: 20px;
        background: var(--input-bg);
        border-radius: 12px;
      }

      .winner-display {
        text-align: center;
        padding: 20px;
      }

      .winner-label {
        font-size: 14px;
        opacity: 0.7;
      }

      .winner-name {
        font-size: 2rem;
        font-weight: bold;
        color: var(--success-color);
        margin: 10px 0;
      }

      .winner-score {
        font-size: 14px;
        opacity: 0.8;
      }

      .ranking-list {
        margin-top: 20px;
      }

      .ranking-item {
        display: flex;
        justify-content: space-between;
        padding: 10px;
        border-radius: 8px;
        margin-bottom: 8px;
        background: var(--card-bg);
      }

      .ranking-item.rank-1 {
        background: rgba(74, 222, 128, 0.2);
      }

      .rank-number {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: var(--primary-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 14px;
      }

      .rank-1 .rank-number {
        background: var(--success-color);
        color: #000;
      }

      .setup-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }

      @media (max-width: 768px) {
        .setup-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <a href="../../index.html" class="back-link">â† è¿”å›å·¥å…·åˆ—è¡¨</a>
        <h1>å†³ç­–çŸ©é˜µ</h1>
        <p>åŠ æƒè¯„åˆ†å†³ç­–åˆ†æå·¥å…·</p>
        <button class="theme-toggle" onclick="toggleTheme()">ğŸŒ“ åˆ‡æ¢ä¸»é¢˜</button>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ¯ å†³ç­–é—®é¢˜</div>
        <input
          type="text"
          class="decision-title"
          id="decisionTitle"
          placeholder="æè¿°ä½ è¦åšçš„å†³ç­–ï¼Œä¾‹å¦‚ï¼šé€‰æ‹©å“ªä¸ªæŠ€æœ¯æ–¹æ¡ˆï¼Ÿ"
        />
      </div>

      <div class="setup-grid">
        <div class="panel">
          <div class="panel-title">âš–ï¸ è¯„ä¼°æ ‡å‡† (æƒé‡ 1-10)</div>
          <div class="criteria-list" id="criteriaList"></div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="addCriteria()">+ æ·»åŠ æ ‡å‡†</button>
          </div>
        </div>

        <div class="panel">
          <div class="panel-title">ğŸ“‹ å¯é€‰æ–¹æ¡ˆ</div>
          <div class="option-list" id="optionList"></div>
          <div class="btn-group">
            <button class="btn btn-secondary" onclick="addOption()">+ æ·»åŠ æ–¹æ¡ˆ</button>
          </div>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ“Š è¯„åˆ†çŸ©é˜µ (1-10 åˆ†)</div>
        <div class="matrix-wrapper">
          <table class="matrix-table" id="matrixTable"></table>
        </div>
      </div>

      <div class="panel">
        <div class="panel-title">ğŸ† ç»“æœåˆ†æ</div>
        <div class="result-section">
          <div class="winner-display" id="winnerDisplay">
            <div class="winner-label">æ¨èé€‰æ‹©</div>
            <div class="winner-name" id="winnerName">-</div>
            <div class="winner-score" id="winnerScore">è¯·å®Œæˆè¯„åˆ†</div>
          </div>
          <div class="ranking-list" id="rankingList"></div>
        </div>
        <div class="btn-group" style="justify-content: center">
          <button class="btn btn-primary" onclick="exportResult()">ğŸ“‹ å¯¼å‡ºç»“æœ</button>
          <button class="btn btn-secondary" onclick="shareMatrix()">ğŸ”— åˆ†äº«</button>
          <button class="btn btn-secondary" onclick="clearAll()">ğŸ—‘ï¸ æ¸…ç©º</button>
        </div>
      </div>
    </div>

    <script>
      const LS_KEY = 'decision-matrix-data';

      let criteria = [];
      let options = [];
      let scores = {};

      function init() {
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if (savedTheme === 'light') {
          document.body.setAttribute('data-theme', 'light');
        }

        loadFromStorage();
        loadFromUrl();

        if (criteria.length === 0) {
          criteria = [
            { id: 1, name: 'æˆæœ¬', weight: 8 },
            { id: 2, name: 'æ•ˆæœ', weight: 9 },
            { id: 3, name: 'é£é™©', weight: 7 }
          ];
        }
        if (options.length === 0) {
          options = [
            { id: 1, name: 'æ–¹æ¡ˆ A' },
            { id: 2, name: 'æ–¹æ¡ˆ B' }
          ];
        }

        renderCriteria();
        renderOptions();
        renderMatrix();

        document.getElementById('decisionTitle').addEventListener('input', saveToStorage);
      }

      function generateId() {
        return Date.now() + Math.random().toString(36).substr(2, 9);
      }

      function addCriteria(name = '', weight = 5) {
        criteria.push({ id: generateId(), name: name, weight: weight });
        renderCriteria();
        renderMatrix();
        saveToStorage();
      }

      function removeCriteria(id) {
        criteria = criteria.filter((c) => c.id !== id);
        renderCriteria();
        renderMatrix();
        saveToStorage();
      }

      function renderCriteria() {
        const container = document.getElementById('criteriaList');
        container.textContent = '';

        criteria.forEach((c) => {
          const div = document.createElement('div');
          div.className = 'criteria-item';

          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.placeholder = 'è¯„ä¼°æ ‡å‡†';
          nameInput.value = c.name;
          nameInput.addEventListener('input', (e) => {
            c.name = e.target.value;
            renderMatrix();
            saveToStorage();
          });

          const weightInput = document.createElement('input');
          weightInput.type = 'number';
          weightInput.className = 'weight-input';
          weightInput.min = '1';
          weightInput.max = '10';
          weightInput.placeholder = 'æƒé‡';
          weightInput.value = c.weight;
          weightInput.addEventListener('input', (e) => {
            c.weight = parseInt(e.target.value) || 1;
            renderMatrix();
            calculateResults();
            saveToStorage();
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger';
          deleteBtn.textContent = 'Ã—';
          deleteBtn.addEventListener('click', () => removeCriteria(c.id));

          div.appendChild(nameInput);
          div.appendChild(weightInput);
          div.appendChild(deleteBtn);

          container.appendChild(div);
        });
      }

      function addOption(name = '') {
        options.push({ id: generateId(), name: name });
        renderOptions();
        renderMatrix();
        saveToStorage();
      }

      function removeOption(id) {
        options = options.filter((o) => o.id !== id);
        renderOptions();
        renderMatrix();
        saveToStorage();
      }

      function renderOptions() {
        const container = document.getElementById('optionList');
        container.textContent = '';

        options.forEach((o) => {
          const div = document.createElement('div');
          div.className = 'option-item';

          const nameInput = document.createElement('input');
          nameInput.type = 'text';
          nameInput.placeholder = 'æ–¹æ¡ˆåç§°';
          nameInput.value = o.name;
          nameInput.addEventListener('input', (e) => {
            o.name = e.target.value;
            renderMatrix();
            saveToStorage();
          });

          const deleteBtn = document.createElement('button');
          deleteBtn.className = 'btn btn-danger';
          deleteBtn.textContent = 'Ã—';
          deleteBtn.addEventListener('click', () => removeOption(o.id));

          div.appendChild(nameInput);
          div.appendChild(deleteBtn);

          container.appendChild(div);
        });
      }

      function renderMatrix() {
        const table = document.getElementById('matrixTable');
        table.textContent = '';

        if (criteria.length === 0 || options.length === 0) {
          const row = document.createElement('tr');
          const cell = document.createElement('td');
          cell.textContent = 'è¯·å…ˆæ·»åŠ è¯„ä¼°æ ‡å‡†å’Œå¯é€‰æ–¹æ¡ˆ';
          cell.style.padding = '20px';
          cell.style.opacity = '0.5';
          row.appendChild(cell);
          table.appendChild(row);
          return;
        }

        // Header row
        const headerRow = document.createElement('tr');
        const emptyHeader = document.createElement('th');
        emptyHeader.textContent = 'æ–¹æ¡ˆ / æ ‡å‡†';
        headerRow.appendChild(emptyHeader);

        criteria.forEach((c) => {
          const th = document.createElement('th');
          th.className = 'criteria-header';
          const nameSpan = document.createElement('div');
          nameSpan.textContent = c.name || '(æœªå‘½å)';
          const weightSpan = document.createElement('span');
          weightSpan.textContent = 'æƒé‡: ' + c.weight;
          th.appendChild(nameSpan);
          th.appendChild(weightSpan);
          headerRow.appendChild(th);
        });

        const totalHeader = document.createElement('th');
        totalHeader.textContent = 'åŠ æƒæ€»åˆ†';
        headerRow.appendChild(totalHeader);

        table.appendChild(headerRow);

        // Calculate totals for each option
        const totals = [];
        options.forEach((o) => {
          let total = 0;
          criteria.forEach((c) => {
            const key = o.id + '-' + c.id;
            const score = scores[key] || 0;
            total += score * c.weight;
          });
          totals.push({ optionId: o.id, total: total });
        });

        const maxTotal = Math.max(...totals.map((t) => t.total));

        // Option rows
        options.forEach((o) => {
          const row = document.createElement('tr');
          const optionTotal = totals.find((t) => t.optionId === o.id);

          if (optionTotal && optionTotal.total === maxTotal && maxTotal > 0) {
            row.className = 'winner';
          }

          const nameCell = document.createElement('td');
          nameCell.className = 'option-name';
          nameCell.textContent = o.name || '(æœªå‘½å)';
          row.appendChild(nameCell);

          criteria.forEach((c) => {
            const cell = document.createElement('td');
            cell.className = 'score-cell';

            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'score-input';
            input.min = '1';
            input.max = '10';
            const key = o.id + '-' + c.id;
            input.value = scores[key] || '';
            input.addEventListener('input', (e) => {
              const val = parseInt(e.target.value);
              if (val >= 1 && val <= 10) {
                scores[key] = val;
              } else if (!e.target.value) {
                delete scores[key];
              }
              renderMatrix();
              calculateResults();
              saveToStorage();
            });

            cell.appendChild(input);
            row.appendChild(cell);
          });

          const totalCell = document.createElement('td');
          totalCell.className = 'total-cell';
          totalCell.textContent = optionTotal ? optionTotal.total.toFixed(1) : '0';
          row.appendChild(totalCell);

          table.appendChild(row);
        });

        calculateResults();
      }

      function calculateResults() {
        const results = options.map((o) => {
          let total = 0;
          let hasScores = false;
          criteria.forEach((c) => {
            const key = o.id + '-' + c.id;
            if (scores[key]) {
              total += scores[key] * c.weight;
              hasScores = true;
            }
          });
          return { option: o, total: total, hasScores: hasScores };
        });

        results.sort((a, b) => b.total - a.total);

        const winnerName = document.getElementById('winnerName');
        const winnerScore = document.getElementById('winnerScore');
        const rankingList = document.getElementById('rankingList');

        if (results.length > 0 && results[0].hasScores) {
          winnerName.textContent = results[0].option.name || '(æœªå‘½å)';
          winnerScore.textContent = 'åŠ æƒæ€»åˆ†: ' + results[0].total.toFixed(1);
        } else {
          winnerName.textContent = '-';
          winnerScore.textContent = 'è¯·å®Œæˆè¯„åˆ†';
        }

        rankingList.textContent = '';
        results.forEach((r, index) => {
          const div = document.createElement('div');
          div.className = 'ranking-item' + (index === 0 ? ' rank-1' : '');

          const left = document.createElement('div');
          left.style.cssText = 'display:flex;align-items:center;gap:12px;';

          const rankNum = document.createElement('div');
          rankNum.className = 'rank-number';
          rankNum.textContent = index + 1;

          const name = document.createElement('span');
          name.textContent = r.option.name || '(æœªå‘½å)';

          left.appendChild(rankNum);
          left.appendChild(name);

          const score = document.createElement('span');
          score.textContent = r.total.toFixed(1);
          score.style.fontWeight = 'bold';

          div.appendChild(left);
          div.appendChild(score);

          rankingList.appendChild(div);
        });
      }

      function exportResult() {
        const title = document.getElementById('decisionTitle').value || 'å†³ç­–åˆ†æ';
        let text = 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';
        text += '        å†³ç­–çŸ©é˜µåˆ†æç»“æœ\n';
        text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n';
        text += 'å†³ç­–é—®é¢˜: ' + title + '\n\n';

        text += 'è¯„ä¼°æ ‡å‡†:\n';
        criteria.forEach((c) => {
          text += 'â€¢ ' + (c.name || '(æœªå‘½å)') + ' (æƒé‡: ' + c.weight + ')\n';
        });
        text += '\n';

        text += 'è¯„åˆ†çŸ©é˜µ:\n';
        text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';

        const results = options.map((o) => {
          let total = 0;
          let scoreDetails = [];
          criteria.forEach((c) => {
            const key = o.id + '-' + c.id;
            const score = scores[key] || 0;
            total += score * c.weight;
            scoreDetails.push((c.name || 'æ ‡å‡†') + ':' + score);
          });
          return { option: o, total: total, details: scoreDetails };
        });

        results.sort((a, b) => b.total - a.total);

        results.forEach((r, index) => {
          text += index + 1 + '. ' + (r.option.name || '(æœªå‘½å)') + '\n';
          text += '   è¯„åˆ†: ' + r.details.join(', ') + '\n';
          text += '   åŠ æƒæ€»åˆ†: ' + r.total.toFixed(1) + '\n\n';
        });

        text += 'â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€\n';
        text += 'æ¨èé€‰æ‹©: ' + (results[0]?.option.name || '-') + '\n';
        text += 'â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n';

        navigator.clipboard.writeText(text).then(() => {
          showToast('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
        });
      }

      function shareMatrix() {
        const data = {
          title: document.getElementById('decisionTitle').value,
          criteria: criteria,
          options: options,
          scores: scores
        };
        const encoded = btoa(encodeURIComponent(JSON.stringify(data)));
        const url = window.location.href.split('#')[0] + '#' + encoded;
        navigator.clipboard.writeText(url).then(() => {
          showToast('åˆ†äº«é“¾æ¥å·²å¤åˆ¶');
        });
      }

      function loadFromUrl() {
        const hash = window.location.hash.slice(1);
        if (hash) {
          try {
            const data = JSON.parse(decodeURIComponent(atob(hash)));
            document.getElementById('decisionTitle').value = data.title || '';
            if (data.criteria) criteria = data.criteria;
            if (data.options) options = data.options;
            if (data.scores) scores = data.scores;
          } catch (e) {
            console.error('Failed to load from URL:', e);
          }
        }
      }

      function saveToStorage() {
        const data = {
          title: document.getElementById('decisionTitle').value,
          criteria: criteria,
          options: options,
          scores: scores
        };
        localStorage.setItem(LS_KEY, JSON.stringify(data));
      }

      function loadFromStorage() {
        const saved = localStorage.getItem(LS_KEY);
        if (saved) {
          try {
            const data = JSON.parse(saved);
            document.getElementById('decisionTitle').value = data.title || '';
            if (data.criteria) criteria = data.criteria;
            if (data.options) options = data.options;
            if (data.scores) scores = data.scores;
          } catch (e) {
            console.error('Failed to load from storage:', e);
          }
        }
      }

      function clearAll() {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†…å®¹å—ï¼Ÿ')) {
          document.getElementById('decisionTitle').value = '';
          criteria = [
            { id: generateId(), name: 'æˆæœ¬', weight: 8 },
            { id: generateId(), name: 'æ•ˆæœ', weight: 9 },
            { id: generateId(), name: 'é£é™©', weight: 7 }
          ];
          options = [
            { id: generateId(), name: 'æ–¹æ¡ˆ A' },
            { id: generateId(), name: 'æ–¹æ¡ˆ B' }
          ];
          scores = {};
          renderCriteria();
          renderOptions();
          renderMatrix();
          localStorage.removeItem(LS_KEY);
          window.location.hash = '';
        }
      }

      function showToast(message) {
        const toast = document.createElement('div');
        toast.style.cssText =
          'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:var(--accent-color);color:#000;padding:12px 24px;border-radius:8px;z-index:1000;font-size:14px;';
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 2000);
      }

      window.toggleTheme = function () {
        const body = document.body;
        const currentTheme = body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        body.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      };

      init();
    </script>
  </body>
</html>
